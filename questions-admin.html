<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إعدادات الامتحان - لوحة المعلم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- ملف إعدادات firebase الخاص بك -->
  <script src="firebase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {font-family:'Tajawal',Arial,sans-serif;background:#f8fafc;margin:0;}
    .container {max-width:650px;margin:30px auto 0 auto;background:#fff;border-radius:12px;padding:28px 20px;box-shadow:0 2px 10px #0002;}
    h2,h3 {color:#2260af;}
    table {width:100%;border-collapse:collapse;margin-top:18px;}
    th,td {border-bottom:1px solid #e4e7ef;padding:9px;text-align:center;font-size:1.07rem;}
    th {background:#eef2fa;}
    input[type="number"] {font-family:'Tajawal',Arial,sans-serif;font-size:1rem;padding:4px 7px;border-radius:5px;border:1px solid #b7c0d6;max-width:90px;text-align:center;}
    .btn {background:#2260af;color:#fff;border:none;padding:6px 18px; border-radius:5px; font-size:1rem;cursor:pointer;}
    .btn[disabled] {background:#bdbdbd;}
    .msg {margin:10px 0 0 0;font-weight:bold;}
    .logout-btn {background:#b83b3b;margin-right:10px;}
    .logout-btn:hover {background:#7a2626;}
    header {background:#2260af;color:#fff;padding:16px 24px;font-size:1.3rem;display:flex;justify-content:space-between;align-items:center;}
    @media (max-width:700px){.container{padding:7px;}.th,td{padding:5px;}}
  </style>
</head>
<body>
  <header>
    <span>إعدادات الامتحان - لوحة المعلم</span>
    <button class="btn logout-btn" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">
    <h2>ضبط عدد الأسئلة لكل مستوى</h2>
    <form id="settingsForm">
      <table>
        <thead>
          <tr>
            <th>المستوى</th>
            <th>عدد الأسئلة (question_num)</th>
            <th>إجراء</th>
          </tr>
        </thead>
        <tbody id="levelsTbody">
          <tr><td colspan="3" style="color:#888">جاري التحميل...</td></tr>
        </tbody>
      </table>
      <div class="msg" id="settingsMsg"></div>
    </form>
  </div>
  <script>
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();

    const LEVELS = [1,2,3,4,5,6,7];

    // حماية الصفحة - فقط للمعلمين
    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (!doc.exists || doc.data().role !== "teacher") {
            window.location.href = "login.html";
          } else {
            loadSettingsTable();
          }
        }).catch(function(error) {
          window.location.href = "login.html";
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }

    // تحميل الإعدادات لكل المستويات
    function loadSettingsTable() {
      const tbody = document.getElementById('levelsTbody');
      tbody.innerHTML = '<tr><td colspan="3" style="color:#888">جاري التحميل...</td></tr>';
      firestore.collection('exam_settings').get().then(snapshot => {
        let data = {};
        snapshot.forEach(doc => {
          data[doc.id] = doc.data().question_num;
        });
        let rows = '';
        LEVELS.forEach(lvl => {
          let val = data[`level_${lvl}`] !== undefined ? data[`level_${lvl}`] : '';
          rows += `
            <tr>
              <td>المستوى ${lvl}</td>
              <td>
                <input type="number" min="1" id="input_level_${lvl}" value="${val}" placeholder="أدخل عدد الأسئلة" required>
              </td>
              <td>
                <button type="button" class="btn" onclick="saveLevel(${lvl})">حفظ</button>
              </td>
            </tr>
          `;
        });
        tbody.innerHTML = rows;
      });
    }

    // حفظ قيمة السؤال لمستوى معين
    function saveLevel(lvl) {
      const msgEl = document.getElementById('settingsMsg');
      msgEl.innerText = '';
      let input = document.getElementById(`input_level_${lvl}`);
      let val = parseInt(input.value);
      if (!val || val<1) {
        msgEl.innerText = `يرجى إدخال عدد صحيح أكبر من صفر للمستوى ${lvl}`;
        msgEl.style.color = '#e63946';
        input.focus();
        return;
      }
      firestore.collection('exam_settings').doc(`level_${lvl}`).set({
        question_num: val
      }).then(()=>{
        msgEl.innerText = `تم حفظ عدد الأسئلة للمستوى ${lvl} بنجاح`;
        msgEl.style.color = '#219e4b';
        setTimeout(()=>{msgEl.innerText='';}, 2000);
      }).catch(()=>{
        msgEl.innerText = "حدث خطأ أثناء الحفظ!";
        msgEl.style.color = '#e63946';
      });
    }
  </script>
</body>
</html>
