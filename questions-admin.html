<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إدارة الأسئلة وإعدادات الامتحان - لوحة المعلم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- ملف إعدادات firebase الخاص بك -->
  <script src="firebase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
        font-family: 'Tajawal', Arial, sans-serif;
        background: #f8fafc;
        margin: 0;
        padding-top: 70px; /* لتجنب اختباء المحتوى خلف شريط التنقل الثابت */
        color: #23272f; /* لون نص افتراضي */
    }
    .container {max-width:900px;margin:30px auto 0 auto;background:#fff;border-radius:12px;padding:28px 20px;box-shadow:0 2px 10px #0002;}
    h2,h3 {color:#2260af;}
    .actions-bar {margin-bottom:18px;}
    .btn {background:#2260af;color:#fff;border:none;padding:7px 18px; border-radius:5px; font-size:1rem;cursor:pointer;}
    .btn[disabled] {background:#bdbdbd;}
    .btn.delete {background:#e63946;}
    .btn.edit {background:#e6a100;}
    .btn.small {padding:2px 9px; font-size:0.9rem;}
    .filter-bar {margin-bottom:18px;}
    .table-questions {width:100%;border-collapse:collapse;margin-top:10px;}
    .table-questions th,.table-questions td {border-bottom:1px solid #e4e7ef;padding:8px;text-align:center;font-size:1rem;}
    .table-questions th {background:#eef2fa;}
    .question-text {text-align:right;}
    .correct-ch {color:#219e4b;font-weight:bold;}
    .choices-list {display:flex;flex-wrap:wrap;gap:6px;}
    .choice-item {background:#f5f7fb;border-radius:7px;padding:2px 10px;margin-bottom:2px;}
    .choice-item.correct {background:#e3f6ed;color:#219e4b;font-weight:bold;}
    /* Form */
    .question-form-block {background:#f8fafc;border-radius:10px;padding:18px 12px;margin:18px 0 30px 0;box-shadow:0 2px 8px #e4e7ef44;}
    .form-row {margin-bottom:13px;}
    label {font-weight:bold;}
    input[type="text"], input[type="number"], textarea, select {font-family:'Tajawal',Arial,sans-serif;font-size:1rem; padding:6px 7px; border-radius:5px; border:1px solid #b7c0d6; width:95%;}
    input[type="number"] {max-width:120px;}
    textarea {height:54px;}
    .choices-area {margin-top:6px;}
    .choice-row {display:flex;align-items:center;gap:7px;margin-bottom:7px;}
    .choice-row input[type="text"] {width:65%;}
    .choice-row .btn.small {padding:1px 7px;}
    .add-choice-btn {margin-top:5px;}
    .msg {color:#e63946;margin-bottom:8px;}
    /* تم نقل أنماط logout-btn إلى main-nav */
    /* header تم استبدالها بتصميم main-nav */
    .settings-table {width:100%;border-collapse:collapse;margin-bottom:24px;}
    .settings-table th,.settings-table td {
        border-bottom:1px solid #e4e7ef;
        padding:9px;
        text-align:center;
        font-size:1.07rem;
        /* Default width for auto-sizing */
        width: auto;
    }
    /* Specific widths for settings table columns */
    .settings-table th:nth-child(1), .settings-table td:nth-child(1) { width: 10%; } /* المستوى */
    .settings-table th:nth-child(2), .settings-table td:nth-child(2) { width: 25%; } /* عدد الأسئلة */
    .settings-table th:nth-child(3), .settings-table td:nth-child(3) { width: 25%; } /* عدد العلامات */
    .settings-table th:nth-child(4), .settings-table td:nth-child(4) { width: 25%; } /* الوقت */
    .settings-table th:nth-child(5), .settings-table td:nth-child(5) { width: 15%; } /* إجراء */

    .settings-table input[type="number"] {
        max-width: 100%; /* Allow inputs to fill their column */
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }
    .settings-table th {background:#eef2fa;}
    .settings-table input[type="number"] {max-width:80px;}
    /* .settings-msg {margin:8px 0 0 0;font-weight:bold;min-height:20px;} تم إزالته ليحل محله الـ Toast */
    @media (max-width:900px){.container{padding:7px;}.table-questions th,.table-questions td{padding:4px;}}
    
    /* Professional Navigation Bar Styles - تم نسخها من dashboard.html */
    .main-nav {
      background: #3b5cb8; /* لون خلفية أزرق داكن */
      color: #fff;
      padding: 10px 30px;
      font-size: 1.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* ظل أكثر احترافية */
      position: fixed; /* تثبيت شريط التنقل */
      top: 0;
      width: 100%;
      z-index: 100; /* لضمان ظهوره فوق العناصر الأخرى */
      box-sizing: border-box; /* لضمان احتساب البادينج ضمن العرض */
    }

    .main-nav .nav-brand {
        display: flex;
        align-items: center;
    }

    .main-nav .center-logo {
        height: 40px; /* حجم الشعار */
        vertical-align: middle;
        margin-right: 15px; /* مسافة بين الشعار والروابط/العنوان */
    }

    .main-nav .nav-links {
        display: flex;
        align-items: center;
        gap: 25px; /* تباعد بين الروابط */
        flex-grow: 1; /* لجعل الروابط تتوزع في المنتصف */
        justify-content: center; /* لمحاذاة الروابط في المنتصف */
    }

    .main-nav .nav-link {
        color: #fff;
        text-decoration: none;
        padding: 8px 15px;
        font-size: 1.05rem;
        transition: background-color 0.3s, color 0.3s, border-radius 0.3s;
        border-radius: 5px;
        white-space: nowrap; /* منع التفاف النص */
    }

    .main-nav .nav-link:hover,
    .main-nav .nav-link.active {
        background-color: #26407a; /* لون الخلفية عند التمرير أو للرابط النشط */
        border-radius: 7px; /* حواف دائرية أنعم عند التفاعل */
    }

    .main-nav .nav-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }

    /* Dark Mode for Navigation Bar */
    .dark-mode .main-nav {
        background: #222f3e; /* خلفية أغمق للوضع الليلي */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
    }
    .dark-mode .main-nav .nav-link:hover,
    .dark-mode .main-nav .nav-link.active {
        background-color: #1a2430; /* خلفية أغمق للروابط في الوضع الليلي */
    }
    
    /* Night Mode for general elements */
    .dark-mode body {
        background: #23272f;
        color: #e0e0e0;
    }
    .dark-mode .container,
    .dark-mode .question-form-block {
        background: #323946;
        color: #e0e0e0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
    }
    .dark-mode h2, .dark-mode h3 {
        color: #8cafff; /* لون أفتح للعناوين */
    }
    .dark-mode .btn {
        background: #4a576b;
        color: #fff;
    }
    .dark-mode .btn:hover {
        background: #5a6b7e;
    }
    .dark-mode .btn.delete {
        background: #a40b2b;
    }
    .dark-mode .btn.delete:hover {
        background: #c02b41;
    }
    .dark-mode .btn.edit {
        background: #b96d0d;
    }
    .dark-mode .btn.edit:hover {
        background: #e6a100;
    }
    .dark-mode .table-questions th,
    .dark-mode .settings-table th {
        background: #2b3547;
        color: #fff;
    }
    .dark-mode .table-questions td,
    .dark-mode .settings-table td {
        border-bottom-color: #4a576b;
        color: #e0e0e0;
    }
    .dark-mode .table-questions tbody tr:hover,
    .dark-mode .settings-table tbody tr:hover {
        background-color: #3a455a;
    }
    .dark-mode input[type="text"],
    .dark-mode input[type="number"],
    .dark-mode textarea,
    .dark-mode select {
        background: #23272f;
        border-color: #4a576b;
        color: #e0e0e0;
    }
    .dark-mode input[type="text"]:focus,
    .dark-mode input[type="number"]:focus,
    .dark-mode textarea:focus,
    .dark-mode select:focus {
        border-color: #8cafff;
    }
    .dark-mode .choice-item {
        background: #2b3547;
        color: #e0e0e0;
    }
    .dark-mode .choice-item.correct {
        background: #1a6b3d;
        color: #e3f6ed;
    }
    .dark-mode .msg {
        color: #ff8080;
    }
    .dark-mode .settings-msg { /* لا يزال هذا موجوداً في الأنماط القديمة، لكنه غير مستخدم الآن */
        color: #66bb6a;
    }

    /* Responsive adjustments for the main navigation */
    @media (max-width: 768px) {
        .main-nav {
            flex-wrap: wrap; /* السماح بالتفاف العناصر */
            justify-content: center; /* توسيط العناصر عند التفافها */
            padding: 10px 15px;
        }
        .main-nav .nav-brand,
        .main-nav .nav-links,
        .main-nav .nav-actions {
            flex-basis: 100%; /* جعل كل قسم يأخذ عرض كامل عند التفاف */
            justify-content: center; /* توسيط المحتوى داخل الأقسام */
            margin-bottom: 5px; /* مسافة بين الصفوف المتراصة */
            gap: 10px; /* تباعد أقل بين الروابط */
        }
        .main-nav .nav-links {
            order: 2; /* وضع الروابط في المنتصف في ترتيب التفاف */
        }
        .main-nav .nav-brand {
            order: 1; /* الشعار أولاً */
            margin-bottom: 10px;
        }
        .main-nav .nav-actions {
            order: 3; /* الأزرار أخيراً */
            margin-bottom: 0;
        }
        .main-nav .nav-link {
            font-size: 0.95rem; /* حجم خط أصغر للروابط */
            padding: 6px 10px;
        }
        .main-nav .center-logo {
            height: 35px; /* حجم أصغر للشعار */
            margin-right: 0; /* إزالة المسافة الجانبية */
        }
        body {
            padding-top: 130px; /* ضبط المسافة العلوية لتناسب ارتفاع شريط التنقل المتراص */
        }
    }

    @media (max-width: 480px) {
        .main-nav .nav-links {
            gap: 10px; /* تباعد أقل للروابط على شاشات أضيق */
        }
        .main-nav .nav-link {
            font-size: 0.9rem; /* حجم خط أصغر */
            padding: 5px 8px;
        }
        body {
            padding-top: 120px; /* ضبط المسافة العلوية لضمان عدم اختباء المحتوى */
        }
    }

    /* Toast Styles - تم نسخها من dashboard.html */
    .toast {
      visibility: hidden; /* Hidden by default. */
      min-width: 250px; /* Set a default minimum width */
      margin-left: -125px; /* Div is centered horizontally */
      background-color: #3b5cb8; /* Blue background */
      color: #fff; /* White text color */
      text-align: center; /* Centered text */
      border-radius: 8px; /* Rounded borders */
      padding: 16px; /* Padding */
      position: fixed; /* Sit on top of the screen */
      z-index: 999; /* Add a z-index if needed */
      left: 50%; /* Center the toast horizontally */
      bottom: 30px; /* 30px from the bottom */
      font-size: 1.05rem;
      opacity: 0; /* Start with 0 opacity */
      transition: opacity 0.5s, visibility 0.5s; /* Add a fade-in effect */
    }

    /* Show the toast when it has the .show class */
    .toast.show {
      visibility: visible; /* Show the toast */
      opacity: 1; /* Fade in */
    }
  </style>
</head>
<body>
  <div style="background:#f2f2f7;color:#2e4061;padding:7px 0;text-align:center;font-size:0.97rem;">
  V19
</div>
  <nav class="main-nav">
    <div class="nav-brand">
      <img src="https://i.ibb.co/cSpS2NDk/logo-1.png" alt="شعار المركز" class="center-logo">
    </div>
    <div class="nav-links">
      <a href="dashboard.html" class="nav-link">لوحة المعلم - إدارة الطلاب والدروس</a>
      <a href="questions-admin.html" class="nav-link active">إدارة الأسئلة وإعدادات الامتحان</a>
    </div>
    <div class="nav-actions">
      <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
    </div>
  </nav>
<div class="container">

  <!-- إعدادات عدد الأسئلة لكل مستوى -->
  <div class="question-form-block" style="margin-bottom:18px;">
    <h3>ضبط عدد الأسئلة في الامتحان لكل مستوى</h3>
    <form id="settingsForm" onsubmit="return false;">
      <table class="settings-table">
        <thead>
          <tr>
            <th>المستوى</th>
            <th>عدد الأسئلة</th>
            <th>عدد العلامات =</th>
            <th>الوقت (دقيقة)</th>
            <th>إجراء</th>
          </tr>
        </thead>
        <tbody id="settingsTbody">
          <tr><td colspan="5" style="color:#888">جاري التحميل...</td></tr>
        </tbody>
      </table>
      <!-- تم إزالة div.settings-msg من هنا -->
    </form>
  </div>
  <!-- نهاية إعدادات عدد الأسئلة -->

  <!-- نموذج إضافة سؤال (الكود الأصلي - بدون تعديل) -->
  <div class="question-form-block">
    <h3 id="formTitle">إضافة سؤال جديد</h3>
    <form id="questionForm">
      <div class="form-row">
        <label for="qText">نص السؤال:</label><br>
        <textarea id="qText" required></textarea>
      </div>
      <div class="form-row">
        <label for="qLevel">المستوى:</label>
        <select id="qLevel">
          <option value="1">المستوى 1</option>
          <option value="2">المستوى 2</option>
          <option value="3">المستوى 3</option>
          <option value="4">المستوى 4</option>
          <option value="5">المستوى 5</option>
          <option value="6">المستوى 6</option>
          <option value="7">المستوى 7</option>
        </select>
      </div>
      <div class="form-row">
        <label for="qMark">علامة السؤال:</label>
        <input type="number" id="qMark" min="1" value="1" required>
      </div>
      <div class="form-row">
        <label>الخيارات:</label>
        <div class="choices-area" id="choicesArea"></div>
        <button type="button" class="btn small add-choice-btn" onclick="addChoice()">+ خيار جديد</button>
      </div>
      <div class="form-row">
        <button type="submit" class="btn">حفظ السؤال</button>
        <button type="button" class="btn" onclick="resetForm()">إلغاء</button>
      </div>
      <div class="msg" id="formMsg"></div>
      <input type="hidden" id="editId">
    </form>
  </div>
  <div class="actions-bar">
    <b>تصفية حسب المستوى:</b>
    <select id="filterLevel" onchange="renderQuestionsTable()">
      <option value="">الكل</option>
      <option value="1">المستوى 1</option>
      <option value="2">المستوى 2</option>
      <option value="3">المستوى 3</option>
      <option value="4">المستوى 4</option>
      <option value="5">المستوى 5</option>
      <option value="6">المستوى 6</option>
      <option value="7">المستوى 7</option>
    </select>
  </div>
  <table class="table-questions" id="questionsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>السؤال</th>
        <th>المستوى</th>
        <th>العلامة</th>
        <th>الخيارات</th>
        <th>عدد الصحيحة</th>
        <th>تعديل</th>
        <th>حذف</th>
      </tr>
    </thead>
    <tbody id="questionsTbody"></tbody>
  </table>
</div>

<!-- Toast element for messages -->
<div id="toast" class="toast"></div>

<script>
// Toast & Loading Functions (copied from dashboard.html)
function showToast(msg, color="#3b5cb8") {
  const toast = document.getElementById("toast");
  if (!toast) {
      console.error("Toast element not found!");
      return;
  }
  toast.innerText = msg;
  toast.style.background = color;
  toast.className = "toast show";
  setTimeout(()=>{ toast.className = toast.className.replace("show", ""); }, 2500);
}
function showLoading(show) {
  // Assuming a spinner exists if needed, otherwise this can be a placeholder.
  // For this page, a spinner might not be strictly necessary for settings saves,
  // but keeping the function consistent.
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) {
      spinner.style.display = show ? "block" : "none";
  }
}


if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
var auth = firebase.auth();
var firestore = firebase.firestore();

let questions = [];
const LEVELS = [1,2,3,4,5,6,7];

// حماية الصفحة - فقط للمعلمين
auth.onAuthStateChanged(function(user) {
  if (user) {
    firestore.collection('users').doc(user.uid).get().then(function(doc) {
      if (!doc.exists || doc.data().role !== "teacher") {
        window.location.href = "login.html";
      } else {
        startQuestionsAdmin();
        loadSettingsTable();
      }
    }).catch(function(error) {
      window.location.href = "login.html";
    });
  } else {
    window.location.href = "login.html";
  }
});

function logout() {
  auth.signOut().then(()=>{window.location.href='login.html';});
}

// إعدادات عدد الأسئلة لكل مستوى
function loadSettingsTable() {
  const tbody = document.getElementById('settingsTbody');
  tbody.innerHTML = '<tr><td colspan="5" style="color:#888">جاري التحميل...</td></tr>'; // Updated colspan
  firestore.collection('exam_settings').get().then(snapshot => {
    let data = {};
    snapshot.forEach(doc => {
      data[doc.id] = doc.data(); // Get all data for the level (question_num, total_marks, exam_duration)
    });
    let rows = '';
    LEVELS.forEach(lvl => {
      let questionNum = data[`level_${lvl}`]?.question_num !== undefined ? data[`level_${lvl}`].question_num : '';
      let totalMarks = data[`level_${lvl}`]?.total_marks !== undefined ? data[`level_${lvl}`].total_marks : ''; // New field
      let examDuration = data[`level_${lvl}`]?.exam_duration !== undefined ? data[`level_${lvl}`].exam_duration : ''; // New field

      rows += `
        <tr>
          <td>المستوى ${lvl}</td>
          <td>
            <input type="number" min="1" id="input_qnum_${lvl}" value="${questionNum}" placeholder="عدد الأسئلة" required>
          </td>
          <td>
            <input type="number" min="1" id="input_tmarks_${lvl}" value="${totalMarks}" placeholder="عدد العلامات" required>
          </td>
          <td>
            <input type="number" min="1" id="input_duration_${lvl}" value="${examDuration}" placeholder="الوقت (دقيقة)" required>
          </td>
          <td>
            <button type="button" class="btn" onclick="saveLevel(${lvl})">حفظ</button>
          </td>
        </tr>
      `;
    });
    tbody.innerHTML = rows;
  });
}

function saveLevel(lvl) {
  // تم إزالة msgEl لأنه سنستخدم showToast
  let inputQNum = document.getElementById(`input_qnum_${lvl}`);
  let inputTMarks = document.getElementById(`input_tmarks_${lvl}`); // New input
  let inputDuration = document.getElementById(`input_duration_${lvl}`); // New input

  let qNum = parseInt(inputQNum.value);
  let tMarks = parseInt(inputTMarks.value); // New value
  let duration = parseInt(inputDuration.value); // New value

  if (!qNum || qNum < 1) {
    showToast(`يرجى إدخال عدد صحيح أكبر من صفر لعدد الأسئلة للمستوى ${lvl}`, '#e63946');
    inputQNum.focus();
    return;
  }
  if (!tMarks || tMarks < 1) { // Validation for total_marks
    showToast(`يرجى إدخال عدد صحيح أكبر من صفر لعدد العلامات للمستوى ${lvl}`, '#e63946');
    inputTMarks.focus();
    return;
  }
  if (!duration || duration < 1) { // Validation for exam_duration
    showToast(`يرجى إدخال عدد صحيح أكبر من صفر للوقت المخصص للمستوى ${lvl}`, '#e63946');
    inputDuration.focus();
    return;
  }

  firestore.collection('exam_settings').doc(`level_${lvl}`).set({
    question_num: qNum,
    total_marks: tMarks, // New field
    exam_duration: duration // New field
  }).then(()=>{
    showToast(`تم حفظ إعدادات المستوى ${lvl} بنجاح`, '#219e4b');
  }).catch((error)=>{ // Added error parameter for better logging
    showToast(`حدث خطأ أثناء الحفظ! ${error.message}`, '#e63946');
    console.error("Error saving level settings:", error); // Log the error for debugging
  });
}

// الكود الأصلي لإضافة الأسئلة وإدارتها
function startQuestionsAdmin() {
  resetForm();
  loadQuestions();
}

function addChoice(text = '', checked = false) {
  let idx = document.querySelectorAll('.choice-row').length;
  let div = document.createElement('div');
  div.className = 'choice-row';
  div.innerHTML = `
    <input type="checkbox" class="correctChoice" name="correct${idx}" ${checked ? 'checked' : ''} title="صحيح">
    <input type="text" class="choiceText" value="${text}" required placeholder="الخيار ${idx+1}">
    <button type="button" class="btn small" onclick="this.parentNode.remove()">حذف</button>
  `;
  document.getElementById('choicesArea').appendChild(div);
}

function resetForm() {
  document.getElementById('questionForm').reset();
  document.getElementById('choicesArea').innerHTML = '';
  addChoice();
  addChoice();
  document.getElementById('editId').value = '';
  document.getElementById('formTitle').innerText = 'إضافة سؤال جديد';
  document.getElementById('formMsg').innerText = '';
  document.getElementById('qMark').value = 1;
}

function loadQuestions() {
  firestore.collection('questions').orderBy('level').get().then(snap => {
    questions = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
    renderQuestionsTable();
  });
}

function renderQuestionsTable() {
  let level = document.getElementById('filterLevel').value;
  let rows = '';
  let filtered = level ? questions.filter(q => q.level == level) : questions;
  filtered.forEach((q, i) => {
    let chs = q.choices.map((c, idx) =>
      `<span class="choice-item${q.correct && q.correct.includes(idx) ? ' correct' : ''}">${c}</span>`
    ).join('');
    rows += `<tr>
      <td>${i+1}</td>
      <td class="question-text">${q.question}</td>
      <td>${q.level}</td>
      <td>${q.mark || 1}</td>
      <td><div class="choices-list">${chs}</div></td>
      <td>${q.correct ? q.correct.length : 0}</td>
      <td><button class="btn edit" onclick="editQuestion('${q.id}')">تعديل</button></td>
      <td><button class="btn delete" onclick="deleteQuestion('${q.id}')">حذف</button></td>
    </tr>`;
  });
  document.getElementById('questionsTbody').innerHTML = rows || `<tr><td colspan="8" style="color:#888">لا توجد أسئلة</td></tr>`;
}

function editQuestion(id) {
  let q = questions.find(x => x.id === id);
  if (!q) return;
  document.getElementById('qText').value = q.question;
  document.getElementById('qLevel').value = q.level;
  document.getElementById('qMark').value = q.mark || 1;
  document.getElementById('choicesArea').innerHTML = '';
  q.choices.forEach((choice, i) => {
    addChoice(choice, q.correct && q.correct.includes(i));
  });
  document.getElementById('editId').value = id;
  document.getElementById('formTitle').innerText = 'تعديل سؤال';
  window.scrollTo({top:0,behavior:'smooth'});
}

function deleteQuestion(id) {
  if (!confirm('هل أنت متأكد من حذف السؤال؟')) return;
  firestore.collection('questions').doc(id).delete().then(loadQuestions);
}

document.getElementById('questionForm').onsubmit = function(e){
  e.preventDefault();
  let question = document.getElementById('qText').value.trim();
  let level = parseInt(document.getElementById('qLevel').value);
  let mark = parseFloat(document.getElementById('qMark').value) || 1;
  let choiceNodes = document.querySelectorAll('.choice-row');
  let choices = [];
  let correct = [];
  choiceNodes.forEach((row, i) => {
    let text = row.querySelector('.choiceText').value.trim();
    if (text) {
      choices.push(text);
      if (row.querySelector('.correctChoice').checked) correct.push(i);
    }
  });
  if (choices.length < 2) { showFormMsg('يجب إدخال خيارين على الأقل!'); return; }
  if (correct.length === 0) { showFormMsg('حدد إجابة صحيحة واحدة على الأقل!'); return; }
  if (mark <= 0) { showFormMsg('يجب أن تكون العلامة أكبر من صفر!'); return; }
  let qObj = {
    question,
    choices,
    correct,
    level,
    mark
  };
  let editId = document.getElementById('editId').value;
  if (editId) {
    firestore.collection('questions').doc(editId).set(qObj).then(()=>{
      resetForm();
      loadQuestions();
      showFormMsg('تم تحديث السؤال بنجاح', true);
    });
  } else {
    firestore.collection('questions').add(qObj).then(()=>{
      resetForm();
      loadQuestions();
      showFormMsg('تمت إضافة السؤال بنجاح', true);
    });
  }
};

function showFormMsg(msg, success=false) {
  let el = document.getElementById('formMsg');
  el.innerText = msg;
  el.style.color = success ? '#219e4b' : '#e63946';
  setTimeout(()=>{el.innerText='';}, 2500);
}
</script>
</body>
</html>
