<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم المعلم - شفاء</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Tajawal', 'Cairo', Arial, sans-serif; margin: 0; background: #f8fafc; color: #333; }
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    .container { max-width: 1000px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    h2 { color: #4361ee; margin-top: 0; }
    .btn { background: #4361ee; color: #fff; border: none; padding: 7px 22px; border-radius: 5px; font-size: 1rem; cursor: pointer; transition: background 0.3s ease; }
    .btn:hover { background: #364fc7; }
    .btn.submit { background: #1dad87; }
    .btn.submit:hover { background: #159b79; }
    .signout { background: #e63946; }
    .signout:hover { background: #cc2c3d; }
    .info-box { background: #eef2fa; border-radius: 7px; padding: 10px 18px; margin: 16px 0; display: flex; justify-content: space-between; align-items: center; }
    #msg { color: #e63946; margin-top: 20px; }
    .spinner { border: 4px solid #eee; border-top: 4px solid #4361ee; border-radius: 50%; width: 38px; height: 38px; animation: spin 1s linear infinite; margin: 60px auto; display: none; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; font-size: 1.05rem; opacity: 0; transition: opacity 0.5s, visibility 0.5s; }
    .toast.show { visibility: visible; opacity: 1; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid #e0e4e8; margin-bottom: 20px; }
    .tab-btn { padding: 12px 20px; cursor: pointer; border: none; background: transparent; font-size: 1.1rem; color: #555; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
    .tab-btn.active { color: #4361ee; border-bottom: 3px solid #4361ee; font-weight: bold; }
    .tab-btn:hover:not(.active) { color: #4361ee; }
    .tab-content { padding-top: 20px; }

    /* Forms & Tables */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #294169; }
    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="number"],
    .form-group input[type="url"],
    .form-group select,
    .form-group textarea {
      width: 100%; padding: 10px; border: 1px solid #b7c0d6; border-radius: 5px; font-size: 1rem;
      box-sizing: border-box; font-family: 'Cairo', 'Tajawal', Arial, sans-serif;
      background: #fdfdfd; color: #1b2a39;
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-group input[type="checkbox"] { margin-left: 8px; }
    .form-group .checkbox-label { display: inline-block; margin-right: 15px; }

    .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05); }
    .data-table th, .data-table td { padding: 12px 8px; border-bottom: 1px solid #e4e7ef; text-align: right; font-size: 0.95rem; }
    .data-table th { background: #eef2fa; color: #1b3e72; font-weight: bold; }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table .actions button { margin-left: 5px; }

    /* Specific Styles for Summaries */
    .summary-item {
      background: #fdfdfd; border: 1px solid #e0e4e8; border-radius: 10px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .summary-item h3 { color: #294169; margin-top: 0; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f2f5; }
    .summary-item p { margin-bottom: 10px; line-height: 1.6; }
    .summary-item .student-info, .summary-item .lesson-info { font-size: 0.95rem; color: #555; margin-bottom: 8px; }
    .summary-item .summary-text-display {
      background: #f5f7fb; padding: 15px; border-radius: 8px; border: 1px solid #e4e7ef;
      margin-top: 15px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7;
    }
    .summary-item .status-badge {
      display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: bold;
      margin-right: 10px;
    }
    .status-badge.submitted { background: #e3f6ed; color: #219e4b; border: 1px solid #b7eecd; }
    .status-badge.draft { background: #f5f7fb; color: #555; border: 1px solid #d2d8e6; }

    .comment-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e0e4e8; }
    .comment-section label { display: block; margin-bottom: 8px; font-weight: bold; color: #294169; }
    .comment-section textarea { width: 98%; height: 80px; padding: 10px; border: 1px solid #b7c0d6; border-radius: 5px; resize: vertical; font-size: 1rem; box-sizing: border-box; }
    .comment-section input[type="number"] { width: 100px; text-align: center; }
    .comment-section .current-mark { font-weight: bold; color: #007bff; margin-right: 10px; }
    .comment-section .mark-input-group { display: flex; align-items: center; margin-bottom: 15px; }

    /* Night Mode */
    .dark-mode { background: #23272f; color: #e0e0e0; }
    .dark-mode .container { background: #323946; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
    .dark-mode header { background: #222f3e; }
    .dark-mode h2 { color: #8cafff; }
    .dark-mode .btn { background: #556ee6; }
    .dark-mode .btn:hover { background: #4a5dc4; }
    .dark-mode .btn.submit { background: #1a8b6f; }
    .dark-mode .btn.submit:hover { background: #156d56; }
    .dark-mode .signout { background: #c73a4b; }
    .dark-mode .signout:hover { background: #a82e3c; }
    .dark-mode .info-box { background: #2a3447; color: #e0e0e0; }
    .dark-mode .form-group label { color: #e0e0e0; }
    .dark-mode .form-group input, .dark-mode .form-group select, .dark-mode .form-group textarea {
      background: #2b3547; border-color: #4a576b; color: #e0e0e0;
    }
    .dark-mode .data-table { background: #293043; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15); }
    .dark-mode .data-table th { background: #253150; color: #e0e0e0; }
    .dark-mode .data-table td { border-bottom-color: #4a576b; }
    .dark-mode .tabs { border-bottom-color: #4a576b; }
    .dark-mode .tab-btn { color: #bbb; }
    .dark-mode .tab-btn.active { color: #8cafff; border-bottom-color: #8cafff; }
    .dark-mode .tab-btn:hover:not(.active) { color: #8cafff; }
    .dark-mode .summary-item { background: #2b3547; border-color: #4a576b; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); }
    .dark-mode .summary-item h3 { color: #8cafff; border-bottom-color: #4a576b; }
    .dark-mode .summary-item .student-info, .dark-mode .summary-item .lesson-info { color: #bbb; }
    .dark-mode .summary-item .summary-text-display { background: #222f3e; border-color: #4a576b; }
    .dark-mode .comment-section label { color: #e0e0e0; }
    .dark-mode .comment-section textarea { background: #2b3547; border-color: #4a576b; color: #e0e0e0; }
    .dark-mode .comment-section .current-mark { color: #a0c4ff; }
    .dark-mode .comment-section { border-top-color: #4a576b; }

    /* New styles for student reply display */
    .student-reply-display {
      background: #eef2fa; /* Light blue-grey */
      padding: 10px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.98rem;
      color: #333;
      border: 1px solid #d2e0f0; /* Slightly darker border */
      line-height: 1.6;
      word-break: break-word; /* Ensure long words break */
    }
    .student-reply-display strong {
      color: #294169; /* Dark blue for emphasis */
      display: block;
      margin-bottom: 5px;
    }
    .dark-mode .student-reply-display {
      background: #2a3447; /* Darker background for dark mode */
      border-color: #4a576b; /* Darker border */
      color: #e0e0e0; /* Light text */
    }
    .dark-mode .student-reply-display strong {
      color: #8cafff; /* Lighter blue for emphasis in dark mode */
    }

    /* Notification Bell and Panel (similar to student.html) */
    .notification-bell {
        position: relative;
        font-size: 1.5rem;
        cursor: pointer;
        margin-left: 20px; /* Space from other header elements */
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -10px;
        background-color: #ff5722; /* Orange-red for unread */
        color: white;
        border-radius: 50%;
        padding: 2px 7px;
        font-size: 0.75rem;
        font-weight: bold;
        line-height: 1;
        min-width: 15px;
        text-align: center;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .notification-panel {
        display: none; /* Hidden by default */
        position: absolute;
        top: 60px; /* Adjust based on header height */
        right: 10px;
        width: 320px;
        max-height: 400px;
        overflow-y: auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        padding: 15px;
        text-align: right;
        border: 1px solid #eee;
        box-sizing: border-box;
    }
    .notification-panel h5 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #294169;
        font-size: 1.1rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .notification-item {
        padding: 10px 0;
        border-bottom: 1px solid #f0f2f5;
        font-size: 0.95rem;
        color: #333;
        line-height: 1.4;
    }
    .notification-item:last-child {
        border-bottom: none;
    }
    .notification-item.unread {
        background-color: #e6f2ff; /* Light blue for unread */
        font-weight: bold;
        padding: 10px;
        margin: 0 -15px; /* Extend background to panel edges */
    }
    .notification-item .timestamp {
        display: block;
        font-size: 0.8em;
        color: #888;
        margin-top: 5px;
    }
    .notification-item .mark-read-btn {
        background: #1dad87;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 8px;
        display: inline-block;
    }
    .notification-item .mark-read-btn:hover {
        background: #159b79;
    }
    /* Dark mode for notifications */
    .dark-mode .notification-panel {
        background-color: #323946;
        border-color: #4a576b;
        color: #e0e0e0;
    }
    .dark-mode .notification-panel h5 {
        color: #8cafff;
        border-bottom-color: #4a576b;
    }
    .dark-mode .notification-item {
        color: #e0e0e0;
        border-bottom-color: #4a576b;
    }
    .dark-mode .notification-item.unread {
        background-color: #2a3447; /* Darker blue for unread in dark mode */
    }
    .dark-mode .notification-item .timestamp {
        color: #bbb;
    }
    .dark-mode .notification-item .mark-read-btn {
        background: #1a6b3d;
    }
    .dark-mode .notification-item .mark-read-btn:hover {
        background: #159b79;
    }

    @media (max-width: 480px) {
        .notification-panel {
            width: 95%;
            left: 2.5%;
            right: 2.5%;
        }
        .notification-item.unread {
          padding: 10px 5px;
          margin: 0 -5px;
        }
    }
  </style>
</head>
<body>
  <header>
    <span>لوحة تحكم المعلم</span>
    <div>
      <button class="btn" id="nightModeBtn" onclick="toggleNightMode()">الوضع الليلي</button>
      
      <span class="notification-bell" onclick="toggleNotificationPanel()">
          <i class="fas fa-bell"></i>
          <span id="unreadNotificationsBadge" class="notification-badge" style="display:none;">0</span>
      </span>

      <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
    </div>
  </header>

  <div class="container">
    <h2>مرحباً، <span id="teacherName"></span></h2>
    <div class="info-box">
      <div><b>البريد الإلكتروني:</b> <span id="teacherEmail"></span></div>
      <div id="msg"></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="openTab(event, 'studentsTab')">الطلاب</button>
      <button class="tab-btn" onclick="openTab(event, 'lessonsTab')">الدروس</button>
      <button class="tab-btn" onclick="openTab(event, 'questionsTab')">الأسئلة</button>
      <button class="tab-btn" onclick="openTab(event, 'examSettingsTab')">إعدادات الاختبار</button>
      <button class="tab-btn" onclick="openTab(event, 'summariesTab')">التلاخيص</button>
      <button class="tab-btn" onclick="openTab(event, 'examResultsTab')">نتائج الاختبارات</button>
    </div>

    <div id="studentsTab" class="tab-content">
      <h3>إدارة الطلاب</h3>
      <div class="form-group">
        <label for="studentEmailInput">إيميل الطالب:</label>
        <input type="email" id="studentEmailInput" placeholder="أدخل إيميل الطالب">
      </div>
      <div class="form-group">
        <label for="studentNameInput">اسم الطالب:</label>
        <input type="text" id="studentNameInput" placeholder="أدخل اسم الطالب">
      </div>
      <div class="form-group">
        <label for="courseNumberInput">رقم المقرر:</label>
        <input type="text" id="courseNumberInput" placeholder="أدخل رقم المقرر">
      </div>
      <div class="form-group">
        <label>المستويات المفعلة:</label>
        <div id="levelsCheckboxes">
          <label class="checkbox-label"><input type="checkbox" id="level1"> المستوى 1</label>
          <label class="checkbox-label"><input type="checkbox" id="level2"> المستوى 2</label>
          <label class="checkbox-label"><input type="checkbox" id="level3"> المستوى 3</label>
          <label class="checkbox-label"><input type="checkbox" id="level4"> المستوى 4</label>
          <label class="checkbox-label"><input type="checkbox" id="level5"> المستوى 5</label>
          <label class="checkbox-label"><input type="checkbox" id="level6"> المستوى 6</label>
          <label class="checkbox-label"><input type="checkbox" id="level7"> المستوى 7</label>
        </div>
      </div>
      <div class="form-group">
        <label>حالة القبول:</label>
        <select id="admissionStatusSelect">
          <option value="">لم يتم التحديد</option>
          <option value="accepted">مقبول</option>
          <option value="rejected">مرفوض</option>
          <option value="pending">قيد المراجعة</option>
        </select>
      </div>
      <button class="btn submit" onclick="addOrUpdateStudent()">إضافة/تحديث الطالب</button>
      <button class="btn signout" onclick="deleteStudent()">حذف الطالب</button>
      <button class="btn" onclick="loadStudentDataForEdit()">تحميل بيانات الطالب للتعديل</button>
      <hr style="margin:25px 0;">
      <h3>قائمة الطلاب</h3>
      <input type="text" id="studentSearchInput" onkeyup="filterStudents()" placeholder="ابحث عن طالب بالاسم أو الإيميل...">
      <div class="spinner" id="studentsLoadingSpinner"></div>
      <table class="data-table" id="studentsTable">
        <thead>
          <tr>
            <th>الإيميل</th>
            <th>الاسم</th>
            <th>المقرر</th>
            <th>المستويات</th>
            <th>القبول</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="lessonsTab" class="tab-content" style="display:none;">
      <h3>إدارة الدروس</h3>
      <div class="form-group">
        <label for="lessonIdInput">رقم الدرس:</label>
        <input type="number" id="lessonIdInput" placeholder="أدخل رقم الدرس (مثال: 1)">
      </div>
      <div class="form-group">
        <label for="lessonTitleInput">عنوان الدرس:</label>
        <input type="text" id="lessonTitleInput" placeholder="أدخل عنوان الدرس">
      </div>
      <div class="form-group">
        <label for="lessonUrlInput">رابط المحاضرة (PDF/Doc):</label>
        <input type="url" id="lessonUrlInput" placeholder="أدخل رابط ملف المحاضرة">
      </div>
      <div class="form-group">
        <label for="lessonVoiceInput">رابط الصوت (MP3):</label>
        <input type="url" id="lessonVoiceInput" placeholder="أدخل رابط الملف الصوتي">
      </div>
      <div class="form-group">
        <label for="lessonLevelSelect">المستوى:</label>
        <select id="lessonLevelSelect">
          <option value="المستوى 1">المستوى 1</option>
          <option value="المستوى 2">المستوى 2</option>
          <option value="المستوى 3">المستوى 3</option>
          <option value="المستوى 4">المستوى 4</option>
          <option value="المستوى 5">المستوى 5</option>
          <option value="المستوى 6">المستوى 6</option>
          <option value="المستوى 7">المستوى 7</option>
        </select>
      </div>
      <button class="btn submit" onclick="addOrUpdateLesson()">إضافة/تحديث الدرس</button>
      <button class="btn signout" onclick="deleteLesson()">حذف الدرس</button>
      <button class="btn" onclick="loadLessonDataForEdit()">تحميل بيانات الدرس للتعديل</button>
      <hr style="margin:25px 0;">
      <h3>قائمة الدروس</h3>
      <div class="spinner" id="lessonsLoadingSpinner"></div>
      <table class="data-table" id="lessonsTable">
        <thead>
          <tr>
            <th>الرقم</th>
            <th>العنوان</th>
            <th>المستوى</th>
            <th>رابط المحاضرة</th>
            <th>رابط الصوت</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="questionsTab" class="tab-content" style="display:none;">
      <h3>إدارة الأسئلة</h3>
      <div class="form-group">
        <label for="questionTextInput">نص السؤال:</label>
        <textarea id="questionTextInput" placeholder="أدخل نص السؤال"></textarea>
      </div>
      <div class="form-group">
        <label for="questionLevelSelect">المستوى:</label>
        <select id="questionLevelSelect">
          <option value="1">المستوى 1</option>
          <option value="2">المستوى 2</option>
          <option value="3">المستوى 3</option>
          <option value="4">المستوى 4</option>
          <option value="5">المستوى 5</option>
          <option value="6">المستوى 6</option>
          <option value="7">المستوى 7</option>
        </select>
      </div>
      <div class="form-group">
        <label for="questionMarkInput">علامة السؤال:</label>
        <input type="number" id="questionMarkInput" value="1" min="0.5" step="0.5">
      </div>
      <div class="form-group">
        <label>الخيارات والإجابات الصحيحة (ضع علامة صح أمام الإجابات الصحيحة):</label>
        <div id="choicesContainer">
          <div class="choice-row" style="margin-bottom:10px;">
            <input type="checkbox" class="correct-choice-checkbox">
            <input type="text" class="choice-text-input" placeholder="الخيار 1" style="width: calc(100% - 30px);">
          </div>
          <div class="choice-row" style="margin-bottom:10px;">
            <input type="checkbox" class="correct-choice-checkbox">
            <input type="text" class="choice-text-input" placeholder="الخيار 2" style="width: calc(100% - 30px);">
          </div>
        </div>
        <button class="btn" onclick="addChoiceInput()">إضافة خيار</button>
      </div>
      <button class="btn submit" onclick="addOrUpdateQuestion()">إضافة/تحديث السؤال</button>
      <button class="btn signout" onclick="deleteQuestion()">حذف السؤال</button>
      <button class="btn" onclick="loadQuestionDataForEdit()">تحميل بيانات السؤال للتعديل</button>
      <hr style="margin:25px 0;">
      <h3>قائمة الأسئلة</h3>
      <div class="spinner" id="questionsLoadingSpinner"></div>
      <table class="data-table" id="questionsTable">
        <thead>
          <tr>
            <th>الرقم</th>
            <th>السؤال</th>
            <th>المستوى</th>
            <th>العلامة</th>
            <th>خيارات</th>
            <th>إجابات صحيحة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="examSettingsTab" class="tab-content" style="display:none;">
      <h3>إعدادات الاختبارات</h3>
      <div class="form-group">
        <label for="examSettingLevelSelect">المستوى:</label>
        <select id="examSettingLevelSelect" onchange="loadExamSetting()">
          <option value="1">المستوى 1</option>
          <option value="2">المستوى 2</option>
          <option value="3">المستوى 3</option>
          <option value="4">المستوى 4</option>
          <option value="5">المستوى 5</option>
          <option value="6">المستوى 6</option>
          <option value="7">المستوى 7</option>
        </select>
      </div>
      <div class="form-group">
        <label for="questionNumInput">عدد الأسئلة في الاختبار:</label>
        <input type="number" id="questionNumInput" min="1" placeholder="أدخل عدد الأسئلة التي ستظهر للطالب">
      </div>
      <button class="btn submit" onclick="saveExamSetting()">حفظ إعدادات الاختبار</button>
      <div class="spinner" id="examSettingsLoadingSpinner"></div>
    </div>

    <div id="summariesTab" class="tab-content" style="display:none;">
      <h3>التلاخيص المقدمة من الطلاب</h3>
      <div class="info-box">
        <input type="text" id="summariesSearchInput" onkeyup="filterSummaries()" placeholder="ابحث عن تلخيص (اسم الطالب، إيميل، عنوان درس)..." style="width: 70%;">
        <select id="summariesFilterStatus" onchange="filterSummaries()" style="width: 25%;">
          <option value="all">جميع الحالات</option>
          <option value="submitted">تم التسليم النهائي</option>
          <option value="draft">مسودة</option>
        </select>
      </div>
      <div class="spinner" id="summariesLoadingSpinner"></div>
      <div id="summariesList">
        <p style="text-align: center; color: #888;">لا توجد تلاخيص لعرضها.</p>
      </div>
    </div>

    <div id="examResultsTab" class="tab-content" style="display:none;">
      <h3>نتائج الاختبارات</h3>
      <div class="info-box">
        <input type="text" id="examResultsSearchInput" onkeyup="filterExamResults()" placeholder="ابحث عن نتيجة (اسم الطالب، إيميل، مستوى)..." style="width: 70%;">
        <select id="examResultsFilterStatus" onchange="filterExamResults()" style="width: 25%;">
          <option value="all">جميع الحالات</option>
          <option value="reviewed">تمت المراجعة</option>
          <option value="pending">قيد المراجعة</option>
        </select>
      </div>
      <div class="spinner" id="examResultsLoadingSpinner"></div>
      <div id="examResultsList">
        <p style="text-align: center; color: #888;">لا توجد نتائج اختبارات لعرضها.</p>
      </div>
    </div>

  </div>
  <div id="toast" class="toast"></div>

  <div id="notificationPanel" class="notification-panel">
    <h5>الإشعارات</h5>
    <div id="notificationsList">
      <p style="text-align: center; color: #888;">لا توجد إشعارات حالياً.</p>
    </div>
  </div>

  <script src="firebase-config.js"></script>
  <script>
    // Firebase Config: تم حذف الكائن من هنا وسيتم جلبه من firebase-config.js

    // Global Firebase variables
    let auth, firestore;
    let currentTeacherEmail = "";
    let currentTeacherName = "";
    let currentTeacherUid = ""; // [NEW] To store teacher UID for notifications
    let allStudents = [];
    let allLessons = [];
    let allQuestions = [];
    let allSummaries = []; // Cache for summaries
    let allExamResults = []; // Cache for exam results
    let summariesListenerUnsubscribe = null; // Listener for summaries
    let examResultsListenerUnsubscribe = null; // Listener for exam results
    let notificationsListenerUnsubscribe = null; // [NEW] Listener for notifications

    // Firebase Init
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    auth = firebase.auth();
    firestore = firebase.firestore();

    // Utility Functions
    function showToast(msg, color = "#333") {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.style.background = color;
      toast.className = "toast show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2500);
    }

    function showLoading(spinnerId, show) {
      document.getElementById(spinnerId).style.display = show ? 'block' : 'none';
    }

    function sanitizeText(text) {
      const div = document.createElement("div");
      div.innerText = text;
      return div.innerHTML;
    }

    function toggleNightMode() {
      document.body.classList.toggle('dark-mode');
    }

    // Authentication and User Data
    auth.onAuthStateChanged(function(user) {
      if (user) {
        currentTeacherUid = user.uid; // [NEW] Save user UID
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists && doc.data().role === "teacher") {
            currentTeacherEmail = doc.data().email;
            currentTeacherName = doc.data().name || "المعلم";
            document.getElementById('teacherName').innerText = currentTeacherName;
            document.getElementById('teacherEmail').innerText = currentTeacherEmail;
            openTab(null, 'studentsTab'); // Default tab
            loadAllStudents();
            loadAllLessons();
            loadAllQuestions();
            loadAllSummariesRealtime(); // Load summaries with real-time listener
            loadAllExamResultsRealtime(); // Load exam results with real-time listener
            setupNotificationsListener(); // [NEW] Setup notifications listener
          } else {
            alert("غير مصرح لك بالوصول إلى هذه الصفحة.");
            logout();
          }
        }).catch(err => {
          showToast("خطأ في جلب بيانات المستخدم: " + err.message, "#e63946");
          console.error("Error fetching user role:", err);
          logout();
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function logout() {
      // Unsubscribe from all listeners before logging out
      if (summariesListenerUnsubscribe) summariesListenerUnsubscribe();
      if (examResultsListenerUnsubscribe) examResultsListenerUnsubscribe();
      if (notificationsListenerUnsubscribe) notificationsListenerUnsubscribe(); // [NEW] Unsubscribe notifications listener

      auth.signOut().then(() => {
        window.location.href = 'login.html';
      }).catch(error => {
        showToast("خطأ في تسجيل الخروج: " + error.message, "#e63946");
      });
    }

    // Tab Management
    function openTab(evt, tabName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tab-btn");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      if (evt) evt.currentTarget.className += " active";

      // Load data relevant to the tab
      if (tabName === 'examSettingsTab') {
        loadExamSetting();
      }
    }

    // [NEW] Notification functions (similar to student.html but for teacher)
    function toggleNotificationPanel() {
        const panel = document.getElementById('notificationPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            // Mark all currently displayed notifications as read when panel is opened
            const unreadItems = document.querySelectorAll('#notificationsList .notification-item.unread');
            unreadItems.forEach(item => {
                const notificationId = item.dataset.id;
                markNotificationAsRead(notificationId);
            });
        }
    }

    function setupNotificationsListener() {
        if (!currentTeacherUid) return;

        if (notificationsListenerUnsubscribe) {
            notificationsListenerUnsubscribe();
        }

        notificationsListenerUnsubscribe = firestore.collection('notifications')
            .where('userId', '==', currentTeacherUid)
            .orderBy('timestamp', 'desc')
            .onSnapshot(function(snapshot) {
                let notifications = [];
                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const notification = { ...doc.data(), id: doc.id };
                    notifications.push(notification);
                    if (!notification.isRead) {
                        unreadCount++;
                    }
                });
                renderNotifications(notifications, unreadCount);
            }, function(error) {
                console.error("Error listening to teacher notifications:", error);
                showToast("خطأ في تحميل إشعارات المعلم: " + error.message, "#e63946");
            });
    }

    function renderNotifications(notifications, unreadCount) {
        const notificationsListDiv = document.getElementById('notificationsList');
        const unreadBadge = document.getElementById('unreadNotificationsBadge');

        if (unreadCount > 0) {
            unreadBadge.innerText = unreadCount;
            unreadBadge.style.display = 'block';
        } else {
            unreadBadge.style.display = 'none';
        }

        if (notifications.length === 0) {
            notificationsListDiv.innerHTML = '<p style="text-align: center; color: #888;">لا توجد إشعارات حالياً.</p>';
            return;
        }

        let html = '';
        notifications.forEach(n => {
            const timestamp = n.timestamp ? new Date(n.timestamp.toDate()).toLocaleString('ar-EG') : '';
            html += `
                <div class="notification-item ${n.isRead ? '' : 'unread'}" data-id="${n.id}">
                    ${n.message}
                    <span class="timestamp">${timestamp}</span>
                    ${!n.isRead ? `<button class="mark-read-btn" onclick="markNotificationAsRead('${n.id}')">قراءة</button>` : ''}
                </div>
            `;
        });
        notificationsListDiv.innerHTML = html;
    }

    function markNotificationAsRead(notificationId) {
        firestore.collection('notifications').doc(notificationId).update({
            isRead: true
        }).catch(error => {
            console.error("Error marking teacher notification as read:", error);
            showToast("خطأ في تحديث حالة الإشعار: " + error.message, "#e63946");
        });
    }

    // [NEW] Function to send a notification to a specific user (student or teacher)
    async function sendNotificationToUser(userId, message) {
        try {
            await firestore.collection('notifications').add({
                userId: userId,
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                isRead: false
            });
            console.log("Notification sent to user:", userId);
        } catch (error) {
            console.error("Error sending notification:", error);
            showToast("خطأ في إرسال الإشعار: " + error.message, "#e63946");
        }
    }


    // Student Management
    function loadAllStudents() {
      showLoading('studentsLoadingSpinner', true);
      firestore.collection('lectures').get().then(snapshot => {
        allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderStudentsTable(allStudents);
        showLoading('studentsLoadingSpinner', false);
      }).catch(err => {
        showToast("خطأ في تحميل الطلاب: " + err.message, "#e63946");
        showLoading('studentsLoadingSpinner', false);
      });
    }

    function renderStudentsTable(students) {
      const tbody = document.querySelector('#studentsTable tbody');
      tbody.innerHTML = '';
      students.forEach(student => {
        const levels = [];
        for (let i = 1; i <= 7; i++) {
          if (student['level' + i]) levels.push(i);
        }
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${sanitizeText(student.email || '')}</td>
          <td>${sanitizeText(student.name || '')}</td>
          <td>${sanitizeText(student.course_number || '')}</td>
          <td>${levels.length > 0 ? levels.join(', ') : 'لا يوجد'}</td>
          <td>${sanitizeText(student.accepted || 'قيد المراجعة')}</td>
          <td class="actions">
            <button class="btn" onclick="editStudent('${student.id}')">تعديل</button>
            <button class="btn signout" onclick="confirmDeleteStudent('${student.id}', '${sanitizeText(student.name)}')">حذف</button>
          </td>
        `;
      });
    }

    function filterStudents() {
      const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
      const filtered = allStudents.filter(student =>
        (student.email && student.email.toLowerCase().includes(searchTerm)) ||
        (student.name && student.name.toLowerCase().includes(searchTerm))
      );
      renderStudentsTable(filtered);
    }

    function addOrUpdateStudent() {
      const email = document.getElementById('studentEmailInput').value.trim();
      const name = document.getElementById('studentNameInput').value.trim();
      const courseNumber = document.getElementById('courseNumberInput').value.trim();
      const acceptedStatus = document.getElementById('admissionStatusSelect').value;

      if (!email || !name) {
        showToast("البريد الإلكتروني والاسم مطلوبان.", "#e63946");
        return;
      }

      const studentData = {
        email: email,
        name: name,
        course_number: courseNumber,
        accepted: acceptedStatus === "" ? firebase.firestore.FieldValue.delete() : acceptedStatus
      };

      for (let i = 1; i <= 7; i++) {
        studentData['level' + i] = document.getElementById('level' + i).checked;
      }

      showLoading('studentsLoadingSpinner', true);
      firestore.collection('lectures').doc(email).set(studentData, { merge: true })
        .then(() => {
          showToast("تم حفظ بيانات الطالب بنجاح!", "#1dad87");
          loadAllStudents();
          clearStudentForm();
        })
        .catch(error => {
          showToast("خطأ في حفظ الطالب: " + error.message, "#e63946");
          showLoading('studentsLoadingSpinner', false);
        });
    }

    function loadStudentDataForEdit() {
      const email = document.getElementById('studentEmailInput').value.trim();
      if (!email) {
        showToast("أدخل إيميل الطالب لتحميل بياناته.", "#e63946");
        return;
      }
      showLoading('studentsLoadingSpinner', true);
      firestore.collection('lectures').doc(email).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('studentNameInput').value = data.name || '';
          document.getElementById('courseNumberInput').value = data.course_number || '';
          document.getElementById('admissionStatusSelect').value = data.accepted || '';
          for (let i = 1; i <= 7; i++) {
            document.getElementById('level' + i).checked = data['level' + i] || false;
          }
          showToast("تم تحميل بيانات الطالب.", "#1dad87");
        } else {
          showToast("لم يتم العثور على طالب بهذا الإيميل.", "#e63946");
          clearStudentForm();
        }
        showLoading('studentsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل بيانات الطالب: " + error.message, "#e63946");
        showLoading('studentsLoadingSpinner', false);
      });
    }

    function confirmDeleteStudent(email, name) {
      if (confirm(`هل أنت متأكد من حذف الطالب ${name} (${email})؟`)) {
        deleteStudent(email);
      }
    }

    function deleteStudent(emailToDelete = null) {
      const email = emailToDelete || document.getElementById('studentEmailInput').value.trim();
      if (!email) {
        showToast("أدخل إيميل الطالب لحذفه.", "#e63946");
        return;
      }
      showLoading('studentsLoadingSpinner', true);
      firestore.collection('lectures').doc(email).delete()
        .then(() => {
          showToast("تم حذف الطالب بنجاح!", "#1dad87");
          loadAllStudents();
          clearStudentForm();
        })
        .catch(error => {
          showToast("خطأ في حذف الطالب: " + error.message, "#e63946");
          showLoading('studentsLoadingSpinner', false);
        });
    }

    function clearStudentForm() {
      document.getElementById('studentEmailInput').value = '';
      document.getElementById('studentNameInput').value = '';
      document.getElementById('courseNumberInput').value = '';
      document.getElementById('admissionStatusSelect').value = '';
      for (let i = 1; i <= 7; i++) {
        document.getElementById('level' + i).checked = false;
      }
    }

    // Lesson Management
    function loadAllLessons() {
      showLoading('lessonsLoadingSpinner', true);
      firestore.collection('lessons').orderBy('id').get().then(snapshot => {
        allLessons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderLessonsTable(allLessons);
        showLoading('lessonsLoadingSpinner', false);
      }).catch(err => {
        showToast("خطأ في تحميل الدروس: " + err.message, "#e63946");
        showLoading('lessonsLoadingSpinner', false);
      });
    }

    function renderLessonsTable(lessons) {
      const tbody = document.querySelector('#lessonsTable tbody');
      tbody.innerHTML = '';
      lessons.forEach(lesson => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${lesson.id || ''}</td>
          <td>${sanitizeText(lesson.title || '')}</td>
          <td>${sanitizeText(lesson.level || '')}</td>
          <td>${lesson.url ? `<a href="${lesson.url}" target="_blank">رابط</a>` : 'لا يوجد'}</td>
          <td>${lesson.voice ? `<a href="${lesson.voice}" target="_blank">رابط</a>` : 'لا يوجد'}</td>
          <td class="actions">
            <button class="btn" onclick="editLesson('${lesson.id}')">تعديل</button>
            <button class="btn signout" onclick="confirmDeleteLesson('${lesson.id}', '${sanitizeText(lesson.title)}')">حذف</button>
          </td>
        `;
      });
    }

    function addOrUpdateLesson() {
      const id = parseInt(document.getElementById('lessonIdInput').value);
      const title = document.getElementById('lessonTitleInput').value.trim();
      const url = document.getElementById('lessonUrlInput').value.trim();
      const voice = document.getElementById('lessonVoiceInput').value.trim();
      const level = document.getElementById('lessonLevelSelect').value;

      if (isNaN(id) || !title || !level) {
        showToast("الرقم، العنوان، والمستوى مطلوبون.", "#e63946");
        return;
      }

      const lessonData = {
        id: id,
        title: title,
        url: url,
        voice: voice,
        level: level
      };

      showLoading('lessonsLoadingSpinner', true);
      firestore.collection('lessons').doc(String(id)).set(lessonData)
        .then(() => {
          showToast("تم حفظ الدرس بنجاح!", "#1dad87");
          loadAllLessons();
          clearLessonForm();
        })
        .catch(error => {
          showToast("خطأ في حفظ الدرس: " + error.message, "#e63946");
          showLoading('lessonsLoadingSpinner', false);
        });
    }

    function loadLessonDataForEdit() {
      const id = parseInt(document.getElementById('lessonIdInput').value);
      if (isNaN(id)) {
        showToast("أدخل رقم الدرس لتحميل بياناته.", "#e63946");
        return;
      }
      showLoading('lessonsLoadingSpinner', true);
      firestore.collection('lessons').doc(String(id)).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('lessonTitleInput').value = data.title || '';
          document.getElementById('lessonUrlInput').value = data.url || '';
          document.getElementById('lessonVoiceInput').value = data.voice || '';
          document.getElementById('lessonLevelSelect').value = data.level || '';
          showToast("تم تحميل بيانات الدرس.", "#1dad87");
        } else {
          showToast("لم يتم العثور على درس بهذا الرقم.", "#e63946");
          clearLessonForm();
        }
        showLoading('lessonsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل بيانات الدرس: " + error.message, "#e63946");
        showLoading('lessonsLoadingSpinner', false);
      });
    }

    function editLesson(id) {
      document.getElementById('lessonIdInput').value = id;
      loadLessonDataForEdit();
    }

    function confirmDeleteLesson(id, title) {
      if (confirm(`هل أنت متأكد من حذف الدرس "${title}" (رقم ${id})؟`)) {
        deleteLesson(id);
      }
    }

    function deleteLesson(idToDelete = null) {
      const id = idToDelete || parseInt(document.getElementById('lessonIdInput').value);
      if (isNaN(id)) {
        showToast("أدخل رقم الدرس لحذفه.", "#e63946");
        return;
      }
      showLoading('lessonsLoadingSpinner', true);
      firestore.collection('lessons').doc(String(id)).delete()
        .then(() => {
          showToast("تم حذف الدرس بنجاح!", "#1dad87");
          loadAllLessons();
          clearLessonForm();
        })
        .catch(error => {
          showToast("خطأ في حذف الدرس: " + error.message, "#e63946");
          showLoading('lessonsLoadingSpinner', false);
        });
    }

    function clearLessonForm() {
      document.getElementById('lessonIdInput').value = '';
      document.getElementById('lessonTitleInput').value = '';
      document.getElementById('lessonUrlInput').value = '';
      document.getElementById('lessonVoiceInput').value = '';
      document.getElementById('lessonLevelSelect').value = 'المستوى 1';
    }

    // Question Management
    function loadAllQuestions() {
      showLoading('questionsLoadingSpinner', true);
      firestore.collection('questions').orderBy('level').orderBy('id').get().then(snapshot => {
        allQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderQuestionsTable(allQuestions);
        showLoading('questionsLoadingSpinner', false);
      }).catch(err => {
        showToast("خطأ في تحميل الأسئلة: " + err.message, "#e63946");
        showLoading('questionsLoadingSpinner', false);
      });
    }

    function renderQuestionsTable(questions) {
      const tbody = document.querySelector('#questionsTable tbody');
      tbody.innerHTML = '';
      questions.forEach((q, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${sanitizeText(q.question || '')}</td>
          <td>المستوى ${q.level || ''}</td>
          <td>${q.mark || 1}</td>
          <td>${(q.choices || []).map(c => sanitizeText(c)).join('; ')}</td>
          <td>${(q.correct || []).map(idx => sanitizeText(q.choices[idx])).join('; ')}</td>
          <td class="actions">
            <button class="btn" onclick="editQuestion('${q.id}')">تعديل</button>
            <button class="btn signout" onclick="confirmDeleteQuestion('${q.id}')">حذف</button>
          </td>
        `;
      });
    }

    function addChoiceInput() {
      const container = document.getElementById('choicesContainer');
      const newIndex = container.children.length;
      const div = document.createElement('div');
      div.className = 'choice-row';
      div.style.marginBottom = '10px';
      div.innerHTML = `
        <input type="checkbox" class="correct-choice-checkbox">
        <input type="text" class="choice-text-input" placeholder="الخيار ${newIndex + 1}" style="width: calc(100% - 30px);">
      `;
      container.appendChild(div);
    }

    function addOrUpdateQuestion() {
      const questionText = document.getElementById('questionTextInput').value.trim();
      const level = parseInt(document.getElementById('questionLevelSelect').value);
      const mark = parseFloat(document.getElementById('questionMarkInput').value);
      const choiceInputs = document.querySelectorAll('.choice-text-input');
      const correctCheckboxes = document.querySelectorAll('.correct-choice-checkbox');

      let choices = [];
      let correct = [];
      choiceInputs.forEach((input, index) => {
        const choice = input.value.trim();
        if (choice) {
          choices.push(choice);
          if (correctCheckboxes[index].checked) {
            correct.push(index);
          }
        }
      });

      if (!questionText || choices.length < 2 || correct.length === 0 || isNaN(level) || isNaN(mark)) {
        showToast("الرجاء ملء جميع الحقول وإدخال خيارين على الأقل وتحديد إجابة صحيحة واحدة على الأقل.", "#e63946");
        return;
      }

      const questionData = {
        question: questionText,
        level: level,
        mark: mark,
        choices: choices,
        correct: correct
      };

      const questionId = document.getElementById('questionTextInput').dataset.editId; // Used for editing
      let promise;

      showLoading('questionsLoadingSpinner', true);
      if (questionId) {
        promise = firestore.collection('questions').doc(questionId).update(questionData);
      } else {
        promise = firestore.collection('questions').add(questionData);
      }

      promise.then(() => {
        showToast("تم حفظ السؤال بنجاح!", "#1dad87");
        loadAllQuestions();
        clearQuestionForm();
      }).catch(error => {
        showToast("خطأ في حفظ السؤال: " + error.message, "#e63946");
        showLoading('questionsLoadingSpinner', false);
      });
    }

    function loadQuestionDataForEdit() {
      const questionText = document.getElementById('questionTextInput').value.trim();
      if (!questionText) {
        showToast("أدخل جزءاً من نص السؤال لتحميل بياناته.", "#e63946");
        return;
      }
      showLoading('questionsLoadingSpinner', true);
      firestore.collection('questions').where('question', '>=', questionText).where('question', '<=', questionText + '\uf8ff').limit(1).get().then(snapshot => {
        if (!snapshot.empty) {
          const doc = snapshot.docs[0];
          const data = doc.data();
          document.getElementById('questionTextInput').value = data.question || '';
          document.getElementById('questionTextInput').dataset.editId = doc.id; // Store ID for update
          document.getElementById('questionLevelSelect').value = data.level || '1';
          document.getElementById('questionMarkInput').value = data.mark || '1';

          const choicesContainer = document.getElementById('choicesContainer');
          choicesContainer.innerHTML = ''; // Clear existing choices
          (data.choices || []).forEach((choice, index) => {
            const div = document.createElement('div');
            div.className = 'choice-row';
            div.style.marginBottom = '10px';
            div.innerHTML = `
              <input type="checkbox" class="correct-choice-checkbox" ${data.correct && data.correct.includes(index) ? 'checked' : ''}>
              <input type="text" class="choice-text-input" value="${sanitizeText(choice)}" style="width: calc(100% - 30px);">
            `;
            choicesContainer.appendChild(div);
          });
          showToast("تم تحميل بيانات السؤال.", "#1dad87");
        } else {
          showToast("لم يتم العثور على سؤال بهذا النص.", "#e63946");
          clearQuestionForm();
        }
        showLoading('questionsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل بيانات السؤال: " + error.message, "#e63946");
        showLoading('questionsLoadingSpinner', false);
      });
    }

    function editQuestion(id) {
      showLoading('questionsLoadingSpinner', true);
      firestore.collection('questions').doc(id).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('questionTextInput').value = data.question || '';
          document.getElementById('questionTextInput').dataset.editId = doc.id; // Store ID for update
          document.getElementById('questionLevelSelect').value = data.level || '1';
          document.getElementById('questionMarkInput').value = data.mark || '1';

          const choicesContainer = document.getElementById('choicesContainer');
          choicesContainer.innerHTML = ''; // Clear existing choices
          (data.choices || []).forEach((choice, index) => {
            const div = document.createElement('div');
            div.className = 'choice-row';
            div.style.marginBottom = '10px';
            div.innerHTML = `
              <input type="checkbox" class="correct-choice-checkbox" ${data.correct && data.correct.includes(index) ? 'checked' : ''}>
              <input type="text" class="choice-text-input" value="${sanitizeText(choice)}" style="width: calc(100% - 30px);">
            `;
            choicesContainer.appendChild(div);
          });
          showToast("تم تحميل بيانات السؤال.", "#1dad87");
        } else {
          showToast("لم يتم العثور على سؤال بهذا الرقم التعريفي.", "#e63946");
          clearQuestionForm();
        }
        showLoading('questionsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل بيانات السؤال: " + error.message, "#e63946");
        showLoading('questionsLoadingSpinner', false);
      });
    }

    function confirmDeleteQuestion(id) {
      if (confirm(`هل أنت متأكد من حذف السؤال؟`)) {
        deleteQuestion(id);
      }
    }

    function deleteQuestion(idToDelete = null) {
      const id = idToDelete || document.getElementById('questionTextInput').dataset.editId;
      if (!id) {
        showToast("الرجاء تحميل السؤال أولاً أو تحديد ID.", "#e63946");
        return;
      }
      showLoading('questionsLoadingSpinner', true);
      firestore.collection('questions').doc(id).delete()
        .then(() => {
          showToast("تم حذف السؤال بنجاح!", "#1dad87");
          loadAllQuestions();
          clearQuestionForm();
        })
        .catch(error => {
          showToast("خطأ في حذف السؤال: " + error.message, "#e63946");
          showLoading('questionsLoadingSpinner', false);
        });
    }

    function clearQuestionForm() {
      document.getElementById('questionTextInput').value = '';
      document.getElementById('questionTextInput').dataset.editId = '';
      document.getElementById('questionLevelSelect').value = '1';
      document.getElementById('questionMarkInput').value = '1';
      const choicesContainer = document.getElementById('choicesContainer');
      choicesContainer.innerHTML = `
        <div class="choice-row" style="margin-bottom:10px;">
          <input type="checkbox" class="correct-choice-checkbox">
          <input type="text" class="choice-text-input" placeholder="الخيار 1" style="width: calc(100% - 30px);">
        </div>
        <div class="choice-row" style="margin-bottom:10px;">
          <input type="checkbox" class="correct-choice-checkbox">
          <input type="text" class="choice-text-input" placeholder="الخيار 2" style="width: calc(100% - 30px);">
        </div>
      `;
    }

    // Exam Settings
    function loadExamSetting() {
      const level = document.getElementById('examSettingLevelSelect').value;
      showLoading('examSettingsLoadingSpinner', true);
      firestore.collection('exam_settings').doc('level_' + level).get().then(doc => {
        if (doc.exists) {
          document.getElementById('questionNumInput').value = doc.data().question_num || '';
          showToast("تم تحميل إعدادات الاختبار.", "#1dad87");
        } else {
          document.getElementById('questionNumInput').value = '';
          showToast("لا توجد إعدادات لهذا المستوى.", "#555");
        }
        showLoading('examSettingsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل إعدادات الاختبار: " + error.message, "#e63946");
        showLoading('examSettingsLoadingSpinner', false);
      });
    }

    function saveExamSetting() {
      const level = document.getElementById('examSettingLevelSelect').value;
      const questionNum = parseInt(document.getElementById('questionNumInput').value);

      if (isNaN(questionNum) || questionNum <= 0) {
        showToast("الرجاء إدخال عدد صحيح موجب للأسئلة.", "#e63946");
        return;
      }

      showLoading('examSettingsLoadingSpinner', true);
      firestore.collection('exam_settings').doc('level_' + level).set({
        question_num: questionNum
      }).then(() => {
        showToast("تم حفظ إعدادات الاختبار بنجاح!", "#1dad87");
        showLoading('examSettingsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في حفظ إعدادات الاختبار: " + error.message, "#e63946");
        showLoading('examSettingsLoadingSpinner', false);
      });
    }

    // Summaries Management (Real-time listener)
    function loadAllSummariesRealtime() {
      showLoading('summariesLoadingSpinner', true);
      if (summariesListenerUnsubscribe) {
        summariesListenerUnsubscribe(); // Unsubscribe from previous listener
      }

      summariesListenerUnsubscribe = firestore.collection('summaries')
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
          allSummaries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          filterSummaries(); // Re-render with current filters
          showLoading('summariesLoadingSpinner', false);
        }, err => {
          showToast("خطأ في تحميل التلاخيص في الوقت الحقيقي: " + err.message, "#e63946");
          showLoading('summariesLoadingSpinner', false);
          console.error("Summaries listener error:", err);
        });
    }

    function filterSummaries() {
      const searchTerm = document.getElementById('summariesSearchInput').value.toLowerCase();
      const statusFilter = document.getElementById('summariesFilterStatus').value;

      const filtered = allSummaries.filter(summary => {
        const matchesSearch = (summary.student_name && summary.student_name.toLowerCase().includes(searchTerm)) ||
                              (summary.student_email && summary.student_email.toLowerCase().includes(searchTerm)) ||
                              (summary.lesson_id && String(summary.lesson_id).includes(searchTerm)) ||
                              (summary.summary_text && summary.summary_text.toLowerCase().includes(searchTerm));
        const matchesStatus = statusFilter === 'all' || summary.status === statusFilter;
        return matchesSearch && matchesStatus;
      });
      renderSummariesList(filtered);
    }

    async function renderSummariesList(summaries) {
      const listDiv = document.getElementById('summariesList');
      listDiv.innerHTML = '';
      if (summaries.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #888;">لا توجد تلاخيص لعرضها.</p>';
        return;
      }

      for (const summary of summaries) {
        const lessonDoc = await firestore.collection('lessons').doc(String(summary.lesson_id)).get();
        const lessonTitle = lessonDoc.exists ? lessonDoc.data().title : `درس رقم ${summary.lesson_id}`;

        // Fetch student_mark if available
        let studentMark = null;
        let studentMarkDocId = null;
        if (summary.status === 'submitted') {
            const markSnapshot = await firestore.collection('student_marks')
                .where('summary_id', '==', summary.id)
                .limit(1)
                .get();
            if (!markSnapshot.empty) {
                studentMark = markSnapshot.docs[0].data().mark;
                studentMarkDocId = markSnapshot.docs[0].id;
            }
        }

        const timestamp = summary.timestamp ? new Date(summary.timestamp.toDate()).toLocaleString('ar-EG') : 'غير متوفر';
        const teacherComment = sanitizeText(summary.teacher_comment || '');
        const studentReplyComment = sanitizeText(summary.student_reply_comment || ''); // New: student reply

        listDiv.innerHTML += `
          <div class="summary-item">
            <h3>تلخيص الدرس: ${sanitizeText(lessonTitle)} <span class="status-badge ${summary.status}">${summary.status === 'submitted' ? 'تم التسليم النهائي' : 'مسودة'}</span></h3>
            <p class="student-info"><b>الطالب:</b> ${sanitizeText(summary.student_name || 'غير معروف')} (${sanitizeText(summary.student_email)})</p>
            <p class="lesson-info"><b>تاريخ التسليم:</b> ${timestamp}</p>
            <p><b>نص التلخيص:</b></p>
            <div class="summary-text-display">${sanitizeText(summary.summary_text || 'لا يوجد نص.')}</div>

            ${studentReplyComment ? `
              <div class="student-reply-display">
                  <strong>رد الطالب:</strong> ${studentReplyComment}
              </div>
            ` : ''}

            <div class="comment-section">
              <label for="teacherComment_${summary.id}">ملاحظة المعلم:</label>
              <textarea id="teacherComment_${summary.id}" placeholder="أضف ملاحظاتك هنا...">${teacherComment}</textarea>
              <div class="mark-input-group">
                  <label for="markInput_${summary.id}">العلامة:</label>
                  <input type="number" id="markInput_${summary.id}" value="${studentMark !== null ? studentMark : ''}" min="0" max="100" step="0.5" placeholder="أدخل العلامة">
                  ${studentMark !== null ? `<span class="current-mark"> (العلامة الحالية: ${studentMark})</span>` : ''}
              </div>
              <button class="btn submit" onclick="saveMarkAndComment('${summary.id}', '${summary.student_email}', '${summary.student_name}', '${lessonTitle}', '${studentMarkDocId}')">حفظ العلامة والملاحظة</button>
            </div>
          </div>
        `;
      }
    }

    // Save Mark and Comment (Modified to send notification)
    async function saveMarkAndComment(summaryId, studentEmail, studentName, lessonTitle, existingMarkDocId) {
      const commentText = document.getElementById(`teacherComment_${summaryId}`).value.trim();
      const markInput = document.getElementById(`markInput_${summaryId}`).value;
      const mark = markInput ? parseFloat(markInput) : null;

      if (commentText === "" && mark === null) {
        showToast("الرجاء إدخال ملاحظة أو علامة.", "#e63946");
        return;
      }

      showLoading('summariesLoadingSpinner', true);

      try {
        // 1. Update summary document with teacher comment
        await firestore.collection('summaries').doc(summaryId).update({
          teacher_comment: commentText
        });

        // 2. Save/Update student mark in 'student_marks' collection
        if (mark !== null) {
          const markData = {
            summary_id: summaryId,
            student_email: studentEmail,
            student_name: studentName,
            lesson_title: lessonTitle,
            mark: mark,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          if (existingMarkDocId && existingMarkDocId !== 'null') { // Check if it's a valid existing ID
            await firestore.collection('student_marks').doc(existingMarkDocId).update(markData);
          } else {
            // Find student's UID for notification
            const userDoc = await firestore.collection('users').where('email', '==', studentEmail).limit(1).get();
            let studentUid = null;
            if (!userDoc.empty) {
                studentUid = userDoc.docs[0].id; // Get the UID
            }
            
            const newMarkRef = firestore.collection('student_marks').doc();
            await newMarkRef.set(markData);
            // After creating a new mark, send a notification to the student
            if (studentUid) {
                await sendNotificationToUser(studentUid, `لقد تم تقييم تلخيصك لدرس "${lessonTitle}" وحصلت على علامة ${mark}.`);
            }
          }
        }
        
        // Find student's UID for notification (if comment was added/updated, or mark was updated)
        const userDoc = await firestore.collection('users').where('email', '==', studentEmail).limit(1).get();
        let studentUid = null;
        if (!userDoc.empty) {
            studentUid = userDoc.docs[0].id; // Get the UID
        }

        // Send notification for teacher comment/mark update (if studentUid is found)
        if (studentUid) {
            let notificationMessage = `قام المعلم بإضافة ملاحظة على تلخيصك لدرس "${lessonTitle}".`;
            if (mark !== null) {
                notificationMessage = `قام المعلم بتقييم تلخيصك لدرس "${lessonTitle}" بعلامة ${mark}.`;
            }
            await sendNotificationToUser(studentUid, notificationMessage);
        }

        showToast("تم حفظ العلامة والملاحظة بنجاح!", "#1dad87");
        // No need to reload all summaries, the real-time listener will update
      } catch (error) {
        showToast("خطأ في حفظ العلامة أو الملاحظة: " + error.message, "#e63946");
        console.error("Error saving mark and comment:", error);
      } finally {
        showLoading('summariesLoadingSpinner', false);
      }
    }


    // Exam Results Management (Real-time listener)
    function loadAllExamResultsRealtime() {
      showLoading('examResultsLoadingSpinner', true);
      if (examResultsListenerUnsubscribe) {
        examResultsListenerUnsubscribe(); // Unsubscribe from previous listener
      }

      examResultsListenerUnsubscribe = firestore.collection('exam_results')
        .orderBy('submitted_at', 'desc')
        .onSnapshot(snapshot => {
          allExamResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          filterExamResults(); // Re-render with current filters
          showLoading('examResultsLoadingSpinner', false);
        }, err => {
          showToast("خطأ في تحميل نتائج الاختبارات في الوقت الحقيقي: " + err.message, "#e63946");
          showLoading('examResultsLoadingSpinner', false);
          console.error("Exam results listener error:", err);
        });
    }

    function filterExamResults() {
      const searchTerm = document.getElementById('examResultsSearchInput').value.toLowerCase();
      const statusFilter = document.getElementById('examResultsFilterStatus').value;

      const filtered = allExamResults.filter(result => {
        const matchesSearch = (result.student_name && result.student_name.toLowerCase().includes(searchTerm)) ||
                              (result.student_email && result.student_email.toLowerCase().includes(searchTerm)) ||
                              (result.level && String(result.level).includes(searchTerm));
        const matchesStatus = statusFilter === 'all' ||
                              (statusFilter === 'reviewed' && result.teacher_reviewed === true) ||
                              (statusFilter === 'pending' && result.teacher_reviewed !== true);
        return matchesSearch && matchesStatus;
      });
      renderExamResultsList(filtered);
    }

    function renderExamResultsList(results) {
      const listDiv = document.getElementById('examResultsList');
      listDiv.innerHTML = '';
      if (results.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #888;">لا توجد نتائج اختبارات لعرضها.</p>';
        return;
      }

      results.forEach(result => {
        const submittedAt = result.submitted_at ? new Date(result.submitted_at.toDate()).toLocaleString('ar-EG') : 'غير متوفر';
        const isReviewed = result.teacher_reviewed === true;
        const approvedStatus = result.approved === true ? 'مُعتمد ✅' : (result.approved === false ? 'مرفوض ❌' : 'قيد المراجعة');
        const reviewBtnText = isReviewed ? 'تمت المراجعة' : 'مراجعة';
        const reviewBtnClass = isReviewed ? 'btn submit' : 'btn';

        let detailsHtml = '';
        if (result.details && result.details.length > 0) {
          detailsHtml = `<h4>تفاصيل الإجابات:</h4><ul>`;
          result.details.forEach((detail, index) => {
            const questionObj = allQuestions.find(q => q.id === detail.question_id);
            const questionText = questionObj ? sanitizeText(questionObj.question) : `سؤال رقم ${index + 1}`;
            const studentSelected = (detail.selected || []).map(idx => questionObj ? sanitizeText(questionObj.choices[idx]) : `خيار ${idx + 1}`).join(', ') || 'لم يجب';
            const correctAnswers = (detail.correct || []).map(idx => questionObj ? sanitizeText(questionObj.choices[idx]) : `خيار ${idx + 1}`).join(', ');
            detailsHtml += `<li><b>${questionText}</b><br>إجابة الطالب: ${studentSelected}<br>الإجابة الصحيحة: ${correctAnswers}</li>`;
          });
          detailsHtml += `</ul>`;
        }

        listDiv.innerHTML += `
          <div class="summary-item">
            <h3>نتيجة اختبار المستوى ${result.level}</h3>
            <p class="student-info"><b>الطالب:</b> ${sanitizeText(result.student_name || 'غير معروف')} (${sanitizeText(result.student_email)})</p>
            <p><b>الدرجة:</b> ${result.score} من ${result.total}</p>
            <p><b>تاريخ التسليم:</b> ${submittedAt}</p>
            <p><b>حالة المراجعة:</b> ${isReviewed ? 'تمت المراجعة ✅' : 'قيد المراجعة ⏳'}</p>
            <p><b>حالة الاعتماد:</b> ${approvedStatus}</p>

            ${detailsHtml}

            <div class="comment-section">
              <button class="${reviewBtnClass}" onclick="markExamReviewed('${result.id}', ${!isReviewed})">${reviewBtnText}</button>
              <button class="btn submit" onclick="approveExamResult('${result.id}', true)">اعتماد النتيجة</button>
              <button class="btn signout" onclick="approveExamResult('${result.id}', false)">رفض النتيجة</button>
            </div>
          </div>
        `;
      });
    }

    async function markExamReviewed(examResultId, reviewedStatus) {
      showLoading('examResultsLoadingSpinner', true);
      try {
        await firestore.collection('exam_results').doc(examResultId).update({
          teacher_reviewed: reviewedStatus
        });

        // Find student's UID for notification
        const examResultDoc = await firestore.collection('exam_results').doc(examResultId).get();
        const studentEmail = examResultDoc.data().student_email;
        const level = examResultDoc.data().level;
        const userDoc = await firestore.collection('users').where('email', '==', studentEmail).limit(1).get();
        let studentUid = null;
        if (!userDoc.empty) {
            studentUid = userDoc.docs[0].id;
        }

        if (studentUid) {
            const message = reviewedStatus ? `قام المعلم بمراجعة اختبارك للمستوى ${level}.` : `تم تغيير حالة مراجعة اختبارك للمستوى ${level}.`;
            await sendNotificationToUser(studentUid, message);
        }

        showToast("تم تحديث حالة المراجعة بنجاح!", "#1dad87");
      } catch (error) {
        showToast("خطأ في تحديث حالة المراجعة: " + error.message, "#e63946");
        console.error("Error marking exam reviewed:", error);
      } finally {
        showLoading('examResultsLoadingSpinner', false);
      }
    }

    async function approveExamResult(examResultId, approvedStatus) {
      showLoading('examResultsLoadingSpinner', true);
      try {
        await firestore.collection('exam_results').doc(examResultId).update({
          approved: approvedStatus,
          teacher_reviewed: true // Mark as reviewed if approved/rejected
        });

        // Find student's UID for notification
        const examResultDoc = await firestore.collection('exam_results').doc(examResultId).get();
        const studentEmail = examResultDoc.data().student_email;
        const level = examResultDoc.data().level;
        const userDoc = await firestore.collection('users').where('email', '==', studentEmail).limit(1).get();
        let studentUid = null;
        if (!userDoc.empty) {
            studentUid = userDoc.docs[0].id;
        }

        if (studentUid) {
            const message = approvedStatus ? `تم اعتماد نتيجة اختبارك للمستوى ${level}.` : `تم رفض نتيجة اختبارك للمستوى ${level}.`;
            await sendNotificationToUser(studentUid, message);
        }

        showToast("تم تحديث حالة الاعتماد بنجاح!", "#1dad87");
      } catch (error) {
        showToast("خطأ في تحديث حالة الاعتماد: " + error.message, "#e63946");
        console.error("Error approving exam result:", error);
      } finally {
        showLoading('examResultsLoadingSpinner', false);
      }
    }

  </script>
</body>
</html>
