<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المعلم - إدارة الطلاب والدروس</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
        font-family: Tajawal, Arial, sans-serif;
        margin: 0;
        background: #f5f7fa;
        color: #23272f;
        min-height: 100vh;
        padding-top: 70px; /* لتجنب اختباء المحتوى خلف شريط التنقل الثابت */
    }
    .main-nav {
      background: #3b5cb8;
      color: #fff;
      padding: 10px 30px;
      font-size: 1.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 100;
      box-sizing: border-box;
    }

    .main-nav .nav-brand {
        display: flex;
        align-items: center;
    }

    .main-nav .center-logo {
        height: 40px;
        vertical-align: middle;
        margin-right: 15px;
    }

    .main-nav .nav-links {
        display: flex;
        align-items: center;
        gap: 25px;
        flex-grow: 1;
        justify-content: center;
    }

    .main-nav .nav-link {
        color: #fff;
        text-decoration: none;
        padding: 8px 15px;
        font-size: 1.05rem;
        transition: background-color 0.3s, color 0.3s, border-radius 0.3s;
        border-radius: 5px;
        white-space: nowrap;
    }

    .main-nav .nav-link:hover,
    .main-nav .nav-link.active {
        background-color: #26407a;
        color: #fff;
    }

    .main-nav .nav-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }

    .container { max-width: 1100px; margin: 32px auto 24px auto; padding: 0 8px;}
    h2 { color: #294169; margin-top: 0; margin-bottom: 18px; font-size: 1.22rem; letter-spacing: 0.5px; font-weight: 700;}
    .btn {
      background: #3b5cb8;
      color: #fff;
      border: none;
      padding: 7px 20px;
      border-radius: 7px;
      font-size: 1rem;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s;
    }
    .btn:hover { background: #26407a; }
    .signout { background: #b83b3b;}
    .signout:hover { background: #7a2626;}
    .delete-btn {background: #dc3545;}
    .delete-btn:hover {background: #c82333;}
    .students-area, .lessons-area {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 4px #00000009;
      margin-bottom: 22px;
      padding: 18px 14px;
    }
    .add-section-toggle {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 7px;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: none;
    }
    .add-section-toggle .toggle-icon {
      background: #3b5cb8;
      color: #fff;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      margin-left: 8px;
      transition: background 0.2s;
    }
    .add-section-toggle .toggle-icon:hover { background: #26407a; }
    .add-section {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 4px #00000009;
      padding: 18px 14px;
      margin-bottom: 18px;
      max-width: 500px;
      margin-right: auto;
      margin-left: auto;
      display: none;
      animation: fadein 0.3s;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(-20px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .add-section h3 {
      color: #294169;
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 1.1rem;
      font-weight: bold;
      letter-spacing: 0.5px;
      text-align: center;
    }
    .add-section form { display: flex; flex-direction: column; gap: 14px;}
    .add-section label { font-size: 1rem; color: #2e4061; margin-bottom: 4px; margin-right: 2px; font-weight: 500;}
    .add-section input, .add-section select, .add-section textarea {
      padding: 9px;
      border: 1px solid #c5c9d2;
      border-radius: 6px;
      font-size: 1rem;
      background: #f7f8fa;
      color: #23272f;
      transition: border 0.15s;
      margin-bottom: 6px;
    }
    .add-section input:focus, .add-section select:focus, .add-section textarea:focus { border-color: #3b5cb8; outline: none;}
    .add-section .btn { margin-top: 8px; width: 100%; padding: 10px 0; font-size: 1.1rem; border-radius: 7px;}
    /* تحسينات عامة على الجداول */
.table-wrapper {
    overflow-x: auto;
    width: 100%;
    margin-top: 20px;
    margin-bottom: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    background: #ffffff;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
}

/* ترويسة الجدول */
th {
  background: #4361ee;
  color: #ffffff;
  padding: 15px 10px;
  text-align: center;
  font-size: 1.05rem;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  white-space: nowrap;
}

/* خلايا البيانات */
td {
  padding: 12px 8px;
  border-bottom: 1px solid #eef2fa;
  text-align: center;
  font-size: 0.98rem;
  color: #333d4b;
  vertical-align: middle;
  white-space: nowrap;
}

/* تأثير عند تمرير المؤشر على الصفوف */
tbody tr:hover {
  background-color: #f7f9fc;
  cursor: pointer;
}

/* إزالة الحد السفلي لآخر صف */
tbody tr:last-child td {
  border-bottom: none;
}

/* تحسينات خاصة بخلية نص التلخيص (لم تعد تستخدم بهذه الطريقة) */
.summary-text-cell {
  text-align: right;
  line-height: 1.6;
  white-space: normal;
  max-width: 250px;
  word-break: break-word;
}

/* أزرار الإجراءات داخل الجدول (التي قد تنتقل للصندوق المخفي) */
.btn[onclick^="saveSummaryMark"], .btn[onclick^="saveSummaryComment"] {
  background-color: #1dad87;
  color: #fff;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out;
}
.btn[onclick^="saveSummaryMark"]:hover, .btn[onclick^="saveSummaryComment"]:hover {
  background-color: #159b79;
}

/* حقل إدخال العلامة والتعليق (داخل الصندوق المخفي الآن) */
.summary-detail-input {
  padding: 5px 8px;
  border: 1px solid #c5c9d2;
  border-radius: 5px;
  font-size: 0.95rem;
  text-align: right;
  width: 90%;
  margin-bottom: 5px;
}
.summary-detail-input.mark { width: 70px; text-align: center; margin-left: 5px;}

/* تحسينات لحالة التلخيص */
.summary-status {
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 0.85rem;
  font-weight: bold;
  display: inline-block;
  white-space: nowrap;
}
.summary-status.submitted {
  background-color: #e3f6ed;
  color: #219e4b;
  border: 1px solid #b7eecd;
}
.summary-status.draft {
  background-color: #fff4e0;
  color: #b96d0d;
  border: 1px solid #ffe0b2;
}

.btn.reset-summary {
    background: #dc3545;
    padding: 5px 10px;
    font-size: 0.85rem;
    margin-right: 5px;
    vertical-align: middle;
}
.btn.reset-summary:hover {
    background: #c82333;
}
.reset-icon {
    cursor: pointer;
    font-size: 1.2rem;
    color: #dc3545;
    vertical-align: middle;
    margin-right: 5px;
    transition: transform 0.2s ease-in-out;
}
.reset-icon:hover {
    transform: rotate(15deg);
}

/* تنسيق خاص بالعنوان "تلخيصات الطالب" */
#summariesTableWrapper h4 {
    color: #294169;
    margin-top: 30px;
    margin-bottom: 15px;
    font-size: 1.25rem;
    font-weight: 700;
    text-align: right;
    border-bottom: 2px solid #eef2fa;
    padding-bottom: 8px;
}
    .student-selection-area { margin-bottom: 20px;}
    #selectedStudentDetails {
      background: #f9fbfd;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e4e8;
      display: none;
    }
    #selectedStudentDetails h3 { color: #294169; margin-top: 0; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold; text-align: right;}
    #selectedStudentDetails p { margin-bottom: 8px; font-size: 1rem; color: #23272f; text-align: right;}
    #selectedStudentDetails p strong { color: #294169;}
    #selectedStudentDetails h4 { color: #294169; margin-top: 20px; margin-bottom: 10px; font-size: 1.05rem; font-weight: bold; text-align: right;}
    .levels-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;}
    .level-item { display: flex; align-items: center; background: #f2f5fc; padding: 8px 12px; border-radius: 6px; border: 1px solid #e5e7ea; cursor: pointer; user-select: none;}
    .level-item input[type="checkbox"] { margin-left: 8px; width: 20px; height: 20px; cursor: pointer;}
    .level-item label { font-size: 0.95rem; color: #294169; font-weight: 500; flex-grow: 1; cursor: pointer;}
    .level-color-1 { background: #e7f2fa !important; }
    .level-color-2 { background: #f8e7fa !important; }
    .level-color-3 { background: #e7faf0 !important; }
    .level-color-4 { background: #f9f6e7 !important; }
    .level-color-5 { background: #f3e7fa !important; }
    .level-color-6 { background: #e7faee !important; }
    .level-color-7 { background: #fae7e7 !important; }
    .edit-btn, .save-btn, .cancel-btn {
      padding: 4px 14px;
      border-radius: 5px;
      border: none;
      margin: 0 2px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.98rem;
      transition: background 0.2s;
    }
    .edit-btn {background:#5a7be4; color:#fff;}
    .edit-btn:hover {background:#294169;}
    .save-btn {background:#1dad87; color:#fff;}
    .save-btn:hover {background:#156c59;}
    .cancel-btn {background:#b83b3b; color:#fff;}
    .cancel-btn:hover {background:#7a2626;}
    #msg, #addStudentMsg, #addLessonMsg, #addLessonMsg, #editLessonMsg { color: #b83b3b; margin-top: 10px; font-size: 1.05rem; min-height: 20px; text-align: center;}
    @media (max-width: 900px){
      .container {padding:8px;}
      h2 {font-size:1rem;}
      .students-area, .lessons-area, .add-section {padding:10px 4px;}
      .add-section {max-width: 99vw;}
      .levels-grid { grid-template-columns: 1fr;}
    }
    .spinner { border: 4px solid #eee; border-top: 4px solid #3b5cb8; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 30px auto; display: none;}
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #3b5cb8; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; font-size: 1.05rem; opacity: 0; transition: opacity 0.5s, visibility 0.5s;}
    .toast.show { visibility: visible; opacity: 1; }
    .search-box {width: 80%;margin: 10px 0 18px 0;padding: 8px 12px;border:1px solid #c5c9d2;border-radius:6px;font-size:1rem;}

    /* New style for inline summary details box */
    .summary-details-box {
      background-color: #fefefe;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #e0e4e8;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      position: relative;
      text-align: right;
      box-sizing: border-box;
      display: none; /* Hidden by default */
      animation: fadein 0.3s; /* Reuse fadein animation */
    }
    .summary-details-box h4 {
      color: #2260af;
      margin-top:0;
      margin-bottom: 15px;
      font-size: 1.25rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .summary-details-box .summary-content-display {
      white-space: pre-wrap;
      font-family: 'Tajawal', sans-serif;
      font-size: 1.05rem;
      line-height: 1.8;
      color: #333;
      max-height: 40vh;
      overflow-y: auto;
      direction: rtl;
      word-break: break-word;
      padding: 10px 0;
      margin-bottom: 15px;
      border: 1px solid #eef2fa;
      background: #fdfdfd;
      padding: 10px;
      border-radius: 8px;
    }
    .summary-details-box .form-group {
        margin-bottom: 15px;
    }
    .summary-details-box .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #2e4061;
    }
    .summary-details-box .form-group textarea {
        width: 100%;
        height: 80px;
        resize: vertical;
        padding: 8px;
        border: 1px solid #c5c9d2;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    .summary-details-box .form-group .btn {
        margin-top: 10px;
        padding: 6px 18px;
        font-size: 0.95rem;
    }
    .summary-details-box .close-box-btn {
        background: #b83b3b;
        margin-top: 20px;
        padding: 8px 30px;
    }
    .summary-details-box .close-box-btn:hover {
        background: #7a2626;
    }
    /* Dark Mode for summary details box */
    .dark-mode .summary-details-box {
      background-color: #323946;
      border: 1px solid #4a576b;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .dark-mode .summary-details-box h4 {
      color: #8cafff;
      border-bottom: 1px solid #4a576b;
    }
    .dark-mode .summary-details-box .summary-content-display {
      background: #2b3547;
      border-color: #4a576b;
      color: #e0e0e0;
    }
    .dark-mode .summary-details-box .form-group label {
        color: #e0e0e0;
    }
    .dark-mode .summary-details-box .form-group textarea {
        background: #23272f;
        border-color: #4a576b;
        color: #e0e0e0;
    }
    .dark-mode .summary-details-box .summary-detail-input {
      background: #23272f;
      border-color: #4a576b;
      color: #e0e0e0;
    }
    .dark-mode .summary-details-box .summary-detail-input:focus {
        border-color: #8cafff;
    }

    /* Professional Navigation Bar Styles */
    .main-nav {
      background: #3b5cb8;
      color: #fff;
      padding: 10px 30px;
      font-size: 1.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 100;
      box-sizing: border-box;
    }

    .main-nav .nav-brand {
        display: flex;
        align-items: center;
    }

    .main-nav .center-logo {
        height: 40px;
        vertical-align: middle;
        margin-right: 15px;
    }

    .main-nav .nav-links {
        display: flex;
        align-items: center;
        gap: 25px;
        flex-grow: 1;
        justify-content: center;
    }

    .main-nav .nav-link {
        color: #fff;
        text-decoration: none;
        padding: 8px 15px;
        font-size: 1.05rem;
        transition: background-color 0.3s, color 0.3s, border-radius 0.3s;
        border-radius: 5px;
        white-space: nowrap;
    }

    .main-nav .nav-link:hover,
    .main-nav .nav-link.active {
        background-color: #26407a;
        border-radius: 7px;
    }

    .main-nav .nav-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }

    /* Dark Mode for Navigation Bar */
    .dark-mode .main-nav {
        background: #222f3e;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
    }
    .dark-mode .main-nav .nav-link:hover,
    .dark-mode .main-nav .nav-link.active {
        background-color: #1a2430;
    }

    /* Responsive adjustments for the main navigation */
    @media (max-width: 768px) {
        .main-nav {
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px 15px;
        }
        .main-nav .nav-brand,
        .main-nav .nav-links,
        .main-nav .nav-actions {
            flex-basis: 100%;
            justify-content: center;
            margin-bottom: 5px;
            gap: 10px;
        }
        .main-nav .nav-links {
            order: 2;
        }
        .main-nav .nav-brand {
            order: 1;
            margin-bottom: 10px;
        }
        .main-nav .nav-actions {
            order: 3;
            margin-bottom: 0;
        }
        .main-nav .nav-link {
            font-size: 0.95rem;
            padding: 6px 10px;
        }
        .main-nav .center-logo {
            height: 35px;
            margin-right: 0;
        }
        body {
            padding-top: 130px;
        }
    }

    @media (max-width: 480px) {
        .main-nav .nav-links {
            gap: 10px;
        }
        .main-nav .nav-link {
            font-size: 0.9rem;
            padding: 5px 8px;
        }
        body {
            padding-top: 120px;
        }
        /* Make summary-details-box responsive */
        .summary-details-box {
            width: 100%;
            margin: 10px auto;
            padding: 10px;
            border-radius: 0;
            box-shadow: none;
        }
    }

    /* Dark Mode for general elements */
    .dark-mode {
        background: #23272f;
        color: #e0e0e0;
    }
    .dark-mode .container,
    .dark-mode .students-area,
    .dark-mode .lessons-area,
    .dark-mode .add-section,
    .dark-mode #selectedStudentDetails,
    .dark-mode .table-wrapper {
        background: #323946;
        color: #e0e0e0;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }
    .dark-mode h2,
    .dark-mode h3,
    .dark-mode h4,
    .dark-mode #selectedStudentDetails p strong {
        color: #8cafff;
    }
    .dark-mode .btn {
        background: #4a576b;
        color: #fff;
    }
    .dark-mode .btn:hover {
        background: #5a6b7e;
    }
    .dark-mode .signout,
    .dark-mode .delete-btn {
        background: #a40b2b;
    }
    .dark-mode .signout:hover,
    .dark-mode .delete-btn:hover {
        background: #c02b41;
    }
    .dark-mode .add-section-toggle .toggle-icon {
        background: #4a576b;
    }
    .dark-mode .add-section-toggle .toggle-icon:hover {
        background: #5a6b7e;
    }
    .dark-mode input,
    .dark-mode select,
    .dark-mode textarea {
        background: #2b3547;
        border-color: #4a576b;
        color: #e0e0e0;
    }
    .dark-mode input:focus,
    .dark-mode select:focus,
    .dark-mode textarea:focus {
        border-color: #8cafff;
    }
    .dark-mode th {
        background: #2b3547;
        color: #fff;
    }
    .dark-mode td {
        border-bottom-color: #4a576b;
        color: #e0e0e0;
    }
    .dark-mode tbody tr:hover {
        background-color: #3a455a;
    }
    .dark-mode .summary-status.submitted {
        background-color: #1a6b3d;
        color: #e3f6ed;
        border-color: #159b79;
    }
    .dark-mode .summary-status.draft {
        background-color: #7a460b;
        color: #fff4e0;
        border-color: #b96d0d;
    }
    .dark-mode .toast {
        background-color: #222f3e;
        color: #fff;
    }
    .dark-mode .level-item {
        background: #2b3547 !important;
        border-color: #4a576b;
    }
    .dark-mode .level-item label {
        color: #e0e0e0;
    }
    .dark-mode .edit-btn { background:#4a576b; }
    .dark-mode .edit-btn:hover { background:#5a6b7e; }
    .dark-mode .save-btn { background:#1a6b3d; }
    .dark-mode .save-btn:hover { background:#159b79; }
    .dark-mode .cancel-btn { background:#a40b2b; }
    .dark-mode .cancel-btn:hover { background:#c02b41; }
  </style>
</head>
<body>
  <div style="background:#f2f2f7;color:#2e4061;padding:7px 0;text-align:center;font-size:0.97rem;">
  V20
</div>
  <nav class="main-nav">
    <div class="nav-brand">
      <img src="https://i.ibb.co/cSpS2NDk/logo-1.png" alt="شعار المركز" class="center-logo">
    </div>
    <div class="nav-links">
      <a href="dashboard.html" class="nav-link active">لوحة المعلم - إدارة الطلاب والدروس</a>
      <a href="questions-admin.html" class="nav-link">إدارة الأسئلة وإعدادات الامتحان</a>
    </div>
    <div class="nav-actions">
      
<span class="notification-bell" onclick="toggleNotificationPanel()">
          <i class="fas fa-bell"></i>
          <span id="unreadNotificationsBadge" class="notification-badge" style="display:none;">0</span>
      </span>

      <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
    </div>
  </nav>
  <div class="container">

    <div class="spinner" id="loadingSpinner"></div>
    <div id="toast" class="toast"></div>
    <div class="add-section-toggle" onclick="toggleSection('addStudentSection')">
      <span class="toggle-icon" id="addStudentToggleIcon">➕</span>
      <span style="font-weight:bold;">إضافة طالب جديد</span>
    </div>
    <div class="add-section" id="addStudentSection">
      <h3>إضافة طالب جديد</h3>
      <form id="addStudentForm" onsubmit="addStudent(event)">
        <label for="studentEmail">البريد الإلكتروني</label>
        <input type="email" id="studentEmail" placeholder="student@email.com" required>
        <label for="studentName">اسم الطالب</label>
        <input type="text" id="studentName" placeholder="اسم الطالب" required>
        <label for="courseNumber">رقم الدورة</label>
        <input type="text" id="courseNumber" placeholder="رقم الدورة" required>
        <button class="btn" type="submit">إضافة الطالب</button>
      </form>
      <div id="addStudentMsg"></div>
    </div>

    <div class="add-section-toggle" onclick="toggleSection('addLessonSection')">
      <span class="toggle-icon" id="addLessonToggleIcon">➕</span>
      <span style="font-weight:bold;">إضافة درس جديد</span>
    </div>
    <div class="add-section" id="addLessonSection">
      <h3>إضافة درس جديد</h3>
      <form id="addLessonForm" onsubmit="addLesson(event)">
        <label for="lessonId">رقم الدرس</label>
        <input type="number" id="lessonId" placeholder="مثال: 1" required min="1">
        <label for="lessonTitle">عنوان الدرس</label>
        <input type="text" id="lessonTitle" placeholder="عنوان الدرس" required>
        <label for="lessonUrl">رابط الدرس (للتنزيل)</label>
        <input type="text" id="lessonUrl" placeholder="رابط التحميل" required>
        <label for="lessonVoice">رابط الصوت (للاستماع)</label>
        <input type="text" id="lessonVoice" placeholder="رابط الصوت (mp3 أو غيره)">
        <label for="lessonLevel">المستوى</label>
        <input type="text" id="lessonLevel" placeholder='مثال: "الأول"' required>
        <button class="btn" type="submit">إضافة الدرس</button>
      </form>
      <div id="addLessonMsg"></div>
    </div>

    <div class="students-area">
      <h2>إدارة مستويات الطلاب </h2>
      <div id="msg"></div>
      <input type="text" class="search-box" id="studentSearch" placeholder="ابحث باسم الطالب أو بريده..." onkeyup="filterStudents()">

      <div class="student-selection-area">
        <label for="studentSelect" style="font-weight:bold; margin-bottom: 10px; display: block; text-align: right;">اختر الطالب:</label>
        <select id="studentSelect" onchange="showSelectedStudentDetails(this.value)" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #c5c9d2; font-size: 1rem; background: #f7f8fa; color: #23272f;">
          <option value="">-- اختر طالباً لعرض بياناته --</option>
        </select>
      </div>
      <div style="text-align:left;margin:10px 0;">
        <button class="btn" id="teacherPDFBtn" onclick="downloadStudentReport()" style="display:none;">تصدير نتائج الطالب PDF</button>
        <button class="btn delete-btn" id="deleteStudentBtn" onclick="confirmDeleteStudent()" style="display:none; margin-right:10px;">حذف الطالب</button>
      </div>

      <div id="selectedStudentDetails" style="background: #f9fbfd; padding: 15px; border-radius: 8px; border: 1px solid #e0e4e8; margin-top: 20px; display: none;">
        <h3>تفاصيل الطالب المحدد:</h3>
        <p><strong>الاسم:</strong> <span id="detailName"></span></p>
        <p><strong>البريد الإلكتروني:</strong> <span id="detailEmail"></span></p>
        <p><strong>رقم الدورة:</strong> <span id="detailCourseNumber"></span></p>

        <p>
            <strong>حالة القبول:</strong>
            <select id="detailAcceptedStatus" onchange="updateStudentAdmission(this.value)" style="padding: 5px 8px; border: 1px solid #c5c9d2; border-radius: 5px; font-size: 0.95rem; margin-right: 10px;">
                <option value="pending">قيد المراجعة</option>
                <option value="accepted">مقبول</option>
                <option value="rejected">مرفوض</option>
            </select>
        </p>
        <p style="margin-top: 15px;">
            <strong>ملاحظات المعلم:</strong>
            <textarea id="detailTeacherNotes" onblur="saveTeacherNotes()" style="width: 98%; height: 80px; padding: 8px; border: 1px solid #c5c9d2; border-radius: 6px; font-size: 1rem; resize: vertical; margin-top: 5px;"></textarea>
            <button class="btn" onclick="saveTeacherNotes()" style="padding: 5px 15px; font-size: 0.9rem; margin-top: 5px;">حفظ الملاحظات</button>
        </p>


        <h4>المستويات:</h4>
        <div id="detailLevels" class="levels-grid"></div>
        <h4 style="margin-top:20px;">امتحانات المستويات:</h4>
        <div id="examsTableWrapper"></div>
        <h4 style="margin-top:30px;">تلخيصات الطالب:</h4>
        <div style="margin-bottom: 15px; text-align: right;">
            <label for="summaryFilterStatus" style="font-weight:bold; margin-left: 10px;">تصفية حسب الحالة:</label>
            <select id="summaryFilterStatus" onchange="filterSummariesTable()" style="padding: 5px 8px; border-radius: 5px; border: 1px solid #c5c9d2;">
                <option value="all">الكل</option>
                <option value="submitted">تم التسليم</option>
                <option value="draft">مسودة</option>
            </select>
        </div>
        <div id="summariesTableWrapper"></div>

        <div id="summaryDetailsBox" class="summary-details-box">
            <h4 id="summaryDetailsTitle"></h4>
            <div class="form-group">
                <label>نص التلخيص:</label>
                <div id="summaryDetailsContent" class="summary-content-display"></div>
            </div>
            <div class="form-group">
                <label for="summaryDetailsComment">تعليق المعلم:</label>
                <textarea id="summaryDetailsComment" class="summary-detail-input" placeholder="اكتب تعليقك هنا..."></textarea>
                <button class="btn" id="saveSummaryDetailsCommentBtn">حفظ التعليق</button>
            </div>
            <div id="studentReplySection" class="form-group" style="display:none;">
                <label>رد الطالب:</label>
                <div id="summaryDetailsStudentReply" class="summary-content-display"></div>
                <button class="btn delete-btn" id="clearStudentReplyBtn">مسح رد الطالب</button>
            </div>
            <div class="form-group">
                <label for="summaryDetailsMark">تعديل العلامة:</label>
                <input type="number" id="summaryDetailsMark" class="summary-detail-input mark" min="0" max="100" placeholder="العلامة">
                <button class="btn" id="saveSummaryDetailsMarkBtn">حفظ العلامة</button>
            </div>
            <div style="text-align: center;">
                <button class="btn close-box-btn" onclick="hideSummaryDetails()">إغلاق</button>
            </div>
        </div>
      </div>
    </div>

    <div class="lessons-area">
      <h2 style="margin-top:0;">قائمة الدروس</h2>
      <div id="editLessonMsg"></div>
      <table class="lessons-table" id="lessonsTable">
        <thead>
          <tr>
            <th>رقم الدرس</th>
            <th>العنوان</th>
            <th>رابط الدرس</th>
            <th>الصوت</th>
            <th>المستوى</th>
            <th>تعديل</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


  <script src="firebase-config.js"></script>
  <script>
    // Firebase Config: تم حذف الكائن من هنا وسيتم جلبه من firebase-config.js
    
    // Global Firebase variables
    let auth, firestore;
    let currentTeacherEmail = "";
    let currentTeacherName = "";
    let currentTeacherUid = ""; // [NEW] To store teacher UID for notifications
    let allStudents = [];
    let allLessons = [];
    let allQuestions = [];
    let allSummaries = []; // Cache for summaries
    let allExamResults = []; // Cache for exam results
    let summariesListenerUnsubscribe = null; // Listener for summaries
    let examResultsListenerUnsubscribe = null; // Listener for exam results
    let notificationsListenerUnsubscribe = null; // [NEW] Listener for notifications
    let currentlyOpenSummaryDocId = null; // [NEW] To track if a summary details box is open


    // Utility Functions
    function showToast(msg, color = "#333") {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.style.background = color;
      toast.className = "toast show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2500);
    }

    function showLoading(spinnerId, show) {
      document.getElementById(spinnerId).style.display = show ? 'block' : 'none';
    }

    function sanitizeText(text) {
      const div = document.createElement("div");
      div.innerText = text;
      return div.innerHTML;
    }

    function toggleNightMode() {
      document.body.classList.toggle('dark-mode');
    }

    // Authentication and User Data
    auth.onAuthStateChanged(function(user) {
      if (user) {
        currentTeacherUid = user.uid; // [NEW] Save user UID
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists && doc.data().role === "teacher") {
            currentTeacherEmail = doc.data().email;
            currentTeacherName = doc.data().name || "المعلم";
            document.getElementById('teacherName').innerText = currentTeacherName;
            document.getElementById('teacherEmail').innerText = currentTeacherEmail;
            openTab(null, 'studentsTab'); // Default tab
            loadAllStudents();
            loadAllLessons();
            loadAllQuestions();
            loadAllSummariesRealtime(); // Load summaries with real-time listener
            loadAllExamResultsRealtime(); // Load exam results with real-time listener
            setupNotificationsListener(); // [NEW] Setup notifications listener
          } else {
            alert("غير مصرح لك بالوصول إلى هذه الصفحة.");
            logout();
          }
        }).catch(err => {
          showToast("خطأ في جلب بيانات المستخدم: " + err.message, "#e63946");
          console.error("Error fetching user role:", err);
          logout();
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function logout() {
      // Unsubscribe from all listeners before logging out
      if (summariesListenerUnsubscribe) summariesListenerUnsubscribe();
      if (examResultsListenerUnsubscribe) examResultsListenerUnsubscribe();
      if (notificationsListenerUnsubscribe) notificationsListenerUnsubscribe(); // [NEW] Unsubscribe notifications listener

      auth.signOut().then(() => {
        window.location.href = 'login.html';
      }).catch(error => {
        showToast("خطأ في تسجيل الخروج: " + error.message, "#e63946");
      });
    }

    // Tab Management
    function openTab(evt, tabName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tab-btn");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      if (evt) evt.currentTarget.className += " active";

      // Load data relevant to the tab
      if (tabName === 'examSettingsTab') {
        loadExamSetting();
      }
    }

    // [NEW] Notification functions (similar to student.html but for teacher)
    function toggleNotificationPanel() {
        const panel = document.getElementById('notificationPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            // Mark all currently displayed notifications as read when panel is opened
            const unreadItems = document.querySelectorAll('#notificationsList .notification-item.unread');
            unreadItems.forEach(item => {
                const notificationId = item.dataset.id;
                markNotificationAsRead(notificationId);
            });
        }
    }

    function setupNotificationsListener() {
        if (!currentTeacherUid) return;

        if (notificationsListenerUnsubscribe) {
            notificationsListenerUnsubscribe();
        }

        notificationsListenerUnsubscribe = firestore.collection('notifications')
            .where('userId', '==', currentTeacherUid)
            .orderBy('timestamp', 'desc')
            .onSnapshot(function(snapshot) {
                let notifications = [];
                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const notification = { ...doc.data(), id: doc.id };
                    notifications.push(notification);
                    if (!notification.isRead) {
                        unreadCount++;
                    }
                });
                renderNotifications(notifications, unreadCount);
            }, function(error) {
                console.error("Error listening to teacher notifications:", error);
                showToast("خطأ في تحميل إشعارات المعلم: " + error.message, "#e63946");
            });
    }

    function renderNotifications(notifications, unreadCount) {
        const notificationsListDiv = document.getElementById('notificationsList');
        const unreadBadge = document.getElementById('unreadNotificationsBadge');

        if (unreadCount > 0) {
            unreadBadge.innerText = unreadCount;
            unreadBadge.style.display = 'block';
        } else {
            unreadBadge.style.display = 'none';
        }

        if (notifications.length === 0) {
            notificationsListDiv.innerHTML = '<p style="text-align: center; color: #888;">لا توجد إشعارات حالياً.</p>';
            return;
        }

        let html = '';
        notifications.forEach(n => {
            const timestamp = n.timestamp ? new Date(n.timestamp.toDate()).toLocaleString('ar-EG') : '';
            html += `
                <div class="notification-item ${n.isRead ? '' : 'unread'}" data-id="${n.id}">
                    ${n.message}
                    <span class="timestamp">${timestamp}</span>
                    ${!n.isRead ? `<button class="mark-read-btn" onclick="markNotificationAsRead('${n.id}')">قراءة</button>` : ''}
                </div>
            `;
        });
        notificationsListDiv.innerHTML = html;
    }

    function markNotificationAsRead(notificationId) {
        firestore.collection('notifications').doc(notificationId).update({
            isRead: true
        }).catch(error => {
            console.error("Error marking teacher notification as read:", error);
            showToast("خطأ في تحديث حالة الإشعار: " + error.message, "#e63946");
        });
    }

    // [NEW] Function to send a notification to a specific user (student or teacher)
    async function sendNotificationToUser(userId, message) {
        try {
            await firestore.collection('notifications').add({
                userId: userId,
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                isRead: false
            });
            console.log("Notification sent to user:", userId);
        } catch (error) {
            console.error("Error sending notification:", error);
            showToast("خطأ في إرسال الإشعار: " + error.message, "#e63946");
        }
    }


    // Student Management
    function loadAllStudents() {
      showLoading('studentsLoadingSpinner', true);
      firestore.collection('lectures').get().then(snapshot => {
        allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderStudentsTable(allStudents);
        showLoading('studentsLoadingSpinner', false);
      }).catch(err => {
        showToast("خطأ في تحميل الطلاب: " + err.message, "#e63946");
        showLoading('studentsLoadingSpinner', false);
      });
    }

    function renderStudentsTable(students) {
      const tbody = document.querySelector('#studentsTable tbody');
      tbody.innerHTML = '';
      students.forEach(student => {
        const levels = [];
        for (let i = 1; i <= 7; i++) {
          if (student['level' + i]) levels.push(i);
        }
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${sanitizeText(student.email || '')}</td>
          <td>${sanitizeText(student.name || '')}</td>
          <td>${sanitizeText(student.course_number || '')}</td>
          <td>${levels.length > 0 ? levels.join(', ') : 'لا يوجد'}</td>
          <td>${sanitizeText(student.accepted || 'قيد المراجعة')}</td>
          <td class="actions">
            <button class="btn" onclick="editStudent('${student.id}')">تعديل</button>
            <button class="btn signout" onclick="confirmDeleteStudent('${student.id}', '${sanitizeText(student.name)}')">حذف</button>
          </td>
        `;
      });
    }

    function filterStudents() {
      const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
      const filtered = allStudents.filter(student =>
        (student.email && student.email.toLowerCase().includes(searchTerm)) ||
        (student.name && student.name.toLowerCase().includes(searchTerm))
      );
      renderStudentsTable(filtered);
    }

    function addOrUpdateStudent() {
      const email = document.getElementById('studentEmailInput').value.trim();
      const name = document.getElementById('studentNameInput').value.trim();
      const courseNumber = document.getElementById('courseNumberInput').value.trim();
      const acceptedStatus = document.getElementById('admissionStatusSelect').value;

      if (!email || !name) {
        showToast("البريد الإلكتروني والاسم مطلوبان.", "#e63946");
        return;
      }

      const studentData = {
        email: email,
        name: name,
        course_number: courseNumber,
        accepted: acceptedStatus === "" ? firebase.firestore.FieldValue.delete() : acceptedStatus
      };

      for (let i = 1; i => 7; i++) { // Corrected loop condition here (should be <=)
        studentData['level' + i] = document.getElementById('level' + i).checked;
      }

      showLoading('studentsLoadingSpinner', true);
      firestore.collection('lectures').doc(email).set(studentData, { merge: true })
        .then(() => {
          showToast("تم حفظ بيانات الطالب بنجاح!", "#1dad87");
          loadAllStudents();
          clearStudentForm();
        })
        .catch(error => {
          showToast("خطأ في حفظ الطالب: " + error.message, "#e63946");
          showLoading('studentsLoadingSpinner', false);
        });
    }

    function loadStudentDataForEdit() {
      const email = document.getElementById('studentEmailInput').value.trim();
      if (!email) {
        showToast("أدخل إيميل الطالب لتحميل بياناته.", "#e63946");
        return;
      }
      showLoading('studentsLoadingSpinner', true);
      firestore.collection('lectures').doc(email).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('studentNameInput').value = data.name || '';
          document.getElementById('courseNumberInput').value = data.course_number || '';
          document.getElementById('admissionStatusSelect').value = data.accepted || '';
          for (let i = 1; i <= 7; i++) {
            document.getElementById('level' + i).checked = data['level' + i] || false;
          }
          showToast("تم تحميل بيانات الطالب.", "#1dad87");
        } else {
          showToast("لم يتم العثور على طالب بهذا الإيميل.", "#e63946");
          clearStudentForm();
        }
        showLoading('studentsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل بيانات الطالب: " + error.message, "#e63946");
        showLoading('studentsLoadingSpinner', false);
      });
    }

    function editStudent(id) {
      document.getElementById('studentEmailInput').value = id;
      loadStudentDataForEdit();
    }

    function confirmDeleteStudent(email, name) {
      if (confirm(`هل أنت متأكد من حذف الطالب ${name} (${email})؟`)) {
        deleteStudent(email);
      }
    }

    function deleteStudent(emailToDelete = null) {
      const email = emailToDelete || document.getElementById('studentEmailInput').value.trim();
      if (!email) {
        showToast("أدخل إيميل الطالب لحذفه.", "#e63946");
        return;
      }
      showLoading('studentsLoadingSpinner', true);
      firestore.collection('lectures').doc(email).delete()
        .then(() => {
          showToast("تم حذف الطالب بنجاح!", "#1dad87");
          loadAllStudents();
          clearStudentForm();
        })
        .catch(error => {
          showToast("خطأ في حذف الطالب: " + error.message, "#e63946");
          showLoading('studentsLoadingSpinner', false);
        });
    }

    function clearStudentForm() {
      document.getElementById('studentEmailInput').value = '';
      document.getElementById('studentNameInput').value = '';
      document.getElementById('courseNumberInput').value = '';
      document.getElementById('admissionStatusSelect').value = '';
      for (let i = 1; i <= 7; i++) {
        document.getElementById('level' + i).checked = false;
      }
    }

    // Lesson Management
    function loadAllLessons() {
      showLoading('lessonsLoadingSpinner', true);
      firestore.collection('lessons').orderBy('id').get().then(snapshot => {
        allLessons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderLessonsTable(allLessons);
        showLoading('lessonsLoadingSpinner', false);
      }).catch(err => {
        showToast("خطأ في تحميل الدروس: " + err.message, "#e63946");
        showLoading('lessonsLoadingSpinner', false);
      });
    }

    function renderLessonsTable(lessons) {
      const tbody = document.querySelector('#lessonsTable tbody');
      tbody.innerHTML = '';
      lessons.forEach(lesson => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${lesson.id || ''}</td>
          <td>${sanitizeText(lesson.title || '')}</td>
          <td>${sanitizeText(lesson.level || '')}</td>
          <td>${lesson.url ? `<a href="${lesson.url}" target="_blank">رابط</a>` : 'لا يوجد'}</td>
          <td>${lesson.voice ? `<a href="${lesson.voice}" target="_blank">رابط</a>` : 'لا يوجد'}</td>
          <td class="actions">
            <button class="btn" onclick="editLesson('${lesson.id}')">تعديل</button>
            <button class="btn signout" onclick="confirmDeleteLesson('${lesson.id}', '${sanitizeText(lesson.title)}')">حذف</button>
          </td>
        `;
      });
    }

    function addOrUpdateLesson() {
      const id = parseInt(document.getElementById('lessonIdInput').value);
      const title = document.getElementById('lessonTitleInput').value.trim();
      const url = document.getElementById('lessonUrlInput').value.trim();
      const voice = document.getElementById('lessonVoiceInput').value.trim();
      const level = document.getElementById('lessonLevelSelect').value;

      if (isNaN(id) || !title || !level) {
        showToast("الرقم، العنوان، والمستوى مطلوبون.", "#e63946");
        return;
      }

      const lessonData = {
        id: id,
        title: title,
        url: url,
        voice: voice,
        level: level
      };

      showLoading('lessonsLoadingSpinner', true);
      firestore.collection('lessons').doc(String(id)).set(lessonData)
        .then(() => {
          showToast("تم حفظ الدرس بنجاح!", "#1dad87");
          loadAllLessons();
          clearLessonForm();
        })
        .catch(error => {
          showToast("خطأ في حفظ الدرس: " + error.message, "#e63946");
          showLoading('lessonsLoadingSpinner', false);
        });
    }

    function loadLessonDataForEdit() {
      const id = parseInt(document.getElementById('lessonIdInput').value);
      if (isNaN(id)) {
        showToast("أدخل رقم الدرس لتحميل بياناته.", "#e63946");
        return;
      }
      showLoading('lessonsLoadingSpinner', true);
      firestore.collection('lessons').doc(String(id)).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('lessonTitleInput').value = data.title || '';
          document.getElementById('lessonUrlInput').value = data.url || '';
          document.getElementById('lessonVoiceInput').value = data.voice || '';
          document.getElementById('lessonLevelSelect').value = data.level || '';
          showToast("تم تحميل بيانات الدرس.", "#1dad87");
        } else {
          showToast("لم يتم العثور على درس بهذا الرقم.", "#e63946");
          clearLessonForm();
        }
        showLoading('lessonsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل بيانات الدرس: " + error.message, "#e63946");
        showLoading('lessonsLoadingSpinner', false);
      });
    }

    function editLesson(id) {
      document.getElementById('lessonIdInput').value = id;
      loadLessonDataForEdit();
    }

    function confirmDeleteLesson(id, title) {
      if (confirm(`هل أنت متأكد من حذف الدرس "${title}" (رقم ${id})؟`)) {
        deleteLesson(id);
      }
    }

    function deleteLesson(idToDelete = null) {
      const id = idToDelete || parseInt(document.getElementById('lessonIdInput').value);
      if (isNaN(id)) {
        showToast("أدخل رقم الدرس لحذفه.", "#e63946");
        return;
      }
      showLoading('lessonsLoadingSpinner', true);
      firestore.collection('lessons').doc(String(id)).delete()
        .then(() => {
          showToast("تم حذف الدرس بنجاح!", "#1dad87");
          loadAllLessons();
          clearLessonForm();
        })
        .catch(error => {
          showToast("خطأ في حذف الدرس: " + error.message, "#e63946");
          showLoading('lessonsLoadingSpinner', false);
        });
    }

    function clearLessonForm() {
      document.getElementById('lessonIdInput').value = '';
      document.getElementById('lessonTitleInput').value = '';
      document.getElementById('lessonUrlInput').value = '';
      document.getElementById('lessonVoiceInput').value = '';
      document.getElementById('lessonLevelSelect').value = 'المستوى 1';
    }

    // Question Management
    function loadAllQuestions() {
      showLoading('questionsLoadingSpinner', true);
      firestore.collection('questions').orderBy('level').orderBy('id').get().then(snapshot => {
        allQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderQuestionsTable(allQuestions);
        showLoading('questionsLoadingSpinner', false);
      }).catch(err => {
        showToast("خطأ في تحميل الأسئلة: " + err.message, "#e63946");
        showLoading('questionsLoadingSpinner', false);
      });
    }

    function renderQuestionsTable(questions) {
      const tbody = document.querySelector('#questionsTable tbody');
      tbody.innerHTML = '';
      questions.forEach((q, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${sanitizeText(q.question || '')}</td>
          <td>المستوى ${q.level || ''}</td>
          <td>${q.mark || 1}</td>
          <td>${(q.choices || []).map(c => sanitizeText(c)).join('; ')}</td>
          <td>${(q.correct || []).map(idx => sanitizeText(q.choices[idx])).join('; ')}</td>
          <td class="actions">
            <button class="btn" onclick="editQuestion('${q.id}')">تعديل</button>
            <button class="btn signout" onclick="confirmDeleteQuestion('${q.id}')">حذف</button>
          </td>
        `;
      });
    }

    function addChoiceInput() {
      const container = document.getElementById('choicesContainer');
      const newIndex = container.children.length;
      const div = document.createElement('div');
      div.className = 'choice-row';
      div.style.marginBottom = '10px';
      div.innerHTML = `
        <input type="checkbox" class="correct-choice-checkbox">
        <input type="text" class="choice-text-input" placeholder="الخيار ${newIndex + 1}" style="width: calc(100% - 30px);">
      `;
      container.appendChild(div);
    }

    function addOrUpdateQuestion() {
      const questionText = document.getElementById('questionTextInput').value.trim();
      const level = parseInt(document.getElementById('questionLevelSelect').value);
      const mark = parseFloat(document.getElementById('questionMarkInput').value);
      const choiceInputs = document.querySelectorAll('.choice-text-input');
      const correctCheckboxes = document.querySelectorAll('.correct-choice-checkbox');

      let choices = [];
      let correct = [];
      choiceInputs.forEach((input, index) => {
        const choice = input.value.trim();
        if (choice) {
          choices.push(choice);
          if (correctCheckboxes[index].checked) {
            correct.push(index);
          }
        }
      });

      if (!questionText || choices.length < 2 || correct.length === 0 || isNaN(level) || isNaN(mark)) {
        showToast("الرجاء ملء جميع الحقول وإدخال خيارين على الأقل وتحديد إجابة صحيحة واحدة على الأقل.", "#e63946");
        return;
      }

      const questionData = {
        question: questionText,
        level: level,
        mark: mark,
        choices: choices,
        correct: correct
      };

      const questionId = document.getElementById('questionTextInput').dataset.editId; // Used for editing
      let promise;

      showLoading('questionsLoadingSpinner', true);
      if (questionId) {
        promise = firestore.collection('questions').doc(questionId).update(questionData);
      } else {
        promise = firestore.collection('questions').add(questionData);
      }

      promise.then(() => {
        showToast("تم حفظ السؤال بنجاح!", "#1dad87");
        loadAllQuestions();
        clearQuestionForm();
      }).catch(error => {
        showToast("خطأ في حفظ السؤال: " + error.message, "#e63946");
        showLoading('questionsLoadingSpinner', false);
      });
    }

    function loadQuestionDataForEdit() {
      const questionText = document.getElementById('questionTextInput').value.trim();
      if (!questionText) {
        showToast("أدخل جزءاً من نص السؤال لتحميل بياناته.", "#e63946");
        return;
      }
      showLoading('questionsLoadingSpinner', true);
      firestore.collection('questions').where('question', '>=', questionText).where('question', '<=', questionText + '\uf8ff').limit(1).get().then(snapshot => {
        if (!snapshot.empty) {
          const doc = snapshot.docs[0];
          const data = doc.data();
          document.getElementById('questionTextInput').value = data.question || '';
          document.getElementById('questionTextInput').dataset.editId = doc.id; // Store ID for update
          document.getElementById('questionLevelSelect').value = data.level || '1';
          document.getElementById('questionMarkInput').value = data.mark || '1';

          const choicesContainer = document.getElementById('choicesContainer');
          choicesContainer.innerHTML = ''; // Clear existing choices
          (data.choices || []).forEach((choice, index) => {
            const div = document.createElement('div');
            div.className = 'choice-row';
            div.style.marginBottom = '10px';
            div.innerHTML = `
              <input type="checkbox" class="correct-choice-checkbox" ${data.correct && data.correct.includes(index) ? 'checked' : ''}>
              <input type="text" class="choice-text-input" value="${sanitizeText(choice)}" style="width: calc(100% - 30px);">
            `;
            choicesContainer.appendChild(div);
          });
          showToast("تم تحميل بيانات السؤال.", "#1dad87");
        } else {
          showToast("لم يتم العثور على سؤال بهذا النص.", "#e63946");
          clearQuestionForm();
        }
        showLoading('questionsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل بيانات السؤال: " + error.message, "#e63946");
        showLoading('questionsLoadingSpinner', false);
      });
    }

    function editQuestion(id) {
      showLoading('questionsLoadingSpinner', true);
      firestore.collection('questions').doc(id).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('questionTextInput').value = data.question || '';
          document.getElementById('questionTextInput').dataset.editId = doc.id; // Store ID for update
          document.getElementById('questionLevelSelect').value = data.level || '1';
          document.getElementById('questionMarkInput').value = data.mark || '1';

          const choicesContainer = document.getElementById('choicesContainer');
          choicesContainer.innerHTML = ''; // Clear existing choices
          (data.choices || []).forEach((choice, index) => {
            const div = document.createElement('div');
            div.className = 'choice-row';
            div.style.marginBottom = '10px';
            div.innerHTML = `
              <input type="checkbox" class="correct-choice-checkbox" ${data.correct && data.correct.includes(index) ? 'checked' : ''}>
              <input type="text" class="choice-text-input" value="${sanitizeText(choice)}" style="width: calc(100% - 30px);">
            `;
            choicesContainer.appendChild(div);
          });
          showToast("تم تحميل بيانات السؤال.", "#1dad87");
        } else {
          showToast("لم يتم العثور على سؤال بهذا الرقم التعريفي.", "#e63946");
          clearQuestionForm();
        }
        showLoading('questionsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل بيانات السؤال: " + error.message, "#e63946");
        showLoading('questionsLoadingSpinner', false);
      });
    }

    function confirmDeleteQuestion(id) {
      if (confirm(`هل أنت متأكد من حذف السؤال؟`)) {
        deleteQuestion(id);
      }
    }

    function deleteQuestion(idToDelete = null) {
      const id = idToDelete || document.getElementById('questionTextInput').dataset.editId;
      if (!id) {
        showToast("الرجاء تحميل السؤال أولاً أو تحديد ID.", "#e63946");
        return;
      }
      showLoading('questionsLoadingSpinner', true);
      firestore.collection('questions').doc(id).delete()
        .then(() => {
          showToast("تم حذف السؤال بنجاح!", "#1dad87");
          loadAllQuestions();
          clearQuestionForm();
        })
        .catch(error => {
          showToast("خطأ في حذف السؤال: " + error.message, "#e63946");
          showLoading('questionsLoadingSpinner', false);
        });
    }

    function clearQuestionForm() {
      document.getElementById('questionTextInput').value = '';
      document.getElementById('questionTextInput').dataset.editId = '';
      document.getElementById('questionLevelSelect').value = '1';
      document.getElementById('questionMarkInput').value = '1';
      const choicesContainer = document.getElementById('choicesContainer');
      choicesContainer.innerHTML = `
        <div class="choice-row" style="margin-bottom:10px;">
          <input type="checkbox" class="correct-choice-checkbox">
          <input type="text" class="choice-text-input" placeholder="الخيار 1" style="width: calc(100% - 30px);">
        </div>
        <div class="choice-row" style="margin-bottom:10px;">
          <input type="checkbox" class="correct-choice-checkbox">
          <input type="text" class="choice-text-input" placeholder="الخيار 2" style="width: calc(100% - 30px);">
        </div>
      `;
    }

    // Exam Settings
    function loadExamSetting() {
      const level = document.getElementById('examSettingLevelSelect').value;
      showLoading('examSettingsLoadingSpinner', true);
      firestore.collection('exam_settings').doc('level_' + level).get().then(doc => {
        if (doc.exists) {
          document.getElementById('questionNumInput').value = doc.data().question_num || '';
          showToast("تم تحميل إعدادات الاختبار.", "#1dad87");
        } else {
          document.getElementById('questionNumInput').value = '';
          showToast("لا توجد إعدادات لهذا المستوى.", "#555");
        }
        showLoading('examSettingsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في تحميل إعدادات الاختبار: " + error.message, "#e63946");
        showLoading('examSettingsLoadingSpinner', false);
      });
    }

    function saveExamSetting() {
      const level = document.getElementById('examSettingLevelSelect').value;
      const questionNum = parseInt(document.getElementById('questionNumInput').value);

      if (isNaN(questionNum) || questionNum <= 0) {
        showToast("الرجاء إدخال عدد صحيح موجب للأسئلة.", "#e63946");
        return;
      }

      showLoading('examSettingsLoadingSpinner', true);
      firestore.collection('exam_settings').doc('level_' + level).set({
        question_num: questionNum
      }).then(() => {
        showToast("تم حفظ إعدادات الاختبار بنجاح!", "#1dad87");
        showLoading('examSettingsLoadingSpinner', false);
      }).catch(error => {
        showToast("خطأ في حفظ إعدادات الاختبار: " + error.message, "#e63946");
        showLoading('examSettingsLoadingSpinner', false);
      });
    }

    // Summaries Management (Real-time listener)
    function loadAllSummariesRealtime() {
      showLoading('summariesLoadingSpinner', true);
      if (summariesListenerUnsubscribe) {
        summariesListenerUnsubscribe(); // Unsubscribe from previous listener
      }

      summariesListenerUnsubscribe = firestore.collection('summaries')
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
          allSummaries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          filterSummaries(); // Re-render with current filters
          showLoading('summariesLoadingSpinner', false);
        }, err => {
          showToast("خطأ في تحميل التلاخيص في الوقت الحقيقي: " + err.message, "#e63946");
          showLoading('summariesLoadingSpinner', false);
          console.error("Summaries listener error:", err);
        });
    }

    function filterSummaries() {
      const searchTerm = document.getElementById('summariesSearchInput').value.toLowerCase();
      const statusFilter = document.getElementById('summariesFilterStatus').value;

      const filtered = allSummaries.filter(summary => {
        const matchesSearch = (summary.student_name && summary.student_name.toLowerCase().includes(searchTerm)) ||
                              (summary.student_email && summary.student_email.toLowerCase().includes(searchTerm)) ||
                              (summary.lesson_id && String(summary.lesson_id).includes(searchTerm)) ||
                              (summary.summary_text && summary.summary_text.toLowerCase().includes(searchTerm));
        const matchesStatus = statusFilter === 'all' || summary.status === statusFilter;
        return matchesSearch && matchesStatus;
      });
      renderSummariesList(filtered);
    }

    async function renderSummariesList(summaries) {
      const listDiv = document.getElementById('summariesList');
      listDiv.innerHTML = '';
      if (summaries.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #888;">لا توجد تلاخيص لعرضها.</p>';
        return;
      }

      for (const summary of summaries) {
        const lessonDoc = await firestore.collection('lessons').doc(String(summary.lesson_id)).get();
        const lessonTitle = lessonDoc.exists ? lessonDoc.data().title : `درس رقم ${summary.lesson_id}`;

        // Fetch student_mark if available
        let studentMark = null;
        let studentMarkDocId = null;
        if (summary.status === 'submitted') {
            const markSnapshot = await firestore.collection('student_marks')
                .where('summary_id', '==', summary.id)
                .limit(1)
                .get();
            if (!markSnapshot.empty) {
                studentMark = markSnapshot.docs[0].data().mark;
                studentMarkDocId = markSnapshot.docs[0].id;
            }
        }

        const timestamp = summary.timestamp ? new Date(summary.timestamp.toDate()).toLocaleString('ar-EG') : 'غير متوفر';
        const teacherComment = sanitizeText(summary.teacher_comment || '');
        const studentReplyComment = sanitizeText(summary.student_reply_comment || ''); // New: student reply

        listDiv.innerHTML += `
          <div class="summary-item">
            <h3>تلخيص الدرس: ${sanitizeText(lessonTitle)} <span class="status-badge ${summary.status}">${summary.status === 'submitted' ? 'تم التسليم النهائي' : 'مسودة'}</span></h3>
            <p class="student-info"><b>الطالب:</b> ${sanitizeText(summary.student_name || 'غير معروف')} (${sanitizeText(summary.student_email)})</p>
            <p class="lesson-info"><b>تاريخ التسليم:</b> ${timestamp}</p>
            <p><b>نص التلخيص:</b></p>
            <div class="summary-text-display">${sanitizeText(summary.summary_text || 'لا يوجد نص.')}</div>

            ${studentReplyComment ? `
              <div class="student-reply-display">
                  <strong>رد الطالب:</strong> ${studentReplyComment}
              </div>
            ` : ''}

            <div class="comment-section">
              <label for="teacherComment_${summary.id}">ملاحظة المعلم:</label>
              <textarea id="teacherComment_${summary.id}" placeholder="أضف ملاحظاتك هنا...">${teacherComment}</textarea>
              <div class="mark-input-group">
                  <label for="markInput_${summary.id}">العلامة:</label>
                  <input type="number" id="markInput_${summary.id}" value="${studentMark !== null ? studentMark : ''}" min="0" max="100" step="0.5" placeholder="أدخل العلامة">
                  ${studentMark !== null ? `<span class="current-mark"> (العلامة الحالية: ${studentMark})</span>` : ''}
              </div>
              <button class="btn submit" onclick="saveMarkAndComment('${summary.id}', '${summary.student_email}', '${sanitizeText(summary.student_name)}', '${sanitizeText(lessonTitle)}', '${studentMarkDocId}')">حفظ العلامة والملاحظة</button>
            </div>
          </div>
        `;
      }
    }

    // Save Mark and Comment (Modified to send notification)
    async function saveMarkAndComment(summaryId, studentEmail, studentName, lessonTitle, existingMarkDocId) {
      const commentText = document.getElementById(`teacherComment_${summaryId}`).value.trim();
      const markInput = document.getElementById(`markInput_${summaryId}`).value;
      const mark = markInput ? parseFloat(markInput) : null;

      if (commentText === "" && mark === null) {
        showToast("الرجاء إدخال ملاحظة أو علامة.", "#e63946");
        return;
      }

      showLoading('summariesLoadingSpinner', true);

      try {
        // 1. Update summary document with teacher comment
        await firestore.collection('summaries').doc(summaryId).update({
          teacher_comment: commentText
        });

        // 2. Save/Update student mark in 'student_marks' collection
        if (mark !== null) {
          const markData = {
            summary_id: summaryId,
            student_email: studentEmail,
            student_name: studentName,
            lesson_title: lessonTitle,
            mark: mark,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          if (existingMarkDocId && existingMarkDocId !== 'null') { // Check if it's a valid existing ID
            await firestore.collection('student_marks').doc(existingMarkDocId).update(markData);
          } else {
            const newMarkRef = firestore.collection('student_marks').doc();
            await newMarkRef.set(markData);
          }
        }
        
        // Find student's UID for notification (for any update)
        const userDoc = await firestore.collection('users').where('email', '==', studentEmail).limit(1).get();
        let studentUid = null;
        if (!userDoc.empty) {
            studentUid = userDoc.docs[0].id;
        }

        // Send notification for teacher comment/mark update (if studentUid is found)
        if (studentUid) {
            let notificationMessage = '';
            if (commentText) {
                notificationMessage = `قام المعلم بإضافة ملاحظة على تلخيصك لدرس "${lessonTitle}".`;
            }
            if (mark !== null) {
                notificationMessage = `قام المعلم بتقييم تلخيصك لدرس "${lessonTitle}" وحصلت على علامة ${mark}.`;
            }
            if (commentText && mark !== null) { // If both comment and mark are updated
                 notificationMessage = `قام المعلم بتقييم تلخيصك لدرس "${lessonTitle}" (علامة ${mark}) وأضاف ملاحظة.`;
            }
            if (notificationMessage) {
                await sendNotificationToUser(studentUid, notificationMessage);
            }
        }

        showToast("تم حفظ العلامة والملاحظة بنجاح!", "#1dad87");
      } catch (error) {
        showToast("خطأ في حفظ العلامة أو الملاحظة: " + error.message, "#e63946");
        console.error("Error saving mark and comment:", error);
      } finally {
        showLoading('summariesLoadingSpinner', false);
      }
    }


    // Exam Results Management (Real-time listener)
    function loadAllExamResultsRealtime() {
      showLoading('examResultsLoadingSpinner', true);
      if (examResultsListenerUnsubscribe) {
        examResultsListenerUnsubscribe(); // Unsubscribe from previous listener
      }

      examResultsListenerUnsubscribe = firestore.collection('exam_results')
        .orderBy('submitted_at', 'desc')
        .onSnapshot(snapshot => {
          allExamResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          filterExamResults(); // Re-render with current filters
          showLoading('examResultsLoadingSpinner', false);
        }, err => {
          showToast("خطأ في تحميل نتائج الاختبارات في الوقت الحقيقي: " + err.message, "#e63946");
          showLoading('examResultsLoadingSpinner', false);
          console.error("Exam results listener error:", err);
        });
    }

    function filterExamResults() {
      const searchTerm = document.getElementById('examResultsSearchInput').value.toLowerCase();
      const statusFilter = document.getElementById('examResultsFilterStatus').value;

      const filtered = allExamResults.filter(result => {
        const matchesSearch = (result.student_name && result.student_name.toLowerCase().includes(searchTerm)) ||
                              (result.student_email && result.student_email.toLowerCase().includes(searchTerm)) ||
                              (result.level && String(result.level).includes(searchTerm));
        const matchesStatus = statusFilter === 'all' ||
                              (statusFilter === 'reviewed' && result.teacher_reviewed === true) ||
                              (statusFilter === 'pending' && result.teacher_reviewed !== true);
        return matchesSearch && matchesStatus;
      });
      renderExamResultsList(filtered);
    }

    function renderExamResultsList(results) {
      const listDiv = document.getElementById('examResultsList');
      listDiv.innerHTML = '';
      if (results.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #888;">لا توجد نتائج اختبارات لعرضها.</p>';
        return;
      }

      results.forEach(result => {
        const submittedAt = result.submitted_at ? new Date(result.submitted_at.toDate()).toLocaleString('ar-EG') : 'غير متوفر';
        const isReviewed = result.teacher_reviewed === true;
        const approvedStatus = result.approved === true ? 'مُعتمد ✅' : (result.approved === false ? 'مرفوض ❌' : 'قيد المراجعة');
        const reviewBtnText = isReviewed ? 'تمت المراجعة' : 'مراجعة';
        const reviewBtnClass = isReviewed ? 'btn submit' : 'btn';

        let detailsHtml = '';
        if (result.details && result.details.length > 0) {
          detailsHtml = `<h4>تفاصيل الإجابات:</h4><ul>`;
          result.details.forEach((detail, index) => {
            const questionObj = allQuestions.find(q => q.id === detail.question_id);
            const questionText = questionObj ? sanitizeText(questionObj.question) : `سؤال رقم ${index + 1}`;
            const studentSelected = (detail.selected || []).map(idx => questionObj ? sanitizeText(questionObj.choices[idx]) : `خيار ${idx + 1}`).join(', ') || 'لم يجب';
            const correctAnswers = (detail.correct || []).map(idx => questionObj ? sanitizeText(questionObj.choices[idx]) : `خيار ${idx + 1}`).join(', ');
            detailsHtml += `<li><b>${questionText}</b><br>إجابة الطالب: ${studentSelected}<br>الإجابة الصحيحة: ${correctAnswers}</li>`;
          });
          detailsHtml += `</ul>`;
        }

        listDiv.innerHTML += `
          <div class="summary-item">
            <h3>نتيجة اختبار المستوى ${result.level}</h3>
            <p class="student-info"><b>الطالب:</b> ${sanitizeText(result.student_name || 'غير معروف')} (${sanitizeText(result.student_email)})</p>
            <p><b>الدرجة:</b> ${result.score} من ${result.total}</p>
            <p><b>تاريخ التسليم:</b> ${submittedAt}</p>
            <p><b>حالة المراجعة:</b> ${isReviewed ? 'تمت المراجعة ✅' : 'قيد المراجعة ⏳'}</p>
            <p><b>حالة الاعتماد:</b> ${approvedStatus}</p>

            ${detailsHtml}

            <div class="comment-section">
              <button class="${reviewBtnClass}" onclick="markExamReviewed('${result.id}', ${!isReviewed})">${reviewBtnText}</button>
              <button class="btn submit" onclick="approveExamResult('${result.id}', true)">اعتماد النتيجة</button>
              <button class="btn signout" onclick="approveExamResult('${result.id}', false)">رفض النتيجة</button>
            </div>
          </div>
        `;
      });
    }

    async function markExamReviewed(examResultId, reviewedStatus) {
      showLoading('examResultsLoadingSpinner', true);
      try {
        await firestore.collection('exam_results').doc(examResultId).update({
          teacher_reviewed: reviewedStatus
        });

        // Find student's UID for notification
        const examResultDoc = await firestore.collection('exam_results').doc(examResultId).get();
        const studentEmail = examResultDoc.data().student_email;
        const level = examResultDoc.data().level;
        const userDoc = await firestore.collection('users').where('email', '==', studentEmail).limit(1).get();
        let studentUid = null;
        if (!userDoc.empty) {
            studentUid = userDoc.docs[0].id;
        }

        if (studentUid) {
            const message = reviewedStatus ? `قام المعلم بمراجعة اختبارك للمستوى ${level}.` : `تم تغيير حالة مراجعة اختبارك للمستوى ${level}.`;
            await sendNotificationToUser(studentUid, message);
        }

        showToast("تم تحديث حالة المراجعة بنجاح!", "#1dad87");
      } catch (error) {
        showToast("خطأ في تحديث حالة المراجعة: " + error.message, "#e63946");
        console.error("Error marking exam reviewed:", error);
      } finally {
        showLoading('examResultsLoadingSpinner', false);
      }
    }

    async function approveExamResult(examResultId, approvedStatus) {
      showLoading('examResultsLoadingSpinner', true);
      try {
        await firestore.collection('exam_results').doc(examResultId).update({
          approved: approvedStatus,
          teacher_reviewed: true // Mark as reviewed if approved/rejected
        });

        // Find student's UID for notification
        const examResultDoc = await firestore.collection('exam_results').doc(examResultId).get();
        const studentEmail = examResultDoc.data().student_email;
        const level = examResultDoc.data().level;
        const userDoc = await firestore.collection('users').where('email', '==', studentEmail).limit(1).get();
        let studentUid = null;
        if (!userDoc.empty) {
            studentUid = userDoc.docs[0].id;
        }

        if (studentUid) {
            const message = approvedStatus ? `تم اعتماد نتيجة اختبارك للمستوى ${level}.` : `تم رفض نتيجة اختبارك للمستوى ${level}.`;
            await sendNotificationToUser(studentUid, message);
        }

        showToast("تم تحديث حالة الاعتماد بنجاح!", "#1dad87");
      } catch (error) {
        showToast("خطأ في تحديث حالة الاعتماد: " + error.message, "#e63946");
        console.error("Error approving exam result:", error);
      } finally {
        showLoading('examResultsLoadingSpinner', false);
      }
    }

  </script>
</body>
</html>
