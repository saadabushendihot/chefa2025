<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المعلم - إدارة الطلاب والدروس</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Tajawal, Arial, sans-serif; margin: 0; background: #f5f7fa; color: #23272f; min-height: 100vh;}
    header {
      background: #3b5cb8;
      color: #fff;
      padding: 18px 30px;
      font-size: 1.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px #3b5cb820;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }
    .container { max-width: 1100px; margin: 32px auto 24px auto; padding: 0 8px;}
    h2 { color: #294169; margin-top: 0; margin-bottom: 18px; font-size: 1.22rem; letter-spacing: 0.5px; font-weight: 700;}
    .btn {
      background: #3b5cb8;
      color: #fff;
      border: none;
      padding: 7px 20px;
      border-radius: 7px;
      font-size: 1rem;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s;
    }
    .btn:hover { background: #26407a; }
    .signout { background: #b83b3b;}
    .signout:hover { background: #7a2626;}
    .students-area, .lessons-area {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 4px #00000009;
      margin-bottom: 22px;
      padding: 18px 14px;
    }
    .add-section-toggle {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 7px;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: none;
    }
    .add-section-toggle .toggle-icon {
      background: #3b5cb8;
      color: #fff;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      margin-left: 8px;
      transition: background 0.2s;
    }
    .add-section-toggle .toggle-icon:hover { background: #26407a; }
    .add-section {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 4px #00000009;
      padding: 18px 14px;
      margin-bottom: 18px;
      max-width: 500px;
      margin-right: auto;
      margin-left: auto;
      display: none;
      animation: fadein 0.3s;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(-20px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .add-section h3 {
      color: #294169;
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 1.1rem;
      font-weight: bold;
      letter-spacing: 0.5px;
      text-align: center;
    }
    .add-section form { display: flex; flex-direction: column; gap: 14px;}
    .add-section label { font-size: 1rem; color: #2e4061; margin-bottom: 4px; margin-right: 2px; font-weight: 500;}
    .add-section input, .add-section select {
      padding: 9px;
      border: 1px solid #c5c9d2;
      border-radius: 6px;
      font-size: 1rem;
      background: #f7f8fa;
      color: #23272f;
      transition: border 0.15s;
      margin-bottom: 6px;
    }
    .add-section input:focus, .add-section select:focus { border-color: #3b5cb8; outline: none;}
    .add-section .btn { margin-top: 8px; width: 100%; padding: 10px 0; font-size: 1.1rem; border-radius: 7px;}
    table { width: 100%; border-collapse: collapse; margin-top: 14px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px #00000008;}
    th, td { padding: 9px 6px; border-bottom: 1px solid #e5e7ea; text-align: center; font-size: 1rem; color: #23272f;}
    th { background: #f2f5fc; color: #294169; font-weight: bold;}
    tr:last-child td { border-bottom: none;}
    .student-selection-area { margin-bottom: 20px;}
    #selectedStudentDetails {background: #f9fbfd; padding: 15px; border-radius: 8px; border: 1px solid #e0e4e8; display: none;}
    #selectedStudentDetails h3 { color: #294169; margin-top: 0; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold; text-align: right;}
    #selectedStudentDetails p { margin-bottom: 8px; font-size: 1rem; color: #23272f; text-align: right;}
    #selectedStudentDetails p strong { color: #294169;}
    #selectedStudentDetails h4 { color: #294169; margin-top: 20px; margin-bottom: 10px; font-size: 1.05rem; font-weight: bold; text-align: right;}
    .levels-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;}
    .level-item { display: flex; align-items: center; background: #f2f5fc; padding: 8px 12px; border-radius: 6px; border: 1px solid #e5e7ea; cursor: pointer; user-select: none;}
    .level-item input[type="checkbox"] { margin-left: 8px; width: 20px; height: 20px; cursor: pointer;}
    .level-item label { font-size: 0.95rem; color: #294169; font-weight: 500; flex-grow: 1; cursor: pointer;}
    .level-color-1 { background: #e7f2fa !important; }
    .level-color-2 { background: #f8e7fa !important; }
    .level-color-3 { background: #e7faf0 !important; }
    .level-color-4 { background: #f9f6e7 !important; }
    .level-color-5 { background: #f3e7fa !important; }
    .level-color-6 { background: #e7faee !important; }
    .level-color-7 { background: #fae7e7 !important; }
    .edit-btn, .save-btn, .cancel-btn {
      padding: 4px 14px;
      border-radius: 5px;
      border: none;
      margin: 0 2px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.98rem;
      transition: background 0.2s;
    }
    .edit-btn {background:#5a7be4; color:#fff;}
    .edit-btn:hover {background:#294169;}
    .save-btn {background:#1dad87; color:#fff;}
    .save-btn:hover {background:#156c59;}
    .cancel-btn {background:#b83b3b; color:#fff;}
    .cancel-btn:hover {background:#7a2626;}
    #msg, #addStudentMsg, #addLessonMsg, #editLessonMsg { color: #b83b3b; margin-top: 10px; font-size: 1.05rem; min-height: 20px; text-align: center;}
    @media (max-width: 900px){
      .container {padding:8px;}
      th, td {font-size: 0.91rem;}
      h2 {font-size:1rem;}
      .students-area, .lessons-area, .add-section {padding:10px 4px;}
      header {font-size:1rem; padding:10px;}
      .add-section {max-width: 99vw;}
      .levels-grid { grid-template-columns: 1fr;}
    }
    .spinner { border: 4px solid #eee; border-top: 4px solid #3b5cb8; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 30px auto; display: none;}
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #3b5cb8; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; font-size: 1.05rem; opacity: 0; transition: opacity 0.5s, visibility 0.5s;}
    .toast.show { visibility: visible; opacity: 1; }
    .search-box {width: 80%;margin: 10px 0 18px 0;padding: 8px 12px;border:1px solid #c5c9d2;border-radius:6px;font-size:1rem;}
    /* صندوق التلخيص الجديد */
    #summaryDetailsBox {
      display:none;
      margin-top:18px;
    }
    #summaryDetailsBox .summary-details-inner {
      background:#fff;
      border:1px solid #e0e4e8;
      padding:22px 14px;
      border-radius:8px;
      box-shadow:0 2px 10px #3b5cb820;
      max-width:520px;
      margin:auto;
      position:relative;
      direction:rtl;
    }
    #summaryDetailsBox button.close-btn {
      position:absolute;
      top:10px;
      left:10px;
      background:#b83b3b;
      color:#fff;
      border:none;
      border-radius:4px;
      padding:3px 12px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <span>لوحة المعلم - إدارة الطلاب والدروس</span>
    <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">

    <!-- Spinner -->
    <div class="spinner" id="loadingSpinner"></div>
    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <div class="add-section-toggle" onclick="toggleSection('addStudentSection')">
      <span class="toggle-icon" id="addStudentToggleIcon">➕</span>
      <span style="font-weight:bold;">إضافة طالب جديد</span>
    </div>
    <div class="add-section" id="addStudentSection">
      <h3>إضافة طالب جديد</h3>
      <form id="addStudentForm" onsubmit="addStudent(event)">
        <label for="studentEmail">البريد الإلكتروني</label>
        <input type="email" id="studentEmail" placeholder="student@email.com" required>
        <label for="studentName">اسم الطالب</label>
        <input type="text" id="studentName" placeholder="اسم الطالب" required>
        <label for="courseNumber">رقم الدورة</label>
        <input type="text" id="courseNumber" placeholder="رقم الدورة" required>
        <button class="btn" type="submit">إضافة الطالب</button>
      </form>
      <div id="addStudentMsg"></div>
    </div>

    <div class="add-section-toggle" onclick="toggleSection('addLessonSection')">
      <span class="toggle-icon" id="addLessonToggleIcon">➕</span>
      <span style="font-weight:bold;">إضافة درس جديد</span>
    </div>
    <div class="add-section" id="addLessonSection">
      <h3>إضافة درس جديد</h3>
      <form id="addLessonForm" onsubmit="addLesson(event)">
        <label for="lessonId">رقم الدرس</label>
        <input type="number" id="lessonId" placeholder="مثال: 1" required min="1">
        <label for="lessonTitle">عنوان الدرس</label>
        <input type="text" id="lessonTitle" placeholder="عنوان الدرس" required>
        <label for="lessonUrl">رابط الدرس (للتنزيل)</label>
        <input type="text" id="lessonUrl" placeholder="رابط التحميل" required>
        <label for="lessonVoice">رابط الصوت (للاستماع)</label>
        <input type="text" id="lessonVoice" placeholder="رابط الصوت (mp3 أو غيره)">
        <label for="lessonLevel">المستوى</label>
        <input type="text" id="lessonLevel" placeholder='مثال: "الأول"' required>
        <button class="btn" type="submit">إضافة الدرس</button>
      </form>
      <div id="addLessonMsg"></div>
    </div>

    <div class="students-area">
      <h2> ******** إدارة مستويات الطلاب **********</h2>
      <div id="msg"></div>
      <input type="text" class="search-box" id="studentSearch" placeholder="ابحث باسم الطالب أو بريده..." onkeyup="filterStudents()">

      <div class="student-selection-area">
        <label for="studentSelect" style="font-weight:bold; margin-bottom: 10px; display: block; text-align: right;">اختر الطالب:</label>
        <select id="studentSelect" onchange="showSelectedStudentDetails(this.value)" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #c5c9d2; font-size: 1rem; background: #f7f8fa; color: #23272f;">
          <option value="">-- اختر طالباً لعرض بياناته --</option>
        </select>
      </div>
      <div style="text-align:left;margin:10px 0;">
        <button class="btn" id="teacherPDFBtn" onclick="downloadStudentReport()" style="display:none;">تصدير نتائج الطالب PDF</button>
      </div>

      <div id="selectedStudentDetails" style="background: #f9fbfd; padding: 15px; border-radius: 8px; border: 1px solid #e0e4e8; margin-top: 20px; display: none;">
        <h3>تفاصيل الطالب المحدد:</h3>
        <p><strong>الاسم:</strong> <span id="detailName"></span></p>
        <p><strong>البريد الإلكتروني:</strong> <span id="detailEmail"></span></p>
        <p><strong>رقم الدورة:</strong> <span id="detailCourseNumber"></span></p>
        <h4>المستويات:</h4>
        <div id="detailLevels" class="levels-grid"></div>
        <h4 style="margin-top:20px;">امتحانات المستويات:</h4>
        <div id="examsTableWrapper"></div>
        <h4 style="margin-top:30px;">تلخيصات الطالب:</h4>
        <div id="summariesTableWrapper"></div>
        <div id="summaryDetailsBox"></div>
      </div>
    </div>

    <div class="lessons-area">
      <h2 style="margin-top:0;">قائمة الدروس</h2>
      <div id="editLessonMsg"></div>
      <table class="lessons-table" id="lessonsTable">
        <thead>
          <tr>
            <th>رقم الدرس</th>
            <th>العنوان</th>
            <th>رابط الدرس</th>
            <th>الصوت</th>
            <th>المستوى</th>
            <th>تعديل</th>
          </tr>
        </thead>
        <tbody id="lessonsList"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Toast & Loading
    function showToast(msg, color="#3b5cb8") {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.style.background = color;
      toast.className = "toast show";
      setTimeout(()=>{ toast.className = toast.className.replace("show", ""); }, 2500);
    }
    function showLoading(show) {
      document.getElementById("loadingSpinner").style.display = show ? "block" : "none";
    }

    function filterStudents() {
      let val = document.getElementById('studentSearch').value.trim().toLowerCase();
      let studentSelect = document.getElementById('studentSelect');
      let options = studentSelect.querySelectorAll('option');
      options.forEach((opt,i)=>{
        if(i==0){ opt.style.display=""; return; }
        let txt = opt.textContent.toLowerCase();
        let email = allStudentsData[opt.value]?.email?.toLowerCase() || '';
        opt.style.display =
          (txt.includes(val)||email.includes(val)) ? "" : "none";
      });
    }

    function downloadStudentReport() {
      let el = document.getElementById('selectedStudentDetails');
      let studentName = document.getElementById('detailName').innerText || "student";
      let opt = {
        margin: 0.2,
        filename: `تقرير_${studentName}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(el).save();
    }

    function toggleSection(sectionId){
      var sec = document.getElementById(sectionId);
      var iconId = sectionId === 'addStudentSection' ? 'addStudentToggleIcon' : 'addLessonToggleIcon';
      var icon = document.getElementById(iconId);
      if (sec.style.display === "block") {
        sec.style.display = "none";
        icon.textContent = "➕";
      } else {
        sec.style.display = "block";
        icon.textContent = "✖";
      }
    }
    window.onload = function() {
      document.getElementById('addStudentSection').style.display = "none";
      document.getElementById('addLessonSection').style.display = "none";
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();

    var editLessonId = null;
    var allStudentsData = {};

    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (!doc.exists || doc.data().role !== "teacher") {
            window.location.href = "login.html";
          } else {
            loadStudents();
            loadLessons();
          }
        }).catch(function(error) {
          console.error("خطأ في جلب دور المستخدم:", error);
          window.location.href = "login.html";
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function addStudent(e) {
      e.preventDefault();
      var email = document.getElementById('studentEmail').value.trim().toLowerCase();
      var name = document.getElementById('studentName').value.trim();
      var courseNumber = document.getElementById('courseNumber').value.trim();
      var msg = document.getElementById('addStudentMsg');
      msg.innerText = '';
      msg.style.color = "#b83b3b";
      if (!validateEmail(email) || !name || !courseNumber) {
        msg.innerText = "يرجى تعبئة جميع الحقول بشكل صحيح.";
        return;
      }
      firestore.collection('lectures').where('email', '==', email).get().then(function(querySnapshot){
        if (!querySnapshot.empty) {
          msg.innerText = "هذا الطالب موجود بالفعل.";
        } else {
          let levelsObj = {};
          let examsObj = {};
          for (let i=1; i<=7; i++) {
            levelsObj["level"+i] = false;
            examsObj["exam"+i] = false;
          }
          firestore.collection('lectures').add({
            email: email,
            name: name,
            course_number: courseNumber,
            role: "student",
            diagnosis_exam: false,
            oral_exam: false,
            ...levelsObj,
            ...examsObj
          }).then(function(){
            msg.style.color = "#1dad87";
            msg.innerText = "تمت إضافة الطالب بنجاح!";
            document.getElementById('addStudentForm').reset();
            loadStudents();
          }).catch(function(err){
            msg.innerText = "حدث خطأ أثناء الإضافة: " + err.message;
          });
        }
      }).catch(function(error) {
        console.error("خطأ في التحقق من وجود الطالب:", error);
        msg.innerText = "حدث خطأ في التحقق من وجود الطالب.";
      });
    }

    function validateEmail(email) {
      var re = /\S+@\S+\.\S+/;
      return re.test(email);
    }

    function addLesson(e) {
      e.preventDefault();
      var id = Number(document.getElementById('lessonId').value.trim());
      var title = document.getElementById('lessonTitle').value.trim();
      var url = document.getElementById('lessonUrl').value.trim();
      var voice = document.getElementById('lessonVoice').value.trim();
      var level = document.getElementById('lessonLevel').value.trim();
      var msg = document.getElementById('addLessonMsg');
      msg.innerText = '';
      msg.style.color = "#b83b3b";
      if (!id || !title || !url || !level) {
        msg.innerText = "يرجى تعبئة جميع الحقول بشكل صحيح.";
        return;
      }
      firestore.collection('lessons').where('id', '==', id).get().then(function(querySnapshot){
        if (!querySnapshot.empty) {
          msg.innerText = "يوجد درس بنفس الرقم بالفعل.";
        } else {
          let lessonObj = {
            id: id,
            title: title,
            url: url,
            level: level
          };
          if (voice) lessonObj.voice = voice;
          firestore.collection('lessons').add(lessonObj).then(function(){
            msg.style.color = "#1dad87";
            msg.innerText = "تمت إضافة الدرس بنجاح!";
            document.getElementById('addLessonForm').reset();
            loadLessons();
          }).catch(function(err){
            msg.innerText = "حدث خطأ أثناء الإضافة: " + err.message;
          });
        }
      }).catch(function(error) {
        console.error("خطأ في التحقق من وجود الدرس:", error);
        msg.innerText = "حدث خطأ في التحقق من وجود الدرس.";
      });
    }

    function loadStudents() {
      showLoading(true);
      firestore.collection('lectures').where('role', '==', 'student').get().then(function(querySnapshot){
        let studentSelect = document.getElementById('studentSelect');
        studentSelect.innerHTML = '<option value="">-- اختر طالباً لعرض بياناته --</option>';
        allStudentsData = {};
        querySnapshot.forEach(function(doc){
          let data = doc.data();
          allStudentsData[doc.id] = data;
          let option = document.createElement('option');
          option.value = doc.id;
          option.textContent = data.name || 'غير معروف';
          studentSelect.appendChild(option);
        });
        showLoading(false);
        const currentSelectedStudentId = studentSelect.value;
        if (currentSelectedStudentId && allStudentsData[currentSelectedStudentId]) {
            showSelectedStudentDetails(currentSelectedStudentId);
        } else {
            document.getElementById('selectedStudentDetails').style.display = 'none';
        }
        if (querySnapshot.size === 1 && !currentSelectedStudentId) {
            studentSelect.value = querySnapshot.docs[0].id;
            showSelectedStudentDetails(querySnapshot.docs[0].id);
        }
      }).catch(function(error) {
        showLoading(false);
        showToast("خطأ في تحميل الطلاب", "#e63946");
        document.getElementById('msg').innerText = "خطأ في تحميل بيانات الطلاب.";
      });
    }

    window.showSelectedStudentDetails = function(studentId) {
      const studentDetailsDiv = document.getElementById('selectedStudentDetails');
      if (!studentId) {
        studentDetailsDiv.style.display = 'none';
        document.getElementById('teacherPDFBtn').style.display = "none";
        return;
      }
      const student = allStudentsData[studentId];
      if (student) {
        document.getElementById('detailName').textContent = student.name || 'غير معروف';
        document.getElementById('detailEmail').textContent = student.email || 'غير معروف';
        document.getElementById('detailCourseNumber').textContent = student.course_number || 'غير معروف';
        const detailLevelsDiv = document.getElementById('detailLevels');
        detailLevelsDiv.innerHTML = '';
        let exams = {};
        for (let i = 1; i <= 7; i++) {
          exams['exam' + i] = Boolean(student['exam' + i]);
        }
        for (let i = 1; i <= 7; i++) {
          const level = 'level' + i;
          const isChecked = student[level] ? 'checked' : '';
          let disabled = '';
          if (i > 1 && !exams['exam' + (i - 1)]) {
            disabled = 'disabled title="يجب اجتياز امتحان المستوى السابق أولاً"';
          }
          const levelItem = document.createElement('div');
          levelItem.className = `level-item level-color-${i}`;
          levelItem.innerHTML = `
            <input type="checkbox" class="level-checkbox" id="level-${studentId}-${i}" data-id="${studentId}" data-level="${level}" ${isChecked} ${disabled} onchange="updateLevel(this)">
            <label for="level-${studentId}-${i}">المستوى ${i}</label>
          `;
          detailLevelsDiv.appendChild(levelItem);
        }
        renderExamsTable(studentId, student);
        document.getElementById('teacherPDFBtn').style.display = "";
        loadStudentSummaries(student.email, student.name, studentId);
        studentDetailsDiv.style.display = 'block';
      } else {
        studentDetailsDiv.style.display = 'none';
        document.getElementById('teacherPDFBtn').style.display = "none";
        document.getElementById('msg').innerText = "لم يتم العثور على بيانات لهذا الطالب.";
        setTimeout(()=>{document.getElementById('msg').innerText='';}, 2000);
      }
    };

    function renderExamsTable(studentId, studentObj) {
      let html = `
        <table style="width:100%;margin-top:8px;">
          <thead>
            <tr>
              <th>المستوى</th>
              <th>حالة الامتحان</th>
              <th>تعديل</th>
            </tr>
          </thead>
          <tbody>
      `;
      for (let i = 1; i <= 7; i++) {
        let examField = 'exam' + i;
        let passed = Boolean(studentObj[examField]);
        html += `
          <tr>
            <td>المستوى ${i}</td>
            <td style="color:${passed ? '#1dad87' : '#b83b3b'};font-weight:bold;">
              ${passed ? "مجتاز" : "غير مجتاز"}
            </td>
            <td>
              <button class="btn" style="padding:4px 10px;font-size:0.95rem;${passed ? 'background:#b83b3b;' : 'background:#1dad87;'}"
                onclick="toggleExamStatus('${studentId}', 'exam${i}', ${passed})">
                ${passed ? "إلغاء اجتياز" : "تحديد كمجتاز"}
              </button>
            </td>
          </tr>
        `;
      }
      html += `</tbody></table>`;
      document.getElementById('examsTableWrapper').innerHTML = html;
    }

    window.toggleExamStatus = function(studentId, examField, currentValue) {
      let updateObj = {};
      updateObj[examField] = !currentValue;
      firestore.collection('lectures').doc(studentId).update(updateObj).then(function(){
        allStudentsData[studentId][examField] = !currentValue;
        showSelectedStudentDetails(studentId);
        document.getElementById('msg').style.color = '#1dad87';
        document.getElementById('msg').innerText = 'تم تحديث حالة الامتحان!';
        setTimeout(()=>{document.getElementById('msg').innerText='';}, 1200);
      }).catch(function(err){
        document.getElementById('msg').innerText = "حدث خطأ أثناء تحديث الامتحان: " + err.message;
      });
    };

    function getLevelNumFromText(levelText) {
      if (!levelText) return 0;
      const map = {
        "الأول": 1, "اول": 1, "1": 1,
        "الثاني": 2, "ثاني": 2, "2": 2,
        "الثالث": 3, "ثالث": 3, "3": 3,
        "الرابع": 4, "رابع": 4, "4": 4,
        "الخامس": 5, "خامس": 5, "5": 5,
        "السادس": 6, "سادس": 6, "6": 6,
        "السابع": 7, "سابع": 7, "7": 7,
      };
      let txt = levelText.trim().replace('المستوى', '').replace(/\s/g, '');
      return map[txt] || 0;
    }

    function loadLessons() {
      firestore.collection('lessons').orderBy('id').get().then(function(querySnapshot){
        let html = '';
        querySnapshot.forEach(function(doc){
          let data = doc.data();
          let levelNum = getLevelNumFromText(data.level);
          let rowClass = levelNum ? `level-color-${levelNum}` : '';
          if (editLessonId === doc.id) {
            html += `
              <tr class="${rowClass}">
                <td><input type="number" id="editId" value="${data.id}" style="width:70px;" required></td>
                <td><input type="text" id="editTitle" value="${data.title}" style="width:180px;" required></td>
                <td><input type="text" id="editUrl" value="${data.url}" style="width:180px;" required></td>
                <td>
                  <input type="text" id="editVoice" value="${data.voice ? data.voice : ''}" placeholder="رابط الصوت (اختياري)" style="width:180px;">
                </td>
                <td><input type="text" id="editLevel" value="${data.level}" style="width:90px;" required></td>
                <td>
                  <button class="save-btn" onclick="saveLesson('${doc.id}')">حفظ</button>
                  <button class="cancel-btn" onclick="cancelEditLesson()">إلغاء</button>
                </td>
              </tr>
            `;
          } else {
            html += `<tr class="${rowClass}">
                <td>${data.id || ''}</td>
                <td>${data.title || ''}</td>
                <td>
                  <a href="${data.url || ''}" target="_blank">تحميل</a>
                </td>
                <td>
                  ${data.voice ? `<audio controls style="width:120px;">
                    <source src="${data.voice}" type="audio/mpeg">
                    </audio>` : ''}
                </td>
                <td>${data.level || ''}</td>
                <td>
                  <button class="edit-btn" onclick="editLesson('${doc.id}')">تعديل</button>
                </td>
              </tr>`;
          }
        });
        document.getElementById('lessonsList').innerHTML = html || '<tr><td colspan="6">لا يوجد دروس بعد.</td></tr>';
      }).catch(function(error) {
        console.error("خطأ في جلب بيانات الدروس:", error);
        document.getElementById('editLessonMsg').innerText = "خطأ في تحميل بيانات الدروس.";
      });
    }

    window.editLesson = function(docId){
      editLessonId = docId;
      document.getElementById('editLessonMsg').innerText = '';
      loadLessons();
    }

    window.cancelEditLesson = function(){
      editLessonId = null;
      document.getElementById('editLessonMsg').innerText = '';
      loadLessons();
    }

    window.saveLesson = function(docId){
      var id = Number(document.getElementById('editId').value.trim());
      var title = document.getElementById('editTitle').value.trim();
      var url = document.getElementById('editUrl').value.trim();
      var voice = document.getElementById('editVoice').value.trim();
      var level = document.getElementById('editLevel').value.trim();
      var msg = document.getElementById('editLessonMsg');
      msg.innerText = '';
      msg.style.color = "#b83b3b";
      if (!id || !title || !url || !level) {
        msg.innerText = "يرجى تعبئة جميع الحقول بشكل صحيح.";
        return;
      }
      let lessonObj = {
        id: id,
        title: title,
        url: url,
        level: level
      };
      if (voice) lessonObj.voice = voice;
      else lessonObj.voice = firebase.firestore.FieldValue.delete();
      firestore.collection('lessons').doc(docId).update(lessonObj).then(function(){
        msg.style.color = "#1dad87";
        msg.innerText = "تم تحديث الدرس بنجاح!";
        editLessonId = null;
        loadLessons();
        setTimeout(()=>{msg.innerText='';}, 1500);
      }).catch(function(err){
        msg.innerText = "حدث خطأ أثناء التحديث: " + err.message;
      });
    }

    window.updateLevel = function(checkbox) {
      const docId = checkbox.getAttribute('data-id');
      const level = checkbox.getAttribute('data-level');
      const value = checkbox.checked;
      const levelNum = parseInt(level.replace('level',''));
      if (levelNum > 1) {
        const previousExam = allStudentsData[docId]['exam'+(levelNum-1)];
        if (!previousExam) {
          checkbox.checked = false;
          document.getElementById('msg').style.color = "#b83b3b";
          document.getElementById('msg').innerText = "لا يمكن تفعيل هذا المستوى قبل اجتياز امتحان المستوى السابق.";
          setTimeout(()=>{document.getElementById('msg').innerText='';}, 1500);
          return;
        }
      }
      firestore.collection('lectures').doc(docId).update({[level]: value}).then(function(){
        document.getElementById('msg').style.color = '#1dad87';
        document.getElementById('msg').innerText = 'تم تحديث المستوى بنجاح!';
        if (allStudentsData[docId]) {
            allStudentsData[docId][level] = value;
            showSelectedStudentDetails(docId);
        }
        setTimeout(()=>{document.getElementById('msg').innerText=''; document.getElementById('msg').style.color='#b83b3b';}, 1500);
      }).catch(function(err){
        document.getElementById('msg').innerText = "خطأ أثناء التحديث: " + err.message;
      });
    }

    // تلخيصات الطالب - عرض التلخيص في مربع ثابت
    function loadStudentSummaries(email, studentName, studentId) {
      showLoading(true);
      firestore.collection('summaries').where('student_email','==',email).get().then(snap=>{
        let summaries = [];
        snap.forEach(doc=>summaries.push({...doc.data(), docId: doc.id}));
        if (!summaries.length) {
          document.getElementById('summariesTableWrapper').innerHTML = "<b>لا توجد تلاخيص.</b>";
          showLoading(false);
          return;
        }
        firestore.collection('lessons').get().then(lessonsSnap=>{
          let lessonsMap = {};
          lessonsSnap.forEach(doc=>lessonsMap[doc.data().id]=doc.data().title);
          let html = `<table style="width:100%;margin-top:8px;">
            <thead><tr><th>الدرس</th><th>الحالة</th><th>العلامة</th><th>تعديل العلامة</th></tr></thead><tbody>`;
          summaries.forEach(s=>{
            let valMark = typeof s.mark !== "undefined" && s.mark !== null ? s.mark : "";
            html += `<tr>
              <td>
                <button class="btn" style="padding:3px 8px;font-size:0.98em;" onclick="openSummaryDetailsBox(
                  '${s.docId}',
                  '${lessonsMap[s.lesson_id]||s.lesson_id}',
                  '${s.student_name||studentName||""}',
                  '${s.student_email||email||""}',
                  '${s.status||""}',
                  '${s.timestamp||""}',
                  '${typeof s.mark!=="undefined"?s.mark:""}',
                  \`${(s.summary_text||"").replace(/`/g,"\\`")}\`
                )">${lessonsMap[s.lesson_id]||s.lesson_id}</button>
              </td>
              <td><span class="summary-status ${s.status}">${s.status==='submitted' ? 'تم التسليم' : 'مسودة'}</span></td>
              <td id="markval_${s.docId}">${valMark}</td>
              <td>
                <input style="width:60px;text-align:center;" id="markinp_${s.docId}" type="number" value="${valMark}" min="0" max="100">
                <button class="btn" style="padding:4px 12px;font-size:0.95rem;" onclick="saveSummaryMark('${s.docId}')">حفظ</button>
              </td>
            </tr>`;
          });
          html += "</tbody></table>";
          document.getElementById('summariesTableWrapper').innerHTML = html;
          // عند عرض أي تلخيص جديد، أخفِ مربع التفاصيل
          document.getElementById('summaryDetailsBox').style.display = "none";
          showLoading(false);
        });
      });
    }

    // صندوق عرض التلخيص
    function openSummaryDetailsBox(docId, lessonTitle, studentName, studentEmail, status, timestamp, mark, summaryText) {
      const box = document.getElementById('summaryDetailsBox');
      let html = `
        <div class="summary-details-inner">
          <button class="close-btn" onclick="closeSummaryDetailsBox()">إغلاق</button>
          <h3 style="margin-top:0;color:#294169;font-size:1.1rem;">تلخيص الدرس: ${lessonTitle}</h3>
          <div style="margin-bottom:7px;"><b>الطالب:</b> ${studentName}</div>
          <div style="margin-bottom:7px;"><b>البريد:</b> ${studentEmail}</div>
          <div style="margin-bottom:7px;"><b>الحالة:</b> ${status==='submitted' ? 'تم التسليم' : 'مسودة'}</div>
          <div style="margin-bottom:7px;"><b>التاريخ:</b> ${timestamp ? new Date(timestamp).toLocaleString('ar-EG') : ''}</div>
          <div style="margin:10px 0;">
            <label><b>التلخيص:</b></label>
            <textarea style="width:100%;min-height:100px;font-size:1.08em;border-radius:6px;padding:7px;background:#f7f8fa;color:#23272f;border:1px solid #c5c9d2;" readonly>${summaryText}</textarea>
          </div>
          <label>العلامة:</label>
          <input type="number" id="detailsBoxMarkInput" min="0" max="100" style="width:80px;text-align:center;" value="${typeof mark !== "undefined" && mark !== null ? mark : ""}">
          <button class="btn" onclick="saveDetailsBoxMark('${docId}')">اعتماد العلامة</button>
          <div id="detailsBoxMsg" style="margin-top:8px;font-size:0.98em;color:#e63946;"></div>
        </div>
      `;
      box.innerHTML = html;
      box.style.display = "block";
      box.setAttribute('data-docid', docId);
    }
    function closeSummaryDetailsBox() {
      const box = document.getElementById('summaryDetailsBox');
      box.style.display = 'none';
      box.innerHTML = '';
    }
    function saveDetailsBoxMark(docId) {
  let val = Number(document.getElementById('detailsBoxMarkInput').value);
  let saveData = { mark: val };
  let docPath = `summaries/${docId}`;
  console.log('[تلخيص] محاولة حفظ العلامة:', saveData, 'في:', docPath);

  if(isNaN(val)) {
    document.getElementById('detailsBoxMsg').innerText = 'أدخل رقمًا صحيحًا';
    document.getElementById('detailsBoxMsg').style.color = "#e63946";
    console.warn("[تلخيص] القيمة المدخلة غير رقمية");
    return;
  }
  firestore.collection('summaries').doc(docId).update(saveData).then(()=>{
    document.getElementById('detailsBoxMsg').style.color = "#1dad87";
    document.getElementById('detailsBoxMsg').innerText = 'تم حفظ العلامة.';
    document.getElementById('markval_' + docId).innerText = val;
    document.getElementById('markinp_' + docId).value = val;
    setTimeout(closeSummaryDetailsBox, 900);
    console.log('[تلخيص] تم الحفظ بنجاح!', saveData, 'في:', docPath);
  }).catch((e)=>{
    document.getElementById('detailsBoxMsg').style.color = "#e63946";
    document.getElementById('detailsBoxMsg').innerText = 'خطأ أثناء حفظ العلامة: ' + e.message;
    console.error('[تلخيص] خطأ أثناء الحفظ:', e, 'البيانات:', saveData, 'المسار:', docPath);
  });
}

    // حفظ علامة التلخيص من الجدول مباشرة
  function saveSummaryMark(docId) {
  let val = Number(document.getElementById('markinp_' + docId).value);
  let saveData = { mark: val };
  let docPath = `summaries/${docId}`;
  console.log('[تلخيص-جدول] محاولة حفظ العلامة:', saveData, 'في:', docPath);

  if(isNaN(val)) {
    showToast('أدخل رقمًا صحيحًا', "#e63946");
    console.warn('[تلخيص-جدول] القيمة المدخلة غير رقمية');
    return;
  }
  firestore.collection('summaries').doc(docId).update(saveData).then(()=>{
    document.getElementById('markval_' + docId).innerText = val;
    showToast('تم تحديث العلامة بنجاح', "#1dad87");
    console.log('[تلخيص-جدول] تم الحفظ بنجاح!', saveData, 'في:', docPath);
  }).catch((e)=>{
    showToast('خطأ أثناء تحديث العلامة: ' + e.message, "#e63946");
    console.error('[تلخيص-جدول] خطأ أثناء الحفظ:', e, 'البيانات:', saveData, 'المسار:', docPath);
  });
}

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';}).catch(function(error) {
        console.error("خطأ في تسجيل الخروج:", error);
      });
    }
    function showDebug(msg, data = null) {
    let box = document.getElementById('debugBox');
    let html = `<div style="margin-bottom:4px;"><strong>${msg}</strong>`;
    if (data !== null) {
        html += "<pre style='background:#eee;padding:5px;overflow-x:auto;'>" + JSON.stringify(data, null, 2) + "</pre>";
    }
    html += "</div>";
    box.innerHTML = html + box.innerHTML; // كل جديد في الأعلى
}
  </script>

  <div id="debugBox" style="background:#f7f7f7;border:1px solid #ccc;padding:10px;margin:10px;color:#555;direction:ltr;font-size:12px;max-width:600px;overflow-x:auto"></div>
  
</body>
</html>
