<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المعلم - إدارة الطلاب والدروس</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Tajawal, Arial, sans-serif; margin: 0; background: #f5f7fa; color: #23272f; min-height: 100vh; }
    header { background: #3b5cb8; color: #fff; padding: 18px 30px; font-size: 1.4rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px #3b5cb820; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; }
    .container { max-width: 1100px; margin: 32px auto 24px auto; padding: 0 8px; }
    h2 { color: #294169; margin-top: 0; margin-bottom: 18px; font-size: 1.22rem; letter-spacing: 0.5px; font-weight: 700; }
    .btn { background: #3b5cb8; color: #fff; border: none; padding: 7px 20px; border-radius: 7px; font-size: 1rem; cursor: pointer; font-family: inherit; transition: background 0.15s; }
    .btn:hover { background: #26407a; }
    .signout { background: #b83b3b; }
    .signout:hover { background: #7a2626; }
    .students-area, .lessons-area { background: #fff; border-radius: 10px; box-shadow: 0 1px 4px #00000009; margin-bottom: 22px; padding: 18px 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px #00000008; }
    th, td { padding: 9px 6px; border-bottom: 1px solid #e5e7ea; text-align: center; font-size: 1rem; color: #23272f; }
    th { background: #f2f5fc; color: #294169; font-weight: bold; }
    tr:last-child td { border-bottom: none; }
    .level-checkbox { width: 18px; height: 18px; }
    @media (max-width: 900px){ .container {padding:8px;} th, td {font-size: 0.91rem;} h2 {font-size:1rem;} .students-area, .lessons-area {padding:10px 4px;} header {font-size:1rem; padding:10px;} }
  </style>
</head>
<body>
  <header>
    <span>لوحة المعلم - إدارة الطلاب والدروس</span>
    <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">
    <div class="students-area">
      <h2>إدارة مستويات الطلاب</h2>
      <div id="msg"></div>
      <div>
        <label for="studentSelector"><strong>اختر طالبًا:</strong></label>
        <select id="studentSelector" onchange="displayStudentDetails()">
          <option value="">-- اختر --</option>
        </select>
      </div>
      <table style="margin-top:16px;">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>البريد</th>
            <th>الدورة</th>
            <th>المستوى 1</th>
            <th>المستوى 2</th>
            <th>المستوى 3</th>
            <th>المستوى 4</th>
            <th>المستوى 5</th>
            <th>المستوى 6</th>
            <th>المستوى 7</th>
          </tr>
        </thead>
        <tbody id="studentDetailRow"></tbody>
      </table>
    </div>
  </div>
  <script>
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (!doc.exists || doc.data().role !== "teacher") {
            window.location.href = "login.html";
          } else {
            loadStudents();
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });

    let studentsData = {};

    function loadStudents() {
      const selector = document.getElementById('studentSelector');
      selector.innerHTML = `<option value="">-- اختر --</option>`;
      studentsData = {};

      firestore.collection('lectures').where('role', '==', 'student').get().then(function(querySnapshot){
        querySnapshot.forEach(function(doc){
          const data = doc.data();
          studentsData[doc.id] = { id: doc.id, ...data };

          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = data.name || 'بدون اسم';
          selector.appendChild(option);
        });
      });
    }

    function displayStudentDetails() {
      const selectedId = document.getElementById('studentSelector').value;
      const student = studentsData[selectedId];
      const row = document.getElementById('studentDetailRow');

      if (!student) {
        row.innerHTML = '';
        return;
      }

      row.innerHTML = `
        <tr>
          <td>${student.name || ''}</td>
          <td>${student.email || ''}</td>
          <td>${student.course_number || ''}</td>
          ${[1,2,3,4,5,6,7].map(i => {
            const levelKey = "level" + i;
            return `<td>
              <input type="checkbox" class="level-checkbox" data-id="${student.id}" data-level="${levelKey}" ${student[levelKey] ? 'checked' : ''} onchange="updateLevel(this)">
            </td>`;
          }).join('')}
        </tr>
      `;
    }

    function updateLevel(checkbox) {
      const docId = checkbox.getAttribute('data-id');
      const level = checkbox.getAttribute('data-level');
      const value = checkbox.checked;

      firestore.collection('lectures').doc(docId).update({[level]: value}).then(function(){
        document.getElementById('msg').style.color = '#1dad87';
        document.getElementById('msg').innerText = 'تم تحديث المستوى بنجاح!';
        setTimeout(()=>{document.getElementById('msg').innerText='';}, 1500);
      }).catch(function(err){
        document.getElementById('msg').innerText = "خطأ أثناء التحديث: " + err.message;
      });
    }

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }
  </script>
</body>
</html>
