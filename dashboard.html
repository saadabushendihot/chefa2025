<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المعلم - إدارة الطلاب والدروس</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- تحميل إعدادات الفايربيز من ملف خارجي -->
  <script src="firebase-config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Tajawal, Arial, sans-serif;
      margin: 0;
      background: #f5f7fa;
      color: #23272f;
      min-height: 100vh;
    }
    header {
      background: #3b5cb8;
      color: #fff;
      padding: 18px 30px;
      font-size: 1.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px #3b5cb820;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }
    .container {
      max-width: 1100px;
      margin: 32px auto 24px auto;
      padding: 0 8px;
    }
    h2 {
      color: #294169;
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 1.22rem;
      letter-spacing: 0.5px;
      font-weight: 700;
    }
    .btn {
      background: #3b5cb8;
      color: #fff;
      border: none;
      padding: 7px 20px;
      border-radius: 7px;
      font-size: 1rem;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s;
    }
    .btn:hover { background: #26407a; }
    .signout { background: #b83b3b;}
    .signout:hover { background: #7a2626;}

    .add-student, .add-lesson, .students-area, .lessons-area {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 4px #00000009;
      margin-bottom: 22px;
      padding: 18px 14px;
    }
    .add-student, .add-lesson {
      display: flex; align-items: center; flex-wrap: wrap; gap: 14px;
    }
    .add-student form, .add-lesson form {
      display: flex; align-items: center; flex-wrap: wrap; gap: 10px;
    }
    .add-student label, .add-lesson label {margin-left: 10px;}
    .add-student input, .add-lesson input {
      padding: 7px; border: 1px solid #c5c9d2; border-radius: 5px; width: 170px; font-size: 1rem;
      background: #f7f8fa; color: #23272f;
      transition: border 0.15s;
    }
    .add-student input:focus, .add-lesson input:focus {
      border-color: #3b5cb8; outline: none;
    }

    /* مناطق الجداول */
    .students-area { margin-bottom: 28px; }
    .lessons-area { margin-bottom: 28px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px #00000008;
    }
    th, td {
      padding: 9px 6px;
      border-bottom: 1px solid #e5e7ea;
      text-align: center;
      font-size: 1rem;
      color: #23272f;
    }
    th { background: #f2f5fc; color: #294169; font-weight: bold;}
    tr:last-child td { border-bottom: none; }
    .level-checkbox { width: 18px; height: 18px; }

    /* ألوان صفوف الدروس حسب المستوى */
    .level-color-1 { background: #e7f2fa !important; }
    .level-color-2 { background: #f8e7fa !important; }
    .level-color-3 { background: #e7faf0 !important; }
    .level-color-4 { background: #f9f6e7 !important; }
    .level-color-5 { background: #f3e7fa !important; }
    .level-color-6 { background: #e7faee !important; }
    .level-color-7 { background: #fae7e7 !important; }
    /* أزرار التعديل */
    .edit-btn, .save-btn, .cancel-btn {
      padding: 4px 14px;
      border-radius: 5px;
      border: none;
      margin: 0 2px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.98rem;
      transition: background 0.2s;
    }
    .edit-btn {background:#5a7be4; color:#fff;}
    .edit-btn:hover {background:#294169;}
    .save-btn {background:#1dad87; color:#fff;}
    .save-btn:hover {background:#156c59;}
    .cancel-btn {background:#b83b3b; color:#fff;}
    .cancel-btn:hover {background:#7a2626;}
    /* رسائل */
    #msg, #addStudentMsg, #addLessonMsg, #editLessonMsg {
      color: #b83b3b; margin-top: 10px; font-size: 1.05rem; min-height: 20px;
    }
    /* استجابة للشاشات الصغيرة */
    @media (max-width: 900px){
      .container {padding:8px;}
      .add-student input, .add-lesson input {width:110px;}
      th, td {font-size: 0.91rem;}
      h2 {font-size:1rem;}
      .add-student, .add-lesson, .students-area, .lessons-area {padding:10px 4px;}
      header {font-size:1rem; padding:10px;}
    }
  </style>
</head>
<body>
  <header>
    <span>لوحة المعلم - إدارة الطلاب والدروس</span>
    <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">

    <!-- إضافة طالب جديد -->
    <div class="add-student">
      <form id="addStudentForm" onsubmit="addStudent(event)">
        <label>إضافة طالب جديد (البريد الإلكتروني):</label>
        <input type="email" id="studentEmail" placeholder="student@email.com" required>
        <input type="text" id="studentName" placeholder="اسم الطالب" required>
        <input type="text" id="courseNumber" placeholder="رقم الدورة" required>
        <button class="btn" type="submit">إضافة الطالب</button>
      </form>
      <div id="addStudentMsg"></div>
    </div>

    <!-- إضافة درس جديد -->
    <div class="add-lesson">
      <form id="addLessonForm" onsubmit="addLesson(event)">
        <label>إضافة درس جديد:</label>
        <input type="number" id="lessonId" placeholder="رقم الدرس" required min="1">
        <input type="text" id="lessonTitle" placeholder="عنوان الدرس" required>
        <input type="text" id="lessonUrl" placeholder="رابط الدرس" required>
        <input type="text" id="lessonLevel" placeholder='المستوى (مثلاً "الأول")' required>
        <button class="btn" type="submit">إضافة الدرس</button>
      </form>
      <div id="addLessonMsg"></div>
    </div>

    <div class="students-area">
      <h2>إدارة مستويات الطلاب</h2>
      <div id="msg"></div>
      <table id="studentsTable">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>البريد</th>
            <th>الدورة</th>
            <th>المستوى 1</th>
            <th>المستوى 2</th>
            <th>المستوى 3</th>
            <th>المستوى 4</th>
            <th>المستوى 5</th>
            <th>المستوى 6</th>
            <th>المستوى 7</th>
          </tr>
        </thead>
        <tbody id="studentsList"></tbody>
      </table>
    </div>

    <div class="lessons-area">
      <h2 style="margin-top:0;">قائمة الدروس</h2>
      <div id="editLessonMsg"></div>
      <table class="lessons-table" id="lessonsTable">
        <thead>
          <tr>
            <th>رقم الدرس</th>
            <th>العنوان</th>
            <th>الرابط</th>
            <th>المستوى</th>
            <th>تعديل</th>
          </tr>
        </thead>
        <tbody id="lessonsList"></tbody>
      </table>
    </div>
  </div>
  <script>
    // لا حاجة لتعريف firebaseConfig هنا، يتم تحميله من الملف الخارجي

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();

    var editLessonId = null; // لتتبع الدرس الجاري تعديله

    // حماية الصفحة: يسمح فقط للمعلم بالدخول
    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (!doc.exists || doc.data().role !== "teacher") {
            window.location.href = "login.html";
          } else {
            loadStudents();
            loadLessons();
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });

    // إضافة طالب جديد
    function addStudent(e) {
      e.preventDefault();
      var email = document.getElementById('studentEmail').value.trim().toLowerCase();
      var name = document.getElementById('studentName').value.trim();
      var courseNumber = document.getElementById('courseNumber').value.trim();
      var msg = document.getElementById('addStudentMsg');
      msg.innerText = '';
      msg.style.color = "#b83b3b";
      if (!validateEmail(email) || !name || !courseNumber) {
        msg.innerText = "يرجى تعبئة جميع الحقول بشكل صحيح.";
        return;
      }

      // تحقق هل الطالب موجود أصلاً في lectures
      firestore.collection('lectures').where('email', '==', email).get().then(function(querySnapshot){
        if (!querySnapshot.empty) {
          msg.innerText = "هذا الطالب موجود بالفعل.";
        } else {
          // إضافة الطالب في lectures
          let levelsObj = {};
          for (let i=1; i<=7; i++) levelsObj["level"+i] = false;
          firestore.collection('lectures').add({
            email: email,
            name: name,
            course_number: courseNumber,
            role: "student",
            diagnosis_exam: false,
            exam1: false,
            oral_exam: false,
            ...levelsObj
          }).then(function(){
            msg.style.color = "#1dad87";
            msg.innerText = "تمت إضافة الطالب بنجاح!";
            document.getElementById('addStudentForm').reset();
            loadStudents();
          }).catch(function(err){
            msg.innerText = "حدث خطأ أثناء الإضافة: " + err.message;
          });
        }
      });
    }

    // إضافة درس جديد
    function addLesson(e) {
      e.preventDefault();
      var id = Number(document.getElementById('lessonId').value.trim());
      var title = document.getElementById('lessonTitle').value.trim();
      var url = document.getElementById('lessonUrl').value.trim();
      var level = document.getElementById('lessonLevel').value.trim();
      var msg = document.getElementById('addLessonMsg');
      msg.innerText = '';
      msg.style.color = "#b83b3b";
      if (!id || !title || !url || !level) {
        msg.innerText = "يرجى تعبئة جميع الحقول بشكل صحيح.";
        return;
      }

      // تحقق هل الدرس برقم id موجود بالفعل
      firestore.collection('lessons').where('id', '==', id).get().then(function(querySnapshot){
        if (!querySnapshot.empty) {
          msg.innerText = "يوجد درس بنفس الرقم بالفعل.";
        } else {
          firestore.collection('lessons').add({
            id: id,
            title: title,
            url: url,
            level: level
          }).then(function(){
            msg.style.color = "#1dad87";
            msg.innerText = "تمت إضافة الدرس بنجاح!";
            document.getElementById('addLessonForm').reset();
            loadLessons();
          }).catch(function(err){
            msg.innerText = "حدث خطأ أثناء الإضافة: " + err.message;
          });
        }
      });
    }

    function validateEmail(email) {
      var re = /\S+@\S+\.\S+/;
      return re.test(email);
    }

    // جلب الطلاب من lectures
    function loadStudents() {
      firestore.collection('lectures').where('role', '==', 'student').get().then(function(querySnapshot){
        let html = '';
        querySnapshot.forEach(function(doc){
          let data = doc.data();
          html += `<tr>
              <td>${data.name || ''}</td>
              <td>${data.email || ''}</td>
              <td>${data.course_number || ''}</td>
              ${Array.from({length: 7}, (_, i) => {
                const level = 'level' + (i+1);
                return `<td>
                  <input type="checkbox" class="level-checkbox" data-id="${doc.id}" data-level="${level}" ${data[level] ? 'checked' : ''} onchange="updateLevel(this)">
                </td>`;
              }).join('')}
            </tr>`;
        });
        document.getElementById('studentsList').innerHTML = html || '<tr><td colspan="10">لا يوجد طلاب بعد.</td></tr>';
      });
    }

    // تحويل اسم المستوى إلى رقم
    function getLevelNumFromText(levelText) {
      if (!levelText) return 0;
      const map = {
        "الأول": 1, "اول": 1, "1": 1,
        "الثاني": 2, "ثاني": 2, "2": 2,
        "الثالث": 3, "ثالث": 3, "3": 3,
        "الرابع": 4, "رابع": 4, "4": 4,
        "الخامس": 5, "خامس": 5, "5": 5,
        "السادس": 6, "سادس": 6, "6": 6,
        "السابع": 7, "سابع": 7, "7": 7,
      };
      let txt = levelText.trim().replace('المستوى', '').replace(/\s/g, '');
      return map[txt] || 0;
    }

    // جلب الدروس مع ألوان المستويات
    function loadLessons() {
      firestore.collection('lessons').orderBy('id').get().then(function(querySnapshot){
        let html = '';
        querySnapshot.forEach(function(doc){
          let data = doc.data();
          let levelNum = getLevelNumFromText(data.level);
          let rowClass = levelNum ? `level-color-${levelNum}` : '';
          if (editLessonId === doc.id) {
            html += `
              <tr class="${rowClass}">
                <td><input type="number" id="editId" value="${data.id}" style="width:70px;" required></td>
                <td><input type="text" id="editTitle" value="${data.title}" style="width:180px;" required></td>
                <td><input type="text" id="editUrl" value="${data.url}" style="width:180px;" required></td>
                <td><input type="text" id="editLevel" value="${data.level}" style="width:90px;" required></td>
                <td>
                  <button class="save-btn" onclick="saveLesson('${doc.id}')">حفظ</button>
                  <button class="cancel-btn" onclick="cancelEditLesson()">إلغاء</button>
                </td>
              </tr>
            `;
          } else {
            html += `<tr class="${rowClass}">
                <td>${data.id || ''}</td>
                <td>${data.title || ''}</td>
                <td><a href="${data.url || ''}" target="_blank">رابط</a></td>
                <td>${data.level || ''}</td>
                <td>
                  <button class="edit-btn" onclick="editLesson('${doc.id}')">تعديل</button>
                </td>
              </tr>`;
          }
        });
        document.getElementById('lessonsList').innerHTML = html || '<tr><td colspan="5">لا يوجد دروس بعد.</td></tr>';
      });
    }

    // بدأ تعديل الدرس
    window.editLesson = function(docId){
      editLessonId = docId;
      document.getElementById('editLessonMsg').innerText = '';
      loadLessons();
    }

    // إلغاء التعديل
    window.cancelEditLesson = function(){
      editLessonId = null;
      document.getElementById('editLessonMsg').innerText = '';
      loadLessons();
    }

    // حفظ الدرس بعد التعديل
    window.saveLesson = function(docId){
      var id = Number(document.getElementById('editId').value.trim());
      var title = document.getElementById('editTitle').value.trim();
      var url = document.getElementById('editUrl').value.trim();
      var level = document.getElementById('editLevel').value.trim();
      var msg = document.getElementById('editLessonMsg');
      msg.innerText = '';
      msg.style.color = "#b83b3b";
      if (!id || !title || !url || !level) {
        msg.innerText = "يرجى تعبئة جميع الحقول بشكل صحيح.";
        return;
      }
      firestore.collection('lessons').doc(docId).update({
        id: id,
        title: title,
        url: url,
        level: level
      }).then(function(){
        msg.style.color = "#1dad87";
        msg.innerText = "تم تحديث الدرس بنجاح!";
        editLessonId = null;
        loadLessons();
        setTimeout(()=>{msg.innerText='';}, 1500);
      }).catch(function(err){
        msg.innerText = "حدث خطأ أثناء التحديث: " + err.message;
      });
    }

    // تحديث مستوى طالب
    window.updateLevel = function(checkbox) {
      const docId = checkbox.getAttribute('data-id');
      const level = checkbox.getAttribute('data-level');
      const value = checkbox.checked;
      firestore.collection('lectures').doc(docId).update({[level]: value}).then(function(){
        document.getElementById('msg').style.color = '#1dad87';
        document.getElementById('msg').innerText = 'تم تحديث المستوى بنجاح!';
        setTimeout(()=>{document.getElementById('msg').innerText=''; document.getElementById('msg').style.color='#b83b3b';}, 1500);
      }).catch(function(err){
        document.getElementById('msg').innerText = "خطأ أثناء التحديث: " + err.message;
      });
    }

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }
  </script>
</body>
</html>
