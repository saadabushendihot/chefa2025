<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة الطالب - شفاء</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal','Cairo',Arial,sans-serif; margin: 0; background: #f8fafc;}
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display:flex; justify-content:space-between; align-items:center;}
    .container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px #0001;}
    h2 { color: #4361ee; margin-top:0;}
    .btn { background: #4361ee; color: #fff; border: none; padding: 7px 22px; border-radius: 5px; font-size: 1rem; cursor: pointer;}
    .btn[disabled] {background: #bdbdbd; color: #fff; cursor: not-allowed;}
    .btn.submit {background: #1dad87;}
    .signout {background:#e63946;}
    .info { background: #f5f7fb; border-radius: 7px; padding: 10px 18px; margin: 16px 0;}
    #msg { color: #e63946; margin-top: 20px; }
    .levels-exams-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 26px;
      margin-bottom: 12px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px #0001;
    }
    .levels-exams-table th, .levels-exams-table td {
      padding: 10px 6px;
      border-bottom:1px solid #e4e7ef;
      text-align:center;
      font-size: 1rem;
    }
    .levels-exams-table th {
      background:#eef2fa;
      color:#1b3e72;
      font-weight: bold;
    }
    .level-on {color: #219e4b; font-weight: bold;}
    .level-off {color: #e63946; font-weight: bold;}
    .exam-status {font-weight:bold;}
    .exam-success {color:#219e4b;}
    .exam-fail {color:#e63946;}
    .exam-label {
      display: inline-block;
      padding: 3px 14px;
      border-radius: 18px;
      font-size: 1rem;
      font-weight: bold;
      background: #e3f6ed;
      color: #219e4b;
      border: 1px solid #b7eecd;
      box-shadow: 0 1px 4px #219e4b12;
      min-width: 90px;
    }
    .exam-label.fail {
      background: #ffecec;
      color: #e63946;
      border: 1px solid #ffbcbc;
      box-shadow: 0 1px 4px #e6394612;
    }
    .exam-label.wait {
      background: #f5f7fb;
      color: #555;
      border: 1px solid #d2d8e6;
    }
    .levels-exams-table tr:last-child td { border-bottom: none; }
    .exam-title { font-weight: bold; color: #294169;}
    #examWarnMsg {color:#e63946;font-weight:bold;margin:10px 0 15px 0;text-align:center;}
    #examBox {background:#f8fafc;border-radius:12px;padding:28px 20px;box-shadow:0 2px 10px #0002;}
    .level-info {background:#e6f2ff;padding:10px 16px;border-radius:8px;font-size:1.08em;margin-bottom:20px;display:inline-block;}
    .student-info {background:#eaf7e4;padding:12px 18px;border-radius:9px;margin-bottom:20px;display:inline-block;font-size:1.1em;}
    .summary-actions {margin-top: 8px;}
    .summary-status {font-weight:bold; font-size:0.95rem; margin-right:8px;}
    .summary-status.draft { color: #e6a100;}
    .summary-status.submitted { color: #219e4b;}
    .summary-mark {color: #1dad87;}
  </style>
</head>
<body>
  <header>
    <span>لوحة الطالب</span>
    <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">
    <h2>مرحباً، <span id="studentName"></span></h2>
    <div class="info">
      <div><b>البريد الإلكتروني:</b> <span id="studentEmail"></span></div>
      <div><b>اسم الطالب:</b> <span id="studentNameInfo"></span></div>
      <div><b>رقم المقرر:</b> <span id="courseNumber"></span></div>
    </div>
    <div id="admissionStatusBox" class="admission-status-box admission-pending" style="display:none;"></div>
    <div id="msg"></div>
    <div class="levels-exams-table">
      <thead>
        <tr>
          <th>المستوى</th>
          <th>حالة التفعيل</th>
          <th>حالة الامتحان</th>
          <th>العلامة</th>
        </tr>
      </thead>
      <tbody id="levelsExamsBody"></tbody>
    </div>
    <div id="examWarnMsg"></div>
    <div id="examBox" style="display:none; margin-top:30px;">
      <div class="student-info" id="examStudentInfo"></div>
      <div class="level-info" id="examLevelInfo"></div>
      <h2>أسئلة الاختبار</h2>
      <form id="examForm">
        <div id="questionsArea"></div>
        <div class="msg" id="formMsg"></div>
        <button type="submit" class="btn">إرسال الإجابات</button>
        <button type="button" class="btn signout" id="exitExamBtn" style="margin-right:8px;">خروج من الاختبار</button>
      </form>
      <div class="result" id="resultArea"></div>
    </div>
  </div>
  <script>
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();
    var currentStudentEmail = "";
    var currentStudentName = "";

    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists) {
            loadStudentData(doc.data().email, doc.data().name);
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function loadStudentData(userEmail, userNameFromUserDoc) {
      currentStudentEmail = userEmail;
      firestore.collection('lectures').where('email', '==', userEmail).get().then(function(querySnapshot) {
        if (querySnapshot.empty) {
          document.getElementById('msg').innerText = "لا توجد بيانات لهذا المستخدم في النظام. تواصل مع الإدارة.";
        } else {
          var data = querySnapshot.docs[0].data();
          currentStudentName = data.name || userNameFromUserDoc || "";
          document.getElementById('studentName').innerText = currentStudentName;
          document.getElementById('studentNameInfo').innerText = currentStudentName;
          document.getElementById('studentEmail').innerText = userEmail || "";
          document.getElementById('courseNumber').innerText = data.course_number || "";
          document.getElementById('msg').innerText = "";
          document.getElementById('levelsExamsBody').innerHTML = "";

          let levelsHtml = '';
          for (var i = 1; i <= 7; i++) {
            var level = data['level'+i];
            let status = level ? 'مُفعل ✅' : 'غير مفعل ❌';
            let examStatus = data['exam'+i] ? '✅ اجتاز الامتحان' : '❌ لم يجتز الامتحان';
            let mark = data['exam'+i+'_mark'] || '—';
            levelsHtml += `<tr>
                <td>المستوى ${i}</td>
                <td class="${level ? 'level-on' : 'level-off'}">${status}</td>
                <td>${examStatus}</td>
                <td><span class="summary-mark">${mark}</span></td>
              </tr>`;
          }
          document.getElementById('levelsExamsBody').innerHTML = levelsHtml;
        }
      }).catch(function(err) {
        document.getElementById('msg').innerText = "خطأ في جلب البيانات: " + err.message;
      });
    }

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }
  </script>
</body>
</html>
