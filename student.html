<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة الطالب - شفاء</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal','Cairo',Arial,sans-serif; margin: 0; background: #f8fafc;}
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display:flex; justify-content:space-between; align-items:center;}
    .container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px #0001;}
    h2 { color: #4361ee; margin-top:0;}
    .btn { background: #4361ee; color: #fff; border: none; padding: 7px 22px; border-radius: 5px; font-size: 1rem; cursor: pointer;}
    .btn[disabled] {background: #bdbdbd; color: #fff; cursor: not-allowed;}
    .btn.submit {background: #1dad87;}
    .signout {background:#e63946;}
    .info { background: #f5f7fb; border-radius: 7px; padding: 10px 18px; margin: 16px 0;}
    #msg { color: #e63946; margin-top: 20px; }
    .levels-table, .exams-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 26px;
      margin-bottom: 12px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px #0001;
    }
    .levels-table th, .levels-table td,
    .exams-table th, .exams-table td {
      padding: 10px 6px;
      border-bottom:1px solid #e4e7ef;
      text-align:center;
      font-size: 1rem;
    }
    .levels-table th, .exams-table th {
      background:#eef2fa;
      color:#1b3e72;
      font-weight: bold;
    }
    .level-on {color: #219e4b; font-weight: bold;}
    .level-off {color: #e63946; font-weight: bold;}
    .exam-status {font-weight:bold;}
    .exam-success {color:#219e4b;}
    .exam-fail {color:#e63946;}
    .exam-label {
      display: inline-block;
      padding: 3px 14px;
      border-radius: 18px;
      font-size: 1rem;
      font-weight: bold;
      background: #e3f6ed;
      color: #219e4b;
      border: 1px solid #b7eecd;
      box-shadow: 0 1px 4px #219e4b12;
      min-width: 90px;
    }
    .exam-label.fail {
      background: #ffecec;
      color: #e63946;
      border: 1px solid #ffbcbc;
      box-shadow: 0 1px 4px #e6394612;
    }
    .exam-label.wait {
      background: #f5f7fb;
      color: #555;
      border: 1px solid #d2d8e6;
    }
    .exams-table tr:last-child td,
    .levels-table tr:last-child td { border-bottom: none; }
    .exam-title { font-weight: bold; color: #294169;}
    .exams-title-bar {
      font-size: 1.16rem;
      background: #f7faff;
      padding: 8px 0 8px 0;
      border-radius: 10px 10px 0 0;
      color: #2260af;
      margin-bottom:0;
      border-bottom: 2px solid #e4e7ef;
      font-weight:bold;
      text-align:center;
      letter-spacing: 1px;
    }
    .exams-table {
      margin-bottom: 26px;
      margin-top: 18px;
    }
    #examBox {background:#f8fafc;border-radius:12px;padding:28px 20px;box-shadow:0 2px 10px #0002;}
    .student-info {background:#eaf7e4;padding:12px 18px;border-radius:9px;margin-bottom:20px;display:inline-block;font-size:1.1em;}
    .level-info {background:#e6f2ff;padding:10px 16px;border-radius:8px;font-size:1.08em;margin-bottom:20px;display:inline-block;}
    .question-block {background:#f8fafc;border-radius:10px;padding:14px 12px;margin:18px 0 30px 0;box-shadow:0 2px 8px #e4e7ef44;}
    .question-title {font-weight:bold;margin-bottom:9px;}
    .multi-note {color:#b96d0d;font-size:0.98em;margin-right:6px;}
    .question-mark {color:#2260af;margin-right:12px;}
    .choices-list {margin-bottom:10px;}
    .choice-row {margin-bottom:6px;}
    .msg {color:#e63946;margin-bottom:16px;}
    .result {font-size:1.3rem;color:#219e4b;font-weight:bold;text-align:center;}
    .scoring-note {color:#007b8f;font-size:0.95em;margin-top:5px;}
    #examForm .btn {margin-left:6px;}
    #examForm .btn.signout {background:#b83b3b;}
    @media (max-width:900px){#examBox{padding:7px;}}
    @media (max-width: 900px){
      .container{padding:8px;}
      header {padding:10px;}
      .levels-table th, .levels-table td,
      .exams-table th, .exams-table td {padding: 7px 2px;}
      .lesson-summary-block{padding:10px 4px;}
      textarea.summary-text {width:96%;}
      .lesson-summary-block audio {width:100%!important;}
    }
    .lesson-summary-block {background: #f5f7fb; border-radius: 10px; margin: 18px 0 28px 0; padding: 18px 14px; box-shadow: 0 2px 6px #e0e7ef33;}
    .lesson-summary-block h4 {margin:0 0 8px 0; color:#1b3e72;}
    .lesson-link {color:#4361ee; text-decoration:none;}
    .summary-actions {margin-top: 8px;}
    .summary-status {font-weight:bold; font-size:0.95rem; margin-right:8px;}
    .summary-status.draft { color: #e6a100;}
    .summary-status.submitted { color: #219e4b;}
    .lesson-student-name {font-size:1rem; color:#888; margin-bottom:7px;}
    textarea.summary-text {
      width:98%;height:80px;padding:8px;border-radius:5px;border:1px solid #b7c0d6;
      resize:vertical;font-size:1.08rem; box-sizing: border-box; background:#fff;
      font-family: 'Cairo','Tajawal',Arial,sans-serif; color: #1b2a39; line-height: 1.7;
      transition: border 0.15s; direction: rtl;
    }
    textarea.summary-text:focus {border-color: #4361ee;}
  </style>
</head>
<body>
  <!-- ... باقي الكود كما هو ... -->
  <script>
    // ... كل الكود كما هو ...

    // فقط عدل دالة إرسال الاختبار بهذا الشكل:
    document.getElementById('examForm').onsubmit = function(e){
      e.preventDefault();
      let totalMark = 0, gainedMark = 0, empty = 0;
      let details = [];
      randomizedExamQuestions.forEach((q, i) => {
        let nodes = document.getElementsByName('q'+i);
        let selected = [];
        nodes.forEach(input => { if(input.checked) selected.push(parseInt(input.value)); });

        let mark = parseFloat(q.mark) || 1;
        totalMark += mark;

        if (selected.length===0) { empty++; return; }

        details.push({
          question_id: q.id,
          selected: selected,
          correct: q.correct
        });

        if(q.correct.length > 1) {
          let perMark = mark / q.correct.length;
          let countCorrect = 0;
          let countWrong = 0;
          selected.forEach(val => {
            if(q.correct.includes(val)) countCorrect++;
            else countWrong++;
          });
          let gained = (countCorrect - countWrong) * perMark;
          if(gained < 0) gained = 0;
          gainedMark += gained;
        }
        else {
          if(selected.length === 1 && q.correct.includes(selected[0])) gainedMark += mark;
        }
      });
      if (empty>0) {
        showFormMsg('يرجى الإجابة على جميع الأسئلة!');
        return;
      }
      gainedMark = Math.round(gainedMark * 100) / 100;

      // تحقق أخير من عدم وجود نتيجة سابقة قبل الحفظ
      firestore.collection('exam_results')
        .where('student_email', '==', currentStudentEmail)
        .where('level', '==', currentExamLevel)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            // إذا وُجدت نتيجة لا تحفظ ولا تعيد التصحيح
            showExamResultOnly(querySnapshot.docs[0].data());
            updateLevelExamTable(currentExamLevel, querySnapshot.docs[0].data());
            return;
          }

          // --- حفظ النتيجة في exam_results ---
          const resultDoc = {
            student_email: currentStudentEmail,
            student_name: currentStudentName,
            level: currentExamLevel,
            score: gainedMark,
            total: totalMark,
            details: details,
            submitted_at: firebase.firestore.Timestamp.now(),
            teacher_reviewed: false,
            approved: null
          };

          firestore.collection('exam_results').add(resultDoc)
            .then((docRef) => {
              // *** التعديل هنا ***
              document.getElementById('questionsArea').innerHTML = '';
              document.getElementById('formMsg').innerText = '';
              document.getElementById('resultArea').innerHTML = `<div style="font-size:1.3rem;color:#219e4b;font-weight:bold;">
                تم حفظ نتيجتك بنجاح! درجتك: ${gainedMark} من ${totalMark}
                </div>`;
              updateLevelExamTable(currentExamLevel, resultDoc);
            })
            .catch((error) => {
              showResult(`درجتك: ${gainedMark} من ${totalMark}`);
              showFormMsg('حدث خطأ أثناء حفظ النتيجة: ' + error.message);
            });

          showFormMsg('');
        });
    };

    // ... باقي الكود كما هو ...
  </script>
</body>
</html>
