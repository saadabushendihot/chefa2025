<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ - Ø´ÙØ§Ø¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal','Cairo',Arial,sans-serif; margin: 0; background: #f8fafc;}
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display:flex; justify-content:space-between; align-items:center;}
    .container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px #0001;}
    h2 { color: #4361ee; margin-top:0;}
    .btn { background: #4361ee; color: #fff; border: none; padding: 7px 22px; border-radius: 5px; font-size: 1rem; cursor: pointer;}
    .btn[disabled] {background: #bdbdbd; color: #fff; cursor: not-allowed;}
    .btn.submit {background: #1dad87;}
    .signout {background:#e63946;}
    .info { background: #f5f7fb; border-radius: 7px; padding: 10px 18px; margin: 16px 0;}
    #msg { color: #e63946; margin-top: 20px; }
    .levels-table, .exams-table {
      width: 100%; border-collapse: collapse; margin-top: 26px; margin-bottom: 12px;
      background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px #0001;
    }
    .levels-table th, .levels-table td,
    .exams-table th, .exams-table td {
      padding: 10px 6px; border-bottom:1px solid #e4e7ef; text-align:center; font-size: 1rem;
    }
    .levels-table th, .exams-table th {background:#eef2fa; color:#1b3e72; font-weight: bold;}
    .level-on {color: #219e4b; font-weight: bold;}
    .level-off {color: #e63946; font-weight: bold;}
    .exam-label {
      display: inline-block; padding: 3px 14px; border-radius: 18px; font-size: 1rem; font-weight: bold;
      background: #e3f6ed; color: #219e4b; border: 1px solid #b7eecd; box-shadow: 0 1px 4px #219e4b12; min-width: 90px;
    }
    .exam-label.fail { background: #ffecec; color: #e63946; border: 1px solid #ffbcbc; box-shadow: 0 1px 4px #e6394612;}
    .exam-label.wait {background: #f5f7fb; color: #555; border: 1px solid #d2d8e6;}
    .exams-table tr:last-child td, .levels-table tr:last-child td { border-bottom: none; }
    .exams-title-bar {
      font-size: 1.16rem; background: #f7faff; padding: 8px 0;
      border-radius: 10px 10px 0 0; color: #2260af; border-bottom: 2px solid #e4e7ef; font-weight:bold;
      text-align:center; letter-spacing: 1px;
    }
    .exams-table {margin-bottom: 26px; margin-top: 18px;}
    #examWarnMsg {color:#e63946;font-weight:bold;margin:10px 0 15px 0;text-align:center;}
    #examBox {background:#f8fafc;border-radius:12px;padding:28px 20px;box-shadow:0 2px 10px #0002;}
    .student-info {background:#eaf7e4;padding:12px 18px;border-radius:9px;margin-bottom:20px;display:inline-block;font-size:1.1em;}
    .level-info {background:#e6f2ff;padding:10px 16px;border-radius:8px;font-size:1.08em;margin-bottom:20px;display:inline-block;}
    .question-block {background:#f8fafc;border-radius:10px;padding:14px 12px;margin:18px 0 30px 0;box-shadow:0 2px 8px #e4e7ef44;}
    .question-title {font-weight:bold;margin-bottom:9px;}
    .multi-note {color:#b96d0d;font-size:0.98em;margin-right:6px;}
    .question-mark {color:#2260af;margin-right:12px;}
    .choices-list {margin-bottom:10px;}
    .choice-row {margin-bottom:6px;}
    .msg {color:#e63946;margin-bottom:16px;}
    .result {font-size:1.3rem;color:#219e4b;font-weight:bold;text-align:center;}
    .scoring-note {color:#007b8f;font-size:0.95em;margin-top:5px;}
    #examForm .btn {margin-left:6px;}
    #examForm .btn.signout {background:#b83b3b;}
    /* Spinner */
    .spinner {
      border: 4px solid #eee; border-top: 4px solid #4361ee; border-radius: 50%;
      width: 38px; height: 38px; animation: spin 1s linear infinite; margin: 60px auto;
      display: none;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    /* Toast */
    .toast {
      visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff;
      text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px;
      font-size: 1.05rem; opacity: 0; transition: opacity 0.5s, visibility 0.5s;
    }
    .toast.show { visibility: visible; opacity: 1; }
    /* Night Mode */
    .dark-mode {background: #23272f; color: #fff;}
    .dark-mode .container {background: #323946; color: #fff;}
    .dark-mode header {background: #222f3e;}
    .dark-mode .info {background: #222f3e;}
    .dark-mode .levels-table, .dark-mode .exams-table {background: #293043;}
    .dark-mode .levels-table th, .dark-mode .exams-table th {background: #253150; color: #fff;}
    .dark-mode .lesson-summary-block {background: #242b39;}
    .dark-mode textarea.summary-text {background: #23272f; color: #fff;}
    /* Dark mode styles for Exam Box */
    .dark-mode #examBox {background: #293043;}
    .dark-mode #examBox h2 {color: #fff;}
    .dark-mode .student-info, .dark-mode .level-info {background: #2b3547; color: #e0e0e0;}
    .dark-mode .question-block {background: #3a455a; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);}
    .dark-mode .question-title {color: #fff;}
    .dark-mode .multi-note {color: #ffcc80;}
    .dark-mode .question-mark {color: #8cafff;}
    .dark-mode .choices-list label {color: #e0e0e0;}
    .dark-mode .scoring-note {color: #66b2b2;}
    .dark-mode .msg {color: #ff8080;}
    .dark-mode .result {color: #66bb6a;}
    .dark-mode input[type="radio"], .dark-mode input[type="checkbox"] {
        filter: invert(0.8);
    }
    /* Ø§Ù„Ø£Ø³Ø§Ø³ Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§ÙˆÙŠ */
    .lesson-mark-badge {
      display:inline-block;
      font-weight:bold;
      border-radius:15px; /* Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ø¨ÙŠØ¶Ø§ÙˆÙŠØ© */
      padding:1px 13px;
      font-size:0.99em;
      margin-right:8px;
      min-width:44px;
      vertical-align:middle;
    }
    /* ÙØ¦Ø© Ù„Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© (Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±) */
    .lesson-mark-badge.positive-mark {
        background:#e3f6ed; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
        color:#219e4b;     /* Ø£Ø®Ø¶Ø± Ø¯Ø§ÙƒÙ† */
        border:1px solid #b7eecd; /* Ø­Ø¯ÙˆØ¯ Ø®Ø¶Ø±Ø§Ø¡ */
    }
    /* ÙØ¦Ø© Ù„Ù„Ø¹Ù„Ø§Ù…Ø© ØµÙØ± */
    .lesson-mark-badge.zero-mark {
        background:#ffecf0; /* Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
        color:#e63946;     /* Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ† */
        border:1px solid #ffbcbc; /* Ø­Ø¯ÙˆØ¯ Ø­Ù…Ø±Ø§Ø¡ */
    }
    /* ÙØ¦Ø© Ù„Ù„Ø¹Ù„Ø§Ù…Ø© ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (Ù…Ø«Ù„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¹Ù„Ø§Ù…Ø©) */
    .lesson-mark-badge.no-mark {
        background:#f5f7fb; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ */
        color:#555;         /* Ø±Ù…Ø§Ø¯ÙŠ Ø¯Ø§ÙƒÙ† */
        border:1px solid #d2d8e6; /* Ø­Ø¯ÙˆØ¯ Ø±Ù…Ø§Ø¯ÙŠØ© */
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØµÙ…ÙŠÙ… Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªÙ„Ø®ÙŠØµ */
    .lesson-summary-block {
      background: #ffffff;
      border-radius: 12px;
      margin: 20px 0 30px 0;
      padding: 24px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border: 1px solid #e0e4e8;
      transition: all 0.3s ease;
    }
    .lesson-summary-block:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    /* ØªØ­Ø³ÙŠÙ† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªÙ„Ø®ÙŠØµ */
    .lesson-summary-block h4 {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f2f5;
        color: #294169;
        font-size: 1.15rem;
    }

    /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù…Ø­Ø³Ù† */
    .dark-mode .lesson-summary-block {
      background: #323946;
      border: 1px solid #3d4a5c;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .dark-mode .lesson-summary-block:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    .dark-mode .lesson-summary-block h4 {
        color: #e0e0e0;
        border-bottom: 1px solid #4a576b;
    }

    textarea.summary-text {
      width:98%;height:80px;padding:8px;border-radius:5px;border:1px solid #b7c0d6;
      resize:vertical;font-size:1.08rem; box-sizing: border-box; background:#fff;
      font-family: 'Cairo','Tajawal',Arial,sans-serif; color: #1b2a39; line-height: 1.7;
      transition: border 0.15s; direction: rtl;
    }
    textarea.summary-text:focus {border-color: #4361ee;}
    /* Ø²Ø± Ø§Ù„Ø¯Ø¹Ù… */
    #supportBtn {background:#007b8f;margin-right:10px;}
    /* Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    #nightModeBtn {background:#323946;margin-right:10px;}

    /* New styles for teacher comment display */
    .teacher-comment-display, .student-reply-display { /* Combined styles */
      background: #f0f2f5;
      padding: 10px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.98rem;
      color: #333;
      border: 1px solid #e0e4e8;
      line-height: 1.6;
      word-break: break-word; /* Ensure long words break */
    }
    .teacher-comment-display strong, .student-reply-display strong {
      color: #294169;
      display: block;
      margin-bottom: 5px;
    }
    .dark-mode .teacher-comment-display, .dark-mode .student-reply-display {
      background: #2b3547;
      border-color: #4a576b;
      color: #e0e0e0;
    }
    .dark-mode .teacher-comment-display strong, .dark-mode .student-reply-display strong {
      color: #8cafff;
    }

    /* Style for reply textarea */
    .reply-area {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #e0e4e8;
    }
    .reply-area label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
        color: #294169;
    }
    .reply-area textarea {
        width: 98%;
        height: 60px;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #b7c0d6;
        resize: vertical;
        font-size: 1rem;
        box-sizing: border-box;
        background: #fff;
        font-family: 'Cairo','Tajawal',Arial,sans-serif;
        color: #1b2a39;
    }
    .reply-area .btn {
        margin-top: 8px;
        padding: 6px 15px;
        font-size: 0.95rem;
    }
    .dark-mode .reply-area label {
        color: #e0e0e0;
    }
    .dark-mode .reply-area textarea {
        background: #2b3547;
        border-color: #4a576b;
        color: #e0e0e0;
    }

  </style>
</head>
<body>
  <header>
    <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</span>
    <div>
      <button class="btn" id="supportBtn" onclick="openSupport()">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</button>
      <button class="btn" id="nightModeBtn" onclick="toggleNightMode()">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
      <button class="btn signout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>
  <div class="container">
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="studentName"></span></h2>
    <div class="info">
      <div><b>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</b> <span id="studentEmail"></span></div>
      <div><b>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</b> <span id="studentNameInfo"></span></div>
      <div><b>Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚Ø±Ø±:</b> <span id="courseNumber"></span></div>
    </div>
    <div id="admissionStatusBox" class="admission-status-box admission-pending" style="display:none;"></div>
    <div id="msg"></div>
    <div class="spinner" id="loadingSpinner"></div>
    <div id="levelsExamsTableArea"></div>
    <div id="examWarnMsg"></div>
    <div class="exams-box" id="examsBox" style="display:none;">
      <div class="exams-title">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
      <div class="exam-row"><b>Ø§Ù…ØªØ­Ø§Ù† ØªØ´Ø®ÙŠØµÙŠ:</b> <span id="diagnosisExamMark"></span></div>
      <div class="exam-row"><b>Ø§Ù…ØªØ­Ø§Ù† 1:</b> <span id="exam1Mark"></span></div>
      <div class="exam-row"><b>Ø§Ù…ØªØ­Ø§Ù† Ø´ÙÙˆÙŠ:</b> <span id="oralExamMark"></span></div>
      <div class="exam-row"><b>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©:</b> <span id="fExam"></span></div>
    </div>
    <div style="text-align:center;margin:15px 0;">
      <button class="btn" id="downloadReportBtn" onclick="downloadReport()">ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯Ø±Ø¬Ø§Øª PDF</button>
    </div>
    <div id="lessonsSummariesArea"></div>

    <div id="examBox" style="display:none; margin-top:30px;">
      <div class="student-info" id="examStudentInfo"></div>
      <div class="level-info" id="examLevelInfo"></div>
      <h2>Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± <span id="examTimer" style="font-size:1.1rem;color:#e63946;"></span></h2>
      <form id="examForm">
        <div id="questionsArea"></div>
        <div class="msg" id="formMsg"></div>
        <button type="submit" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
        <button type="button" class="btn signout" id="exitExamBtn" style="margin-right:8px;">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
      </form>
      <div class="result" id="resultArea"></div>
    </div>
  </div>
  <div id="toast" class="toast"></div>
  <audio id="timeWarningSound" src="path/to/your/warning_sound.mp3" preload="auto"></audio>

  <script src="firebase-config.js"></script>
  <script>
    // Firebase Config: ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø¦Ù† Ù…Ù† Ù‡Ù†Ø§ ÙˆØ³ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡ Ù…Ù† firebase-config.js
    
    // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
    function toggleNightMode() {
      document.body.classList.toggle('dark-mode');
    }

    // Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© (Toast)
    function showToast(msg, color="#333") {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.style.background = color;
      toast.className = "toast show";
      setTimeout(()=>{ toast.className = toast.className.replace("show", ""); }, 2500);
    }

    // Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„
    function showLoading(show) {
      document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    // ÙØªØ­ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
    function openSupport() {
      window.open("mailto:support@chefa.edu.sa?subject=Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨", "_blank");
    }

    // ØªÙ†Ø²ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF (Ù…ÙƒØªØ¨Ø© jsPDF Ù…Ø·Ù„ÙˆØ¨Ø©)
    function downloadReport() {
      showToast("Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØªØ·Ù„Ø¨ Ù…ÙƒØªØ¨Ø© jsPDF. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.");
      // Ù…Ø«Ø§Ù„: https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js
      // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ø«Ù… ØªÙØ¹ÙŠÙ„ ÙƒÙˆØ¯ ØªØµØ¯ÙŠØ± PDF Ù‡Ù†Ø§.
    }

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù†Øµ Ù„Ù…Ù†Ø¹ HTML
    function sanitizeText(text) {
      const div = document.createElement("div");
      div.innerText = text;
      return div.innerHTML;
    }

    // Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    let examTimerInterval, examTimeLeft = 0;
    function startExamTimer(minutes = 20) {
      clearInterval(examTimerInterval);
      examTimeLeft = minutes * 60;
      updateExamTimer();
      examTimerInterval = setInterval(() => {
        examTimeLeft--;
        updateExamTimer();
        if (examTimeLeft <= 0) {
          clearInterval(examTimerInterval);
          showToast("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±! Ø³ÙŠØªÙ… ØªØ³Ù„ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.", "#e63946");
          processExamSubmission(true); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        }
      }, 1000);
    }
    function updateExamTimer() {
      const el = document.getElementById('examTimer');
      if (examTimeLeft > 0) {
        const min = Math.floor(examTimeLeft/60);
        const sec = examTimeLeft%60;
        el.innerText = `(${min}:${sec<10?'0':''}${sec})`;

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªØ­Ø°ÙŠØ± Ù‚Ø¨Ù„ 30 Ø«Ø§Ù†ÙŠØ©
        if (examTimeLeft === 30) {
          const sound = document.getElementById('timeWarningSound');
          if (sound) {
            sound.play().catch(e => console.error("Error playing sound:", e));
          }
        }
      } else {
        el.innerText = "";
      }
    }

    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    let auth, firestore;
    let currentStudentEmail = "";
    let currentStudentName = "";
    let lastActiveLevel = null;
    let lastActiveLevelIndex = null;
    let examQuestions = [];
    let randomizedExamQuestions = [];
    let examQuestionsLimit = null;
    let currentExamLevel = null;
    let studentSummaries = {}; // Map to store summaries by lesson_id for quick lookup
    let summariesListenerUnsubscribe = null; // [NEW] To store unsubscribe function for real-time listener


    // Firebase init
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } // firebaseConfig ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡ Ø§Ù„Ø¢Ù† Ù…Ù† firebase-config.js
    auth = firebase.auth();
    firestore = firebase.firestore();

    // ØªØ­ÙˆÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¥Ù„Ù‰ Ù†ØµÙ‡ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
    function getLevelText(index) {
      const names = ["", "Ø§Ù„Ø£ÙˆÙ„", "Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø«", "Ø§Ù„Ø±Ø§Ø¨Ø¹", "Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„Ø³Ø§Ø¯Ø³", "Ø§Ù„Ø³Ø§Ø¨Ø¹"];
      return names[index] || "";
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function getLevelNumber(levelName) {
      switch (levelName.replace('Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ', '').replace('Ø§Ù„', '')) {
        case "Ø£ÙˆÙ„": case "Ø§Ù„Ø£ÙˆÙ„": return 1;
        case "Ø«Ø§Ù†ÙŠ": case "Ø§Ù„Ø«Ø§Ù†ÙŠ": return 2;
        case "Ø«Ø§Ù„Ø«": case "Ø§Ù„Ø«Ø§Ù„Ø«": return 3;
        case "Ø±Ø§Ø¨Ø¹": case "Ø§Ù„Ø±Ø§Ø¨Ø¹": return 4;
        case "Ø®Ø§Ù…Ø³": case "Ø§Ù„Ø®Ø§Ù…Ø³": return 5;
        case "Ø³Ø§Ø¯Ø³": case "Ø§Ù„Ø³Ø§Ø¯Ø³": return 6;
        case "Ø³Ø§Ø¨Ø¹": case "Ø§Ù„Ø³Ø§Ø¨Ø¹": return 7;
        case "1": return 1; case "2": return 2; case "3": return 3; case "4": return 4; case "5": return 5; case "6": return 6; case "7": return 7;
        default: return 0;
      }
    }

    function getAllowedLevels(data) {
      let allowed = [];
      for(let i=1; i<=7; i++){
        if(data['level'+i]) allowed.push(i);
      }
      return allowed;
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists) {
            if (doc.data().role !== "student") {
              window.location.href = "dashboard.html";
              return;
            }
            loadStudentData(doc.data().email, doc.data().name);
          } else {
            firestore.collection('users').doc(user.uid).set({
              email: user.email, role: "student"
            }).then(function() { window.location.reload(); });
          }
        }).catch(err => { showLoading(false); showToast("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "#e63946"); });
      } else {
        window.location.href = "login.html";
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
    function loadStudentData(userEmail, userNameFromUserDoc) {
      currentStudentEmail = userEmail;
      showLoading(true);
      firestore.collection('lectures').where('email', '==', userEmail).get().then(function(querySnapshot) {
        showLoading(false);
        if (querySnapshot.empty) {
          document.getElementById('msg').innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.";
        } else {
          const data = querySnapshot.docs[0].data();
          currentStudentName = data.name || userNameFromUserDoc || "";
          document.getElementById('studentName').innerText = currentStudentName;
          document.getElementById('studentNameInfo').innerText = currentStudentName;
          document.getElementById('studentEmail').innerText = userEmail || "";
          document.getElementById('courseNumber').innerText = data.course_number || "";
          document.getElementById('msg').innerText = "";
          document.getElementById('examsBox').style.display = "none";
          document.getElementById('admissionStatusBox').style.display = "none";
          document.getElementById('lessonsSummariesArea').innerHTML = "";
          document.getElementById('levelsExamsTableArea').innerHTML = "";

          // Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¨ÙˆÙ„
          const admissionBox = document.getElementById('admissionStatusBox');
          const status = data.accepted;
          const isAccepted = (status === true || status === "Ù…Ù‚Ø¨ÙˆÙ„" || status === "accepted");
          const isRejected = (status === false || status === "Ù…Ø±ÙÙˆØ¶" || status === "rejected");

          admissionBox.style.display = "block";
          if (typeof status !== "undefined") {
            if (isAccepted) {
              admissionBox.className = "admission-status-box admission-accepted";
              admissionBox.innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„Ùƒ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© âœ…";
              document.getElementById('examsBox').style.display = "block";
            } else if (isRejected) {
              admissionBox.className = "admission-status-box admission-rejected";
              admissionBox.innerText = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„Ùƒ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©.";
              document.getElementById('examsBox').style.display = "none";
            } else {
              admissionBox.className = "admission-status-box admission-pending";
              admissionBox.innerText = "Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...";
              document.getElementById('examsBox').style.display = "none";
            }
          } else {
            admissionBox.className = "admission-status-box admission-pending";
            admissionBox.innerText = "Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...";
            document.getElementById('examsBox').style.display = "none";
          }

          // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª/Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
          renderLevelsExamsMergedTable(data);

          // Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
          const diagnosisMark = data.diagnosis_exam_mark || (data.diagnosis_exam ? 'Ù…ÙØ¬ØªØ§Ø²' : 'ØºÙŠØ± Ù…Ø¬ØªØ§Ø²');
          const exam1Mark = data.exam1_mark || (data.exam1 ? 'Ù…ÙØ¬ØªØ§Ø²' : 'ØºÙŠØ± Ù…Ø¬ØªØ§Ø²');
          const oralMark = data.oral_exam_mark || (data.oral_exam ? 'Ù…ÙØ¬ØªØ§Ø²' : 'ØºÙŠØ± Ù…Ø¬ØªØ§Ø²');
          const fMark = (typeof data.f !== "undefined" && data.f !== null && data.f !== "") ? data.f : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
          document.getElementById('diagnosisExamMark').innerText = diagnosisMark;
          document.getElementById('exam1Mark').innerText = exam1Mark;
          document.getElementById('oralExamMark').innerText = oralMark;
          document.getElementById('fExam').innerText = fMark;

          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„ØªÙ„Ø§Ø®ÙŠØµ (Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
          const allowedLevels = getAllowedLevels(data);
          loadActiveLessonsAndSummaries(allowedLevels);
        }
      }).catch(function(err) {
        showLoading(false);
        document.getElementById('msg').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message;
        showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨!", "#e63946");
      });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù‡Ù„ÙŠØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    function performExamEligibilityCheckAndProceed(studentData, proceedIfEligible = false) {
      const btn = document.getElementById('goToExamBtn');
      const warn = document.getElementById('examWarnMsg');

      if (!lastActiveLevelIndex || !studentData.accepted) {
        btn.style.display = "none";
        warn.innerText = ''; // Ù…Ø³Ø­ Ø£ÙŠ ØªØ­Ø°ÙŠØ±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
        return; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙˆÙ‰ Ù†Ø´Ø· Ø£Ùˆ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„
      }

      const levelText = getLevelText(lastActiveLevelIndex);
      showLoading(true); // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚

      firestore.collection('lessons').where('level', '==', levelText).get().then(function(lessonQuery){
        let lessons = [];
        lessonQuery.forEach(doc => lessons.push(doc.data()));
        const lessonIds = lessons.map(l=>l.id);

        if(!lessonIds.length) {
          btn.style.display = "none";
          warn.innerText = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.';
          showLoading(false);
          return;
        }

        let summaryAndMarkPromises = [];
        firestore.collection('summaries')
          .where('student_email', '==', currentStudentEmail)
          .where('lesson_id', 'in', lessonIds)
          .get()
          .then(function(summariesSnap){
            let summariesMapForExamCheck = {};
            summariesSnap.forEach(doc => {
                let s = { ...doc.data(), docId: doc.id };
                summariesMapForExamCheck[s.lesson_id] = s;
                if (s.status === 'submitted') {
                    summaryAndMarkPromises.push(
                        firestore.collection('student_marks')
                        .where('summary_id', '==', s.docId)
                        .where('student_email', '==', currentStudentEmail)
                        .limit(1)
                        .get()
                        .then(markSnap => {
                            // Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯: ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±
                            if (!markSnap.empty && markSnap.docs[0].data().mark !== null && markSnap.docs[0].data().mark !== undefined && markSnap.docs[0].data().mark > 0) {
                                s.mark_from_student_marks = markSnap.docs[0].data().mark;
                                return true;
                            }
                            s.mark_from_student_marks = null; // Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© (ØµÙØ± Ø£Ùˆ Ø£Ù‚Ù„)
                            return false; // Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ø³Ù„Ù… Ù„ÙƒÙ† Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù„Ø§Ù…Ø© ØµØ§Ù„Ø­Ø©
                        }).catch(error => {
                            console.error("Error fetching mark for summary in exam check:", s.docId, error);
                            s.mark_from_student_marks = null;
                            return false; // Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ ØºÙŠØ± ØµØ§Ù„Ø­Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                        })
                    );
                } else {
                    s.mark_from_student_marks = null; // Ø§Ù„Ù…Ù„Ø®ØµØ§Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù„Ø§ ØªØ¤Ù‡Ù„ Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†
                    summaryAndMarkPromises.push(Promise.resolve(false));
                }
            });

            Promise.all(summaryAndMarkPromises).then(() => {
              let allRequiredSummariesPresentAndMarked = true;

              if (lessons.length === 0) {
                allRequiredSummariesPresentAndMarked = true;
              } else if (Object.keys(summariesMapForExamCheck).length !== lessons.length) {
                allRequiredSummariesPresentAndMarked = false;
              } else {
                for (let i = 0; i < lessons.length; i++) {
                  const lessonId = lessons[i].id;
                  const summary = summariesMapForExamCheck[lessonId];
                  if (!summary || summary.status !== 'submitted' || summary.mark_from_student_marks === null || summary.mark_from_student_marks <= 0) {
                    allRequiredSummariesPresentAndMarked = false;
                    break;
                  }
                }
              }

              if(allRequiredSummariesPresentAndMarked){
                  btn.style.display="";
                  warn.innerText = '';
                  if (proceedIfEligible) { // ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø§Ù„Ø© Ù‚Ø¯ Ø§Ø³ØªØ¯Ø¹ÙŠØª Ø¨Ù‡Ø¯Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†
                      currentExamLevel = lastActiveLevelIndex;
                      checkIfExamAlreadySubmitted(currentStudentEmail, currentExamLevel);
                      setTimeout(function(){
                          document.getElementById('examBox').scrollIntoView({behavior: 'smooth'});
                      }, 300);
                  }
              } else {
                  btn.style.display="none";
                  warn.innerText = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ ØªØ³Ù„ÙŠÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ„Ø§Ø®ÙŠØµ ÙˆØªØµØ­ÙŠØ­Ù‡Ø§ Ø¨Ø¹Ù„Ø§Ù…Ø© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.';
              }
              showLoading(false); // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
            }).catch(error => {
                console.error("Error in Promise.all for summary/mark check:", error);
                btn.style.display="none";
                warn.innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ„Ø§Ø®ÙŠØµ (ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª).';
                showLoading(false);
            });
          }).catch(error => {
              console.error("Error fetching summaries for exam check:", error);
              btn.style.display="none";
              warn.innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ„Ø§Ø®ÙŠØµ.';
              showLoading(false);
          });
      }).catch(error => {
          console.error("Error fetching lessons for exam check:", error);
          btn.style.display="none";
          warn.innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¯Ø±ÙˆØ³.';
          showLoading(false);
      });
    }

    // Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª + Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø±Ø¶)
    function renderLevelsExamsMergedTable(data) {
      let html = `<div class="exams-title-bar">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ÙˆÙ†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</div>
        <table class="levels-table" id="levelsExamsTable">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th>
            </tr>
          </thead><tbody>`;
      lastActiveLevel = null;
      lastActiveLevelIndex = null;
      for (let i = 1; i <= 7; i++) {
        const level = data['level'+i];
        const exam = data['exam'+i];
        if(level) { lastActiveLevel = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ' + i; lastActiveLevelIndex = i; }
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„
        const levelStatus = level ? '<span class="level-on">Ù…ÙÙØ¹Ù„ âœ…</span>' : '<span class="level-off">ØºÙŠØ± Ù…ÙØ¹Ù„ âŒ</span>';
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
        let examLabel = '';
        if (exam === true) {
          examLabel = `<span class="exam-label">âœ… Ø§Ø¬ØªØ§Ø² Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</span>`;
        } else if (exam === false) {
          examLabel = `<span class="exam-label fail">âŒ Ù„Ù… ÙŠØ¬ØªØ² Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</span>`;
        } else if (level) {
          examLabel = `<span class="exam-label wait">Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯</span>`;
        } else {
          examLabel = `<span class="exam-label wait">â€”</span>`;
        }
        html += `<tr>
            <td>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${i}</td>
            <td>${levelStatus}</td>
            <td>${examLabel}</td>
          </tr>`;
      }
      html += "</tbody></table>";

      // Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
      if(lastActiveLevelIndex && data.accepted === true){
        html += `<div style="text-align:center; margin:20px 0;">
          <button class="btn" id="goToExamBtn" style="display:none">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø± ${getLevelText(lastActiveLevelIndex)}</button>
        </div>`;
      }
      document.getElementById('levelsExamsTableArea').innerHTML = html;

      // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ù„Ø§ Ù†ØªÙ‚Ø¯Ù… Ù„Ù„Ø§Ù…ØªØ­Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
      if(lastActiveLevelIndex && data.accepted === true){
          performExamEligibilityCheckAndProceed(data, false); // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£ÙˆÙ„ÙŠ
          // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆÙ†ØªÙ‚Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø±ÙˆØ· Ù…Ø³ØªÙˆÙØ§Ø©
          document.getElementById('goToExamBtn').onclick = function(){
              performExamEligibilityCheckAndProceed(data, true); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
          };
      }
    }


    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    function checkIfExamAlreadySubmitted(email, level) {
      firestore.collection('exam_results')
        .where('student_email', '==', email)
        .where('level', '==', level)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            showExamResultOnly(querySnapshot.docs[0].data());
          } else {
            showExamBox(currentStudentName, currentStudentEmail, currentExamLevel);
          }
        })
        .catch(()=>{ showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±", "#e63946"); });
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·
    function showExamResultOnly(result) {
      document.getElementById('examBox').style.display = '';
      document.getElementById('questionsArea').innerHTML = '';
      document.getElementById('formMsg').innerText = '';
      document.getElementById('examStudentInfo').innerHTML =
        `<b>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</b> ${currentStudentName} &nbsp; | &nbsp; <b>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</b> ${currentStudentEmail} &nbsp; | &nbsp; <b>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${result.level}`;
      document.getElementById('examLevelInfo').innerText = '';
      document.getElementById('resultArea').innerHTML = `<div style="font-size:1.3rem;color:#e63946;font-weight:bold;">
        Ù„Ù‚Ø¯ Ø³Ø¨Ù‚ Ù„Ùƒ ØªÙ‚Ø¯ÙŠÙ… Ø§Ø®ØªØ¨Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.<br>Ø¯Ø±Ø¬ØªÙƒ: ${result.score} Ù…Ù† ${result.total}
        </div>`;
      let btn = document.getElementById('goToExamBtn');
      if(btn) btn.style.display = "none";
      document.querySelector("button[type=submit]").style.display = "none";
      document.getElementById('exitExamBtn').style.display = "none";
      clearInterval(examTimerInterval); updateExamTimer();
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    function showExamBox(studentName, studentEmail, level) {
      document.getElementById('examBox').style.display = '';
      document.getElementById('examStudentInfo').innerHTML =
        `<b>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</b> ${studentName} &nbsp; | &nbsp; <b>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</b> ${studentEmail} &nbsp; | &nbsp; <b>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${getLevelText(level)}`;
      firestore.collection('exam_settings').doc('level_' + level).get().then(function(settingDoc){
        if(settingDoc.exists && settingDoc.data().question_num){
          examQuestionsLimit = settingDoc.data().question_num;
          document.getElementById('examLevelInfo').innerText =
            `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${examQuestionsLimit}`;
        } else {
          examQuestionsLimit = null;
          document.getElementById('examLevelInfo').innerText =
            'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©).';
        }
        loadExamQuestions(level);
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù…Ø«Ø§Ù„: 20 Ø¯Ù‚ÙŠÙ‚Ø©)
        startExamTimer(20);
      });
      document.getElementById('formMsg').innerText = '';
      document.getElementById('resultArea').innerText = '';
      document.querySelector("button[type=submit]").style.display = "";
      document.getElementById('exitExamBtn').style.display = "";
    }

    // Ø¬Ù„Ø¨ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    function loadExamQuestions(level) {
      firestore.collection('questions').where('level', '==', level).get().then(snap=>{
        examQuestions = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
        prepareRandomizedExam();
        renderExamQuestions();
      }).catch(()=>{ showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©", "#e63946"); });
    }

    // Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
    function prepareRandomizedExam() {
      let shuffled = shuffleArray(examQuestions.map(q => {
        let choiceObjs = (q.choices||[]).map((choice, idx) => ({
          text: choice,
          origIndex: idx
        }));
        let shuffledChoices = shuffleArray(choiceObjs);
        let newCorrect = [];
        shuffledChoices.forEach((ch, ix) => {
          if(q.correct && q.correct.includes(ch.origIndex)) newCorrect.push(ix);
        });
        return {
          ...q,
          choices: shuffledChoices.map(c => c.text),
          correct: newCorrect
        };
      }));
      randomizedExamQuestions = examQuestionsLimit ? shuffled.slice(0, examQuestionsLimit) : shuffled;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    function renderExamQuestions() {
      let html = '';
      randomizedExamQuestions.forEach((q, i) => {
        let multiNote = '';
        let scoringNote = '';
        if (q.correct.length > 1) {
          multiNote = '<span class="multi-note">(ÙŠØ­ØªÙ…Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©)</span>';
          scoringNote = `<div class="scoring-note">
          Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ØªØ®ØªØ§Ø±Ù‡Ø§ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø©ØŒ ÙˆÙ„ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© ØªØ®ØªØ§Ø±Ù‡Ø§ ÙŠÙØ®ØµÙ… Ù†ÙØ³ Ø§Ù„Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙ‚Ù„ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„ØµÙØ±.
          </div>`;
        }
        let markText = `<span class="question-mark">[Ø§Ù„Ø¹Ù„Ø§Ù…Ø©: ${q.mark || 1}]</span>`;
        html += `<div class="question-block">
          <div class="question-title">${i+1}. ${q.question} ${multiNote} ${markText}</div>
          <div class="choices-list">` +
          (q.choices||[]).map((choice, idx) =>
            `<div class="choice-row">
              <label>
                <input type="${q.correct.length>1?'checkbox':'radio'}" name="q${i}" value="${idx}">
                ${choice}
              </label>
            </div>`
          ).join('') +
          `</div>
          ${scoringNote}
        </div>`;
      });
      document.getElementById('questionsArea').innerHTML = html || '<div class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
    }

    // ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    document.getElementById('exitExamBtn').onclick = function(){
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ù„Ù† ØªØ­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ!")) {
        document.getElementById('examBox').style.display = 'none';
        document.getElementById('questionsArea').innerHTML = "";
        document.getElementById('formMsg').innerText = "";
        document.getElementById('resultArea').innerText = "";
        clearInterval(examTimerInterval); updateExamTimer();
      }
    };

    // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† ØªØ£ÙƒÙŠØ¯
    window.onbeforeunload = function(e) {
      if (document.getElementById('examBox').style.display !== 'none') {
        return "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©ØŸ Ù‚Ø¯ ØªÙÙ‚Ø¯ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ!";
      }
    };

    // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    function processExamSubmission(isTimerSubmission = false) {
      let totalMark = 0, gainedMark = 0, empty = 0;
      let details = [];
      randomizedExamQuestions.forEach((q, i) => {
        const nodes = document.getElementsByName('q'+i);
        let selected = [];
        nodes.forEach(input => { if(input.checked) selected.push(parseInt(input.value)); });

        let mark = parseFloat(q.mark) || 1;
        totalMark += mark;

        // Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„ØªØ³Ù„ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
        if (selected.length === 0) {
          if (!isTimerSubmission) {
            empty++;
          }
        }

        details.push({
          question_id: q.id,
          selected: selected,
          correct: q.correct
        });

        if(q.correct.length > 1) {
          let perMark = mark / q.correct.length;
          let countCorrect = 0;
          let countWrong = 0;
          selected.forEach(val => {
            if(q.correct.includes(val)) countCorrect++;
            else countWrong++;
          });
          let gained = (countCorrect - countWrong) * perMark;
          if(gained < 0) gained = 0;
          gainedMark += gained;
        }
        else {
          if(selected.length === 1 && q.correct.includes(selected[0])) gainedMark += mark;
        }
      });

      // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙŠØ¯ÙˆÙŠØ§Ù‹
      if (!isTimerSubmission && empty > 0) {
        showFormMsg('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!');
        showToast("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!", "#e63946");
        return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø£Ø³Ø¦Ù„Ø© ÙØ§Ø±ØºØ©
      }

      gainedMark = Math.round(gainedMark * 100) / 100;

      firestore.collection('exam_results')
        .where('student_email', '==', currentStudentEmail)
        .where('level', '==', currentExamLevel)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            showExamResultOnly(querySnapshot.docs[0].data());
            updateLevelExamTable(currentExamLevel, querySnapshot.docs[0].data());
            showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹", "#e63946");
            return;
          }
          const resultDoc = {
            student_email: currentStudentEmail,
            student_name: currentStudentName,
            level: currentExamLevel,
            score: gainedMark,
            total: totalMark,
            details: details,
            submitted_at: firebase.firestore.Timestamp.now(),
            teacher_reviewed: false,
            approved: null
          };
          firestore.collection('exam_results').add(resultDoc)
            .then(() => {
              document.getElementById('questionsArea').innerHTML = '';
              document.getElementById('formMsg').innerText = '';
              document.getElementById('resultArea').innerHTML = `<div style="font-size:1.3rem;color:#219e4b;font-weight:bold;">
                ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! Ø¯Ø±Ø¬ØªÙƒ: ${gainedMark} Ù…Ù† ${totalMark}
                </div>`;
              document.querySelector("button[type=submit]").style.display = "none";
              document.getElementById('exitExamBtn').style.display = "none";
              let btn = document.getElementById('goToExamBtn');
              if(btn) btn.style.display = "none";
              updateLevelExamTable(currentExamLevel, resultDoc);
              showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "#1dad87");
              clearInterval(examTimerInterval); updateExamTimer();
            })
            .catch((error) => {
              showResult(`Ø¯Ø±Ø¬ØªÙƒ: ${gainedMark} Ù…Ù† ${totalMark}`);
              showFormMsg('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ' + error.message);
              showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©!", "#e63946");
            });
          showFormMsg('');
        });
    }

    // Ø±Ø¨Ø· Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    document.getElementById('examForm').onsubmit = function(e){
      e.preventDefault();
      processExamSubmission(false); // ØªØ³Ù„ÙŠÙ… ÙŠØ¯ÙˆÙŠ
    };

    function showFormMsg(msg) {
      document.getElementById('formMsg').innerText = msg;
    }
    function showResult(msg) {
      document.getElementById('resultArea').innerText = msg;
    }

    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
    function updateLevelExamTable(level, result) {
      let passed = (result.score >= result.total * 0.5);
      let label = passed
        ? `<span class="exam-label">âœ… Ø§Ø¬ØªØ§Ø² Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (${result.score} Ù…Ù† ${result.total})</span>`
        : `<span class="exam-label fail">âŒ Ù„Ù… ÙŠØ¬ØªØ² (${result.score} Ù…Ù† ${result.total})</span>`;
      let table = document.querySelectorAll(".levels-table tbody tr");
      if(table && table.length >= level) {
        let cell = table[level-1].querySelector("td:last-child");
        if(cell) cell.innerHTML = label;
      }
    }

    // ØªÙ„Ø®ÙŠØµØ§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ (Load with Realtime Listener)
    function loadStudentSummaries(email) {
      showLoading(true);
      currentStudentEmailForSummaries = email;

      // Unsubscribe from previous listener if exists
      if (teacherSummariesListenerUnsubscribe) {
        teacherSummariesListenerUnsubscribe();
        teacherSummariesListenerUnsubscribe = null;
      }

      // Get lessons first (they don't change often)
      firestore.collection('lessons').orderBy('id').get().then(function(lessonsSnap) {
        lessonsSnap.forEach(doc=>window.lessonsMap[doc.data().id]=doc.data().title); // Populate global lessonsMap

        // Now set up a real-time listener for summaries of the CURRENTLY SELECTED student
        teacherSummariesListenerUnsubscribe = firestore.collection('summaries')
          .where('student_email', '==', currentStudentEmailForSummaries)
          .onSnapshot(function(snapshot) {
            let changes = snapshot.docChanges(); // Get changes since last snapshot
            let shouldShowToast = false;
            
            // Re-fetch all summaries for the selected student to ensure complete data
            window.allSummaries = [];
            window.studentSummariesMap = {};
            snapshot.forEach(doc => {
              let s = { ...doc.data(), docId: doc.id };
              window.allSummaries.push(s);
              window.studentSummariesMap[s.docId] = s;

              // Check for specific changes for toast notification
              if (changes.some(change => change.type === "modified" && change.doc.id === doc.id)) {
                  let oldDoc = changes.find(change => change.doc.id === doc.id)?.oldDoc?.data();
                  if (oldDoc) {
                      // If student_reply_comment was added/changed OR status changed to submitted
                      if (s.student_reply_comment !== oldDoc.student_reply_comment || (s.status === 'submitted' && oldDoc.status === 'draft')) {
                          shouldShowToast = true;
                      }
                  }
              }
            });

            // Fetch marks for all summaries (or just the changed ones)
            let markPromises = window.allSummaries.map(s => {
                // ... (mark fetching logic)
            });

            Promise.all(markPromises).then(updatedSummariesArray => {
                // Rebuild window.allSummaries and window.studentSummariesMap from the updated array
                window.allSummaries = updatedSummariesArray;
                window.studentSummariesMap = {};
                updatedSummariesArray.forEach(s => {
                    window.studentSummariesMap[s.docId] = s;
                });

                filterSummariesTable(); // Re-render with fresh data and filter
                if (shouldShowToast) {
                    showToast(`Ù„Ø¯ÙŠÙƒ Ø±Ø¯ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ù‰ ØªÙ„Ø®ÙŠØµ Ù…Ù† ${allStudentsData[document.getElementById('studentSelect').value]?.name || 'Ø§Ù„Ø·Ø§Ù„Ø¨'}!`, "#3b5cb8");
                }
                showLoading(false);
            }).catch(err => {
                showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: " + err.message, "#e63946");
                console.error("Promise.all error in listener:", err);
                showLoading(false);
            });

          }, function(error) {
            showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙ„Ø§Ø®ÙŠØµ: " + error.message, "#e63946");
            console.error("Listener error:", error);
            showLoading(false);
          });
      }).catch(err => {
        showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³ Ù„Ù„ØªÙ„Ø§Ø®ÙŠØµ: " + err.message, "#e63946");
        showLoading(false);
        console.error("Error fetching lessons for summaries:", err);
      });
    }

    function filterSummariesTable() {
        const filterStatus = document.getElementById('summaryFilterStatus').value;
        let filteredSummaries = window.allSummaries.filter(s => {
            if (filterStatus === 'all') return true;
            return s.status === filterStatus;
        });

        // Sort summaries by lesson_id
        filteredSummaries.sort((a, b) => a.lesson_id - b.lesson_id);


        if (!filteredSummaries.length) {
            document.getElementById('summariesTableWrapper').innerHTML = "<b>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ„Ø§Ø®ÙŠØµ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±.</b>";
            hideSummaryDetails();
            return;
        }

        let html = `
        <div class="table-wrapper">
        <table style="width:100%;margin-top:8px;">
          <thead><tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø³</th>
            <th>Ø§Ù„Ø¯Ø±Ø³</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th>
            <th>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ„Ø®ÙŠØµ</th>
          </tr></thead><tbody>`;

        // No need for new markPromises here, marks are already in window.allSummaries
        filteredSummaries.forEach(s => {
            const isSubmitted = s.status === 'submitted';
            html += `<tr>
                <td>${s.lesson_id}</td>
                <td style="cursor:pointer; font-weight:bold; color:#3b5cb8;" onclick="showSummaryDetails('${s.docId}')">
                    ${window.lessonsMap[s.lesson_id] || s.lesson_id}
                </td>
                <td><span class="summary-status ${s.status}">${s.status==='submitted' ? 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' : 'Ù…Ø³ÙˆØ¯Ø©'}</span></td>
                <td>${s.mark_from_student_marks || "â€”"}</td>
                <td>
                    ${isSubmitted ? `
                        <button class="btn reset-summary" onclick="resetSummary('${s.docId}', '${currentStudentEmailForSummaries}')" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø¥Ù„Ù‰ Ù…Ø³ÙˆØ¯Ø©">
                            ğŸ”„
                        </button>
                    ` : 'â€”'}
                </td>
            </tr>`;
        });
        html += "</tbody></table></div>";
        document.getElementById('summariesTableWrapper').innerHTML = html;
        hideSummaryDetails();
    }

// Function to show and populate the inline summary details box
function showSummaryDetails(docId) {
    const summary = window.studentSummariesMap[docId];
    if (!summary) {
        showToast("ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ„Ø®ÙŠØµ.", "#e63946");
        return;
    }

    const lessonTitle = window.lessonsMap[summary.lesson_id] || summary.lesson_id;
    const summaryDetailsBox = document.getElementById('summaryDetailsBox');

    document.getElementById('summaryDetailsTitle').innerText = `ØªÙØ§ØµÙŠÙ„ ØªÙ„Ø®ÙŠØµ Ø§Ù„Ø¯Ø±Ø³: ${lessonTitle}`;
    document.getElementById('summaryDetailsContent').innerText = summary.summary_text;
    document.getElementById('summaryDetailsComment').value = summary.teacher_comment || '';
    document.getElementById('summaryDetailsMark').value = summary.mark_from_student_marks || '';

    // Populate student reply section
    const studentReplySection = document.getElementById('studentReplySection');
    const summaryDetailsStudentReply = document.getElementById('summaryDetailsStudentReply');
    const clearStudentReplyBtn = document.getElementById('clearStudentReplyBtn');

    if (summary.student_reply_comment) {
        summaryDetailsStudentReply.innerText = summary.student_reply_comment;
        studentReplySection.style.display = 'block';
        clearStudentReplyBtn.dataset.docId = docId; // Set docId for clearing
        clearStudentReplyBtn.onclick = () => clearStudentReply(docId); // Attach event listener
    } else {
        studentReplySection.style.display = 'none';
        summaryDetailsStudentReply.innerText = '';
    }

    // Set dataset for save buttons
    document.getElementById('saveSummaryDetailsCommentBtn').dataset.docId = docId;
    document.getElementById('saveSummaryDetailsMarkBtn').dataset.docId = docId;

    // Remove existing listeners to prevent duplicates and add new ones
    const saveCommentBtn = document.getElementById('saveSummaryDetailsCommentBtn');
    const saveMarkBtn = document.getElementById('saveSummaryDetailsMarkBtn');

    saveCommentBtn.onclick = null;
    saveMarkBtn.onclick = null;

    saveCommentBtn.onclick = () => saveSummaryComment(saveCommentBtn.dataset.docId);
    saveMarkBtn.onclick = () => saveSummaryMark(saveMarkBtn.dataset.docId);

    summaryDetailsBox.style.display = 'block';
    summaryDetailsBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Function to hide the inline summary details box
function hideSummaryDetails() {
    document.getElementById('summaryDetailsBox').style.display = 'none';
}

// Function to clear student's reply
function clearStudentReply(docId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø±Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
        return;
    }

    showLoading(true);
    firestore.collection('summaries').doc(docId).update({
        student_reply_comment: firebase.firestore.FieldValue.delete()
    }).then(() => {
        showToast('ØªÙ… Ù…Ø³Ø­ Ø±Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', '#1dad87');
        // No need to call loadStudentSummaries here, listener will handle refresh
    }).catch(error => {
        showToast(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø±Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨: ${error.message}`, '#e63946');
        console.error('Error clearing student reply:', error);
        showLoading(false);
    });
}


// Ø­ÙØ¸ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙ„Ø®ÙŠØµ
function saveSummaryMark(docId) {
  let val = document.getElementById('summaryDetailsMark').value;

  // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„Ø®ÙŠØµ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„ØªÙ‡
  firestore.collection('summaries').doc(docId).get().then(summaryDoc => {
    if (!summaryDoc.exists) {
      showToast("Ø®Ø·Ø£: Ø§Ù„ØªÙ„Ø®ÙŠØµ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "#e63946");
      return;
    }

    const summaryData = summaryDoc.data();
    if (summaryData.status === "draft") {
      showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù„ØªÙ„Ø®ÙŠØµ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©. ÙŠØ¬Ø¨ ØªØ³Ù„ÙŠÙ…Ù‡ Ø£ÙˆÙ„Ø§Ù‹.", "#e63946");
      return;
    }

    const studentName = document.getElementById('detailName').textContent || '';
    const studentEmail = document.getElementById('detailEmail').textContent || '';
    const courseNumber = document.getElementById('detailCourseNumber').textContent || '';

    const lessonTitle = window.lessonsMap[summaryData.lesson_id] || summaryData.lesson_id;
    const statusText = summaryData.status === 'submitted' ? 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' : 'Ù…Ø³ÙˆØ¯Ø©';

    const user = firebase.auth().currentUser;
    if (!user) {
      showToast("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ! ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.", "#e63946");
      return;
    }

    firestore.collection('users').doc(user.uid).get().then(userDoc => {
      const dataToAdd = {
        summary_id: docId,
        student_name: studentName,
        student_email: studentEmail,
        course_number: courseNumber,
        lesson_title: lessonTitle,
        status: statusText,
        mark: Number(val)
      };

      firestore.collection('student_marks')
        .where('student_email', '==', studentEmail)
        .where('summary_id', '==', docId)
        .limit(1)
        .get().then(querySnapshot => {
          if (!querySnapshot.empty) {
            const docRef = querySnapshot.docs[0].ref;
            docRef.update(dataToAdd).then(() => {
              showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!', "#1dad87");
              // No need to call loadStudentSummaries here, listener will handle refresh
            }).catch((err) => {
              showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø©:\n' + err.message, "#e63946");
              console.error(err);
            });
          } else {
            firestore.collection('student_marks').add(dataToAdd).then(() => {
              showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©!', "#1dad87");
              // No need to call loadStudentSummaries here, listener will handle refresh
            }).catch((err) => {
              showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©:\n' + err.message, "#e63946");
              console.error(err);
            });
          }
        }).catch((err) => {
          showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø©:\n' + err.message, "#e63946");
          console.error(err);
        });

    }).catch(err => {
      showToast("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ users:\n" + err.message, "#e63946");
      console.error(err);
    });
  }).catch(err => {
    showToast("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„Ø®ÙŠØµ:\n" + err.message, "#e63946");
    console.error(err);
  });
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù„Ù… Ø¹Ù„Ù‰ Ø§Ù„ØªÙ„Ø®ÙŠØµ
function saveSummaryComment(docId) {
    const comment = document.getElementById('summaryDetailsComment').value.trim();

    firestore.collection('summaries').doc(docId).update({
        teacher_comment: comment
    }).then(() => {
        showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!', '#1dad87');
        // No need to call loadStudentSummaries here, listener will handle refresh
    }).catch(err => {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: ' + err.message, '#e63946');
        console.error('Error saving summary comment:', err);
    });
}


// New function to reset summary status
window.resetSummary = function(summaryDocId, studentEmail) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø¥Ù„Ù‰ Ù…Ø³ÙˆØ¯Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙˆØ±Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡.')) {
        return;
    }

    showLoading(true);
    // Update summary status to 'draft'
    firestore.collection('summaries').doc(summaryDocId).update({
        status: 'draft',
        teacher_comment: firebase.firestore.FieldValue.delete(),
        student_reply_comment: firebase.firestore.FieldValue.delete()
    }).then(() => {
        // Find and delete the corresponding mark in student_marks collection
        return firestore.collection('student_marks')
            .where('summary_id', '==', summaryDocId)
            .where('student_email', '==', studentEmail)
            .get();
    }).then(markSnapshot => {
        if (!markSnapshot.empty) {
            const deletePromises = [];
            markSnapshot.forEach(doc => {
                deletePromises.push(doc.ref.delete());
            });
            return Promise.all(deletePromises);
        }
        return Promise.resolve(); // No mark to delete
    }).then(() => {
        showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù…Ø³ÙˆØ¯Ø©!', '#1dad87');
        // No need to call loadStudentSummaries here, listener will handle refresh
        hideSummaryDetails();
        showLoading(false);
    }).catch(error => {
        showToast(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ„Ø®ÙŠØµ: ${error.message}`, '#e63946');
        console.error('Error resetting summary:', error);
        showLoading(false);
    });
};


    function logout() {
      // Unsubscribe from listener before logging out
      if (teacherSummariesListenerUnsubscribe) {
        teacherSummariesListenerUnsubscribe();
        teacherSummariesListenerUnsubscribe = null;
      }
      auth.signOut().then(()=>{window.location.href='login.html';}).catch(function(error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", error);
      });
    }

  </script>
</body>
</html>
