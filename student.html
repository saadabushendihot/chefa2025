<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة الطالب - شفاء</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal','Cairo',Arial,sans-serif; margin: 0; background: #f8fafc;}
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display:flex; justify-content:space-between; align-items:center;}
    .container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px #0001;}
    h2 { color: #4361ee; margin-top:0;}
    .btn { background: #4361ee; color: #fff; border: none; padding: 7px 22px; border-radius: 5px; font-size: 1rem; cursor: pointer;}
    .btn[disabled] {background: #bdbdbd; color: #fff; cursor: not-allowed;}
    .btn.submit {background: #1dad87;}
    .signout {background:#e63946;}
    .info { background: #f5f7fb; border-radius: 7px; padding: 10px 18px; margin: 16px 0;}
    #msg { color: #e63946; margin-top: 20px; }
    .levels-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 26px;
      margin-bottom: 12px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px #0001;
    }
    .levels-table th, .levels-table td  {
      padding: 10px 6px;
      border-bottom:1px solid #e4e7ef;
      text-align:center;
      font-size: 1rem;
      background:#fff;
    }
    .levels-table th  {
      background:#eef2fa;
      color:#1b3e72;
      font-weight: bold;
    }
    .level-on {color: #219e4b; font-weight: bold;}
    .level-off {color: #e63946; font-weight: bold;}
    .exam-label {
      display: inline-block;
      padding: 3px 14px;
      border-radius: 18px;
      font-size: 1rem;
      font-weight: bold;
      background: #e3f6ed;
      color: #219e4b;
      border: 1px solid #b7eecd;
      box-shadow: 0 1px 4px #219e4b12;
      min-width: 90px;
    }
    .exam-label.fail {
      background: #ffecec;
      color: #e63946;
      border: 1px solid #ffbcbc;
      box-shadow: 0 1px 4px #e6394612;
    }
    .exam-label.wait {
      background: #f5f7fb;
      color: #555;
      border: 1px solid #d2d8e6;
    }
    .levels-table tr:last-child td { border-bottom: none; }
    .exam-title { font-weight: bold; color: #294169;}
    #examWarnMsg {color:#e63946;font-weight:bold;margin:10px 0 15px 0;text-align:center;}
    /* جدول الدروس */
    #lessonsSummariesArea table {
      width:100%;border-collapse:collapse;background:#fbfdff;border-radius:8px;box-shadow:0 1px 4px #0001;
      margin-top:18px;
    }
    #lessonsSummariesArea th,#lessonsSummariesArea td {
      padding:8px 4px;text-align:center;font-size:1rem;border-bottom:1px solid #eee;
    }
    #lessonsSummariesArea th {background:#eef2fa;color:#1b3e72;}
    #lessonsSummariesArea tr:last-child td {border-bottom:none;}
    .summary-status {font-weight:bold; font-size:0.95rem;}
    .summary-status.draft { color: #e6a100;}
    .summary-status.submitted { color: #219e4b;}
    @media (max-width: 900px){
      .container{padding:8px;}
      header {padding:10px;}
      .levels-table th, .levels-table td,
      #lessonsSummariesArea th, #lessonsSummariesArea td {padding: 7px 2px;}
    }
  </style>
</head>
<body>
  <header>
    <span>لوحة الطالب</span>
    <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">
    <h2>مرحباً، <span id="studentName"></span></h2>
    <div class="info">
      <div><b>البريد الإلكتروني:</b> <span id="studentEmail"></span></div>
      <div><b>اسم الطالب:</b> <span id="studentNameInfo"></span></div>
      <div><b>رقم المقرر:</b> <span id="courseNumber"></span></div>
    </div>
    <div id="admissionStatusBox" class="admission-status-box admission-pending" style="display:none;"></div>
    <div id="msg"></div>
    <table class="levels-table" id="levelsTable" style="display:none;">
      <thead>
        <tr>
          <th>المستوى</th>
          <th>حالة التفعيل</th>
          <th>حالة الامتحان</th>
          <th>الانتقال للاختبار</th>
        </tr>
      </thead>
      <tbody id="levelsBody"></tbody>
    </table>
    <div id="examWarnMsg"></div>
    <div id="lessonsSummariesArea"></div>
    <div id="examBox" style="display:none; margin-top:30px;">
      <div class="student-info" id="examStudentInfo"></div>
      <div class="level-info" id="examLevelInfo"></div>
      <h2>أسئلة الاختبار</h2>
      <form id="examForm">
        <div id="questionsArea"></div>
        <div class="msg" id="formMsg"></div>
        <button type="submit" class="btn">إرسال الإجابات</button>
        <button type="button" class="btn signout" id="exitExamBtn" style="margin-right:8px;">خروج من الاختبار</button>
      </form>
      <div class="result" id="resultArea"></div>
    </div>
  </div>
  <script>
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();
    var currentStudentEmail = "";
    var currentStudentName = "";
    var lastActiveLevel = null;
    var lastActiveLevelIndex = null;
    let currentExamLevel = null;

    // --- أدوات جلب المستويات والدروس والتلاخيص ---
    function getLevelText(index) {
      const names = ["", "الأول", "الثاني", "الثالث", "الرابع", "الخامس", "السادس", "السابع"];
      return names[index] || "";
    }
    function getAllowedLevels(data) {
      let allowed = [];
      for(let i=1; i<=7; i++){
        if(data['level'+i]) allowed.push(i);
      }
      return allowed;
    }
    function getLevelNumber(levelName) {
      switch (levelName.replace('المستوى ', '').replace('ال', '')) {
        case "أول": case "الأول": return 1;
        case "ثاني": case "الثاني": return 2;
        case "ثالث": case "الثالث": return 3;
        case "رابع": case "الرابع": return 4;
        case "خامس": case "الخامس": return 5;
        case "سادس": case "السادس": return 6;
        case "سابع": case "السابع": return 7;
        case "1": return 1; case "2": return 2; case "3": return 3; case "4": return 4; case "5": return 5; case "6": return 6; case "7": return 7;
        default: return 0;
      }
    }
    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists) {
            if (doc.data().role !== "student") {
              window.location.href = "dashboard.html";
              return;
            }
            loadStudentData(doc.data().email, doc.data().name);
          } else {
            firestore.collection('users').doc(user.uid).set({
              email: user.email, role: "student"
            }).then(function() { window.location.reload(); });
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function loadStudentData(userEmail, userNameFromUserDoc) {
      currentStudentEmail = userEmail;
      firestore.collection('lectures').where('email', '==', userEmail).get().then(function(querySnapshot) {
        if (querySnapshot.empty) {
          document.getElementById('msg').innerText = "لا توجد بيانات لهذا المستخدم في النظام. تواصل مع الإدارة.";
        } else {
          var data = querySnapshot.docs[0].data();
          currentStudentName = data.name || userNameFromUserDoc || "";
          document.getElementById('studentName').innerText = currentStudentName;
          document.getElementById('studentNameInfo').innerText = currentStudentName;
          document.getElementById('studentEmail').innerText = userEmail || "";
          document.getElementById('courseNumber').innerText = data.course_number || "";
          document.getElementById('msg').innerText = "";
          document.getElementById('levelsBody').innerHTML = "";
          document.getElementById('levelsTable').style.display = "none";
          document.getElementById('admissionStatusBox').style.display = "none";
          document.getElementById('lessonsSummariesArea').innerHTML = "";

          var admissionBox = document.getElementById('admissionStatusBox');
          var status = data.accepted;
          let isAccepted = (status === true || status === "مقبول" || status === "accepted");
          let isRejected = (status === false || status === "مرفوض" || status === "rejected");

          admissionBox.style.display = "block";
          if (typeof status !== "undefined") {
            if (isAccepted) {
              admissionBox.className = "admission-status-box admission-accepted";
              admissionBox.innerText = "تم قبولك في الدورة ✅";
              document.getElementById('levelsTable').style.display = "";
            } else if (isRejected) {
              admissionBox.className = "admission-status-box admission-rejected";
              admissionBox.innerText = "عذراً، لم يتم قبولك في الدورة.";
              document.getElementById('levelsTable').style.display = "none";
            } else {
              admissionBox.className = "admission-status-box admission-pending";
              admissionBox.innerText = "طلبك قيد المراجعة...";
              document.getElementById('levelsTable').style.display = "none";
            }
          } else {
            admissionBox.className = "admission-status-box admission-pending";
            admissionBox.innerText = "طلبك قيد المراجعة...";
            document.getElementById('levelsTable').style.display = "none";
          }

          loadLevelsAndLessons(data);
        }
      }).catch(function(err) {
        document.getElementById('msg').innerText = "خطأ في جلب البيانات: " + err.message;
      });
    }

    function loadLevelsAndLessons(data) {
      // تحميل معلومات الامتحانات لكل مستوى
      let levelsData = [];
      for (let i = 1; i <= 7; i++) {
        levelsData.push({
          index: i,
          name: getLevelText(i),
          activated: !!data['level'+i],
          exam: data['exam'+i] // true/false/undefined
        });
      }

      // جلب دروس وتلاخيص كل مستوى
      firestore.collection('lessons').orderBy('id').get().then(function(querySnapshot) {
        let allLessons = [];
        querySnapshot.forEach(function(doc) {
          allLessons.push(doc.data());
        });
        firestore.collection('summaries')
          .where('student_email', '==', currentStudentEmail)
          .get()
          .then(function(summarySnapshot){
            let summariesMap = {};
            summarySnapshot.forEach(function(doc){
              let s = doc.data();
              summariesMap[s.lesson_id] = { ...s, docId: doc.id };
            });

            renderUnifiedLevelsTable(levelsData, allLessons, summariesMap, data);
          });
      });
    }

    function renderUnifiedLevelsTable(levelsData, allLessons, summariesMap, userData) {
      let html = "";
      let lastActiveIdx = 0;
      levelsData.forEach(lvl => { if(lvl.activated) lastActiveIdx = lvl.index; });
      levelsData.forEach(lvl => {
        // حالة التفعيل
        let activateHtml = lvl.activated ? '<span class="level-on">مُفعل ✅</span>' : '<span class="level-off">غير مفعل ❌</span>';
        // حالة الامتحان
        let examHtml = '';
        if (lvl.exam === true) examHtml = `<span class="exam-label">✅ اجتاز الامتحان</span>`;
        else if (lvl.exam === false) examHtml = `<span class="exam-label fail">❌ لم يجتز الامتحان</span>`;
        else examHtml = `<span class="exam-label wait">—</span>`;
        // زر اختبار المستوى الأخير المفعّل فقط
        let btn = '';
        if(lvl.index === lastActiveIdx && lvl.activated) btn = `<button class="btn" id="goToExamBtn" style="padding:3px 16px;">الانتقال للاختبار</button>`;
        html += `<tr>
          <td>المستوى ${lvl.index}</td>
          <td>${activateHtml}</td>
          <td>${examHtml}</td>
          <td>${btn}</td>
        </tr>`;
      });
      document.getElementById('levelsBody').innerHTML = html;

      // زر اختبار المستوى: تحقق من إظهار أو إخفاء بناءً على شرط التلاخيص
      document.getElementById('examWarnMsg').innerText = '';
      if(lastActiveIdx) {
        let levelText = getLevelText(lastActiveIdx);
        let lessons = allLessons.filter(l => l.level === levelText);
        let lessonIds = lessons.map(l=>l.id);
        let validSummaries = 0;
        lessons.forEach(lesson => {
          let sum = summariesMap[lesson.id] || {};
          let mark = (typeof sum.mark !== 'undefined' && sum.mark !== null) ? sum.mark : ((typeof sum.Mark !== 'undefined' && sum.Mark !== null) ? sum.Mark : undefined);
          if(sum.status === 'submitted' && typeof mark !== 'undefined') validSummaries++;
        });
        let btn = document.getElementById('goToExamBtn');
        if(!lessonIds.length) {
          if(btn) btn.style.display = "none";
          document.getElementById('examWarnMsg').innerText = 'لا توجد دروس في هذا المستوى.';
        } else if(validSummaries !== lessons.length) {
          if(btn) btn.style.display = "none";
          document.getElementById('examWarnMsg').innerText = 'لا يمكن تقديم الاختبار';
        } else {
          if(btn) {
            btn.style.display = "";
            btn.onclick = function(){
              currentExamLevel = lastActiveIdx;
              checkIfExamAlreadySubmitted(currentStudentEmail, currentExamLevel);
              setTimeout(function(){
                document.getElementById('examBox').scrollIntoView({behavior: 'smooth'});
              }, 300);
            };
          }
        }
        renderLessonsTable(lessons, summariesMap);
      } else {
        renderLessonsTable([], {});
      }
    }

    function renderLessonsTable(lessons, summariesMap) {
      let html = `<h3 style="color:#4361ee; margin-bottom:10px;">دروس المستوى الحالي</h3>
        <table>
          <thead>
            <tr>
              <th>رقم الدرس</th>
              <th>عنوان الدرس</th>
              <th>حالة التلخيص</th>
              <th>العلامة</th>
            </tr>
          </thead>
          <tbody>
      `;
      lessons.forEach(lesson => {
        let s = summariesMap[lesson.id] || {};
        let status = s.status || 'لم يُسلم';
        let mark = (typeof s.mark !== 'undefined' && s.mark !== null)
          ? s.mark
          : ((typeof s.Mark !== 'undefined' && s.Mark !== null) ? s.Mark : '—');
        html += `<tr>
          <td>${lesson.id}</td>
          <td>${lesson.title}</td>
          <td class="summary-status ${status}">${status === 'submitted' ? 'تم التسليم' : 'لم يُسلم'}</td>
          <td>${mark}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById('lessonsSummariesArea').innerHTML = html;
    }

    // --- كود الامتحان والأسئلة والحساب والتسليم ---
    let examQuestions = [];
    let randomizedExamQuestions = [];
    let examQuestionsLimit = null;

    function checkIfExamAlreadySubmitted(email, level) {
      firestore.collection('exam_results')
        .where('student_email', '==', email)
        .where('level', '==', level)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            let data = querySnapshot.docs[0].data();
            showExamResultOnly(data);
          } else {
            showExamBox(currentStudentName, currentStudentEmail, currentExamLevel);
          }
        });
    }

    function showExamResultOnly(result) {
      document.getElementById('examBox').style.display = '';
      document.getElementById('questionsArea').innerHTML = '';
      document.getElementById('formMsg').innerText = '';
      document.getElementById('examStudentInfo').innerHTML =
        `<b>اسم الطالب:</b> ${currentStudentName} &nbsp; | &nbsp; <b>الإيميل:</b> ${currentStudentEmail} &nbsp; | &nbsp; <b>المستوى الحالي:</b> المستوى ${result.level}`;
      document.getElementById('examLevelInfo').innerText = '';
      document.getElementById('resultArea').innerHTML = `<div style="font-size:1.3rem;color:#e63946;font-weight:bold;">
        لقد سبق لك تقديم اختبار هذا المستوى.<br>درجتك: ${result.score} من ${result.total}
        </div>`;
      var btn = document.getElementById('goToExamBtn');
      if(btn) btn.style.display = "none";
      document.querySelector("button[type=submit]").style.display = "none";
      document.getElementById('exitExamBtn').style.display = "none";
    }

    function showExamBox(studentName, studentEmail, level) {
      document.getElementById('examBox').style.display = '';
      document.getElementById('examStudentInfo').innerHTML =
        `<b>اسم الطالب:</b> ${studentName} &nbsp; | &nbsp; <b>الإيميل:</b> ${studentEmail} &nbsp; | &nbsp; <b>المستوى الحالي:</b> المستوى ${getLevelText(level)}`;

      firestore.collection('exam_settings').doc('level_' + level).get().then(function(settingDoc){
        if(settingDoc.exists && settingDoc.data().question_num){
          examQuestionsLimit = settingDoc.data().question_num;
          document.getElementById('examLevelInfo').innerText =
            `عدد الأسئلة المخصصة لهذا المستوى: ${examQuestionsLimit}`;
        } else {
          examQuestionsLimit = null;
          document.getElementById('examLevelInfo').innerText =
            'لم يتم تحديد عدد الأسئلة لهذا المستوى (سيتم عرض جميع الأسئلة).';
        }
        loadExamQuestions(level);
      });

      document.getElementById('formMsg').innerText = '';
      document.getElementById('resultArea').innerText = '';
      document.querySelector("button[type=submit]").style.display = "";
      document.getElementById('exitExamBtn').style.display = "";
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function loadExamQuestions(level) {
      firestore.collection('questions').where('level', '==', level).get().then(snap=>{
        examQuestions = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
        prepareRandomizedExam();
        renderExamQuestions();
      });
    }

    function prepareRandomizedExam() {
      let shuffled = shuffleArray(examQuestions.map(q => {
        let choiceObjs = (q.choices||[]).map((choice, idx) => ({
          text: choice,
          origIndex: idx
        }));
        let shuffledChoices = shuffleArray(choiceObjs);
        let newCorrect = [];
        shuffledChoices.forEach((ch, ix) => {
          if(q.correct && q.correct.includes(ch.origIndex)) newCorrect.push(ix);
        });
        return {
          ...q,
          choices: shuffledChoices.map(c => c.text),
          correct: newCorrect
        };
      }));
      randomizedExamQuestions = examQuestionsLimit ? shuffled.slice(0, examQuestionsLimit) : shuffled;
    }

    function renderExamQuestions() {
      let html = '';
      randomizedExamQuestions.forEach((q, i) => {
        let multiNote = '';
        let scoringNote = '';
        if (q.correct.length > 1) {
          multiNote = '<span class="multi-note">(يحتمل أكثر من إجابة صحيحة)</span>';
          scoringNote = `<div class="scoring-note">
          ملاحظة: لكل إجابة صحيحة تختارها تحصل على جزء من العلامة، ولكل إجابة خاطئة تختارها يُخصم نفس الجزء من العلامة. لا يمكن أن تقل علامة السؤال عن الصفر.
          </div>`;
        }
        let markText = `<span class="question-mark">[العلامة: ${q.mark || 1}]</span>`;
        html += `<div class="question-block">
          <div class="question-title">${i+1}. ${q.question} ${multiNote} ${markText}</div>
          <div class="choices-list">` +
          (q.choices||[]).map((choice, idx) =>
            `<div class="choice-row">
              <label>
                <input type="${q.correct.length>1?'checkbox':'radio'}" name="q${i}" value="${idx}">
                ${choice}
              </label>
            </div>`
          ).join('') +
          `</div>
          ${scoringNote}
        </div>`;
      });
      document.getElementById('questionsArea').innerHTML = html || '<div class="msg">لا توجد أسئلة حالياً.</div>';
    }

    document.getElementById('examForm').onsubmit = function(e){
      e.preventDefault();
      let totalMark = 0, gainedMark = 0, empty = 0;
      let details = [];
      randomizedExamQuestions.forEach((q, i) => {
        let nodes = document.getElementsByName('q'+i);
        let selected = [];
        nodes.forEach(input => { if(input.checked) selected.push(parseInt(input.value)); });

        let mark = parseFloat(q.mark) || 1;
        totalMark += mark;

        if (selected.length===0) { empty++; return; }

        details.push({
          question_id: q.id,
          selected: selected,
          correct: q.correct
        });

        if(q.correct.length > 1) {
          let perMark = mark / q.correct.length;
          let countCorrect = 0;
          let countWrong = 0;
          selected.forEach(val => {
            if(q.correct.includes(val)) countCorrect++;
            else countWrong++;
          });
          let gained = (countCorrect - countWrong) * perMark;
          if(gained < 0) gained = 0;
          gainedMark += gained;
        }
        else {
          if(selected.length === 1 && q.correct.includes(selected[0])) gainedMark += mark;
        }
      });
      if (empty>0) {
        showFormMsg('يرجى الإجابة على جميع الأسئلة!');
        return;
      }
      gainedMark = Math.round(gainedMark * 100) / 100;

      firestore.collection('exam_results')
        .where('student_email', '==', currentStudentEmail)
        .where('level', '==', currentExamLevel)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            showExamResultOnly(querySnapshot.docs[0].data());
            return;
          }

          const resultDoc = {
            student_email: currentStudentEmail,
            student_name: currentStudentName,
            level: currentExamLevel,
            score: gainedMark,
            total: totalMark,
            details: details,
            submitted_at: firebase.firestore.Timestamp.now(),
            teacher_reviewed: false,
            approved: null
          };

          firestore.collection('exam_results').add(resultDoc)
            .then((docRef) => {
              document.getElementById('questionsArea').innerHTML = '';
              document.getElementById('formMsg').innerText = '';
              document.getElementById('resultArea').innerHTML = `<div style="font-size:1.3rem;color:#219e4b;font-weight:bold;">
                تم حفظ نتيجتك بنجاح! درجتك: ${gainedMark} من ${totalMark}
                </div>`;
              document.querySelector("button[type=submit]").style.display = "none";
              document.getElementById('exitExamBtn').style.display = "none";
              var btn = document.getElementById('goToExamBtn');
              if(btn) btn.style.display = "none";
            })
            .catch((error) => {
              showResult(`درجتك: ${gainedMark} من ${totalMark}`);
              showFormMsg('حدث خطأ أثناء حفظ النتيجة: ' + error.message);
            });

          showFormMsg('');
        });
    };

    function showFormMsg(msg) {
      document.getElementById('formMsg').innerText = msg;
    }
    function showResult(msg) {
      document.getElementById('resultArea').innerText = msg;
    }

    document.getElementById('exitExamBtn').onclick = function(){
      document.getElementById('examBox').style.display = 'none';
      document.getElementById('questionsArea').innerHTML = "";
      document.getElementById('formMsg').innerText = "";
      document.getElementById('resultArea').innerText = "";
    };

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }
  </script>
</body>
</html>
