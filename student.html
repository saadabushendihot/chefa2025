<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ - Ø´ÙØ§Ø¡</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal','Cairo',Arial,sans-serif; margin: 0; background: #f8fafc;}
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display:flex; justify-content:space-between; align-items:center;}
    .container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px #0001;}
    h2 { color: #4361ee; margin-top:0;}
    .btn { background: #4361ee; color: #fff; border: none; padding: 7px 22px; border-radius: 5px; font-size: 1rem; cursor: pointer;}
    .btn[disabled] {background: #bdbdbd; color: #fff; cursor: not-allowed;}
    .btn.submit {background: #1dad87;}
    .signout {background:#e63946;}
    .info { background: #f5f7fb; border-radius: 7px; padding: 10px 18px; margin: 16px 0;}
    #msg { color: #e63946; margin-top: 20px; }
    .levels-table, .exams-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 26px;
      margin-bottom: 12px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px #0001;
    }
    .levels-table th, .levels-table td,
    .exams-table th, .exams-table td {
      padding: 10px 6px;
      border-bottom:1px solid #e4e7ef;
      text-align:center;
      font-size: 1rem;
    }
    .levels-table th, .exams-table th {
      background:#eef2fa;
      color:#1b3e72;
      font-weight: bold;
    }
    .level-on {color: #219e4b; font-weight: bold;}
    .level-off {color: #e63946; font-weight: bold;}
    .exam-status {font-weight:bold;}
    .exam-success {color:#219e4b;}
    .exam-fail {color:#e63946;}
    .exam-label {
      display: inline-block;
      padding: 3px 14px;
      border-radius: 18px;
      font-size: 1rem;
      font-weight: bold;
      background: #e3f6ed;
      color: #219e4b;
      border: 1px solid #b7eecd;
      box-shadow: 0 1px 4px #219e4b12;
      min-width: 90px;
    }
    .exam-label.fail {
      background: #ffecec;
      color: #e63946;
      border: 1px solid #ffbcbc;
      box-shadow: 0 1px 4px #e6394612;
    }
    .exam-label.wait {
      background: #f5f7fb;
      color: #555;
      border: 1px solid #d2d8e6;
    }
    .exams-table tr:last-child td,
    .levels-table tr:last-child td { border-bottom: none; }
    .exam-title { font-weight: bold; color: #294169;}
    .exams-title-bar {
      font-size: 1.16rem;
      background: #f7faff;
      padding: 8px 0 8px 0;
      border-radius: 10px 10px 0 0;
      color: #2260af;
      margin-bottom:0;
      border-bottom: 2px solid #e4e7ef;
      font-weight:bold;
      text-align:center;
      letter-spacing: 1px;
    }
    .exams-table {
      margin-bottom: 26px;
      margin-top: 18px;
    }
    #examBox {background:#f8fafc;border-radius:12px;padding:28px 20px;box-shadow:0 2px 10px #0002;}
    .student-info {background:#eaf7e4;padding:12px 18px;border-radius:9px;margin-bottom:20px;display:inline-block;font-size:1.1em;}
    .level-info {background:#e6f2ff;padding:10px 16px;border-radius:8px;font-size:1.08em;margin-bottom:20px;display:inline-block;}
    .question-block {background:#f8fafc;border-radius:10px;padding:14px 12px;margin:18px 0 30px 0;box-shadow:0 2px 8px #e4e7ef44;}
    .question-title {font-weight:bold;margin-bottom:9px;}
    .multi-note {color:#b96d0d;font-size:0.98em;margin-right:6px;}
    .question-mark {color:#2260af;margin-right:12px;}
    .choices-list {margin-bottom:10px;}
    .choice-row {margin-bottom:6px;}
    .msg {color:#e63946;margin-bottom:16px;}
    .result {font-size:1.3rem;color:#219e4b;font-weight:bold;text-align:center;}
    .scoring-note {color:#007b8f;font-size:0.95em;margin-top:5px;}
    #examForm .btn {margin-left:6px;}
    #examForm .btn.signout {background:#b83b3b;}
    @media (max-width:900px){#examBox{padding:7px;}}
    @media (max-width: 900px){
      .container{padding:8px;}
      header {padding:10px;}
      .levels-table th, .levels-table td,
      .exams-table th, .exams-table td {padding: 7px 2px;}
      .lesson-summary-block{padding:10px 4px;}
      textarea.summary-text {width:96%;}
      .lesson-summary-block audio {width:100%!important;}
    }
    .lesson-summary-block {background: #f5f7fb; border-radius: 10px; margin: 18px 0 28px 0; padding: 18px 14px; box-shadow: 0 2px 6px #e0e7ef33;}
    .lesson-summary-block h4 {margin:0 0 8px 0; color:#1b3e72;}
    .lesson-link {color:#4361ee; text-decoration:none;}
    .summary-actions {margin-top: 8px;}
    .summary-status {font-weight:bold; font-size:0.95rem; margin-right:8px;}
    .summary-status.draft { color: #e6a100;}
    .summary-status.submitted { color: #219e4b;}
    .lesson-student-name {font-size:1rem; color:#888; margin-bottom:7px;}
    textarea.summary-text {
      width:98%;height:80px;padding:8px;border-radius:5px;border:1px solid #b7c0d6;
      resize:vertical;font-size:1.08rem; box-sizing: border-box; background:#fff;
      font-family: 'Cairo','Tajawal',Arial,sans-serif; color: #1b2a39; line-height: 1.7;
      transition: border 0.15s; direction: rtl;
    }
    textarea.summary-text:focus {border-color: #4361ee;}
  </style>
</head>
<body>
  <header>
    <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</span>
    <button class="btn signout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </header>
  <div class="container">
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="studentName"></span></h2>
    <div class="info">
      <div><b>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</b> <span id="studentEmail"></span></div>
      <div><b>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</b> <span id="studentNameInfo"></span></div>
      <div><b>Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚Ø±Ø±:</b> <span id="courseNumber"></span></div>
    </div>
    <div id="admissionStatusBox" class="admission-status-box admission-pending" style="display:none;"></div>
    <div id="msg"></div>
    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª -->
    <table class="levels-table" id="levelsTable" style="display:none;">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody id="levelsBody"></tbody>
    </table>
    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ -->
    <div id="examsTableArea"></div>
    <!-- Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© -->
    <div class="exams-box" id="examsBox" style="display:none;">
      <div class="exams-title">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
      <div class="exam-row"><b>Ø§Ù…ØªØ­Ø§Ù† ØªØ´Ø®ÙŠØµÙŠ:</b> <span id="diagnosisExamMark"></span></div>
      <div class="exam-row"><b>Ø§Ù…ØªØ­Ø§Ù† 1:</b> <span id="exam1Mark"></span></div>
      <div class="exam-row"><b>Ø§Ù…ØªØ­Ø§Ù† Ø´ÙÙˆÙŠ:</b> <span id="oralExamMark"></span></div>
      <div class="exam-row"><b>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©:</b> <span id="fExam"></span></div>
    </div>
    <div id="lessonsSummariesArea"></div>
    <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¯Ù…Ø¬ -->
    <div id="examBox" style="display:none; margin-top:30px;">
      <div class="student-info" id="examStudentInfo"></div>
      <div class="level-info" id="examLevelInfo"></div>
      <h2>Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
      <form id="examForm">
        <div id="questionsArea"></div>
        <div class="msg" id="formMsg"></div>
        <button type="submit" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
        <button type="button" class="btn signout" id="exitExamBtn" style="margin-right:8px;">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
      </form>
      <div class="result" id="resultArea"></div>
    </div>
  </div>
  <script>
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();
    var currentStudentEmail = "";
    var currentStudentName = "";
    var lastActiveLevel = null;
    var lastActiveLevelIndex = null;

    // Ù…ØªØºÙŠØ±Ø§Øª ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    let examQuestions = [];
    let randomizedExamQuestions = [];
    let examQuestionsLimit = null;
    let currentExamLevel = null;

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function getLevelNumber(levelName) {
      switch (levelName.replace('Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ', '').replace('Ø§Ù„', '')) {
        case "Ø£ÙˆÙ„": case "Ø§Ù„Ø£ÙˆÙ„": return 1;
        case "Ø«Ø§Ù†ÙŠ": case "Ø§Ù„Ø«Ø§Ù†ÙŠ": return 2;
        case "Ø«Ø§Ù„Ø«": case "Ø§Ù„Ø«Ø§Ù„Ø«": return 3;
        case "Ø±Ø§Ø¨Ø¹": case "Ø§Ù„Ø±Ø§Ø¨Ø¹": return 4;
        case "Ø®Ø§Ù…Ø³": case "Ø§Ù„Ø®Ø§Ù…Ø³": return 5;
        case "Ø³Ø§Ø¯Ø³": case "Ø§Ù„Ø³Ø§Ø¯Ø³": return 6;
        case "Ø³Ø§Ø¨Ø¹": case "Ø§Ù„Ø³Ø§Ø¨Ø¹": return 7;
        case "1": return 1; case "2": return 2; case "3": return 3; case "4": return 4; case "5": return 5; case "6": return 6; case "7": return 7;
        default: return 0;
      }
    }

    function getAllowedLevels(data) {
      let allowed = [];
      for(let i=1; i<=7; i++){
        if(data['level'+i]) allowed.push(i);
      }
      return allowed;
    }

    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists) {
            if (doc.data().role !== "student") {
              window.location.href = "dashboard.html";
              return;
            }
            loadStudentData(doc.data().email, doc.data().name);
          } else {
            firestore.collection('users').doc(user.uid).set({
              email: user.email, role: "student"
            }).then(function() { window.location.reload(); });
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function loadStudentData(userEmail, userNameFromUserDoc) {
      currentStudentEmail = userEmail;
      firestore.collection('lectures').where('email', '==', userEmail).get().then(function(querySnapshot) {
        if (querySnapshot.empty) {
          document.getElementById('msg').innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.";
        } else {
          var data = querySnapshot.docs[0].data();
          currentStudentName = data.name || userNameFromUserDoc || "";
          document.getElementById('studentName').innerText = currentStudentName;
          document.getElementById('studentNameInfo').innerText = currentStudentName;
          document.getElementById('studentEmail').innerText = userEmail || "";
          document.getElementById('courseNumber').innerText = data.course_number || "";
          document.getElementById('msg').innerText = "";
          document.getElementById('levelsBody').innerHTML = "";
          document.getElementById('levelsTable').style.display = "none";
          document.getElementById('examsBox').style.display = "none";
          document.getElementById('admissionStatusBox').style.display = "none";
          document.getElementById('lessonsSummariesArea').innerHTML = "";
          document.getElementById('examsTableArea').innerHTML = "";

          var admissionBox = document.getElementById('admissionStatusBox');
          var status = data.accepted;
          let isAccepted = (status === true || status === "Ù…Ù‚Ø¨ÙˆÙ„" || status === "accepted");
          let isRejected = (status === false || status === "Ù…Ø±ÙÙˆØ¶" || status === "rejected");

          admissionBox.style.display = "block";
          if (typeof status !== "undefined") {
            if (isAccepted) {
              admissionBox.className = "admission-status-box admission-accepted";
              admissionBox.innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„Ùƒ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© âœ…";
              document.getElementById('levelsTable').style.display = "";
              document.getElementById('examsBox').style.display = "block";
            } else if (isRejected) {
              admissionBox.className = "admission-status-box admission-rejected";
              admissionBox.innerText = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„Ùƒ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©.";
              document.getElementById('levelsTable').style.display = "none";
              document.getElementById('examsBox').style.display = "none";
            } else {
              admissionBox.className = "admission-status-box admission-pending";
              admissionBox.innerText = "Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...";
              document.getElementById('levelsTable').style.display = "none";
              document.getElementById('examsBox').style.display = "none";
            }
          } else {
            admissionBox.className = "admission-status-box admission-pending";
            admissionBox.innerText = "Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...";
            document.getElementById('levelsTable').style.display = "none";
            document.getElementById('examsBox').style.display = "none";
          }

          // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ù…Ø¹ Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Øª Ø¢Ø®Ø± Ù…Ø³ØªÙˆÙ‰ Ù…ÙØ¹Ù‘Ù„
          let levelsHtml = '';
          lastActiveLevel = null;
          lastActiveLevelIndex = null;
          for (var i = 1; i <= 7; i++) {
            var level = data['level'+i];
            if(level) {
              lastActiveLevel = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ' + i;
              lastActiveLevelIndex = i;
            }
            levelsHtml += `<tr>
                <td>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${i}</td>
                <td class="${level ? 'level-on' : 'level-off'}">${level ? 'Ù…ÙÙØ¹Ù„ âœ…' : 'ØºÙŠØ± Ù…ÙØ¹Ù„ âŒ'}</td>
              </tr>`;
          }
          // Ø£Ø¶Ù Ø§Ù„Ø²Ø± ØªØ­Øª Ø¢Ø®Ø± Ù…Ø³ØªÙˆÙ‰ Ù…ÙØ¹Ù‘Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù‚Ø¨ÙˆÙ„Ù‹Ø§
          if(lastActiveLevelIndex && isAccepted){
            levelsHtml += `<tr>
              <td colspan="2" style="padding-top:18px;">
                <button class="btn" id="goToExamBtn">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø± ${lastActiveLevel}</button>
              </td>
            </tr>`;
          }
          document.getElementById('levelsBody').innerHTML = levelsHtml;
          document.getElementById('levelsTable').style.display = "";

          // Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ£Ø³Ù„ÙˆØ¨ Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
          if(lastActiveLevelIndex && isAccepted){
            setTimeout(function() {
              var btn = document.getElementById('goToExamBtn');
              if(btn){
                btn.onclick = function(){
                  currentExamLevel = lastActiveLevelIndex;
                  checkIfExamAlreadySubmitted(currentStudentEmail, currentExamLevel);
                  setTimeout(function(){
                    document.getElementById('examBox').scrollIntoView({behavior: 'smooth'});
                  }, 300);
                };
              }
            }, 100);
          }

          // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…Ù†ÙØµÙ„
          renderExamsTable(data);

          // Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
          let diagnosisMark = data.diagnosis_exam_mark || (data.diagnosis_exam ? 'Ù…ÙØ¬ØªØ§Ø²' : 'ØºÙŠØ± Ù…Ø¬ØªØ§Ø²');
          let exam1Mark = data.exam1_mark || (data.exam1 ? 'Ù…ÙØ¬ØªØ§Ø²' : 'ØºÙŠØ± Ù…Ø¬ØªØ§Ø²');
          let oralMark = data.oral_exam_mark || (data.oral_exam ? 'Ù…ÙØ¬ØªØ§Ø²' : 'ØºÙŠØ± Ù…Ø¬ØªØ§Ø²');
          let fMark = (typeof data.f !== "undefined" && data.f !== null && data.f !== "") ? data.f : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

          document.getElementById('diagnosisExamMark').innerText = diagnosisMark;
          document.getElementById('exam1Mark').innerText = exam1Mark;
          document.getElementById('oralExamMark').innerText = oralMark;
          document.getElementById('fExam').innerText = fMark;

          // Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø©
          let allowedLevels = getAllowedLevels(data);
          loadActiveLessonsAndSummaries(allowedLevels);
        }
      }).catch(function(err) {
        document.getElementById('msg').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message;
      });
    }

    // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‚Ø¯Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
    function checkIfExamAlreadySubmitted(email, level) {
      firestore.collection('exam_results')
        .where('student_email', '==', email)
        .where('level', '==', level)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            // ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ù† Ù‚Ø¨Ù„ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙ‚Ø·
            let data = querySnapshot.docs[0].data();
            showExamResultOnly(data);
          } else {
            // Ù„Ù… ÙŠÙ‚Ø¯Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¹Ø¯ØŒ Ø§Ø¹Ø±Ø¶ ÙÙˆØ±Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            showExamBox(currentStudentName, currentStudentEmail, currentExamLevel);
          }
        });
    }

    // Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    function showExamResultOnly(result) {
      document.getElementById('examBox').style.display = '';
      document.getElementById('questionsArea').innerHTML = '';
      document.getElementById('formMsg').innerText = '';
      document.getElementById('examStudentInfo').innerHTML =
        `<b>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</b> ${currentStudentName} &nbsp; | &nbsp; <b>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</b> ${currentStudentEmail} &nbsp; | &nbsp; <b>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${result.level}`;
      document.getElementById('examLevelInfo').innerText = '';
      document.getElementById('resultArea').innerHTML = `<div style="font-size:1.3rem;color:#219e4b;font-weight:bold;">
        Ù„Ù‚Ø¯ Ø³Ø¨Ù‚ Ù„Ùƒ ØªÙ‚Ø¯ÙŠÙ… Ø§Ø®ØªØ¨Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.<br>Ø¯Ø±Ø¬ØªÙƒ: ${result.score} Ù…Ù† ${result.total}
        </div>`;
    }

    // ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    function showExamBox(studentName, studentEmail, level) {
      document.getElementById('examBox').style.display = '';
      document.getElementById('examStudentInfo').innerHTML =
        `<b>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</b> ${studentName} &nbsp; | &nbsp; <b>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</b> ${studentEmail} &nbsp; | &nbsp; <b>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${level}`;

      firestore.collection('exam_settings').doc('level_' + level).get().then(function(settingDoc){
        if(settingDoc.exists && settingDoc.data().question_num){
          examQuestionsLimit = settingDoc.data().question_num;
          document.getElementById('examLevelInfo').innerText =
            `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${examQuestionsLimit}`;
        } else {
          examQuestionsLimit = null;
          document.getElementById('examLevelInfo').innerText =
            'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©).';
        }
        loadExamQuestions(level);
      });

      document.getElementById('formMsg').innerText = '';
      document.getElementById('resultArea').innerText = '';
    }

    function loadExamQuestions(level) {
      firestore.collection('questions').where('level', '==', level).get().then(snap=>{
        examQuestions = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
        prepareRandomizedExam();
        renderExamQuestions();
      });
    }

    function prepareRandomizedExam() {
      let shuffled = shuffleArray(examQuestions.map(q => {
        let choiceObjs = (q.choices||[]).map((choice, idx) => ({
          text: choice,
          origIndex: idx
        }));
        let shuffledChoices = shuffleArray(choiceObjs);
        let newCorrect = [];
        shuffledChoices.forEach((ch, ix) => {
          if(q.correct && q.correct.includes(ch.origIndex)) newCorrect.push(ix);
        });
        return {
          ...q,
          choices: shuffledChoices.map(c => c.text),
          correct: newCorrect
        };
      }));
      randomizedExamQuestions = examQuestionsLimit ? shuffled.slice(0, examQuestionsLimit) : shuffled;
    }

    function renderExamQuestions() {
      let html = '';
      randomizedExamQuestions.forEach((q, i) => {
        let multiNote = '';
        let scoringNote = '';
        if (q.correct.length > 1) {
          multiNote = '<span class="multi-note">(ÙŠØ­ØªÙ…Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©)</span>';
          scoringNote = `<div class="scoring-note">
          Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ØªØ®ØªØ§Ø±Ù‡Ø§ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø©ØŒ ÙˆÙ„ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© ØªØ®ØªØ§Ø±Ù‡Ø§ ÙŠÙØ®ØµÙ… Ù†ÙØ³ Ø§Ù„Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙ‚Ù„ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„ØµÙØ±.
          </div>`;
        }
        let markText = `<span class="question-mark">[Ø§Ù„Ø¹Ù„Ø§Ù…Ø©: ${q.mark || 1}]</span>`;
        html += `<div class="question-block">
          <div class="question-title">${i+1}. ${q.question} ${multiNote} ${markText}</div>
          <div class="choices-list">` +
          (q.choices||[]).map((choice, idx) =>
            `<div class="choice-row">
              <label>
                <input type="${q.correct.length>1?'checkbox':'radio'}" name="q${i}" value="${idx}">
                ${choice}
              </label>
            </div>`
          ).join('') +
          `</div>
          ${scoringNote}
        </div>`;
      });
      document.getElementById('questionsArea').innerHTML = html || '<div class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
    }

    // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    document.getElementById('examForm').onsubmit = function(e){
      e.preventDefault();
      let totalMark = 0, gainedMark = 0, empty = 0;
      let details = [];
      randomizedExamQuestions.forEach((q, i) => {
        let nodes = document.getElementsByName('q'+i);
        let selected = [];
        nodes.forEach(input => { if(input.checked) selected.push(parseInt(input.value)); });

        let mark = parseFloat(q.mark) || 1;
        totalMark += mark;

        if (selected.length===0) { empty++; return; }

        details.push({
          question_id: q.id,
          selected: selected,
          correct: q.correct
        });

        if(q.correct.length > 1) {
          let perMark = mark / q.correct.length;
          let countCorrect = 0;
          let countWrong = 0;
          selected.forEach(val => {
            if(q.correct.includes(val)) countCorrect++;
            else countWrong++;
          });
          let gained = (countCorrect - countWrong) * perMark;
          if(gained < 0) gained = 0;
          gainedMark += gained;
        }
        else {
          if(selected.length === 1 && q.correct.includes(selected[0])) gainedMark += mark;
        }
      });
      if (empty>0) {
        showFormMsg('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!');
        return;
      }
      gainedMark = Math.round(gainedMark * 100) / 100;

      // ØªØ­Ù‚Ù‚ Ø£Ø®ÙŠØ± Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†ØªÙŠØ¬Ø© Ø³Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
      firestore.collection('exam_results')
        .where('student_email', '==', currentStudentEmail)
        .where('level', '==', currentExamLevel)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            // Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ù†ØªÙŠØ¬Ø© Ù„Ø§ ØªØ­ÙØ¸ ÙˆÙ„Ø§ ØªØ¹ÙŠØ¯ Ø§Ù„ØªØµØ­ÙŠØ­
            showExamResultOnly(querySnapshot.docs[0].data());
            updateLevelExamTable(currentExamLevel, querySnapshot.docs[0].data());
            return;
          }

          // --- Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ exam_results ---
          const resultDoc = {
            student_email: currentStudentEmail,
            student_name: currentStudentName,
            level: currentExamLevel,
            score: gainedMark,
            total: totalMark,
            details: details,
            submitted_at: firebase.firestore.Timestamp.now(),
            teacher_reviewed: false,
            approved: null
          };

          firestore.collection('exam_results').add(resultDoc)
            .then((docRef) => {
              showResult(`ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! Ø¯Ø±Ø¬ØªÙƒ: ${gainedMark} Ù…Ù† ${totalMark}`);
              updateLevelExamTable(currentExamLevel, resultDoc);
            })
            .catch((error) => {
              showResult(`Ø¯Ø±Ø¬ØªÙƒ: ${gainedMark} Ù…Ù† ${totalMark}`);
              showFormMsg('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ' + error.message);
            });

          showFormMsg('');
        });
    };

    function showFormMsg(msg) {
      document.getElementById('formMsg').innerText = msg;
    }
    function showResult(msg) {
      document.getElementById('resultArea').innerText = msg;
    }

    document.getElementById('exitExamBtn').onclick = function(){
      document.getElementById('examBox').style.display = 'none';
      document.getElementById('questionsArea').innerHTML = "";
      document.getElementById('formMsg').innerText = "";
      document.getElementById('resultArea').innerText = "";
    };

    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ (Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©)
    function updateLevelExamTable(level, result) {
      let passed = (result.score >= result.total * 0.5);
      let label = passed
        ? `<span class="exam-label">âœ… Ø§Ø¬ØªØ§Ø² Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (${result.score} Ù…Ù† ${result.total})</span>`
        : `<span class="exam-label fail">âŒ Ù„Ù… ÙŠØ¬ØªØ² (${result.score} Ù…Ù† ${result.total})</span>`;
      let table = document.querySelectorAll(".exams-table tbody tr");
      if(table && table.length >= level) {
        let cell = table[level-1].querySelector("td:last-child");
        if(cell) cell.innerHTML = label;
      }
    }

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„: Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§ØªØŒ Ø§Ù„Ø¯Ø±ÙˆØ³ØŒ Ø§Ù„ØªÙ„Ø®ÙŠØµØ§ØªØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)
    function renderExamsTable(data) {
      let html = `
        <div class="exams-title-bar">Ù†ØªØ§Ø¦Ø¬ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</div>
        <table class="exams-table">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
              <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th>
            </tr>
          </thead>
          <tbody>
      `;
      for(let i=1; i<=7; i++){
        let exam = data['exam'+i];
        let label = '';
        if (exam === true) {
          label = `<span class="exam-label">âœ… Ø§Ø¬ØªØ§Ø² Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</span>`;
        } else if (exam === false) {
          label = `<span class="exam-label fail">âŒ Ù„Ù… ÙŠØ¬ØªØ² Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</span>`;
        } else {
          label = `<span class="exam-label wait">â€”</span>`;
        }
        html += `<tr>
          <td class="exam-title">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${i}</td>
          <td>${label}</td>
        </tr>`;
      }
      html += "</tbody></table>";
      document.getElementById('examsTableArea').innerHTML = html;
    }

    function loadActiveLessonsAndSummaries(activeLevels) {
      if (!activeLevels.length) {
        document.getElementById('lessonsSummariesArea').innerHTML = "";
        return;
      }
      firestore.collection('lessons').orderBy('id').get().then(function(querySnapshot) {
        let lessons = [];
        querySnapshot.forEach(function(doc) {
          let lesson = doc.data();
          let levelNum = getLevelNumber(lesson.level);
          if (activeLevels.includes(levelNum)) {
            lessons.push(lesson);
          }
        });
        if (lessons.length === 0) {
          document.getElementById('lessonsSummariesArea').innerHTML = "";
          return;
        }
        let lessonIds = lessons.map(l=>l.id);
        firestore.collection('summaries')
          .where('student_email', '==', currentStudentEmail)
          .where('lesson_id', 'in', lessonIds)
          .get()
          .then(function(summarySnapshot){
            let summariesMap = {};
            summarySnapshot.forEach(function(doc){
              let s = doc.data();
              summariesMap[s.lesson_id] = { ...s, docId: doc.id };
            });
            renderSummariesLessonsUI(lessons, summariesMap);
          });
      });
    }

    function renderSummariesLessonsUI(lessons, summariesMap) {
      let html = `<h3 style="color:#2260af; margin-bottom:10px;">ØªÙ„Ø®ÙŠØµØ§Øª Ø¯Ø±ÙˆØ³Ùƒ</h3>`;
      lessons.forEach(function(lesson){
        let sum = summariesMap[lesson.id] || { summary_text: "", status: "draft" };
        let submitted = sum.status === 'submitted';
        html += `
        <div class="lesson-summary-block">
          <div class="lesson-student-name">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${currentStudentName || ""}</div>
          <h4>(${lesson.id}) ${lesson.title}</h4>
          <div style="margin-bottom:10px;">
            <a href="${lesson.url || "#"}" class="lesson-link" download target="_blank" style="margin-left:10px;">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ğŸ“¥</a>
            ${lesson.voice ? `
            <audio controls style="width:70%;vertical-align:middle;">
              <source src="${lesson.voice}" type="audio/mpeg">
              Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.
            </audio>
            ` : ''}
          </div>
          <div style="margin:12px 0 5px 0;">
            <textarea class="summary-text" id="sumtext_${lesson.id}" ${submitted ? 'readonly' : ''} placeholder="Ø§ÙƒØªØ¨ ØªÙ„Ø®ÙŠØµÙƒ Ù‡Ù†Ø§...">${sum.summary_text || ''}</textarea>
          </div>
          <div class="summary-actions">
            <span class="summary-status ${sum.status}">${sum.status === 'submitted' ? 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ' : 'Ù…Ø³ÙˆØ¯Ø© (Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…)'}</span>
            <button class="btn" style="margin-left:8px;" onclick="saveSummary(${lesson.id})" ${submitted ? 'disabled' : ''}>Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
            <button class="btn submit" onclick="submitSummary(${lesson.id})" ${submitted ? 'disabled' : ''}>ØªØ³Ù„ÙŠÙ… Ù†Ù‡Ø§Ø¦ÙŠ</button>
          </div>
          <div id="sum_msg_${lesson.id}" style="margin-top:5px; color:#e63946; font-size:0.97rem;"></div>
        </div>
        `;
      });
      document.getElementById('lessonsSummariesArea').innerHTML = html;
    }

    function saveSummary(lessonId) {
      let textarea = document.getElementById('sumtext_' + lessonId);
      let msg = document.getElementById('sum_msg_' + lessonId);
      let text = textarea.value.trim();
      msg.innerText = "";
      if (!text) { msg.innerText = "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø£ÙˆÙ„Ø§Ù‹."; return; }
      firestore.collection('summaries')
        .where('student_email', '==', currentStudentEmail)
        .where('lesson_id', '==', lessonId)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            let docId = querySnapshot.docs[0].id;
            let data = querySnapshot.docs[0].data();
            if (data.status === "submitted") {
              msg.innerText = "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.";
              return;
            }
            firestore.collection('summaries').doc(docId).update({
              summary_text: text,
              student_name: currentStudentName || "",
              status: "draft",
              timestamp: new Date().toISOString()
            }).then(function(){
              msg.style.color = "#1dad87";
              msg.innerText = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©.";
              setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
            });
          } else {
            firestore.collection('summaries').add({
              student_email: currentStudentEmail,
              student_name: currentStudentName || "",
              lesson_id: lessonId,
              summary_text: text,
              status: "draft",
              timestamp: new Date().toISOString()
            }).then(function(){
              msg.style.color = "#1dad87";
              msg.innerText = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©.";
              setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
            });
          }
        });
    }

    function submitSummary(lessonId) {
      let textarea = document.getElementById('sumtext_' + lessonId);
      let msg = document.getElementById('sum_msg_' + lessonId);
      let text = textarea.value.trim();
      msg.innerText = "";
      if (!text) { msg.innerText = "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø£ÙˆÙ„Ø§Ù‹."; return; }
      firestore.collection('summaries')
        .where('student_email', '==', currentStudentEmail)
        .where('lesson_id', '==', lessonId)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            let docId = querySnapshot.docs[0].id;
            let data = querySnapshot.docs[0].data();
            if (data.status === "submitted") {
              msg.innerText = "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø¨Ø§Ù„ÙØ¹Ù„.";
              return;
            }
            firestore.collection('summaries').doc(docId).update({
              summary_text: text,
              student_name: currentStudentName || "",
              status: "submitted",
              timestamp: new Date().toISOString()
            }).then(function(){
              msg.style.color = "#1dad87";
              msg.innerText = "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø¨Ù†Ø¬Ø§Ø­.";
              textarea.readOnly = true;
              loadStudentData(currentStudentEmail, currentStudentName);
              setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
            });
          } else {
            firestore.collection('summaries').add({
              student_email: currentStudentEmail,
              student_name: currentStudentName || "",
              lesson_id: lessonId,
              summary_text: text,
              status: "submitted",
              timestamp: new Date().toISOString()
            }).then(function(){
              msg.style.color = "#1dad87";
              msg.innerText = "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„ØªÙ„Ø®ÙŠØµ Ø¨Ù†Ø¬Ø§Ø­.";
              textarea.readOnly = true;
              loadStudentData(currentStudentEmail, currentStudentName);
              setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
            });
          }
        });
    }

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }
  </script>
</body>
</html>
