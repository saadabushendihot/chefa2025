<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة الطالب - شفاء</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Tajawal, Arial, sans-serif; margin: 0; background: #f8fafc;}
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display:flex; justify-content:space-between; align-items:center;}
    .container { max-width: 600px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px #0001;}
    h2 { color: #4361ee; margin-top:0;}
    .btn { background: #4361ee; color: #fff; border: none; padding: 8px 24px; border-radius: 5px; font-size: 1rem; cursor: pointer;}
    .signout {background:#e63946;}
    .info { background: #f5f7fb; border-radius: 7px; padding: 10px 18px; margin: 16px 0;}
    .levels {margin-top:24px;}
    .level {margin-bottom:14px; font-size:1.1rem;}
    .level .on {color: #219e4b; font-weight: bold;}
    .level .off {color: #e63946; font-weight: bold;}
    .exams-box {background: #eaf3fc; border-radius: 7px; padding: 16px 18px; margin: 26px 0 0 0;}
    .exams-title {font-size: 1.2rem; color: #2260af; font-weight: bold; margin-bottom: 10px;}
    .exam {margin-bottom: 10px; font-size: 1.08rem;}
    .exam-label {display:inline-block; width:110px;}
    .exam-mark {color:#0d4c82; font-weight:bold; margin-right:8px;}
    .exam .yes {color: #219e4b; font-weight: bold;}
    .exam .no {color: #e63946; font-weight: bold;}
    #msg { color: #e63946; margin-top: 20px; }
    @media (max-width: 700px) {
      .container {padding: 8px;}
      header {padding:10px;}
      .exam-label {width:90px;}
    }
  </style>
</head>
<body>
  <header>
    <span>لوحة الطالب</span>
    <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">
    <h2>مرحباً، <span id="studentName"></span></h2>
    <div class="info">
      <div><b>البريد الإلكتروني:</b> <span id="studentEmail"></span></div>
      <div><b>رقم المقرر:</b> <span id="courseNumber"></span></div>
    </div>
    <div id="msg"></div>
    <div class="levels" id="levels"></div>
    <div class="exams-box" id="examsBox" style="display:none;">
      <div class="exams-title">الامتحانات</div>
      <div class="exam">
        <span class="exam-label">تشخيصي:</span>
        <span id="diagnosisExamMark" class="exam-mark"></span>
        <span id="diagnosisExam"></span>
      </div>
      <div class="exam">
        <span class="exam-label">امتحان 1:</span>
        <span id="exam1Mark" class="exam-mark"></span>
        <span id="exam1"></span>
      </div>
      <div class="exam">
        <span class="exam-label">شفوي:</span>
        <span id="oralExamMark" class="exam-mark"></span>
        <span id="oralExam"></span>
      </div>
      <div class="exam">
        <span class="exam-label">العلامة النهائية:</span>
        <span id="fExam" class="exam-mark"></span>
      </div>
    </div>
  </div>
  <script>
    // إعدادات الفايربيز
    var firebaseConfig = {
      apiKey: "AIzaSyCNx0wz_Xf5kXHl8kxmn7j6eH90DSMsEHw",
      authDomain: "shefa-502fe.firebaseapp.com",
      projectId: "shefa-502fe",
      storageBucket: "shefa-502fe.appspot.com",
      messagingSenderId: "639314388969",
      appId: "1:639314388969:web:ad5245fc2d5d9c750c4d78"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();

    // تحقق من الدخول وأضف الطالب تلقائياً إلى users إذا لم يكن موجوداً
    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists) {
            if (doc.data().role !== "student") {
              window.location.href = "dashboard.html";
              return;
            }
            loadStudentData(doc.data().email);
          } else {
            firestore.collection('users').doc(user.uid).set({
              email: user.email,
              role: "student"
            }).then(function() {
              window.location.reload();
            });
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });

    // جلب بيانات الطالب من lectures
    function loadStudentData(userEmail) {
      document.getElementById('studentName').innerText = "";
      document.getElementById('studentEmail').innerText = "";
      document.getElementById('courseNumber').innerText = "";
      document.getElementById('msg').innerText = "";
      document.getElementById('levels').innerHTML = "";
      document.getElementById('examsBox').style.display = "none";

      firestore.collection('lectures').where('email', '==', userEmail).get().then(function(querySnapshot) {
        if (querySnapshot.empty) {
          document.getElementById('msg').innerText = "لا توجد بيانات لهذا المستخدم في النظام. تواصل مع الإدارة.";
        } else {
          var data = querySnapshot.docs[0].data();
          document.getElementById('studentName').innerText = data.name || "";
          document.getElementById('studentEmail').innerText = data.email || "";
          document.getElementById('courseNumber').innerText = data.course_number || "";

          // عرض المستويات
          var html = '';
          for (var i = 1; i <= 7; i++) {
            html += `<div class="level">المستوى ${i}: <span class="${data['level'+i] ? 'on' : 'off'}">${data['level'+i] ? 'مُفعل ✅' : 'غير مفعل ❌'}</span></div>`;
          }
          document.getElementById('levels').innerHTML = html;

          // عرض الامتحانات مع العلامات
          let diagnosisMark = data.diagnosis_exam_mark || (data.diagnosis_exam ? 'مُجتاز' : 'غير مجتاز');
          let exam1Mark = data.exam1_mark || (data.exam1 ? 'مُجتاز' : 'غير مجتاز');
          let oralMark = data.oral_exam_mark || (data.oral_exam ? 'مُجتاز' : 'غير مجتاز');
          let fMark = (typeof data.f !== "undefined" && data.f !== null && data.f !== "") ? data.f : 'غير متوفر';

          document.getElementById('diagnosisExamMark').innerText = diagnosisMark;
          document.getElementById('diagnosisExam').innerHTML = data.diagnosis_exam ? '<span class="yes">✅</span>' : '<span class="no">❌</span>';

          document.getElementById('exam1Mark').innerText = exam1Mark;
          document.getElementById('exam1').innerHTML = data.exam1 ? '<span class="yes">✅</span>' : '<span class="no">❌</span>';

          document.getElementById('oralExamMark').innerText = oralMark;
          document.getElementById('oralExam').innerHTML = data.oral_exam ? '<span class="yes">✅</span>' : '<span class="no">❌</span>';

          document.getElementById('fExam').innerText = fMark;

          document.getElementById('examsBox').style.display = "block";
        }
      }).catch(function(err) {
        document.getElementById('msg').innerText = "خطأ في جلب البيانات: " + err.message;
      });
    }

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }
  </script>
</body>
</html>
