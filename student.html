<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة الطالب - شفاء</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Tajawal, Arial, sans-serif; margin: 0; background: #f8fafc;}
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display:flex; justify-content:space-between; align-items:center;}
    .container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px #0001;}
    h2 { color: #4361ee; margin-top:0;}
    .btn { background: #4361ee; color: #fff; border: none; padding: 7px 22px; border-radius: 5px; font-size: 1rem; cursor: pointer;}
    .btn[disabled] {background: #bdbdbd; color: #fff; cursor: not-allowed;}
    .btn.submit {background: #1dad87;}
    .signout {background:#e63946;}
    .info { background: #f5f7fb; border-radius: 7px; padding: 10px 18px; margin: 16px 0;}
    #msg { color: #e63946; margin-top: 20px; }
    .levels-table { width: 100%; border-collapse: collapse; margin-top: 26px; margin-bottom: 26px;}
    .levels-table th, .levels-table td {padding: 10px 6px; border-bottom:1px solid #e4e7ef; text-align:center;}
    .levels-table th {background:#eef2fa; color:#1b3e72;}
    .level-on {color: #219e4b; font-weight: bold;}
    .level-off {color: #e63946; font-weight: bold;}
    .exam-mark, .final-mark {background: #eaf3fc; color:#0d4c82; border-radius: 5px; padding:2px 10px; font-weight: bold;}
    .final-mark {background: #ffeeb4; color: #ad7a13;}
    .exams-box {background: #eaf3fc; border-radius: 7px; padding: 16px 18px; margin: 30px 0 0 0;}
    .exams-title {font-size: 1.2rem; color: #2260af; font-weight: bold; margin-bottom: 10px;}
    .exam-row {margin-bottom: 10px; font-size: 1.09rem;}
    .exam-row span {margin-left: 10px;}
    .admission-status-box { 
      padding: 15px 18px; 
      margin-bottom: 18px; 
      border-radius: 8px; 
      font-size: 1.18rem; 
      font-weight: bold; 
      border: 2px solid #e4e7ef; 
      text-align:center;
    }
    .admission-accepted { background: #e6faea; color: #219e4b; border-color: #8be2b4;}
    .admission-rejected { background: #fff2f2; color: #e63946; border-color: #f6b8b8;}
    .admission-pending { background: #fffde6; color: #e6a100; border-color: #ffeab6;}
    .lesson-summary-block {background: #f5f7fb; border-radius: 10px; margin: 18px 0 28px 0; padding: 18px 14px; box-shadow: 0 2px 6px #e0e7ef33;}
    .lesson-summary-block h4 {margin:0 0 8px 0; color:#1b3e72;}
    .lesson-link {color:#4361ee;}
    .summary-actions {margin-top: 8px;}
    .summary-status {font-weight:bold; font-size:0.95rem; margin-right:8px;}
    .summary-status.draft { color: #e6a100;}
    .summary-status.submitted { color: #219e4b;}
    textarea.summary-text {width:98%;height:80px;padding:8px;border-radius:5px;border:1px solid #b7c0d6;resize:vertical;font-size:1rem; box-sizing: border-box;}
    @media (max-width: 900px){
      .container{padding:8px;}
      header {padding:10px;}
      .levels-table th, .levels-table td {padding: 7px 2px;}
      .lesson-summary-block{padding:10px 4px;}
      textarea.summary-text {width:96%;}
    }
  </style>
</head>
<body>
  <header>
    <span>لوحة الطالب</span>
    <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">
    <h2>مرحباً، <span id="studentName"></span></h2>
    <div class="info">
      <div><b>البريد الإلكتروني:</b> <span id="studentEmail"></span></div>
      <div><b>رقم المقرر:</b> <span id="courseNumber"></span></div>
    </div>
    <!-- مربع حالة القبول -->
    <div id="admissionStatusBox" class="admission-status-box admission-pending" style="display:none;"></div>
    <div id="msg"></div>
    <table class="levels-table" id="levelsTable" style="display:none;">
      <thead>
        <tr>
          <th>المستوى</th>
          <th>الحالة</th>
          <th>علامة امتحان المادة</th>
          <th>علامة الامتحان النهائي للمستوى</th>
        </tr>
      </thead>
      <tbody id="levelsBody"></tbody>
    </table>
    <div class="exams-box" id="examsBox" style="display:none;">
      <div class="exams-title">الامتحانات العامة</div>
      <div class="exam-row"><b>امتحان تشخيصي:</b> <span id="diagnosisExamMark"></span></div>
      <div class="exam-row"><b>امتحان 1:</b> <span id="exam1Mark"></span></div>
      <div class="exam-row"><b>امتحان شفوي:</b> <span id="oralExamMark"></span></div>
      <div class="exam-row"><b>العلامة النهائية العامة:</b> <span id="fExam"></span></div>
    </div>
    <!-- تلخيص الدروس -->
    <div id="lessonsSummariesArea"></div>
  </div>
  <script>
    // إعداد Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyCNx0wz_Xf5kXHl8kxmn7j6eH90DSMsEHw",
      authDomain: "shefa-502fe.firebaseapp.com",
      projectId: "shefa-502fe",
      storageBucket: "shefa-502fe.appspot.com",
      messagingSenderId: "639314388969",
      appId: "1:639314388969:web:ad5245fc2d5d9c750c4d78"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();
    var currentStudentEmail = "";
    var currentStudentName = "";

    // تحويل اسم المستوى الى رقم
    function getLevelNumber(levelName) {
      switch (levelName.replace('المستوى ', '').replace('ال', '')) {
        case "أول": case "الأول": return 1;
        case "ثاني": case "الثاني": return 2;
        case "ثالث": case "الثالث": return 3;
        case "رابع": case "الرابع": return 4;
        case "خامس": case "الخامس": return 5;
        case "سادس": case "السادس": return 6;
        case "سابع": case "السابع": return 7;
        case "1": return 1;
        case "2": return 2;
        case "3": return 3;
        case "4": return 4;
        case "5": return 5;
        case "6": return 6;
        case "7": return 7;
        default: return 0;
      }
    }

    auth.onAuthStateChanged(function(user) {
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists) {
            if (doc.data().role !== "student") {
              window.location.href = "dashboard.html";
              return;
            }
            loadStudentData(doc.data().email, doc.data().name);
          } else {
            firestore.collection('users').doc(user.uid).set({
              email: user.email,
              role: "student"
            }).then(function() {
              window.location.reload();
            });
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function loadStudentData(userEmail, userName) {
      currentStudentEmail = userEmail;
      currentStudentName = userName;
      document.getElementById('studentName').innerText = userName || "";
      document.getElementById('studentEmail').innerText = userEmail || "";
      document.getElementById('courseNumber').innerText = "";
      document.getElementById('msg').innerText = "";
      document.getElementById('levelsBody').innerHTML = "";
      document.getElementById('levelsTable').style.display = "none";
      document.getElementById('examsBox').style.display = "none";
      document.getElementById('admissionStatusBox').style.display = "none";
      document.getElementById('lessonsSummariesArea').innerHTML = "";

      firestore.collection('lectures').where('email', '==', userEmail).get().then(function(querySnapshot) {
        if (querySnapshot.empty) {
          document.getElementById('msg').innerText = "لا توجد بيانات لهذا المستخدم في النظام. تواصل مع الإدارة.";
        } else {
          var data = querySnapshot.docs[0].data();
          document.getElementById('courseNumber').innerText = data.course_number || "";

          // عرض حالة القبول
          var admissionBox = document.getElementById('admissionStatusBox');
          var status = data.accepted;
          let isAccepted = (status === true || status === "مقبول" || status === "accepted");
          let isRejected = (status === false || status === "مرفوض" || status === "rejected");

          admissionBox.style.display = "block";
          if (typeof status !== "undefined") {
            if (isAccepted) {
              admissionBox.className = "admission-status-box admission-accepted";
              admissionBox.innerText = "تم قبولك في الدورة ✅";
              document.getElementById('levelsTable').style.display = "";
              document.getElementById('examsBox').style.display = "block";
            } else if (isRejected) {
              admissionBox.className = "admission-status-box admission-rejected";
              admissionBox.innerText = "عذراً، لم يتم قبولك في الدورة.";
              document.getElementById('levelsTable').style.display = "none";
              document.getElementById('examsBox').style.display = "none";
            } else {
              admissionBox.className = "admission-status-box admission-pending";
              admissionBox.innerText = "طلبك قيد المراجعة...";
              document.getElementById('levelsTable').style.display = "none";
              document.getElementById('examsBox').style.display = "none";
            }
          } else {
            admissionBox.className = "admission-status-box admission-pending";
            admissionBox.innerText = "طلبك قيد المراجعة...";
            document.getElementById('levelsTable').style.display = "none";
            document.getElementById('examsBox').style.display = "none";
          }

          // بناء جدول المستويات والامتحانات فقط إذا كان مقبول
          let activeLevels = [];
          if (isAccepted) {
            var levelsHtml = '';
            for (var i = 1; i <= 7; i++) {
              var level = data['level'+i];
              var mark = data['level'+i+'_exam_mark'];
              var final = data['level'+i+'_final_exam'];
              if (level) activeLevels.push(i);
              levelsHtml += `<tr>
                <td>المستوى ${i}</td>
                <td class="${level ? 'level-on' : 'level-off'}">${level ? 'مُفعل ✅' : 'غير مفعل ❌'}</td>
                <td><span class="exam-mark">${mark ? mark : '—'}</span></td>
                <td><span class="final-mark">${final ? final : '—'}</span></td>
              </tr>`;
            }
            document.getElementById('levelsBody').innerHTML = levelsHtml;
            document.getElementById('levelsTable').style.display = "";

            // الامتحانات العامة
            let diagnosisMark = data.diagnosis_exam_mark || (data.diagnosis_exam ? 'مُجتاز' : 'غير مجتاز');
            let exam1Mark = data.exam1_mark || (data.exam1 ? 'مُجتاز' : 'غير مجتاز');
            let oralMark = data.oral_exam_mark || (data.oral_exam ? 'مُجتاز' : 'غير مجتاز');
            let fMark = (typeof data.f !== "undefined" && data.f !== null && data.f !== "") ? data.f : 'غير متوفر';

            document.getElementById('diagnosisExamMark').innerText = diagnosisMark;
            document.getElementById('exam1Mark').innerText = exam1Mark;
            document.getElementById('oralExamMark').innerText = oralMark;
            document.getElementById('fExam').innerText = fMark;

            // جلب دروس المستويات المفعلة ثم جلب التلخيصات
            loadActiveLessonsAndSummaries(activeLevels);
          }
        }
      }).catch(function(err) {
        document.getElementById('msg').innerText = "خطأ في جلب البيانات: " + err.message;
      });
    }

    // جلب الدروس المفعلة وجلب التلخيصات وعرضها
    function loadActiveLessonsAndSummaries(activeLevels) {
      if (!activeLevels.length) {
        document.getElementById('lessonsSummariesArea').innerHTML = "";
        return;
      }
      firestore.collection('lessons').orderBy('id').get().then(function(querySnapshot) {
        let lessons = [];
        querySnapshot.forEach(function(doc) {
          let lesson = doc.data();
          let levelNum = getLevelNumber(lesson.level);
          if (activeLevels.includes(levelNum)) {
            lessons.push(lesson);
          }
        });
        // جلب التلخيصات الخاصة بالطالب لهذه الدروس فقط
        if (lessons.length === 0) {
          document.getElementById('lessonsSummariesArea').innerHTML = "";
          return;
        }
        let lessonIds = lessons.map(l=>l.id);
        firestore.collection('summaries')
          .where('student_email', '==', currentStudentEmail)
          .where('lesson_id', 'in', lessonIds)
          .get()
          .then(function(summarySnapshot){
            let summariesMap = {};
            summarySnapshot.forEach(function(doc){
              let s = doc.data();
              summariesMap[s.lesson_id] = { ...s, docId: doc.id };
            });
            renderSummariesLessonsUI(lessons, summariesMap);
          });
      });
    }

    // بناء واجهة التلخيصات
    function renderSummariesLessonsUI(lessons, summariesMap) {
      let html = `<h3 style="color:#2260af; margin-bottom:10px;">تلخيصات دروسك</h3>`;
      lessons.forEach(function(lesson){
        let sum = summariesMap[lesson.id] || {
          summary_text: "",
          status: "draft"
        };
        let submitted = sum.status === 'submitted';
        html += `
        <div class="lesson-summary-block">
          <h4>(${lesson.id}) ${lesson.title}</h4>
          <a href="${lesson.url}" target="_blank" class="lesson-link">رابط المحاضرة</a>
          <div style="margin:12px 0 5px 0;">
            <textarea class="summary-text" id="sumtext_${lesson.id}" ${submitted ? 'readonly' : ''} placeholder="اكتب تلخيصك هنا...">${sum.summary_text || ''}</textarea>
          </div>
          <div class="summary-actions">
            <span class="summary-status ${sum.status}">${sum.status === 'submitted' ? 'تم التسليم النهائي' : 'مسودة (لم يتم التسليم)'}</span>
            <button class="btn" style="margin-left:8px;" onclick="saveSummary(${lesson.id})" ${submitted ? 'disabled' : ''}>حفظ المسودة</button>
            <button class="btn submit" onclick="submitSummary(${lesson.id})" ${submitted ? 'disabled' : ''}>تسليم نهائي</button>
          </div>
          <div id="sum_msg_${lesson.id}" style="margin-top:5px; color:#e63946; font-size:0.97rem;"></div>
        </div>
        `;
      });
      document.getElementById('lessonsSummariesArea').innerHTML = html;
    }

    // حفظ مسودة التلخيص
    function saveSummary(lessonId) {
      let textarea = document.getElementById('sumtext_' + lessonId);
      let msg = document.getElementById('sum_msg_' + lessonId);
      let text = textarea.value.trim();
      msg.innerText = "";
      if (!text) { msg.innerText = "يرجى كتابة التلخيص أولاً."; return; }
      firestore.collection('summaries')
        .where('student_email', '==', currentStudentEmail)
        .where('lesson_id', '==', lessonId)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            // تعديل المسودة فقط إذا لم تكن submitted
            let docId = querySnapshot.docs[0].id;
            let data = querySnapshot.docs[0].data();
            if (data.status === "submitted") {
              msg.innerText = "تم تسليم التلخيص النهائي ولا يمكن التعديل.";
              return;
            }
            firestore.collection('summaries').doc(docId).update({
              summary_text: text,
              status: "draft",
              timestamp: new Date().toISOString()
            }).then(function(){
              msg.style.color = "#1dad87";
              msg.innerText = "تم حفظ المسودة.";
              setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
            });
          } else {
            firestore.collection('summaries').add({
              student_email: currentStudentEmail,
              student_name: currentStudentName || "",
              lesson_id: lessonId,
              summary_text: text,
              status: "draft",
              timestamp: new Date().toISOString()
            }).then(function(){
              msg.style.color = "#1dad87";
              msg.innerText = "تم حفظ المسودة.";
              setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
            });
          }
        });
    }

    // تسليم التلخيص بشكل نهائي
    function submitSummary(lessonId) {
      let textarea = document.getElementById('sumtext_' + lessonId);
      let msg = document.getElementById('sum_msg_' + lessonId);
      let text = textarea.value.trim();
      msg.innerText = "";
      if (!text) { msg.innerText = "يرجى كتابة التلخيص أولاً."; return; }
      firestore.collection('summaries')
        .where('student_email', '==', currentStudentEmail)
        .where('lesson_id', '==', lessonId)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            let docId = querySnapshot.docs[0].id;
            let data = querySnapshot.docs[0].data();
            if (data.status === "submitted") {
              msg.innerText = "تم تسليم التلخيص بالفعل.";
              return;
            }
            firestore.collection('summaries').doc(docId).update({
              summary_text: text,
              status: "submitted",
              timestamp: new Date().toISOString()
            }).then(function(){
              msg.style.color = "#1dad87";
              msg.innerText = "تم تسليم التلخيص بنجاح.";
              textarea.readOnly = true;
              loadStudentData(currentStudentEmail, currentStudentName);
              setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
            });
          } else {
            firestore.collection('summaries').add({
              student_email: currentStudentEmail,
              student_name: currentStudentName || "",
              lesson_id: lessonId,
              summary_text: text,
              status: "submitted",
              timestamp: new Date().toISOString()
            }).then(function(){
              msg.style.color = "#1dad87";
              msg.innerText = "تم تسليم التلخيص بنجاح.";
              textarea.readOnly = true;
              loadStudentData(currentStudentEmail, currentStudentName);
              setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
            });
          }
        });
    }

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }
  </script>
</body>
</html>
