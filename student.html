<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة الطالب - شفاء</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Tajawal','Cairo',Arial,sans-serif; margin: 0; background: #f8fafc;}
    header { background: #4361ee; color: #fff; padding: 18px 30px; font-size: 1.5rem; display:flex; justify-content:space-between; align-items:center;}
    .container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px #0001;}
    h2 { color: #4361ee; margin-top:0;}
    .btn { background: #4361ee; color: #fff; border: none; padding: 7px 22px; border-radius: 5px; font-size: 1rem; cursor: pointer;}
    .btn[disabled] {background: #bdbdbd; color: #fff; cursor: not-allowed;}
    .btn.submit {background: #1dad87;}
    .signout {background:#e63946;}
    .info { background: #f5f7fb; border-radius: 7px; padding: 10px 18px; margin: 16px 0;}
    #msg { color: #e63946; margin-top: 20px; }
    .levels-table, .exams-table {
      width: 100%; border-collapse: collapse; margin-top: 26px; margin-bottom: 12px;
      background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px #0001;
    }
    .levels-table th, .levels-table td,
    .exams-table th, .exams-table td {
      padding: 10px 6px; border-bottom:1px solid #e4e7ef; text-align:center; font-size: 1rem;
    }
    .levels-table th, .exams-table th {background:#eef2fa; color:#1b3e72; font-weight: bold;}
    .level-on {color: #219e4b; font-weight: bold;}
    .level-off {color: #e63946; font-weight: bold;}
    .exam-label {
      display: inline-block; padding: 3px 14px; border-radius: 18px; font-size: 1rem; font-weight: bold;
      background: #e3f6ed; color: #219e4b; border: 1px solid #b7eecd; box-shadow: 0 1px 4px #219e4b12; min-width: 90px;
    }
    .exam-label.fail { background: #ffecec; color: #e63946; border: 1px solid #ffbcbc; box-shadow: 0 1px 4px #e6394612;}
    .exam-label.wait {background: #f5f7fb; color: #555; border: 1px solid #d2d8e6;}
    .exams-table tr:last-child td, .levels-table tr:last-child td { border-bottom: none; }
    .exams-title-bar {
      font-size: 1.16rem; background: #f7faff; padding: 8px 0;
      border-radius: 10px 10px 0 0; color: #2260af; border-bottom: 2px solid #e4e7ef; font-weight:bold;
      text-align:center; letter-spacing: 1px;
    }
    .exams-table {margin-bottom: 26px; margin-top: 18px;}
    #examWarnMsg {color:#e63946;font-weight:bold;margin:10px 0 15px 0;text-align:center;}
    #examBox {background:#f8fafc;border-radius:12px;padding:28px 20px;box-shadow:0 2px 10px #0002;}
    .student-info {background:#eaf7e4;padding:12px 18px;border-radius:9px;margin-bottom:20px;display:inline-block;font-size:1.1em;}
    .level-info {background:#e6f2ff;padding:10px 16px;border-radius:8px;font-size:1.08em;margin-bottom:20px;display:inline-block;}
    .question-block {background:#f8fafc;border-radius:10px;padding:14px 12px;margin:18px 0 30px 0;box-shadow:0 2px 8px #e4e7ef44;}
    .question-title {font-weight:bold;margin-bottom:9px;}
    .multi-note {color:#b96d0d;font-size:0.98em;margin-right:6px;}
    .question-mark {color:#2260af;margin-right:12px;}
    .choices-list {margin-bottom:10px;}
    .choice-row {margin-bottom:6px;}
    .msg {color:#e63946;margin-bottom:16px;}
    .result {font-size:1.3rem;color:#219e4b;font-weight:bold;text-align:center;}
    .scoring-note {color:#007b8f;font-size:0.95em;margin-top:5px;}
    #examForm .btn {margin-left:6px;}
    #examForm .btn.signout {background:#b83b3b;}
    /* Spinner */
    .spinner {
      border: 4px solid #eee; border-top: 4px solid #4361ee; border-radius: 50%;
      width: 38px; height: 38px; animation: spin 1s linear infinite; margin: 60px auto;
      display: none;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    /* Toast */
    .toast {
      visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff;
      text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px;
      font-size: 1.05rem; opacity: 0; transition: opacity 0.5s, visibility 0.5s;
    }
    .toast.show { visibility: visible; opacity: 1; }
    /* Night Mode */
    .dark-mode {background: #23272f; color: #fff;}
    .dark-mode .container {background: #323946; color: #fff;}
    .dark-mode header {background: #222f3e;}
    .dark-mode .info {background: #222f3e;}
    .dark-mode .levels-table, .dark-mode .exams-table {background: #293043;}
    .dark-mode .levels-table th, .dark-mode .exams-table th {background: #253150; color: #fff;}
    .dark-mode .lesson-summary-block {background: #242b39;}
    .dark-mode textarea.summary-text {background: #23272f; color: #fff;}
    /* Dark mode styles for Exam Box */
    .dark-mode #examBox {background: #293043;}
    .dark-mode #examBox h2 {color: #fff;}
    .dark-mode .student-info, .dark-mode .level-info {background: #2b3547; color: #e0e0e0;}
    .dark-mode .question-block {background: #3a455a; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);}
    .dark-mode .question-title {color: #fff;}
    .dark-mode .multi-note {color: #ffcc80;}
    .dark-mode .question-mark {color: #8cafff;}
    .dark-mode .choices-list label {color: #e0e0e0;}
    .dark-mode .scoring-note {color: #66b2b2;}
    .dark-mode .msg {color: #ff8080;}
    .dark-mode .result {color: #66bb6a;}
    .dark-mode input[type="radio"], .dark-mode input[type="checkbox"] {
        filter: invert(0.8);
    }
    /* الأساس لشكل العلامة البيضاوي */
    .lesson-mark-badge {
      display:inline-block;
      font-weight:bold;
      border-radius:15px; /* لجعلها بيضاوية */
      padding:1px 13px;
      font-size:0.99em;
      margin-right:8px;
      min-width:44px;
      vertical-align:middle;
    }
    /* فئة للعلامات الإيجابية (أكبر من صفر) */
    .lesson-mark-badge.positive-mark {
        background:#e3f6ed; /* أخضر فاتح */
        color:#219e4b;     /* أخضر داكن */
        border:1px solid #b7eecd; /* حدود خضراء */
    }
    /* فئة للعلامة صفر */
    .lesson-mark-badge.zero-mark {
        background:#ffecf0; /* أحمر فاتح */
        color:#e63946;     /* أحمر داكن */
        border:1px solid #ffbcbc; /* حدود حمراء */
    }
    /* فئة للعلامة غير الموجودة (مثل المسودة أو لم يتم تحديد علامة) */
    .lesson-mark-badge.no-mark {
        background:#f5f7fb; /* رمادي فاتح */
        color:#555;         /* رمادي داكن */
        border:1px solid #d2d8e6; /* حدود رمادية */
    }

    /* تحسينات تصميم مربع التلخيص */
    .lesson-summary-block {
      background: #ffffff;
      border-radius: 12px;
      margin: 20px 0 30px 0;
      padding: 24px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border: 1px solid #e0e4e8;
      transition: all 0.3s ease;
    }
    .lesson-summary-block:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    /* تحسين عنوان الدرس داخل مربع التلخيص */
    .lesson-summary-block h4 {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f2f5;
        color: #294169;
        font-size: 1.15rem;
    }

    /* تعديلات الوضع الليلي لمربع التلخيص المحسن */
    .dark-mode .lesson-summary-block {
      background: #323946;
      border: 1px solid #3d4a5c;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .dark-mode .lesson-summary-block:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    .dark-mode .lesson-summary-block h4 {
        color: #e0e0e0;
        border-bottom: 1px solid #4a576b;
    }

    textarea.summary-text {
      width:98%;height:80px;padding:8px;border-radius:5px;border:1px solid #b7c0d6;
      resize:vertical;font-size:1.08rem; box-sizing: border-box; background:#fff;
      font-family: 'Cairo','Tajawal',Arial,sans-serif; color: #1b2a39; line-height: 1.7;
      transition: border 0.15s; direction: rtl;
    }
    textarea.summary-text:focus {border-color: #4361ee;}
    /* زر الدعم */
    #supportBtn {background:#007b8f;margin-right:10px;}
    /* زر الوضع الليلي */
    #nightModeBtn {background:#323946;margin-right:10px;}

    /* New styles for teacher comment display */
    .teacher-comment-display, .student-reply-display { /* Combined styles */
      background: #f0f2f5;
      padding: 10px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.98rem;
      color: #333;
      border: 1px solid #e0e4e8;
      line-height: 1.6;
      word-break: break-word; /* Ensure long words break */
    }
    .teacher-comment-display strong, .student-reply-display strong {
      color: #294169;
      display: block;
      margin-bottom: 5px;
    }
    .dark-mode .teacher-comment-display, .dark-mode .student-reply-display {
      background: #2b3547;
      border-color: #4a576b;
      color: #e0e0e0;
    }
    .dark-mode .teacher-comment-display strong, .dark-mode .student-reply-display strong {
      color: #8cafff;
    }

    /* Style for reply textarea */
    .reply-area {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #e0e4e8;
    }
    .reply-area label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
        color: #294169;
    }
    .reply-area textarea {
        width: 98%;
        height: 60px;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #b7c0d6;
        resize: vertical;
        font-size: 1rem;
        box-sizing: border-box;
        background: #fff;
        font-family: 'Cairo','Tajawal',Arial,sans-serif;
        color: #1b2a39;
    }
    .reply-area .btn {
        margin-top: 8px;
        padding: 6px 15px;
        font-size: 0.95rem;
    }
    .dark-mode .reply-area label {
        color: #e0e0e0;
    }
    .dark-mode .reply-area textarea {
        background: #2b3547;
        border-color: #4a576b;
        color: #e0e0e0;
    }

    /* Notifications icon and panel styles */
    .notification-bell {
        position: relative;
        font-size: 1.5rem;
        cursor: pointer;
        margin-left: 20px; /* Space from other header elements */
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -10px;
        background-color: #ff5722; /* Orange-red for unread */
        color: white;
        border-radius: 50%;
        padding: 2px 7px;
        font-size: 0.75rem;
        font-weight: bold;
        line-height: 1;
        min-width: 15px;
        text-align: center;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .notification-panel {
        display: none; /* Hidden by default */
        position: absolute;
        top: 60px; /* Adjust based on header height */
        right: 10px;
        width: 320px;
        max-height: 400px;
        overflow-y: auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        padding: 15px;
        text-align: right;
        border: 1px solid #eee;
        box-sizing: border-box;
    }
    .notification-panel h5 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #294169;
        font-size: 1.1rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .notification-item {
        padding: 10px 0;
        border-bottom: 1px solid #f0f2f5;
        font-size: 0.95rem;
        color: #333;
        line-height: 1.4;
    }
    .notification-item:last-child {
        border-bottom: none;
    }
    .notification-item.unread {
        background-color: #e6f2ff; /* Light blue for unread */
        font-weight: bold;
        padding: 10px;
        margin: 0 -15px; /* Extend background to panel edges */
    }
    .notification-item .timestamp {
        display: block;
        font-size: 0.8em;
        color: #888;
        margin-top: 5px;
    }
    .notification-item .mark-read-btn {
        background: #1dad87;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 8px;
        display: inline-block;
    }
    .notification-item .mark-read-btn:hover {
        background: #159b79;
    }
    /* Dark mode for notifications */
    .dark-mode .notification-panel {
        background-color: #323946;
        border-color: #4a576b;
        color: #e0e0e0;
    }
    .dark-mode .notification-panel h5 {
        color: #8cafff;
        border-bottom-color: #4a576b;
    }
    .dark-mode .notification-item {
        color: #e0e0e0;
        border-bottom-color: #4a576b;
    }
    .dark-mode .notification-item.unread {
        background-color: #2a3447; /* Darker blue for unread in dark mode */
    }
    .dark-mode .notification-item .timestamp {
        color: #bbb;
    }
    .dark-mode .notification-item .mark-read-btn {
        background: #1a6b3d;
    }
    .dark-mode .notification-item .mark-read-btn:hover {
        background: #159b79;
    }

    @media (max-width: 480px) {
        .notification-panel {
            width: 95%;
            left: 2.5%;
            right: 2.5%;
        }
        .notification-item.unread {
          padding: 10px 5px;
          margin: 0 -15px;
        }
    }

  </style>
</head>
<body>
  <header>
    <span>لوحة الطالب</span>
    <div>
      <button class="btn" id="supportBtn" onclick="openSupport()">الدعم الفني</button>
      <button class="btn" id="nightModeBtn" onclick="toggleNightMode()">الوضع الليلي</button>
      
      <span class="notification-bell" onclick="toggleNotificationPanel()">
          <i class="fas fa-bell"></i>
          <span id="unreadNotificationsBadge" class="notification-badge" style="display:none;">0</span>
      </span>

      <button class="btn signout" onclick="logout()">تسجيل الخروج</button>
    </div>
  </header>
  <div class="container">
    <h2>مرحباً، <span id="studentName"></span></h2>
    <div class="info">
      <div><b>البريد الإلكتروني:</b> <span id="studentEmail"></span></div>
      <div><b>اسم الطالب:</b> <span id="studentNameInfo"></span></div>
      <div><b>رقم المقرر:</b> <span id="courseNumber"></span></div>
    </div>
    <div id="admissionStatusBox" class="admission-status-box admission-pending" style="display:none;"></div>
    <div id="msg"></div>
    <div class="spinner" id="loadingSpinner"></div>
    <div id="levelsExamsTableArea"></div>
    <div id="examWarnMsg"></div>
    <div class="exams-box" id="examsBox" style="display:none;">
      <div class="exams-title">الامتحانات العامة</div>
      <div class="exam-row"><b>امتحان تشخيصي:</b> <span id="diagnosisExamMark"></span></div>
      <div class="exam-row"><b>امتحان 1:</b> <span id="exam1Mark"></span></div>
      <div class="exam-row"><b>امتحان شفوي:</b> <span id="oralExamMark"></span></div>
      <div class="exam-row"><b>العلامة النهائية العامة:</b> <span id="fExam"></span></div>
    </div>
    <div style="text-align:center;margin:15px 0;">
      <button class="btn" id="downloadReportBtn" onclick="downloadReport()">تحميل تقرير الدرجات PDF</button>
    </div>
    <div id="lessonsSummariesArea"></div>

    <div id="examBox" style="display:none; margin-top:30px;">
      <div class="student-info" id="examStudentInfo"></div>
      <div class="level-info" id="examLevelInfo"></div>
      <h2>أسئلة الاختبار <span id="examTimer" style="font-size:1.1rem;color:#e63946;"></span></h2>
      <form id="examForm">
        <div id="questionsArea"></div>
        <div class="msg" id="formMsg"></div>
        <button type="submit" class="btn">إرسال الإجابات</button>
        <button type="button" class="btn signout" id="exitExamBtn" style="margin-right:8px;">خروج من الاختبار</button>
      </form>
      <div class="result" id="resultArea"></div>
    </div>
  </div>
  <div id="toast" class="toast"></div>
  <audio id="timeWarningSound" src="path/to/your/warning_sound.mp3" preload="auto"></audio>

  <div id="notificationPanel" class="notification-panel">
    <h5>الإشعارات</h5>
    <div id="notificationsList">
      <p style="text-align: center; color: #888;">لا توجد إشعارات حالياً.</p>
    </div>
  </div>


  <script src="firebase-config.js"></script>
  <script>
    // Firebase Config: تم حذف الكائن من هنا وسيتم جلبه من firebase-config.js
    
    // الوضع الليلي
    function toggleNightMode() {
      document.body.classList.toggle('dark-mode');
    }

    // رسالة منبثقة (Toast)
    function showToast(msg, color="#333") {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.style.background = color;
      toast.className = "toast show";
      setTimeout(()=>{ toast.className = toast.className.replace("show", ""); }, 2500);
    }

    // مؤشر تحميل
    function showLoading(show) {
      document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    // فتح الدعم الفني
    function openSupport() {
      window.open("mailto:support@chefa.edu.sa?subject=دعم فني للطالب", "_blank");
    }

    // تنزيل تقرير PDF (مكتبة jsPDF مطلوبة)
    function downloadReport() {
      showToast("هذه الميزة تتطلب مكتبة jsPDF. يمكنك إضافتها لاحقًا.");
      // مثال: https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js
      // يمكنك استيرادها ثم تفعيل كود تصدير PDF هنا.
    }

    // فلترة النص لمنع HTML
    function sanitizeText(text) {
      const div = document.createElement("div");
      div.innerText = text;
      return div.innerHTML;
    }

    // عداد الوقت للاختبار
    let examTimerInterval, examTimeLeft = 0;
    function startExamTimer(minutes = 20) {
      clearInterval(examTimerInterval);
      examTimeLeft = minutes * 60;
      updateExamTimer();
      examTimerInterval = setInterval(() => {
        examTimeLeft--;
        updateExamTimer();
        if (examTimeLeft <= 0) {
          clearInterval(examTimerInterval);
          showToast("انتهى وقت الاختبار! سيتم تسليم إجاباتك تلقائياً.", "#e63946");
          processExamSubmission(true); // استدعاء الدالة الجديدة للتسليم التلقائي
        }
      }, 1000);
    }
    function updateExamTimer() {
      const el = document.getElementById('examTimer');
      if (examTimeLeft > 0) {
        const min = Math.floor(examTimeLeft/60);
        const sec = examTimeLeft%60;
        el.innerText = `(${min}:${sec<10?'0':''}${sec})`;

        // تشغيل صوت التحذير قبل 30 ثانية
        if (examTimeLeft === 30) {
          const sound = document.getElementById('timeWarningSound');
          if (sound) {
            sound.play().catch(e => console.error("Error playing sound:", e));
          }
        }
      } else {
        el.innerText = "";
      }
    }

    // المتغيرات
    let auth, firestore;
    let currentStudentEmail = "";
    let currentStudentName = "";
    let currentStudentUid = ""; // [NEW] To store student UID for notifications
    let lastActiveLevel = null;
    let lastActiveLevelIndex = null;
    let examQuestions = [];
    let randomizedExamQuestions = [];
    let examQuestionsLimit = null;
    let currentExamLevel = null;
    let studentSummaries = {}; // Map to store summaries by lesson_id for quick lookup
    let summariesListenerUnsubscribe = null; // To store unsubscribe function for real-time listener
    let notificationsListenerUnsubscribe = null; // [NEW] To store unsubscribe function for notifications

    // [NEW] Hardcoded teacher email for notifications
    const TEACHER_ADMIN_EMAIL = "saad.abushendi@gmail.com";


    // Firebase init
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } // firebaseConfig يتم جلبه الآن من firebase-config.js
    auth = firebase.auth();
    firestore = firebase.firestore();

    // تحويل رقم المستوى إلى نصه العربي
    function getLevelText(index) {
      const names = ["", "الأول", "الثاني", "الثالث", "الرابع", "الخامس", "السادس", "السابع"];
      return names[index] || "";
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function getLevelNumber(levelName) {
      switch (levelName.replace('المستوى ', '').replace('ال', '')) {
        case "أول": case "الأول": return 1;
        case "ثاني": case "الثاني": return 2;
        case "ثالث": case "الثالث": return 3;
        case "رابع": case "الرابع": return 4;
        case "خامس": case "الخامس": return 5;
        case "سادس": case "السادس": return 6;
        case "سابع": case "السابع": return 7;
        case "1": return 1; case "2": return 2; case "3": return 3; case "4": return 4; case "5": return 5; case "6": return 6; case "7": return 7;
        default: return 0;
      }
    }

    function getAllowedLevels(data) {
      let allowed = [];
      for(let i=1; i<=7; i++){
        if(data['level'+i]) allowed.push(i);
      }
      return allowed;
    }

    // مراقبة الدخول
    auth.onAuthStateChanged(function(user) {
      if (user) {
        currentStudentUid = user.uid; // [NEW] Save user UID
        console.log("معرف المستخدم الحالي (UID): ", currentStudentUid);
        firestore.collection('users').doc(user.uid).get().then(function(doc) {
          if (doc.exists) {
            if (doc.data().role !== "student") {
              window.location.href = "dashboard.html";
              return;
            }
            loadStudentData(doc.data().email, doc.data().name);
            setupNotificationsListener(); // [NEW] Setup notifications listener after user data is loaded
          } else {
            firestore.collection('users').doc(user.uid).set({
              email: user.email, role: "student"
            }).then(function() { window.location.reload(); });
          }
        }).catch(err => { showLoading(false); showToast("خطأ في جلب بيانات المستخدم", "#e63946"); });
      } else {
        window.location.href = "login.html";
      }
    });

    // [NEW] Helper function to send notifications to the teacher
    async function sendTeacherNotification(messageContent, type, relatedId = null, relatedName = null) {
        if (!currentStudentEmail || !currentStudentName || !messageContent) {
            console.warn("Cannot send teacher notification: Missing student info or message content.");
            return;
        }
        try {
            await firestore.collection('notifications').add({
                message: messageContent,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                recipient_email: TEACHER_ADMIN_EMAIL, // Recipient is the teacher
                is_read: false,
                sender_email: currentStudentEmail, // Sender is the student
                sender_name: currentStudentName,
                notification_type: type, // e.g., 'summary_submitted', 'student_reply'
                related_id: relatedId,
                related_name: relatedName
            });
            console.log(`Notification sent to teacher: "${messageContent}"`);
        } catch (error) {
            console.error("Error sending teacher notification:", error);
        }
    }


    // [NEW] Notification functions for student UI
    function toggleNotificationPanel() {
        const panel = document.getElementById('notificationPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            // Mark all currently displayed notifications as read when panel is opened
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            unreadItems.forEach(item => {
                const notificationId = item.dataset.id;
                markNotificationAsRead(notificationId);
            });
        }
    }

    function setupNotificationsListener() {
        if (!currentStudentEmail) { // Ensure currentStudentEmail is loaded
            console.warn("currentStudentEmail not yet available for notifications listener.");
            return;
        }

        // Unsubscribe from previous listener if exists
        if (notificationsListenerUnsubscribe) {
            notificationsListenerUnsubscribe();
        }

        // Corrected query to filter by recipient_email or 'all'
        notificationsListenerUnsubscribe = firestore.collection('notifications')
            .where('recipient_email', 'in', [currentStudentEmail, 'all'])
            .orderBy('timestamp', 'desc')
            .onSnapshot(function(snapshot) {
                let notifications = [];
                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const notification = { ...doc.data(), id: doc.id };
                    notifications.push(notification);
                    if (!notification.is_read) { // Use is_read as per Firestore document
                        unreadCount++;
                    }
                });
                renderNotifications(notifications, unreadCount);
            }, function(error) {
                console.error("Error listening to notifications:", error);
                showToast("خطأ في تحميل الإشعارات: " + error.message, "#e63946");
            });
    }

    function renderNotifications(notifications, unreadCount) {
        const notificationsListDiv = document.getElementById('notificationsList');
        const unreadBadge = document.getElementById('unreadNotificationsBadge');

        if (unreadCount > 0) {
            unreadBadge.innerText = unreadCount;
            unreadBadge.style.display = 'block';
        } else {
            unreadBadge.style.display = 'none';
        }

        if (notifications.length === 0) {
            notificationsListDiv.innerHTML = '<p style="text-align: center; color: #888;">لا توجد إشعارات حالياً.</p>';
            return;
        }

        let html = '';
        notifications.forEach(n => {
            const timestamp = n.timestamp ? new Date(n.timestamp.toDate()).toLocaleString('ar-EG') : '';
            html += `
                <div class="notification-item ${n.is_read ? '' : 'unread'}" data-id="${n.id}">
                    ${n.message}
                    <span class="timestamp">${timestamp}</span>
                    ${!n.is_read ? `<button class="mark-read-btn" onclick="markNotificationAsRead('${n.id}')">قراءة</button>` : ''}
                </div>
            `;
        });
        notificationsListDiv.innerHTML = html;
    }

    function markNotificationAsRead(notificationId) {
        firestore.collection('notifications').doc(notificationId).update({
            is_read: true // Use is_read as per Firestore document
        }).catch(error => {
            console.error("Error marking notification as read:", error);
            showToast("خطأ في تحديث حالة الإشعار: " + error.message, "#e63946");
        });
    }


    // تحميل بيانات الطالب
    function loadStudentData(userEmail, userNameFromUserDoc) {
      currentStudentEmail = userEmail;
      showLoading(true);
      firestore.collection('lectures').where('email', '==', userEmail).get().then(function(querySnapshot) {
        showLoading(false);
        if (querySnapshot.empty) {
          document.getElementById('msg').innerText = "لا توجد بيانات لهذا المستخدم في النظام. تواصل مع الإدارة.";
        } else {
          const data = querySnapshot.docs[0].data();
          currentStudentName = data.name || userNameFromUserDoc || "";
          document.getElementById('studentName').innerText = currentStudentName;
          document.getElementById('studentNameInfo').innerText = currentStudentName;
          document.getElementById('studentEmail').innerText = userEmail || "";
          document.getElementById('courseNumber').innerText = data.course_number || "";
          document.getElementById('msg').innerText = "";
          document.getElementById('examsBox').style.display = "none";
          document.getElementById('admissionStatusBox').style.display = "none";
          document.getElementById('lessonsSummariesArea').innerHTML = "";
          document.getElementById('levelsExamsTableArea').innerHTML = "";

          // حالة القبول
          const admissionBox = document.getElementById('admissionStatusBox');
          const status = data.accepted;
          const isAccepted = (status === true || status === "مقبول" || status === "accepted");
          const isRejected = (status === false || status === "مرفوض" || status === "rejected");

          admissionBox.style.display = "block";
          if (typeof status !== "undefined") {
            if (isAccepted) {
              admissionBox.className = "admission-status-box admission-accepted";
              admissionBox.innerText = "تم قبولك في الدورة ✅";
              document.getElementById('examsBox').style.display = "block";
            } else if (isRejected) {
              admissionBox.className = "admission-status-box admission-rejected";
              admissionBox.innerText = "عذراً، لم يتم قبولك في الدورة.";
              document.getElementById('examsBox').style.display = "none";
            } else {
              admissionBox.className = "admission-status-box admission-pending";
              admissionBox.innerText = "طلبك قيد المراجعة...";
              document.getElementById('examsBox').style.display = "none";
            }
          } else {
            admissionBox.className = "admission-status-box admission-pending";
            admissionBox.innerText = "طلبك قيد المراجعة...";
            document.getElementById('examsBox').style.display = "none";
          }

          // جدول المستويات/الامتحانات
          renderLevelsExamsMergedTable(data);

          // الامتحانات العامة
          const diagnosisMark = data.diagnosis_exam_mark || (data.diagnosis_exam ? 'مُجتاز' : 'غير مجتاز');
          const exam1Mark = data.exam1_mark || (data.exam1 ? 'مُجتاز' : 'غير مجتاز');
          const oralMark = data.oral_exam_mark || (data.oral_exam ? 'مُجتاز' : 'غير مجتاز');
          const fMark = (typeof data.f !== "undefined" && data.f !== null && data.f !== "") ? data.f : 'غير متوفر';
          document.getElementById('diagnosisExamMark').innerText = diagnosisMark;
          document.getElementById('exam1Mark').innerText = exam1Mark;
          document.getElementById('oralExamMark').innerText = oralMark;
          document.getElementById('fExam').innerText = fMark;

          // تحميل الدروس والتلاخيص (مع التعديل الجديد)
          const allowedLevels = getAllowedLevels(data);
          loadActiveLessonsAndSummaries(allowedLevels);
        }
      }).catch(function(err) {
        showLoading(false);
        document.getElementById('msg').innerText = "خطأ في جلب البيانات: " + err.message;
        showToast("خطأ في تحميل بيانات الطالب!", "#e63946");
      });
    }

    // دالة مساعدة للتحقق من أهلية الامتحان والمتابعة
    function performExamEligibilityCheckAndProceed(studentData, proceedIfEligible = false) {
      const btn = document.getElementById('goToExamBtn');
      const warn = document.getElementById('examWarnMsg');

      if (!lastActiveLevelIndex || !studentData.accepted) {
        btn.style.display = "none";
        warn.innerText = ''; // مسح أي تحذيرات سابقة
        return; // لا يوجد مستوى نشط أو الطالب غير مقبول
      }

      const levelText = getLevelText(lastActiveLevelIndex);
      showLoading(true); // إظهار مؤشر التحميل أثناء التحقق

      firestore.collection('lessons').where('level', '==', levelText).get().then(function(lessonQuery){
        let lessons = [];
        lessonQuery.forEach(doc => lessons.push(doc.data()));
        const lessonIds = lessons.map(l=>l.id);

        if(!lessonIds.length) {
          btn.style.display = "none";
          warn.innerText = 'لا توجد دروس في هذا المستوى.';
          showLoading(false);
          return;
        }

        let summaryAndMarkPromises = [];
        firestore.collection('summaries')
          .where('student_email', '==', currentStudentEmail)
          .where('lesson_id', 'in', lessonIds)
          .get()
          .then(function(summariesSnap){
            let summariesMapForExamCheck = {};
            summariesSnap.forEach(doc => {
                let s = { ...doc.data(), docId: doc.id };
                summariesMapForExamCheck[s.lesson_id] = s;
                if (s.status === 'submitted') {
                    summaryAndMarkPromises.push(
                        firestore.collection('student_marks')
                        .where('summary_id', '==', s.docId)
                        .where('student_email', '==', currentStudentEmail)
                        .limit(1)
                        .get()
                        .then(markSnap => {
                            // الشرط الجديد: يجب أن تكون العلامة أكبر من صفر
                            if (!markSnap.empty && markSnap.docs[0].data().mark !== null && markSnap.docs[0].data().mark > 0) {
                                s.mark_from_student_marks = markSnap.docs[0].data().mark;
                                return true;
                            }
                            s.mark_from_student_marks = null; // العلامة غير صالحة (صفر أو أقل)
                            return false; // الملخص مسلم لكن لا يوجد علامة صالحة
                        }).catch(error => {
                            console.error("Error fetching mark for summary in exam check:", s.docId, error);
                            s.mark_from_student_marks = null;
                            return false; // اعتبارها غير صالحة في حالة الخطأ
                        })
                    );
                } else {
                    s.mark_from_student_marks = null; // الملخصات المسودة لا تؤهل للامتحان
                    summaryAndMarkPromises.push(Promise.resolve(false));
                }
            });

            Promise.all(summaryAndMarkPromises).then(() => {
              let allRequiredSummariesPresentAndMarked = true;

              if (lessons.length === 0) {
                allRequiredSummariesPresentAndMarked = true;
              } else if (Object.keys(summariesMapForExamCheck).length !== lessons.length) {
                allRequiredSummariesPresentAndMarked = false;
              } else {
                for (let i = 0; i < lessons.length; i++) {
                  const lessonId = lessons[i].id;
                  const summary = summariesMapForExamCheck[lessonId];
                  if (!summary || summary.status !== 'submitted' || summary.mark_from_student_marks === null || summary.mark_from_student_marks <= 0) {
                    allRequiredSummariesPresentAndMarked = false;
                    break;
                  }
                }
              }

              if(allRequiredSummariesPresentAndMarked){
                  btn.style.display="";
                  warn.innerText = '';
                  if (proceedIfEligible) { // فقط إذا كانت الدالة قد استدعيت بهدف المتابعة للامتحان
                      currentExamLevel = lastActiveLevelIndex;
                      checkIfExamAlreadySubmitted(currentStudentEmail, currentExamLevel);
                      setTimeout(function(){
                          document.getElementById('examBox').scrollIntoView({behavior: 'smooth'});
                      }, 300);
                  }
              } else {
                  btn.style.display="none";
                  warn.innerText = 'لا يمكن تقديم الاختبار إلا بعد تسليم جميع التلاخيص وتصحيحها بعلامة أكبر من صفر.';
              }
              showLoading(false); // إخفاء مؤشر التحميل بعد التحقق
            }).catch(error => {
                console.error("Error in Promise.all for summary/mark check:", error);
                btn.style.display="none";
                warn.innerText = 'حدث خطأ في التحقق من التلاخيص (فشل جلب العلامات).';
                showLoading(false);
            });
          }).catch(error => {
              console.error("Error fetching summaries for exam check:", error);
              btn.style.display="none";
              warn.innerText = 'حدث خطأ في جلب التلاخيص.';
              showLoading(false);
          });
      }).catch(error => {
          console.error("Error fetching lessons for exam check:", error);
          btn.style.display="none";
          warn.innerText = 'حدث خطأ في جلب الدروس.';
          showLoading(false);
      });
    }

    // المستويات + الامتحانات (مع تحسينات عرض)
    function renderLevelsExamsMergedTable(data) {
      let html = `<div class="exams-title-bar">حالة المستويات ونتائج الامتحانات</div>
        <table class="levels-table" id="levelsExamsTable">
          <thead>
            <tr>
              <th>المستوى</th>
              <th>الحالة</th>
              <th>حالة الامتحان</th>
            </tr>
          </thead><tbody>`;
      lastActiveLevel = null;
      lastActiveLevelIndex = null;
      for (let i = 1; i <= 7; i++) {
        const level = data['level'+i];
        const exam = data['exam'+i];
        if(level) { lastActiveLevel = 'المستوى ' + i; lastActiveLevelIndex = i; }
        // حالة التفعيل
        const levelStatus = level ? '<span class="level-on">مُفعل ✅</span>' : '<span class="level-off">غير مفعل ❌</span>';
        // حالة الامتحان
        let examLabel = '';
        if (exam === true) {
          examLabel = `<span class="exam-label">✅ اجتاز الامتحان</span>`;
        } else if (exam === false) {
          examLabel = `<span class="exam-label fail">❌ لم يجتز الامتحان</span>`;
        } else if (level) {
          examLabel = `<span class="exam-label wait">لم يبدأ بعد</span>`;
        } else {
          examLabel = `<span class="exam-label wait">—</span>`;
        }
        html += `<tr>
            <td>المستوى ${i}</td>
            <td>${levelStatus}</td>
            <td>${examLabel}</td>
          </tr>`;
      }
      html += "</tbody></table>";

      // زر الانتقال للاختبار
      if(lastActiveLevelIndex && data.accepted === true){
        html += `<div style="text-align:center; margin:20px 0;">
          <button class="btn" id="goToExamBtn" style="display:none">الانتقال إلى اختبار ${getLevelText(lastActiveLevelIndex)}</button>
        </div>`;
      }
      document.getElementById('levelsExamsTableArea').innerHTML = html;

      // عند تحميل الصفحة، نقوم بالتحقق الأولي (لا نتقدم للامتحان تلقائياً)
      if(lastActiveLevelIndex && data.accepted === true){
          performExamEligibilityCheckAndProceed(data, false); // التحقق الأولي
          // عند الضغط على الزر، نعيد التحقق ونتقدم إذا كانت الشروط مستوفاة
          document.getElementById('goToExamBtn').onclick = function(){
              performExamEligibilityCheckAndProceed(data, true); // إعادة التحقق والتقدم عند النقر
          };
      }
    }


    // التحقق من الاختبار
    function checkIfExamAlreadySubmitted(email, level) {
      firestore.collection('exam_results')
        .where('student_email', '==', email)
        .where('level', '==', level)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            showExamResultOnly(querySnapshot.docs[0].data());
          } else {
            showExamBox(currentStudentName, currentStudentEmail, currentExamLevel);
          }
        })
        .catch(()=>{ showToast("خطأ في تحميل نتيجة الاختبار", "#e63946"); });
    }

    // إظهار نتيجة الاختبار فقط
    function showExamResultOnly(result) {
      document.getElementById('examBox').style.display = '';
      document.getElementById('questionsArea').innerHTML = '';
      document.getElementById('formMsg').innerText = '';
      document.getElementById('examStudentInfo').innerHTML =
        `<b>اسم الطالب:</b> ${currentStudentName} &nbsp; | &nbsp; <b>الإيميل:</b> ${currentStudentEmail} &nbsp; | &nbsp; <b>المستوى الحالي:</b> المستوى ${result.level}`;
      document.getElementById('examLevelInfo').innerText = '';
      document.getElementById('resultArea').innerHTML = `<div style="font-size:1.3rem;color:#e63946;font-weight:bold;">
        لقد سبق لك تقديم اختبار هذا المستوى.<br>درجتك: ${result.score} من ${result.total}
        </div>`;
      let btn = document.getElementById('goToExamBtn');
      if(btn) btn.style.display = "none";
      document.querySelector("button[type=submit]").style.display = "none";
      document.getElementById('exitExamBtn').style.display = "none";
      clearInterval(examTimerInterval); updateExamTimer();
    }

    // إظهار نافذة الاختبار
    function showExamBox(studentName, studentEmail, level) {
      document.getElementById('examBox').style.display = '';
      document.getElementById('examStudentInfo').innerHTML =
        `<b>اسم الطالب:</b> ${studentName} &nbsp; | &nbsp; <b>الإيميل:</b> ${studentEmail} &nbsp; | &nbsp; <b>المستوى الحالي:</b> المستوى ${getLevelText(level)}`;
      firestore.collection('exam_settings').doc('level_' + level).get().then(function(settingDoc){
        if(settingDoc.exists && settingDoc.data().question_num){
          examQuestionsLimit = settingDoc.data().question_num;
          document.getElementById('examLevelInfo').innerText =
            `عدد الأسئلة المخصصة لهذا المستوى: ${examQuestionsLimit}`;
        } else {
          examQuestionsLimit = null;
          document.getElementById('examLevelInfo').innerText =
            'لم يتم تحديد عدد الأسئلة لهذا المستوى (سيتم عرض جميع الأسئلة).';
        }
        loadExamQuestions(level);
        // بدء العداد (مثال: 20 دقيقة)
        startExamTimer(20);
      });
      document.getElementById('formMsg').innerText = '';
      document.getElementById('resultArea').innerText = '';
      document.querySelector("button[type=submit]").style.display = "";
      document.getElementById('exitExamBtn').style.display = "";
    }

    // جلب أسئلة الاختبار
    function loadExamQuestions(level) {
      firestore.collection('questions').where('level', '==', level).get().then(snap=>{
        examQuestions = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
        prepareRandomizedExam();
        renderExamQuestions();
      }).catch(()=>{ showToast("خطأ في تحميل الأسئلة", "#e63946"); });
    }

    // عشوائية الأسئلة والاختيارات
    function prepareRandomizedExam() {
      let shuffled = shuffleArray(examQuestions.map(q => {
        let choiceObjs = (q.choices||[]).map((choice, idx) => ({
          text: choice,
          origIndex: idx
        }));
        let shuffledChoices = shuffleArray(choiceObjs);
        let newCorrect = [];
        shuffledChoices.forEach((ch, ix) => {
          if(q.correct && q.correct.includes(ch.origIndex)) newCorrect.push(ix);
        });
        return {
          ...q,
          choices: shuffledChoices.map(c => c.text),
          correct: newCorrect
        };
      }));
      randomizedExamQuestions = examQuestionsLimit ? shuffled.slice(0, examQuestionsLimit) : shuffled;
    }

    // عرض الأسئلة
    function renderExamQuestions() {
      let html = '';
      randomizedExamQuestions.forEach((q, i) => {
        let multiNote = '';
        let scoringNote = '';
        if (q.correct.length > 1) {
          multiNote = '<span class="multi-note">(يحتمل أكثر من إجابة صحيحة)</span>';
          scoringNote = `<div class="scoring-note">
          ملاحظة: لكل إجابة صحيحة تختارها تحصل على جزء من العلامة، ولكل إجابة خاطئة تختارها يُخصم نفس الجزء من العلامة. لا يمكن أن تقل علامة السؤال عن الصفر.
          </div>`;
        }
        let markText = `<span class="question-mark">[العلامة: ${q.mark || 1}]</span>`;
        html += `<div class="question-block">
          <div class="question-title">${i+1}. ${q.question} ${multiNote} ${markText}</div>
          <div class="choices-list">` +
          (q.choices||[]).map((choice, idx) =>
            `<div class="choice-row">
              <label>
                <input type="${q.correct.length>1?'checkbox':'radio'}" name="q${i}" value="${idx}">
                ${choice}
              </label>
            </div>`
          ).join('') +
          `</div>
          ${scoringNote}
        </div>`;
      });
      document.getElementById('questionsArea').innerHTML = html || '<div class="msg">لا توجد أسئلة حالياً.</div>';
    }

    // تأكيد قبل الخروج من الاختبار
    document.getElementById('exitExamBtn').onclick = function(){
      if (confirm("هل أنت متأكد أنك تريد الخروج؟ لن تحفظ إجاباتك!")) {
        document.getElementById('examBox').style.display = 'none';
        document.getElementById('questionsArea').innerHTML = "";
        document.getElementById('formMsg').innerText = "";
        document.getElementById('resultArea').innerText = "";
        clearInterval(examTimerInterval); updateExamTimer();
      }
    };

    // منع إغلاق الصفحة أثناء الاختبار بدون تأكيد
    window.onbeforeunload = function(e) {
      if (document.getElementById('examBox').style.display !== 'none') {
        return "هل أنت متأكد أنك تريد مغادرة الصفحة؟ قد تفقد إجاباتك!";
      }
    };

    // الدالة الموحدة لمعالجة تسليم الاختبار
    function processExamSubmission(isTimerSubmission = false) {
      let totalMark = 0, gainedMark = 0, empty = 0;
      let details = [];
      randomizedExamQuestions.forEach((q, i) => {
        const nodes = document.getElementsByName('q'+i);
        let selected = [];
        nodes.forEach(input => { if(input.checked) selected.push(parseInt(input.value)); });

        let mark = parseFloat(q.mark) || 1;
        totalMark += mark;

        // عد الأسئلة الفارغة فقط إذا لم يكن التسليم تلقائياً بسبب انتهاء الوقت
        if (selected.length === 0) {
          if (!isTimerSubmission) {
            empty++;
          }
        }

        details.push({
          question_id: q.id,
          selected: selected,
          correct: q.correct
        });

        if(q.correct.length > 1) {
          let perMark = mark / q.correct.length;
          let countCorrect = 0;
          let countWrong = 0;
          selected.forEach(val => {
            if(q.correct.includes(val)) countCorrect++;
            else countWrong++;
          });
          let gained = (countCorrect - countWrong) * perMark;
          if(gained < 0) gained = 0;
          gainedMark += gained;
        }
        else {
          if(selected.length === 1 && q.correct.includes(selected[0])) gainedMark += mark;
        }
      });

      // عرض رسالة تحذير للأسئلة الفارغة فقط إذا كان التسليم يدوياً
      if (!isTimerSubmission && empty > 0) {
        showFormMsg('يرجى الإجابة على جميع الأسئلة!');
        showToast("يرجى الإجابة على جميع الأسئلة!", "#e63946");
        return; // إيقاف التسليم اليدوي إذا كانت هناك أسئلة فارغة
      }

      gainedMark = Math.round(gainedMark * 100) / 100;

      firestore.collection('exam_results')
        .where('student_email', '==', currentStudentEmail)
        .where('level', '==', currentExamLevel)
        .get()
        .then(function(querySnapshot){
          if (!querySnapshot.empty) {
            showExamResultOnly(querySnapshot.docs[0].data());
            updateLevelExamTable(currentExamLevel, querySnapshot.docs[0].data());
            showToast("تم إرسال الإجابات مسبقاً", "#e63946");
            return;
          }
          const resultDoc = {
            student_email: currentStudentEmail,
            student_name: currentStudentName,
            level: currentExamLevel,
            score: gainedMark,
            total: totalMark,
            details: details,
            submitted_at: firebase.firestore.Timestamp.now(),
            teacher_reviewed: false,
            approved: null
          };
          firestore.collection('exam_results').add(resultDoc)
            .then(() => {
              document.getElementById('questionsArea').innerHTML = '';
              document.getElementById('formMsg').innerText = '';
              document.getElementById('resultArea').innerHTML = `<div style="font-size:1.3rem;color:#219e4b;font-weight:bold;">
                تم حفظ نتيجتك بنجاح! درجتك: ${gainedMark} من ${totalMark}
                </div>`;
              document.querySelector("button[type=submit]").style.display = "none";
              document.getElementById('exitExamBtn').style.display = "none";
              let btn = document.getElementById('goToExamBtn');
              if(btn) btn.style.display = "none";
              updateLevelExamTable(currentExamLevel, resultDoc);
              showToast("تم إرسال الإجابات بنجاح", "#1dad87");
              clearInterval(examTimerInterval); updateExamTimer();
            })
            .catch((error) => {
              showResult(`درجتك: ${gainedMark} من ${totalMark}`);
              showFormMsg('حدث خطأ أثناء حفظ النتيجة: ' + error.message);
              showToast("حدث خطأ أثناء حفظ النتيجة!", "#e63946");
            });
          showFormMsg('');
        });
    }

    // ربط نموذج الاختبار بالدالة الجديدة
    document.getElementById('examForm').onsubmit = function(e){
      e.preventDefault();
      processExamSubmission(false); // تسليم يدوي
    };

    function showFormMsg(msg) {
      document.getElementById('formMsg').innerText = msg;
    }
    function showResult(msg) {
      document.getElementById('resultArea').innerText = msg;
    }

    // تحديث جدول الامتحان
    function updateLevelExamTable(level, result) {
      let passed = (result.score >= result.total * 0.5);
      let label = passed
        ? `<span class="exam-label">✅ اجتاز الامتحان (${result.score} من ${result.total})</span>`
        : `<span class="exam-label fail">❌ لم يجتز (${result.score} من ${result.total})</span>`;
      let table = document.querySelectorAll(".levels-table tbody tr");
      if(table && table.length >= level) {
        let cell = table[level-1].querySelector("td:last-child");
        if(cell) cell.innerHTML = label;
      }
    }

    // تحميل الدروس والتلاخيص (مع التعديل الجديد)
    function loadActiveLessonsAndSummaries(activeLevels) {
      // Unsubscribe from previous listener if exists
      if (summariesListenerUnsubscribe) {
        summariesListenerUnsubscribe();
        summariesListenerUnsubscribe = null;
      }

      if (!activeLevels.length) {
        document.getElementById('lessonsSummariesArea').innerHTML = "";
        return;
      }
      showLoading(true);

      // Get lessons first (they don't change often)
      firestore.collection('lessons').orderBy('id').get().then(function(lessonsSnap) {
        let lessons = [];
        lessonsSnap.forEach(function(doc) {
          let lesson = doc.data();
          let levelNum = getLevelNumber(lesson.level);
          if (activeLevels.includes(levelNum)) {
            lessons.push(lesson);
          }
        });
        lessons.sort((a, b) => a.id - b.id); // Sort lessons by ID numerically

        if (lessons.length === 0) {
          document.getElementById('lessonsSummariesArea').innerHTML = "";
          showLoading(false);
          return;
        }

        // Now set up a real-time listener for summaries
        summariesListenerUnsubscribe = firestore.collection('summaries')
          .where('student_email', '==', currentStudentEmail)
          .onSnapshot(function(snapshot) {
            let changes = snapshot.docChanges(); // Get changes since last snapshot
            let shouldShowToast = false;
            
            // Re-fetch all summaries to ensure complete data
            studentSummaries = {}; // Clear before repopulating
            snapshot.forEach(doc => {
              let s = { ...doc.data(), docId: doc.id };
              studentSummaries[s.docId] = s;
              studentSummaries[s.lesson_id] = s;

              // Check for specific changes for toast notification
              if (changes.some(change => change.type === "modified" && change.doc.id === doc.id)) {
                  let oldDoc = changes.find(change => change.doc.id === doc.id)?.oldDoc?.data();
                  if (oldDoc) {
                      // If teacher_comment was added/changed OR mark was added/changed
                      if (s.teacher_comment !== oldDoc.teacher_comment || s.mark_from_student_marks !== oldDoc.mark_from_student_marks) {
                          shouldShowToast = true;
                      }
                  }
              }
            });

            // Fetch marks for all summaries (or just the changed ones)
            let markPromises = Object.values(studentSummaries).map(s =>
                firestore.collection('student_marks')
                .where('summary_id', '==', s.docId)
                .where('student_email', '==', currentStudentEmail)
                .limit(1)
                .get()
                .then(markSnap => {
                    if (!markSnap.empty) {
                        s.mark_from_student_marks = markSnap.docs[0].data().mark;
                    } else {
                        s.mark_from_student_marks = null;
                    }
                    return s; // Return the updated summary object
                }).catch(err => {
                    console.error("Error fetching mark for summary in listener:", s.docId, err);
                    s.mark_from_student_marks = null;
                    return s;
                })
            );

            Promise.all(markPromises).then(updatedSummariesArray => {
                // Rebuild studentSummaries map from the updated array
                studentSummaries = {};
                updatedSummariesArray.forEach(s => {
                    studentSummaries[s.docId] = s;
                    studentSummaries[s.lesson_id] = s;
                });

                renderSummariesLessonsUI(lessons, studentSummaries); // Re-render with fresh data
                if (shouldShowToast) {
                    showToast("لديك تعليق أو علامة جديدة من المعلم على أحد تلاخيصك!", "#3b5cb8");
                }
                showLoading(false);
            }).catch(err => {
                showToast("خطأ في تحديث العلامات في الوقت الحقيقي: " + err.message, "#e63946");
                console.error("Promise.all error in listener:", err);
                showLoading(false);
            });

          }, function(error) {
            showToast("خطأ في الاستماع لتحديثات التلاخيص: " + error.message, "#e63946");
            console.error("Listener error:", error);
            showLoading(false);
          });
      }).catch(err => {
        showToast("خطأ في تحميل الدروس للتلاخيص: " + err.message, "#e63946");
        showLoading(false);
        console.error("Error fetching lessons for summaries:", err);
      });
    }

    // عرض التلاخيص مع العلامة والتاريخ (مُعدلة)
    function renderSummariesLessonsUI(lessons, summariesMap) {
      let html = `<h3 style="color:#2260af; margin-bottom:10px;">تلخيصات دروسك</h3>`;
      lessons.forEach(function(lesson){
        // Ensure teacher_comment and student_reply_comment are initialized even if null in DB
        let sum = summariesMap[lesson.id] || { docId: `new_draft_${lesson.id}`, summary_text: "", status: "draft", teacher_comment: "", student_reply_comment: "" };
        let submitted = sum.status === 'submitted';

        // تحديد العلامة للعرض بناءً على حالة التلخيص والعلامة المجلوبة
        let markToDisplay = '—';
        let markBadgeClass = 'no-mark';

        if (submitted) {
            if (typeof sum.mark_from_student_marks !== 'undefined' && sum.mark_from_student_marks !== null) {
                markToDisplay = 'العلامة: ' + sum.mark_from_student_marks;
                // تحديد الفئة بناءً على قيمة العلامة
                if (sum.mark_from_student_marks > 0) {
                    markBadgeClass = 'positive-mark'; // أخضر/نجاح
                } else {
                    markBadgeClass = 'zero-mark'; // أحمر/تحذير
                }
            }
        }

        let time = sum.timestamp ? `<span style="color:#888;font-size:0.97em;">(${(new Date(sum.timestamp)).toLocaleString('ar-EG')})</span>` : "";

        html += `
        <div class="lesson-summary-block">
          <div class="lesson-student-name">اسم الطالب: ${currentStudentName || ""}</div>
          <h4>
            (${lesson.id}) ${lesson.title}
            <span class="lesson-mark-badge ${markBadgeClass}">
              ${markToDisplay}
            </span>
            ${time}
          </h4>
          <div style="margin-bottom:10px;">
            <a href="${lesson.url || "#"}" class="lesson-link" download target="_blank" style="margin-left:10px;">تحميل المحاضرة 📥</a>
            ${lesson.voice ? `
            <audio controls style="width:70%;vertical-align:middle;">
              <source src="${lesson.voice}" type="audio/mpeg">
              متصفحك لا يدعم تشغيل الصوت.
            </audio>
            ` : ''}
          </div>
          <div style="margin:12px 0 5px 0;">
            <textarea class="summary-text" id="sumtext_${lesson.id}" ${submitted ? 'readonly' : ''} placeholder="اكتب تلخيصك هنا...">${sum.summary_text || ''}</textarea>
          </div>
          ${submitted && sum.teacher_comment ? `
            <div class="teacher-comment-display">
                <strong>ملاحظة المعلم:</strong> ${sum.teacher_comment}
            </div>
          ` : ''}
          ${submitted ? `
            <div class="reply-area">
                <label for="studentreply_${sum.docId}">تعليقك/ردك على الدرس:</label>
                <textarea class="summary-text" id="studentreply_${sum.docId}" placeholder="اكتب ردك هنا...">${sum.student_reply_comment || ''}</textarea>
                <button class="btn" onclick="saveStudentReply('${sum.docId}', ${lesson.id})">حفظ الرد</button>
            </div>
          ` : ''}
          <div class="summary-actions">
            <span class="summary-status ${sum.status}">${sum.status === 'submitted' ? 'تم التسليم النهائي' : 'مسودة (لم يتم التسليم)'}</span>
            <button class="btn" style="margin-left:8px;" onclick="saveSummary(${lesson.id})" ${submitted ? 'disabled' : ''}>حفظ المسودة</button>
            <button class="btn submit" onclick="submitSummary(${lesson.id})">تسليم نهائي</button>
          </div>
          <div id="sum_msg_${lesson.id}" style="margin-top:5px; color:#e63946; font-size:0.97rem;"></div>
        </div>
        `;
      });
      document.getElementById('lessonsSummariesArea').innerHTML = html;
    }

    // Function to save student reply to teacher's comment (or initiate comment)
    function saveStudentReply(summaryDocId) {
        const replyTextarea = document.getElementById(`studentreply_${summaryDocId}`);
        const replyText = sanitizeText(replyTextarea.value.trim());

        // Get lessonTitle for notification message
        const summary = studentSummaries[summaryDocId];
        const lessonTitle = window.lessonsMap[summary.lesson_id];

        if (!replyText) {
            showToast("يرجى كتابة الرد أولاً.", "#e63946");
            return;
        }

        firestore.collection('summaries').doc(summaryDocId).update({
            student_reply_comment: replyText
        }).then(() => {
            showToast("تم حفظ ردك بنجاح!", "#1dad87");
            // NEW: Send notification to teacher for student reply
            sendTeacherNotification(
                `قام الطالب ${currentStudentName} بالرد على تعليقك في درس "${lessonTitle}".`,
                'student_reply',
                summary.lesson_id, // relatedId
                lessonTitle // relatedName
            );
            // No need to call loadStudentData here, listener will handle refresh
        }).catch(error => {
            showToast(`حدث خطأ أثناء حفظ الرد: ${error.message}`, "#e63946");
            console.error("Error saving student reply:", error);
        });
    }

    // حفظ المسودة
    function saveSummary(lessonId) {
      const textarea = document.getElementById('sumtext_' + lessonId);
      const msg = document.getElementById('sum_msg_' + lessonId);
      const text = sanitizeText(textarea.value.trim());
      msg.innerText = "";
      if (!text) { msg.innerText = "يرجى كتابة التلخيص أولاً."; showToast("يرجى كتابة التلخيص!", "#e63946"); return; }
      
      let docRef;
      const existingSummary = Object.values(studentSummaries).find(s => s.lesson_id === lessonId);
      if (existingSummary && existingSummary.docId && !existingSummary.docId.startsWith('new_draft_')) {
          docRef = firestore.collection('summaries').doc(existingSummary.docId);
          // Check if already submitted
          if (existingSummary.status === "submitted") {
              msg.innerText = "تم تسليم التلخيص النهائي ولا يمكن التعديل.";
              showToast("تم تسليم التلخيص النهائي ولا يمكن التعديل.", "#e63946");
              return;
          }
      } else {
          docRef = firestore.collection('summaries').doc(); // Create a new doc
      }

      const summaryData = {
          student_email: currentStudentEmail,
          student_name: currentStudentName || "",
          lesson_id: lessonId,
          summary_text: text,
          status: "draft",
          timestamp: firebase.firestore.FieldValue.serverTimestamp() // Use server timestamp
      };

      docRef.set(summaryData, { merge: true }).then(function(){ // Use set with merge for both new and update
          msg.style.color = "#1dad87";
          msg.innerText = "تم حفظ المسودة.";
          showToast("تم حفظ المسودة.", "#1dad87");
          // No need to call loadStudentData, listener will handle refresh
          setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
      }).catch((error)=>{ 
          showToast("خطأ أثناء الحفظ: " + error.message, "#e63946"); 
          console.error("Error saving draft:", error); 
      });
    }

    // تسليم النهائي
    function submitSummary(lessonId) {
      const textarea = document.getElementById('sumtext_' + lessonId);
      const msg = document.getElementById('sum_msg_' + lessonId);
      const text = sanitizeText(textarea.value.trim());
      msg.innerText = "";
      if (!text) { msg.innerText = "يرجى كتابة التلخيص أولاً."; showToast("يرجى كتابة التلخيص!", "#e63946"); return; }
      
      let docRef;
      const existingSummary = Object.values(studentSummaries).find(s => s.lesson_id === lessonId);
      if (existingSummary && existingSummary.docId && !existingSummary.docId.startsWith('new_draft_')) {
          docRef = firestore.collection('summaries').doc(existingSummary.docId);
          // Check if already submitted
          if (existingSummary.status === "submitted") {
              msg.innerText = "تم تسليم التلخيص بالفعل.";
              showToast("تم تسليم التلخيص بالفعل.", "#e63946");
              return;
          }
      } else {
          docRef = firestore.collection('summaries').doc(); // Create a new doc
      }

      const summaryData = {
          summary_text: text,
          status: "submitted",
          timestamp: firebase.firestore.FieldValue.serverTimestamp() // Use server timestamp
      };
      
      // For new summaries being submitted
      if (!existingSummary || existingSummary.docId.startsWith('new_draft_')) {
          summaryData.student_email = currentStudentEmail;
          summaryData.student_name = currentStudentName || "";
          summaryData.lesson_id = lessonId;
      }

      const lessonTitle = window.lessonsMap[lessonId]; // Get lesson title for notification

      docRef.set(summaryData, { merge: true }).then(function(){
          msg.style.color = "#1dad87";
          msg.innerText = "تم تسليم التلخيص بنجاح.";
          // No need to call loadStudentData, listener will handle refresh
          showToast("تم تسليم التلخيص بنجاح!", "#1dad87");
          // NEW: Send notification to teacher for summary submission
          sendTeacherNotification(
              `قام الطالب ${currentStudentName} بتسليم تلخيص جديد لدرس "${lessonTitle}".`,
              'summary_submitted',
              lessonId,
              lessonTitle
          );
          setTimeout(()=>{msg.innerText=''; msg.style.color="#e63946";}, 1500);
      }).catch((error)=>{ 
          showToast("خطأ أثناء التسليم: " + error.message, "#e63946"); 
          console.error("Error submitting summary (update):", error); 
      });
    }

    // تسجيل الخروج
    function logout() {
      // Unsubscribe from listener before logging out
      if (summariesListenerUnsubscribe) {
        summariesListenerUnsubscribe();
        summariesListenerUnsubscribe = null;
      }
      if (notificationsListenerUnsubscribe) {
        notificationsListenerUnsubscribe();
        notificationsListenerUnsubscribe = null;
      }
      auth.signOut().then(()=>{window.location.href='login.html';});
    }

  </script>
</body>
</html>
