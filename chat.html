<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>صفحة الدردشة - شفاء</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <!-- Firebase Configuration (assumes it's in the same directory or accessible path) -->
  <script src="firebase-config.js"></script>
  <!-- Google Fonts for Arabic -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Material Design Variables (inspired) */
    :root {
      --primary-color: #6200ee; /* Deep Purple */
      --primary-dark: #3700b3;
      --primary-light: #bb86fc;
      --secondary-color: #03dac6; /* Teal */
      --secondary-dark: #018786;
      --background-color: #f5f5f5; /* Light grey background */
      --surface-color: #ffffff; /* Card/Modal background */
      --text-on-primary: #ffffff;
      --text-on-surface: #000000;
      --text-secondary-light: #666666;
      --error-color: #b00020; /* Red */
      --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      --shadow-4: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
    }

    html, body {
      height: 100%; /* Make html and body take full viewport height */
      margin: 0;
      overflow: hidden; /* Hide main scrollbar, inner elements will scroll */
    }
    body {
      font-family: 'Tajawal', Arial, sans-serif;
      background: var(--background-color);
      display: flex;
      flex-direction: column; /* Arrange children in a column */
      direction: rtl;
      text-align: right;
      color: var(--text-on-surface);
    }
    header {
      background: var(--primary-color);
      color: var(--text-on-primary);
      padding: 10px 20px; /* Reduced padding */
      font-size: 1.4rem; /* Slightly reduced font size */
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-2); /* Material shadow */
      z-index: 200; /* High z-index to stay on top */
      flex-shrink: 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
    }
    .main-container {
      flex: 1; /* Takes all available vertical space between header and input area */
      display: flex; /* For chat-list-panel and chat-area side-by-side */
      max-width: 1200px;
      width: 100%;
      margin: 0 auto; /* Center horizontally */
      padding-top: 60px; /* Space for fixed header (adjust if header height changes) */
      padding-bottom: 75px; /* Space for fixed input area (adjust if input area height changes) */
      box-sizing: border-box; /* Include padding in height calculation */
      overflow: hidden; /* Hide main-container's scrollbar */
      background: var(--surface-color); /* Apply surface color */
      border-radius: 8px; /* Rounded corners */
      box-shadow: var(--shadow-1); /* Subtle container shadow */
      margin-top: 20px; /* Margin from header */
      margin-bottom: 20px; /* Margin from bottom (if not full height) */
    }
    .chat-list-panel {
      width: 300px;
      border-left: 1px solid var(--background-color); /* Use background color for subtle border */
      background: var(--background-color);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out, width 0.3s ease-out; /* Added width to transition */
    }
    /* Default visibility on desktop, hide on mobile */
    .chat-list-panel.hidden-mobile { /* Class for hiding on mobile when not active */
        transform: translateX(100%); /* Slide out to the right (RTL) */
        opacity: 0;
        pointer-events: none; /* Disable interactions when hidden */
        width: 0; /* Collapse width completely */
        /* To make display work with transitions, we manage it in JS */
    }

    .chat-list-header {
      padding: 15px;
      font-size: 1.1rem; /* Slightly smaller */
      font-weight: bold;
      border-bottom: 1px solid var(--surface-color); /* Use surface color for subtle border */
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      background: var(--surface-color);
      color: var(--primary-color); /* Highlight header with primary color */
      box-shadow: var(--shadow-1); /* Subtle shadow for list header */
    }
    #chatRoomsList {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }
    .chat-room-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .chat-room-item:last-child {
      border-bottom: none;
    }
    .chat-room-item:hover {
      background-color: var(--primary-light); /* Light primary for hover */
      transform: translateX(-3px); /* Subtle slide on hover */
    }
    .chat-room-item.active {
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      font-weight: bold;
    }
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      padding: 15px;
      font-size: 1.1rem; /* Slightly smaller */
      font-weight: bold;
      border-bottom: 1px solid var(--background-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface-color);
      color: var(--primary-color); /* Highlight header with primary color */
      flex-shrink: 0;
      box-shadow: var(--shadow-1); /* Subtle shadow for chat header */
    }
    #messageDisplay {
      flex: 1;
      padding: 15px; /* Slightly reduced padding */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #fdfdfd; /* Lighter background for messages */
      padding-bottom: 75px; /* Ensure last message is not hidden by fixed input area */
    }
    .message-input-area {
      flex-shrink: 0;
      background: var(--surface-color);
      border-top: 1px solid var(--background-color);
      padding: 10px 15px;
      display: flex;
      align-items: center;
      box-shadow: var(--shadow-2); /* Material shadow upwards */
      z-index: 100; /* Ensure it's above main container */
      position: fixed; /* Fixed to the viewport */
      bottom: 0;
      left: 0;
      right: 0;
    }
    #messageInput {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px; /* More rounded */
      font-size: 1rem;
      resize: none;
      min-height: 40px;
      max-height: 120px; /* Prevent it from growing too large */
      margin-left: 10px;
      direction: rtl;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    #messageInput:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(98, 0, 238, 0.2);
        outline: none;
    }
    .btn {
      background: var(--primary-color);
      color: var(--text-on-primary);
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      white-space: nowrap;
      box-shadow: var(--shadow-1);
    }
    .btn:hover {
      background-color: var(--primary-dark);
      box-shadow: var(--shadow-2);
    }
    .btn:active {
        box-shadow: var(--shadow-1);
    }
    .btn:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
      box-shadow: none;
    }
    .logout-btn { background:var(--error-color); }
    .logout-btn:hover { background:#9b0000; }
    .attach-btn {
        background-color: var(--secondary-color);
        margin-right: 10px;
        padding: 10px 15px;
        border-radius: 50%; /* Circular button */
        width: 40px; /* Fixed width for circular */
        height: 40px; /* Fixed height for circular */
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: var(--shadow-1);
    }
    .attach-btn:hover {
        background-color: var(--secondary-dark);
        box-shadow: var(--shadow-2);
    }

    /* Message Bubbles */
    .message-bubble {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
      line-height: 1.5;
      position: relative;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Subtle bubble shadow */
    }
    .message-bubble.sent {
      background-color: var(--primary-light); /* Light primary color for sent messages */
      color: var(--text-on-primary); /* Text color contrast */
      align-self: flex-end;
      text-align: right;
    }
    .message-bubble.received {
      background-color: var(--surface-color); /* White for received messages */
      border: 1px solid #e0e0e0; /* Subtle border */
      align-self: flex-start;
      text-align: right;
    }
    .message-header-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    .message-sender {
      font-weight: bold;
      font-size: 0.9em;
      color: var(--text-secondary-light);
    }
    .message-bubble.sent .message-sender {
      color: rgba(255,255,255,0.8); /* Lighter color for sender in sent bubbles */
    }
    .message-text {
      font-size: 1.05em;
    }
    .message-timestamp {
      font-size: 0.75em;
      color: #888;
      margin-top: 5px;
      text-align: left;
    }
    .message-bubble.sent .message-timestamp {
      color: rgba(255,255,255,0.7); /* Lighter color for timestamp in sent bubbles */
    }
    .attachment-link {
        display: block;
        padding: 8px 10px;
        background-color: var(--background-color);
        border-radius: 8px;
        margin-top: 5px;
        text-decoration: none;
        color: var(--primary-color);
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .attachment-link:hover {
        background-color: #e0e0e0;
    }
    .attachment-link i {
        font-size: 1.2em;
    }
    .attachment-preview {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        margin-top: 5px;
        display: block;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .delete-message-btn {
        background: none;
        border: none;
        color: var(--error-color);
        cursor: pointer;
        font-size: 1.1em; /* Larger icon for delete */
        padding: 0 5px;
        transition: color 0.2s ease, transform 0.1s ease;
    }
    .delete-message-btn:hover {
        color: #d42a3b;
        transform: scale(1.1);
    }
    .message-bubble.sent .delete-message-btn {
        color: rgba(255,255,255,0.8); /* Lighter for sent bubbles */
    }
    .message-bubble.sent .delete-message-btn:hover {
        color: #ffffff; /* White on hover for sent bubbles */
    }


    /* Modals for Admin */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: var(--surface-color);
      margin: auto;
      padding: 25px;
      border-radius: 10px;
      box-shadow: var(--shadow-4);
      max-width: 500px;
      width: 90%;
      position: relative;
    }
    .close-btn {
      color: #aaa;
      float: left; /* Adjusted for RTL */
      font-size: 28px;
      font-weight: bold;
    }
    .close-btn:hover,
    .close-btn:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .modal-content label { display: block; margin-bottom: 8px; font-weight: bold; }
    .modal-content input[type="text"], .modal-content select {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .multi-select-list {
        border: 1px solid #ddd;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .multi-select-list div {
        padding: 5px;
        cursor: pointer;
    }
    .multi-select-list div:hover {
        background-color: #eee;
    }
    .multi-select-list div.selected {
        background-color: var(--primary-light);
        font-weight: bold;
    }

    /* Toast */
    .toast {
      visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff;
      text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px;
      font-size: 1.05rem; opacity: 0; transition: opacity 0.5s, visibility 0.5s;
      box-shadow: var(--shadow-2);
    }
    .toast.show { visibility: visible; opacity: 1; }

    /* Spinner */
    .spinner {
      border: 4px solid #eee; border-top: 4px solid var(--primary-color); border-radius: 50%;
      width: 38px; height: 38px; animation: spin 1s linear infinite; margin: 60px auto;
      display: none;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* File upload spinner */
    #fileUploadSpinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    /* Chat List Toggle Button (FAB) */
    #chatListToggleButton {
        position: fixed;
        top: 80px; /* Below header */
        right: 20px; /* Positioned on the right for RTL */
        background-color: var(--secondary-color);
        color: var(--text-on-primary);
        border: none;
        border-radius: 50%;
        width: 56px; /* Standard FAB size */
        height: 56px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        box-shadow: var(--shadow-2);
        cursor: pointer;
        z-index: 150; /* Above main container, below header */
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        display: none; /* Hidden by default, shown on mobile via media query */
    }
    #chatListToggleButton:hover {
        background-color: var(--secondary-dark);
        box-shadow: var(--shadow-4);
    }


    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        margin: 0; /* Remove horizontal margin on small screens */
        border-radius: 0; /* Remove rounded corners */
        box-shadow: none; /* Remove shadow */
      }
      .chat-list-panel {
        position: fixed; /* Make it fixed to overlay */
        top: 60px; /* Below header */
        bottom: 75px; /* Above input area */
        right: 0;
        width: 250px; /* Smaller width for mobile overlay */
        box-shadow: var(--shadow-4); /* Stronger shadow for overlay */
        z-index: 180; /* Above chat area */
        transform: translateX(100%); /* Initially off-screen to the right */
        opacity: 0;
        pointer-events: none;
        display: none; /* Start as completely hidden on mobile */
        flex-direction: column; /* Keep flex-direction for content layout */
      }
      .chat-list-panel.active-panel { /* Class toggled by JS */
          transform: translateX(0); /* Slide into view */
          opacity: 1;
          pointer-events: auto;
          display: flex; /* Make visible and flexible */
      }
      .chat-list-header {
        font-size: 1rem;
        padding: 10px;
      }
      .chat-area {
        min-height: auto; /* Let it adapt */
      }
      .message-input-area {
        padding: 8px 10px;
      }
      .btn, .attach-btn {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      #chatListToggleButton {
          display: flex; /* Show FAB on small screens */
      }
    }
  </style>
</head>
<body>
  <header>
    <span>منصة شفاء - الدردشة</span>
    <div>
        <span id="currentUserInfo" style="font-size: 0.9em; margin-left: 15px;"></span>
        <button class="btn logout-btn" onclick="logout()">تسجيل الخروج</button>
    </div>
  </header>

  <div class="main-container">
    <div id="chatListOverlay" class="chat-list-panel"> <!-- Removed 'hidden' class here -->
      <div class="chat-list-header">
        <h5>المحادثات</h5>
        <button class="btn" id="createChatBtn" style="font-size:0.85em; padding: 5px 10px; display: none;" onclick="openCreateChatModal()">
            <i class="fas fa-plus" style="margin-left: 5px;"></i> إنشاء
        </button>
      </div>
      <div id="chatRoomsList">
        <p style="text-align: center; color: #888; padding: 20px;">جاري تحميل المحادثات...</p>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header">
        <span id="currentChatRoomName">الرجاء اختيار محادثة</span>
        <button class="btn" id="manageParticipantsBtn" style="font-size:0.85em; padding: 5px 10px; display: none;" onclick="openManageParticipantsModal()">
            <i class="fas fa-users" style="margin-left: 5px;"></i> إدارة الأعضاء
        </button>
      </div>
      <div id="messageDisplay">
        <!-- Messages will be loaded here -->
      </div>
      <div class="spinner" id="loadingSpinner"></div> <!-- Main loading spinner -->

      <!-- message-input-area is now fixed to viewport bottom in CSS -->
    </div>
  </div>

  <button id="chatListToggleButton" onclick="toggleChatListPanel()">
      <i class="fas fa-bars" id="chatListToggleIcon"></i>
  </button>

  <div class="message-input-area">
    <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
    <button class="btn attach-btn" onclick="document.getElementById('fileInput').click()" title="إرفاق ملف">
        <i class="fas fa-paperclip"></i>
    </button>
    <div id="fileUploadSpinner"></div> <!-- Spinner for file upload -->
    <textarea id="messageInput" placeholder="اكتب رسالتك هنا..." rows="1"></textarea>
    <button class="btn" id="sendMessageBtn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i> إرسال</button>
  </div>

  <!-- Create Chat Modal -->
  <div id="createChatModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeCreateChatModal()">&times;</span>
      <h2>إنشاء محادثة جديدة</h2>
      <label for="newChatName">اسم المحادثة:</label>
      <input type="text" id="newChatName" placeholder="مثال: دردشة المستوى الأول" required>

      <label>اختر المشاركين:</label>
      <div id="allUsersList" class="multi-select-list">
        <p style="text-align: center; color: #888;">جاري تحميل المستخدمين...</p>
      </div>
      <p style="font-size:0.8em; color:#888;">* يمكنك الضغط على اسم المستخدم لتحديده/إلغاء تحديده.</p>

      <div class="modal-buttons">
        <button class="btn" onclick="createNewChatRoom()">إنشاء</button>
        <button class="btn logout-btn" onclick="closeCreateChatModal()">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Manage Participants Modal -->
  <div id="manageParticipantsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeManageParticipantsModal()">&times;</span>
      <h2>إدارة أعضاء المحادثة: <span id="manageChatRoomName"></span></h2>

      <label>المشاركون الحاليون:</label>
      <div id="currentParticipantsList" class="multi-select-list">
        <!-- Current participants will be loaded here -->
      </div>
      <p style="font-size:0.8em; color:#888;">* يمكنك الضغط على اسم المستخدم لتحديده/إلغاء تحديده.</p>

      <div class="modal-buttons">
        <button class="btn" onclick="saveParticipantsChanges()">حفظ التغييرات</button>
        <button class="btn logout-btn" onclick="closeManageParticipantsModal()">إلغاء</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Firebase Initialization (from firebase-config.js)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const firestore = firebase.firestore();
    const storage = firebase.storage(); // Initialize Firebase Storage

    // Global variables
    let currentUser = null;
    let currentUserRole = null;
    let currentChatRoomId = null;
    let chatRoomsListenerUnsubscribe = null;
    let messagesListenerUnsubscribe = null;
    let allUsers = []; // For create/manage chat modals
    let currentChatParticipants = []; // For manage participants modal

    // --- Utility Functions ---
    function showToast(msg, color = "#333") {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.style.background = color;
      toast.className = "toast show";
      setTimeout(() => {
        toast.className = toast.className.replace("show", "");
      }, 2500);
    }

    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
      }
    }

    function showFileUploadSpinner(show) {
        const spinner = document.getElementById('fileUploadSpinner');
        if (spinner) {
            spinner.style.display = show ? 'block' : 'none';
        }
    }

    function sanitizeText(text) {
      const div = document.createElement("div");
      div.innerText = text;
      return div.innerHTML;
    }

    function logout() {
      // Unsubscribe from all listeners before logging out
      if (chatRoomsListenerUnsubscribe) chatRoomsListenerUnsubscribe();
      if (messagesListenerUnsubscribe) messagesListenerUnsubscribe();
      auth.signOut().then(() => {
        window.location.href = "login.html"; // Redirect to login page
      }).catch((error) => {
        console.error("Error during sign-out:", error);
        showToast("خطأ أثناء تسجيل الخروج: " + error.message, "#e63946");
      });
    }

    // --- Authentication State Listener ---
    auth.onAuthStateChanged(function(user) {
      if (user) {
        currentUser = user;
        firestore.collection('users').doc(user.uid).get().then(doc => {
          if (doc.exists) {
            currentUserRole = doc.data().role;
            document.getElementById('currentUserInfo').innerText = `مرحباً، ${doc.data().name || user.email} (${currentUserRole === 'teacher' ? 'معلم' : 'طالب'})`;
            // If teacher, show admin buttons
            if (currentUserRole === 'teacher') {
              document.getElementById('createChatBtn').style.display = 'inline-block';
              document.getElementById('manageParticipantsBtn').style.display = 'inline-block';
            }
            loadChatRooms(); // Start loading chat rooms
            loadAllUsersForModals(); // Load all users for admin modals
          } else {
            // User exists in Auth but not in 'users' collection (shouldn't happen if login.html works correctly)
            console.warn("User data not found in Firestore 'users' collection.");
            showToast("خطأ: لم يتم العثور على بيانات المستخدم.", "#e63946");
            logout();
          }
        }).catch(err => {
          console.error("Error fetching user role:", err);
          showToast("خطأ في جلب دور المستخدم: " + err.message, "#e63946");
          logout();
        });
      } else {
        // No user is signed in.
        window.location.href = "login.html"; // Redirect to login page
      }
    });

    // --- Chat Room Management ---
    function loadChatRooms() {
      if (chatRoomsListenerUnsubscribe) chatRoomsListenerUnsubscribe(); // Unsubscribe previous listener

      const chatRoomsListDiv = document.getElementById('chatRoomsList');
      chatRoomsListDiv.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">جاري تحميل المحادثات...</p>';

      chatRoomsListenerUnsubscribe = firestore.collection('chatRooms')
        .where('participants', 'array-contains', currentUser.uid)
        .orderBy('lastMessageTimestamp', 'desc') // Order by latest activity
        .onSnapshot(snapshot => {
          let rooms = [];
          snapshot.forEach(doc => {
            rooms.push({ id: doc.id, ...doc.data() });
          });
          renderChatRooms(rooms);
          if (!currentChatRoomId && rooms.length > 0) {
            // Automatically select the first chat room if none is selected
            selectChatRoom(rooms[0].id);
          }
        }, error => {
          console.error("Error loading chat rooms:", error);
          showToast("خطأ في تحميل المحادثات: " + error.message, "#e63946");
          chatRoomsListDiv.innerHTML = '<p style="text-align: center; color: #e63946; padding: 20px;">خطأ في تحميل المحادثات.</p>';
        });
    }

    function renderChatRooms(rooms) {
      const chatRoomsListDiv = document.getElementById('chatRoomsList');
      if (rooms.length === 0) {
        chatRoomsListDiv.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">لا توجد محادثات بعد. <br> (إذا كنت معلمًا، قم بإنشاء واحدة.)</p>';
        return;
      }
      let html = '';
      rooms.forEach(room => {
        const activeClass = room.id === currentChatRoomId ? 'active' : '';
        html += `
          <div class="chat-room-item ${activeClass}" onclick="selectChatRoom('${room.id}')">
            ${sanitizeText(room.name)}
          </div>
        `;
      });
      chatRoomsListDiv.innerHTML = html;
    }

    function selectChatRoom(chatRoomId) {
      if (currentChatRoomId === chatRoomId) return;

      if (messagesListenerUnsubscribe) messagesListenerUnsubscribe(); // Unsubscribe previous listener

      currentChatRoomId = chatRoomId;
      document.getElementById('messageDisplay').innerHTML = ''; // Clear previous messages
      showLoading(true); // Show main spinner

      document.getElementById('currentChatRoomName').innerText = 'جاري التحميل...';

      // Update active class in chat list
      document.querySelectorAll('.chat-room-item').forEach(item => {
        item.classList.remove('active');
      });
      const selectedRoomElement = document.querySelector(`.chat-room-item[onclick="selectChatRoom('${chatRoomId}')"]`);
      if (selectedRoomElement) {
        selectedRoomElement.classList.add('active');
      }

      firestore.collection('chatRooms').doc(chatRoomId).get().then(doc => {
        if (doc.exists) {
          document.getElementById('currentChatRoomName').innerText = sanitizeText(doc.data().name);
          loadMessages(chatRoomId); // loadMessages will handle showing/hiding spinner and rendering messages
        } else {
          console.error("Chat room not found:", chatRoomId);
          showToast("تعذر العثور على غرفة الدردشة.", "#e63946");
          document.getElementById('currentChatRoomName').innerText = 'المحادثة غير موجودة';
          document.getElementById('messageDisplay').innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">المحادثة غير موجودة.</p>';
          showLoading(false); // Hide main spinner
        }
      }).catch(error => {
        console.error("Error fetching chat room details:", error);
        showToast("خطأ في جلب تفاصيل المحادثة: " + error.message, "#e63946");
        document.getElementById('currentChatRoomName').innerText = 'خطأ في التحميل';
        document.getElementById('messageDisplay').innerHTML = '<p style="text-align: center; color: #e63946; padding: 20px;">خطأ في تحميل تفاصيل المحادثة.</p>';
        showLoading(false); // Hide main spinner
      });
      // NEW: Hide chat list panel on mobile when a chat room is selected
      if (window.innerWidth <= 768) {
          toggleChatListPanel(); // Toggle it off
      }
    }

    // --- Message Management ---
    function loadMessages(chatRoomId) {
      const messageDisplay = document.getElementById('messageDisplay');
      // showLoading(true) is already called in selectChatRoom

      messagesListenerUnsubscribe = firestore.collection('chatRooms').doc(chatRoomId).collection('messages')
        .orderBy('timestamp', 'asc')
        .limit(50) // Load initial 50 messages, implement pagination for more
        .onSnapshot(snapshot => {
          showLoading(false); // Hide main spinner once initial messages are loaded

          // Clear messages and re-render only if it's the first load or a full refresh is needed
          // To prevent flickering with real-time updates, handle docChanges
          if (messageDisplay.innerHTML === '' && snapshot.size > 0) { // Check if empty for initial load
              messageDisplay.innerHTML = '';
          }
          
          // Process changes to messages
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              const message = { id: change.doc.id, ...change.doc.data() };
              renderMessage(message);
            } else if (change.type === "modified") {
                // Optional: update existing message (e.g., read status)
                const updatedMessage = { id: change.doc.id, ...change.doc.data() };
                const existingBubble = messageDisplay.querySelector(`[data-message-id="${updatedMessage.id}"]`);
                if (existingBubble) {
                    // Example: update readBy status visually
                    // existingBubble.querySelector('.message-timestamp').innerText = `${updatedMessage.timestamp.toDate().toLocaleString('ar-EG', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'numeric' })} (read by ${updatedMessage.readBy.length})`;
                }
            } else if (change.type === "removed") {
                // Optional: remove message from UI
                const removedMessageId = change.doc.id;
                const removedBubble = messageDisplay.querySelector(`[data-message-id="${removedMessageId}"]`);
                if (removedBubble) {
                    removedBubble.remove();
                }
            }
          });
          messageDisplay.scrollTop = messageDisplay.scrollHeight; // Scroll to bottom
        }, error => {
          console.error("Error loading messages:", error);
          showToast("خطأ في تحميل الرسائل: " + error.message, "#e63946");
          messageDisplay.innerHTML = '<p style="text-align: center; color: #e63946; padding: 20px;">خطأ في تحميل الرسائل.</p>';
          showLoading(false);
        });
    }

    function renderMessage(message) {
      const messageDisplay = document.getElementById('messageDisplay');
      const isSentByMe = message.senderId === currentUser.uid;
      const isTeacher = currentUserRole === 'teacher';
      const senderName = isSentByMe ? 'أنت' : message.senderName || 'مستخدم غير معروف';
      const timestamp = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleString('ar-EG', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'numeric' }) : '';

      const messageDiv = document.createElement('div');
      messageDiv.className = `message-bubble ${isSentByMe ? 'sent' : 'received'}`;
      messageDiv.dataset.messageId = message.id; // Add data attribute for easier identification
      
      let messageContentHtml = sanitizeText(message.text || '');

      if (message.type === 'file' && message.fileUrl) {
          const fileName = message.fileName || 'ملف مرفق';
          const fileIcon = getFileIcon(fileName);
          messageContentHtml += `
            <a href="${message.fileUrl}" target="_blank" class="attachment-link" download>
                <i class="${fileIcon}"></i>
                ${sanitizeText(fileName)}
            </a>
          `;
      } else if (message.type === 'image' && message.fileUrl) {
          messageContentHtml += `
            <a href="${message.fileUrl}" target="_blank">
                <img src="${message.fileUrl}" alt="صورة مرفقة" class="attachment-preview" onerror="this.onerror=null;this.src='https://placehold.co/150x100?text=صورة+غير+متوفرة';"/>
            </a>
          `;
      }

      // Add delete button if user is sender or is a teacher
      const deleteButtonHtml = (isSentByMe || isTeacher) ? `
        <button class="delete-message-btn" onclick="confirmDeleteMessage('${currentChatRoomId}', '${message.id}', '${message.fileUrl || ''}', '${message.type || 'text'}')">
            <i class="fas fa-trash-alt"></i>
        </button>
      ` : '';

      messageDiv.innerHTML = `
        <div class="message-header-line">
            <div class="message-sender">${sanitizeText(senderName)}</div>
            ${deleteButtonHtml}
        </div>
        <div class="message-text">${messageContentHtml}</div>
        <div class="message-timestamp">${timestamp}</div>
      `;
      messageDisplay.appendChild(messageDiv);
    }

    // New: Function to confirm and delete a message
    async function confirmDeleteMessage(chatRoomId, messageId, fileUrl, messageType) {
        if (!confirm("هل أنت متأكد من حذف هذه الرسالة؟ لا يمكن التراجع عن هذا الإجراء.")) {
            return;
        }

        showToast("جاري حذف الرسالة...", "#4361ee");
        try {
            // Delete message from Firestore
            await firestore.collection('chatRooms').doc(chatRoomId).collection('messages').doc(messageId).delete();
            
            // If message has an attached file, delete it from Storage
            if (fileUrl && (messageType === 'file' || messageType === 'image')) {
                // Extract fullPath from fileUrl (this assumes standard Firebase Storage URL structure)
                // e.g., https://firebasestorage.googleapis.com/v0/b/project.appspot.com/o/path%2Fto%2Ffile?alt=media
                const urlParts = fileUrl.split('/o/');
                if (urlParts.length > 1) {
                    const encodedPath = urlParts[1].split('?')[0]; // Get path, remove query params
                    const fullPath = decodeURIComponent(encodedPath); // Decode URI components (%2F to /)
                    
                    const fileRef = storage.ref(fullPath);
                    await fileRef.delete();
                    console.log("File deleted from Storage:", fullPath);
                }
            }

            showToast("تم حذف الرسالة والمرفق (إن وجد) بنجاح!", "#1dad87");
            // No need to re-load messages, listener will handle it
        } catch (error) {
            console.error("Error deleting message or file:", error);
            showToast("خطأ أثناء حذف الرسالة: " + error.message, "#e63946");
        }
    }


    function getFileIcon(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();
        switch (extension) {
            case 'pdf': return 'fas fa-file-pdf';
            case 'doc':
            case 'docx': return 'fas fa-file-word';
            case 'xls':
            case 'xlsx': return 'fas fa-file-excel';
            case 'ppt':
            case 'pptx': return 'fas fa-file-powerpoint';
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'gif': return 'fas fa-file-image';
            case 'mp3':
            case 'wav': return 'fas fa-file-audio';
            case 'mp4':
            case 'avi': return 'fas fa-file-video';
            default: return 'fas fa-file';
        }
    }

    function sendMessage(fileUrl = null, fileName = null, fileType = 'text') {
      const messageInput = document.getElementById('messageInput');
      const messageText = messageInput.value.trim();

      // Only allow sending if there's text OR a file
      if (!messageText && !fileUrl) {
        showToast("لا يمكن إرسال رسالة فارغة.", "#e63946");
        return;
      }
      if (!currentChatRoomId || !currentUser) {
        showToast("الرجاء اختيار محادثة.", "#e63946");
        return;
      }

      const messageData = {
        senderId: currentUser.uid,
        senderName: currentUser.displayName || currentUser.email,
        text: messageText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        readBy: [currentUser.uid], // Mark as read by sender immediately
        type: fileUrl ? (fileType.startsWith('image/') ? 'image' : 'file') : 'text', // Set message type
        fileUrl: fileUrl, // Include file URL if present
        fileName: fileName // Include file name if present
      };

      firestore.collection('chatRooms').doc(currentChatRoomId).update({ // <-- Updated line
        lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessageText: fileUrl ? `[ملف: ${fileName || 'مرفق'}]` : messageText, // Show file indicator in last message preview
        lastMessageSender: currentUser.displayName || currentUser.email
      }).then(() => {
        firestore.collection('chatRooms').doc(currentChatRoomId).collection('messages').add(messageData); // <-- Original line
      })
        .then(() => { // This .then() belongs to the update, not the add. It needs to be chained.
          messageInput.value = ''; // Clear text input
          messageInput.style.height = 'auto'; // Reset textarea height
          document.getElementById('fileInput').value = ''; // Clear file input
        })
        .catch(error => {
          console.error("Error sending message:", error);
          showToast("خطأ أثناء إرسال الرسالة: " + error.message, "#e63946");
        });
    }

    // Adjust textarea height automatically (basic)
    document.getElementById('messageInput').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // --- File Attachment Logic ---
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const ALLOWED_FILE_TYPES = [
        'image/jpeg', 'image/png', 'image/gif', // Images
        'application/pdf', // Documents
        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .doc, .docx
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xls, .xlsx
        'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .ppt, .pptx
        'text/plain' // Text files
        // Removed: 'application/zip', 'application/x-rar-compressed'
    ];

    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
            showFileUploadSpinner(false); // Hide spinner if no file selected (e.g., user cancels)
            return;
        }

        // 1. Client-side Validation
        if (!ALLOWED_FILE_TYPES.includes(file.type)) {
            showToast("نوع الملف غير مدعوم. أنواع الملفات المدعومة هي: صور، PDF، مستندات Word/Excel/PowerPoint، ملفات نصية.", "#e63946");
            document.getElementById('fileInput').value = ''; // Clear input
            return;
        }

        if (file.size > MAX_FILE_SIZE) {
            showToast(`حجم الملف كبير جداً. الحد الأقصى المسموح به هو ${MAX_FILE_SIZE / (1024 * 1024)} ميجابايت.`, "#e63946");
            document.getElementById('fileInput').value = ''; // Clear input
            return;
        }

        if (!currentChatRoomId) {
            showToast("الرجاء اختيار محادثة قبل إرفاق ملف.", "#e63946");
            document.getElementById('fileInput').value = ''; // Clear input
            return;
        }

        showFileUploadSpinner(true);
        try {
            // 2. Upload to Firebase Storage
            const storageRef = storage.ref();
            // Path: chat_attachments/{chatRoomId}/{timestamp}_{fileName}
            const fileExtension = file.name.split('.').pop();
            const fileNameForStorage = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`; // Sanitize file name
            const fileRef = storageRef.child(`chat_attachments/${currentChatRoomId}/${fileNameForStorage}`);

            const uploadTask = fileRef.put(file);

            // Listen for state changes, errors, and completion of the upload.
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Optional: Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                    // You could update a progress bar here if you have one
                },
                (error) => {
                    // Handle unsuccessful uploads
                    console.error("Error during file upload:", error);
                    showToast("خطأ أثناء رفع الملف: " + error.message, "#e63946");
                    showFileUploadSpinner(false);
                },
                async () => {
                    // Handle successful uploads on complete
                    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                    // 3. Send message with file URL
                    sendMessage(downloadURL, file.name, file.type);
                    showToast("تم رفع الملف بنجاح وإرساله!", "#1dad87");
                    showFileUploadSpinner(false);
                }
            );

        } catch (error) {
            console.error("Error initiating file upload:", error); // Error in the try block itself, not the uploadTask
            showToast("خطأ في بدء عملية رفع الملف: " + error.message, "#e63946");
            showFileUploadSpinner(false);
        } finally {
            // It's crucial to ensure spinner is hidden even if try/catch blocks don't catch everything
            // showFileUploadSpinner(false); // This is handled by uploadTask.on('state_changed', ..., error, success)
            document.getElementById('fileInput').value = ''; // Clear file input regardless of success/failure
        }
    }


    // --- Admin Functionality (Create/Manage Chats) ---
    // Load all users for modals (teacher only)
    function loadAllUsersForModals() {
      firestore.collection('users').get().then(snapshot => {
        allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      }).catch(error => {
        console.error("Error loading all users:", error);
        showToast("خطأ في تحميل قائمة المستخدمين للمدير.", "#e63946");
      });
    }

    // Create Chat Modal Functions
    function openCreateChatModal() {
      document.getElementById('createChatModal').style.display = 'flex';
      const allUsersListDiv = document.getElementById('allUsersList');
      allUsersListDiv.innerHTML = ''; // Clear previous list

      // Display all users, allowing multi-selection
      allUsers.forEach(user => {
        if (user.id === currentUser.uid) return; // Don't show current admin in list to add themselves
        const userDiv = document.createElement('div');
        userDiv.innerText = sanitizeText(user.name || user.email);
        userDiv.dataset.uid = user.id;
        userDiv.onclick = () => userDiv.classList.toggle('selected');
        allUsersListDiv.appendChild(userDiv);
      });

      // Automatically add and select the current admin
      const adminUserDiv = document.createElement('div');
      adminUserDiv.innerText = sanitizeText(currentUser.displayName || currentUser.email) + " (أنت - المدير)";
      adminUserDiv.dataset.uid = currentUser.uid;
      adminUserDiv.classList.add('selected'); // Admin is always a participant
      adminUserDiv.style.fontWeight = 'bold';
      adminUserDiv.style.backgroundColor = '#dff0d8'; // Light green background for admin
      adminUserDiv.onclick = (e) => e.stopPropagation(); // Prevent unselecting admin
      allUsersListDiv.prepend(adminUserDiv); // Add admin to the top
    }

    function closeCreateChatModal() {
      document.getElementById('createChatModal').style.display = 'none';
      document.getElementById('newChatName').value = '';
      document.getElementById('allUsersList').innerHTML = '<p style="text-align: center; color: #888;">جاري تحميل المستخدمين...</p>'; // Reset content
    }

    function createNewChatRoom() {
      const chatName = document.getElementById('newChatName').value.trim();
      if (!chatName) {
        showToast("الرجاء إدخال اسم للمحادثة.", "#e63946");
        return;
      }

      const selectedUsers = Array.from(document.querySelectorAll('#allUsersList .selected'))
        .map(div => div.dataset.uid);

      if (selectedUsers.length === 0) {
        showToast("الرجاء اختيار مشارك واحد على الأقل.", "#e63946");
        return;
      }

      showLoading(true);
      firestore.collection('chatRooms').add({
        name: chatName,
        participants: selectedUsers,
        adminId: currentUser.uid, // Admin who created the chat
        type: selectedUsers.length > 2 ? 'group' : 'private', // Simple logic for type
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp() // Initial timestamp
      }).then(() => {
        showToast("تم إنشاء المحادثة بنجاح!", "#1dad87");
        closeCreateChatModal();
        showLoading(false);
      }).catch(error => {
        console.error("Error creating chat room:", error);
        showToast("خطأ أثناء إنشاء المحادثة: " + error.message, "#e63946");
        showLoading(false);
      });
    }

    // Manage Participants Modal Functions
    function openManageParticipantsModal() {
      if (!currentChatRoomId) {
        showToast("الرجاء اختيار محادثة لإدارة أعضائها.", "#e63946");
        return;
      }
      document.getElementById('manageParticipantsModal').style.display = 'flex';
      document.getElementById('manageChatRoomName').innerText = document.getElementById('currentChatRoomName').innerText;
      const currentParticipantsListDiv = document.getElementById('currentParticipantsList');
      currentParticipantsListDiv.innerHTML = '<p style="text-align: center; color: #888;">جاري تحميل المشاركين...</p>';

      firestore.collection('chatRooms').doc(currentChatRoomId).get().then(doc => {
        if (!doc.exists) {
          showToast("غرفة الدردشة غير موجودة.", "#e63946");
          closeManageParticipantsModal();
          return;
        }
        const roomData = doc.data();
        currentChatParticipants = roomData.participants || [];

        // Display all users, pre-selecting current participants
        allUsers.forEach(user => {
          const userDiv = document.createElement('div');
          userDiv.innerText = sanitizeText(user.name || user.email);
          userDiv.dataset.uid = user.id;
          if (currentChatParticipants.includes(user.id)) {
            userDiv.classList.add('selected');
          }
          userDiv.onclick = () => {
            // Prevent removing the admin who created the chat (if adminId exists)
            if (roomData.adminId && user.id === roomData.adminId) {
              showToast("لا يمكن إزالة مدير الدردشة.", "#e63946");
              return;
            }
            userDiv.classList.toggle('selected');
          };
          currentParticipantsListDiv.appendChild(userDiv);
        });

      }).catch(error => {
        console.error("Error fetching chat room participants:", error);
        showToast("خطأ في جلب المشاركين: " + error.message, "#e63946");
        closeManageParticipantsModal();
      });
    }

    function closeManageParticipantsModal() {
      document.getElementById('manageParticipantsModal').style.display = 'none';
      document.getElementById('currentParticipantsList').innerHTML = ''; // Reset content
    }

    function saveParticipantsChanges() {
      if (!currentChatRoomId) return;

      const newSelectedParticipants = Array.from(document.querySelectorAll('#currentParticipantsList .selected'))
        .map(div => div.dataset.uid);

      if (newSelectedParticipants.length === 0) {
        showToast("يجب أن يكون هناك مشارك واحد على الأقل في المحادثة.", "#e63946");
        return;
      }

      showLoading(true);
      firestore.collection('chatRooms').doc(currentChatRoomId).update({
        participants: newSelectedParticipants
      }).then(() => {
        showToast("تم تحديث المشاركين بنجاح!", "#1dad87");
        closeManageParticipantsModal();
        showLoading(false);
      }).catch(error => {
        console.error("Error updating participants:", error);
        showToast("خطأ أثناء تحديث المشاركين: " + error.message, "#e63946");
        showLoading(false);
      });
    }

    // NEW: Toggle Chat List Panel (for mobile/small screens)
    function toggleChatListPanel() {
        const chatListPanel = document.getElementById('chatListOverlay');
        const toggleIcon = document.getElementById('chatListToggleIcon');
        if (chatListPanel.classList.contains('active-panel')) {
            // Hide panel
            chatListPanel.classList.remove('active-panel');
            toggleIcon.classList.replace('fa-times', 'fa-bars'); // Change icon to bars
            // After transition, set display to none to make it completely non-interactive
            chatListPanel.addEventListener('transitionend', function handler() {
                chatListPanel.style.display = 'none';
                chatListPanel.removeEventListener('transitionend', handler);
            });
        } else {
            // Show panel
            chatListPanel.style.display = 'flex'; // Make it visible for transition
            // Small delay to ensure display:flex applies before transform starts
            setTimeout(() => {
                chatListPanel.classList.add('active-panel');
                toggleIcon.classList.replace('fa-bars', 'fa-times'); // Change icon to X
            }, 10);
        }
    }
    // Set initial state based on screen size on load and resize
    function initializeChatListPanelVisibility() {
        const chatListPanel = document.getElementById('chatListOverlay');
        const toggleButton = document.getElementById('chatListToggleButton');

        if (window.innerWidth <= 768) {
            chatListPanel.style.display = 'none'; // Ensure hidden on mobile
            chatListPanel.classList.remove('active-panel'); // Ensure not active
            toggleButton.style.display = 'flex'; // Show FAB
            document.getElementById('chatListToggleIcon').classList.replace('fa-times', 'fa-bars'); // Reset icon
        } else {
            chatListPanel.style.display = 'flex'; // Show panel normally on desktop
            chatListPanel.classList.remove('active-panel'); // Ensure not in active mobile state
            toggleButton.style.display = 'none'; // Hide FAB
        }
    }

    window.addEventListener('load', initializeChatListPanelVisibility);
    window.addEventListener('resize', initializeChatListPanelVisibility);

  </script>
</body>
</html>
