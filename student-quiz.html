<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>اختبار الطالب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {font-family:'Tajawal',Arial,sans-serif;background:#f8fafc;margin:0;}
    .container {max-width:900px;margin:30px auto 0 auto;background:#fff;border-radius:12px;padding:28px 20px;box-shadow:0 2px 10px #0002;}
    h2 {color:#2260af;}
    .question-block {background:#f8fafc;border-radius:10px;padding:14px 12px;margin:18px 0 30px 0;box-shadow:0 2px 8px #e4e7ef44;}
    .question-title {font-weight:bold;margin-bottom:9px;}
    .multi-note {color:#b96d0d;font-size:0.98em;margin-right:6px;}
    .question-mark {color:#2260af;margin-right:12px;}
    .choices-list {margin-bottom:10px;}
    .choice-row {margin-bottom:6px;}
    .btn {background:#2260af;color:#fff;border:none;padding:8px 22px;border-radius:5px;font-size:1rem;cursor:pointer;}
    .btn[disabled] {background:#bdbdbd;}
    .msg {color:#e63946;margin-bottom:16px;}
    .result {font-size:1.3rem;color:#219e4b;font-weight:bold;text-align:center;}
    .logout-btn {background:#b83b3b;margin-right:10px;}
    .logout-btn:hover {background:#7a2626;}
    header {background:#2260af;color:#fff;padding:16px 24px;font-size:1.3rem;display:flex;justify-content:space-between;align-items:center;}
    @media (max-width:900px){.container{padding:7px;}}
    .scoring-note {color:#007b8f;font-size:0.95em;margin-top:5px;}
  </style>
</head>
<body>
  <header>
    <span>اختبار الطالب</span>
    <button class="btn logout-btn" onclick="logout()">تسجيل الخروج</button>
  </header>
  <div class="container">
    <h2>الأسئلة</h2>
    <form id="examForm">
      <div id="questionsArea"></div>
      <div class="msg" id="formMsg"></div>
      <button type="submit" class="btn">إرسال الإجابات</button>
    </form>
    <div class="result" id="resultArea"></div>
  </div>

  <script>
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();

    // دالة خلط عشوائي لمصفوفة
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    let questions = [];
    let randomizedQuestions = [];

    // حماية الصفحة - فقط للطلاب
    auth.onAuthStateChanged(function(user){
      if (user) {
        firestore.collection('users').doc(user.uid).get().then(function(doc){
          if (!doc.exists || doc.data().role !== "student") {
            window.location.href = "login.html";
          } else {
            loadQuestions();
          }
        }).catch(function(){
          window.location.href = "login.html";
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function logout() {
      auth.signOut().then(()=>{window.location.href='login.html';});
    }

    function loadQuestions() {
      firestore.collection('questions').get().then(snap=>{
        questions = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
        prepareRandomized();
        renderQuestions();
      });
    }

    // تجهيز نسخة عشوائية من الأسئلة وترتيب الخيارات
    function prepareRandomized() {
      randomizedQuestions = shuffleArray(questions.map(q => {
        // خلط الخيارات
        let choiceObjs = (q.choices||[]).map((choice, idx) => ({
          text: choice,
          origIndex: idx
        }));
        let shuffledChoices = shuffleArray(choiceObjs);
        // تعيين correct الجديدة بحسب ترتيب الخيارات الجديد
        let newCorrect = [];
        shuffledChoices.forEach((ch, ix) => {
          if(q.correct && q.correct.includes(ch.origIndex)) newCorrect.push(ix);
        });
        return {
          ...q,
          choices: shuffledChoices.map(c => c.text),
          correct: newCorrect
        };
      }));
    }

    function renderQuestions() {
      let html = '';
      randomizedQuestions.forEach((q, i) => {
        let multiNote = '';
        let scoringNote = '';
        if (q.correct.length > 1) {
          multiNote = '<span class="multi-note">(يحتمل أكثر من إجابة صحيحة)</span>';
          scoringNote = `<div class="scoring-note">
          ملاحظة: لكل إجابة صحيحة تختارها تحصل على جزء من العلامة، ولكل إجابة خاطئة تختارها يُخصم نفس الجزء من العلامة. لا يمكن أن تقل علامة السؤال عن الصفر.
          </div>`;
        }
        let markText = `<span class="question-mark">[العلامة: ${q.mark || 1}]</span>`;
        html += `<div class="question-block">
          <div class="question-title">${i+1}. ${q.question} ${multiNote} ${markText}</div>
          <div class="choices-list">` +
          (q.choices||[]).map((choice, idx) =>
            `<div class="choice-row">
              <label>
                <input type="${q.correct.length>1?'checkbox':'radio'}" name="q${i}" value="${idx}">
                ${choice}
              </label>
            </div>`
          ).join('') +
          `</div>
          ${scoringNote}
        </div>`;
      });
      document.getElementById('questionsArea').innerHTML = html || '<div class="msg">لا توجد أسئلة حالياً.</div>';
    }

    document.getElementById('examForm').onsubmit = function(e){
      e.preventDefault();
      let totalMark = 0, gainedMark = 0, empty = 0;
      randomizedQuestions.forEach((q, i) => {
        let nodes = document.getElementsByName('q'+i);
        let selected = [];
        nodes.forEach(input => { if(input.checked) selected.push(parseInt(input.value)); });

        let mark = parseFloat(q.mark) || 1;
        totalMark += mark;

        if (selected.length===0) { empty++; return; }

        // التصحيح التفاضلي
        if(q.correct.length > 1) {
          let perMark = mark / q.correct.length;
          let countCorrect = 0;
          let countWrong = 0;
          selected.forEach(val => {
            if(q.correct.includes(val)) countCorrect++;
            else countWrong++;
          });
          let gained = (countCorrect - countWrong) * perMark;
          if(gained < 0) gained = 0;
          gainedMark += gained;
        }
        else {
          // سؤال بإجابة واحدة فقط: العلامة كاملة إذا كانت الإجابة صحيحة فقط
          if(selected.length === 1 && q.correct.includes(selected[0])) gainedMark += mark;
        }
      });
      if (empty>0) {
        showFormMsg('يرجى الإجابة على جميع الأسئلة!');
        return;
      }
      // تقريب العلامة النهائية إلى منزلتين
      gainedMark = Math.round(gainedMark * 100) / 100;
      showResult(`درجتك: ${gainedMark} من ${totalMark}`);
      showFormMsg('');
    };

    function showFormMsg(msg) {
      document.getElementById('formMsg').innerText = msg;
    }
    function showResult(msg) {
      document.getElementById('resultArea').innerText = msg;
    }
  </script>
</body>
</html>
