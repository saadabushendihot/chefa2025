<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>منصة شفاء - الدخول</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script src="firebase-config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Tajawal, Arial, sans-serif; background: #f8fafc; margin: 0;}
    .container { max-width: 800px; margin: 40px auto; }
    .nav { background: #4361ee; color: #fff; padding: 0; margin: 0; display: flex; gap: 0; }
    .nav a { color: #fff; text-decoration: none; display: inline-block; padding: 16px 28px; font-size: 1.1rem;}
    .nav a:hover, .nav .active { background: #23366d; }
    .box { background: #fff; padding: 30px 24px; border-radius: 8px; box-shadow: 0 2px 8px #ccc2; margin: 40px auto; max-width: 450px;}
    label { display: block; margin-top: 14px; font-size: 1.1rem;}
    input[type="email"], input[type="password"] { padding: 10px; width: 96%; border: 1px solid #ccc; border-radius: 4px; margin-top: 8px;}
    button { background: #4361ee; color: #fff; border: none; padding: 12px 36px; border-radius: 6px; font-size: 1.1rem; margin-top: 24px;}
    .msg { color: #ef476f; margin-top: 12px;}
    .logout-btn { background: #eb2f06; color: #fff; padding: 7px 20px; border-radius: 4px; border: none; font-size: 1em; margin-right: 15px;}
    #student-redirect { color: #4361ee; font-weight:bold; margin-top:24px; font-size:1.1em;}
  </style>
</head>
<body>
  <div id="navbar" class="nav" style="display:none;"></div>
  <div class="container">
    <div id="loginBox" class="box">
      <h2>تسجيل الدخول</h2>
      <form id="loginForm">
        <label>البريد الإلكتروني:
          <input type="email" id="email" required>
        </label>
        <label>كلمة المرور:
          <input type="password" id="password" required>
        </label>
        <button type="submit">دخول</button>
      </form>
      <div id="msg" class="msg"></div>
      <div id="student-redirect" style="display:none;"></div>
    </div>
    <div id="welcomeBox" class="box" style="display:none;">
      <h2 id="welcomeMessage"></h2>
      <p id="roleMessage"></p>
      <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
    </div>
  </div>

  <script>

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var auth = firebase.auth();
    var firestore = firebase.firestore();

    // عند الضغط على زر الدخول
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var email = document.getElementById('email').value.trim().toLowerCase();
      var password = document.getElementById('password').value.trim();
      document.getElementById('msg').innerText = "";
      document.getElementById('student-redirect').style.display = "none";

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          let user = userCredential.user;
          firestore.collection('users').doc(user.uid).get().then(function(doc) {
            if (doc.exists) {
              let data = doc.data();
              localStorage.setItem('user_email', user.email);
              localStorage.setItem('user_role', data.role);

              if(data.role === "teacher") {
                showNavbar(data.role, user.email, data.name);
                document.getElementById('loginBox').style.display = "none";
                document.getElementById('welcomeBox').style.display = "block";
                document.getElementById('welcomeMessage').innerText = `مرحباً ${data.name ? data.name : user.email}`;
                document.getElementById('roleMessage').innerText = `صلاحيتك: معلم`;
              } else if(data.role === "student") {
                document.getElementById('student-redirect').style.display = "block";
                document.getElementById('student-redirect').innerText = "مرحباً طالبنا العزيز، سيتم تحويلك تلقائياً إلى صفحتك...";
                setTimeout(function() {
                  window.location.href = "student.html";
                }, 2000);
                auth.signOut();
              } else {
                document.getElementById('msg').innerText = "لا توجد بيانات صلاحية لهذا الحساب.";
                auth.signOut();
              }
            } else {
              document.getElementById('msg').innerText = "لا توجد بيانات صلاحية لهذا الحساب.";
              auth.signOut();
            }
          });
        })
        .catch((error) => {
          document.getElementById('msg').innerText = "خطأ: " + error.message;
        });
    });

    // شريط تنقل للمعلم فقط
    function showNavbar(role, email, name) {
      let nav = document.getElementById('navbar');
      let links = '';
      if(role === "teacher") {
        links += `<a href="dashboard.html" target="_self">إدارة الطلاب</a>`;
        links += `<a href="student.html" target="_self">صفحة الطالب</a>`;
      }
      nav.innerHTML = links;
      nav.style.display = "flex";
    }

    // تحقق من تسجيل الدخول عند تحديث الصفحة
    window.onload = function() {
      auth.onAuthStateChanged(function(user) {
        if(user){
          firestore.collection('users').doc(user.uid).get().then(function(doc) {
            if(doc.exists && doc.data().role === "teacher"){
              let data = doc.data();
              showNavbar(data.role, user.email, data.name);
              document.getElementById('loginBox').style.display = "none";
              document.getElementById('welcomeBox').style.display = "block";
              document.getElementById('welcomeMessage').innerText = `مرحباً ${data.name ? data.name : user.email}`;
              document.getElementById('roleMessage').innerText = `صلاحيتك: معلم`;
            }
          });
        }
      });
    };

    // تسجيل الخروج
    function logout() {
      auth.signOut().then(function() {
        localStorage.clear();
        location.reload();
      });
    }
  </script>
</body>
</html>
